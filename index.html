<!DOCTYPE html> <!-- Tek sayfa uygulama bildirimi -->
<html lang="tr"> <!-- Dil ayarÄ± TÃ¼rkÃ§e -->
<head> <!-- BaÅŸlÄ±k bilgileri baÅŸlangÄ±cÄ± -->
<meta charset="UTF-8"> <!-- Unicode desteÄŸi -->
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobil uyum -->
<title>Hat SimÃ¼lasyonu</title> <!-- Sayfa baÅŸlÄ±ÄŸÄ± -->
<style> /* GÃ¶mÃ¼lÃ¼ stiller baÅŸlangÄ±cÄ± */
:root { /* Tema deÄŸiÅŸkenleri tanÄ±mÄ± */
  --bg: #111316; /* Arka plan rengi */
  --card: #1c1f24; /* Kart arka planÄ± */
  --card-light: #242830; /* Kart aÃ§Ä±k tonu */
  --accent: #64d2ff; /* Vurgu rengi */
  --accent-strong: #30a6d9; /* GÃ¼Ã§lÃ¼ vurgu rengi */
  --text: #f4f5f7; /* Metin rengi */
  --muted: #9aa0ab; /* SÃ¶nÃ¼k metin rengi */
  --danger: #ff6b6b; /* Hata/darboÄŸaz rengi */
  --border-radius: 12px; /* Genel kÃ¶ÅŸe yuvarlama */
  --transition: 160ms ease; /* Standart geÃ§iÅŸ sÃ¼resi */
}

* { /* Genel reset */
  box-sizing: border-box; /* Kutular iÃ§eriÄŸe gÃ¶re hesaplanÄ±r */
}

body { /* GÃ¶vde stili */
  margin: 0; /* VarsayÄ±lan boÅŸluklarÄ± kaldÄ±r */
  font-family: "Segoe UI", sans-serif; /* Modern yazÄ± tipi */
  background: var(--bg); /* Arka plan */
  color: var(--text); /* Metin */
  min-height: 100vh; /* Tam ekran */
}

header { /* Ãœst Ã§ubuk stili */
  position: sticky; /* YukarÄ±da sabitlenir */
  top: 0; /* YukarÄ± hizalama */
  z-index: 10; /* Ãœstte kalmasÄ± iÃ§in */
  background: rgba(17, 19, 22, 0.94); /* Hafif saydam fon */
  backdrop-filter: blur(12px); /* Cam efekti */
  padding: 16px 24px 12px 24px; /* Ä°Ã§ boÅŸluk */
  box-shadow: 0 2px 12px rgba(0,0,0,0.35); /* GÃ¶lge */
  display: grid; /* Tab ve toolbar Ä±zgarasÄ± */
  gap: 12px; /* SatÄ±rlar arasÄ± boÅŸluk */
}

.tab-bar { /* Sekme Ã§ubuÄŸu */
  display: flex; /* Yatay hizalama */
  flex-wrap: wrap; /* SatÄ±r kÄ±rÄ±lmasÄ±na izin ver */
  gap: 8px; /* Sekmeler arasÄ± boÅŸluk */
  align-items: center; /* Dikey ortalama */
}

.tab-button { /* Sekme dÃ¼ÄŸmesi */
  display: inline-flex; /* Ä°Ã§eriÄŸi hizala */
  align-items: center; /* Dikey ortala */
  gap: 8px; /* Ä°kon boÅŸluÄŸu */
  padding: 6px 14px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Tam yuvarlak */
  border: 1px solid rgba(255,255,255,0.16); /* Ä°nce kenar */
  background: rgba(26, 30, 36, 0.7); /* Panel fonu */
  color: var(--text); /* Metin rengi */
  cursor: pointer; /* El imleci */
  transition: background var(--transition), border-color var(--transition), transform var(--transition); /* GeÃ§iÅŸler */
  user-select: none; /* Metni seÃ§me */
}

.tab-button[data-active="true"] { /* Aktif sekme */
  background: linear-gradient(135deg, rgba(100,210,255,0.92), rgba(143,123,255,0.9)); /* Degrade */
  color: #06141c; /* Kontrast metin */
  border-color: transparent; /* KenarÄ± kaldÄ±r */
  box-shadow: 0 12px 28px rgba(0,0,0,0.35); /* GÃ¶lge */
}

.tab-button:hover:not([data-active="true"]) { /* Hover pasif sekme */
  background: rgba(100,210,255,0.2); /* Vurgu fon */
  border-color: rgba(100,210,255,0.4); /* KenarÄ± vurgula */
}

.tab-button[data-dirty="true"]::after { /* KaydedilmemiÅŸ deÄŸiÅŸiklik gÃ¶stergesi */
  content: 'â€¢'; /* Nokta */
  margin-left: 6px; /* BoÅŸluk */
  color: var(--accent); /* Vurgu rengi */
  font-size: 1.2em; /* Boyut */
}

.tab-button span { /* Sekme adÄ± */
  pointer-events: none; /* Ä°Ã§ metne tÄ±klama yok */
}

.tab-close { /* Sekme kapatma ikonu */
  background: transparent; /* Åeffaf */
  border: none; /* Kenar yok */
  color: inherit; /* Metni devral */
  font-size: 0.9rem; /* Boyut */
  cursor: pointer; /* El imleci */
  padding: 0; /* BoÅŸluk yok */
  line-height: 1; /* SÄ±kÄ± hizalama */
}

.tab-button[draggable="true"] { /* SÃ¼rÃ¼klenebilir sekme */
  opacity: 1; /* Tam gÃ¶rÃ¼nÃ¼r */
}

.new-tab-btn { /* Yeni sekme butonu */
  padding: 6px 12px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Yuvarlak */
  background: rgba(255,255,255,0.08); /* Hafif parlak */
  border: 1px dashed rgba(255,255,255,0.2); /* Kesikli kenar */
  color: var(--text); /* Metin rengi */
  cursor: pointer; /* El imleci */
  transition: background var(--transition), border-color var(--transition); /* GeÃ§iÅŸ */
}

.new-tab-btn:hover { /* Hover yeni sekme */
  background: rgba(100,210,255,0.2); /* Parlak */
  border-color: rgba(100,210,255,0.5); /* Kenar */
}

.controls { /* Ana toolbar kapsayÄ±cÄ±sÄ± */
  display: flex; /* Yatay hizalama */
  flex-direction: column; /* SatÄ±rlar halinde dÃ¼zenle */
  gap: 12px; /* SatÄ±rlar arasÄ± boÅŸluk */
}

.toolbar-row { /* Toolbar satÄ±rÄ± */
  display: flex; /* Yatay hizalama */
  flex-wrap: wrap; /* SatÄ±r kÄ±rÄ±lmasÄ±na izin ver */
  gap: 12px; /* Grup arasÄ± boÅŸluk */
  align-items: center; /* Dikey ortala */
}

.toolbar-dropdown { /* Ãœst menÃ¼ aÃ§Ä±lÄ±r grup */
  position: relative; /* MenÃ¼ konum referansÄ± */
  display: inline-flex; /* Yatay hizalama */
  align-items: center; /* Dikey ortala */
}

.dropdown-toggle { /* AÃ§Ä±lÄ±r menÃ¼ tetikleyicisi */
  display: inline-flex; /* Yatay hizalama */
  align-items: center; /* Dikey ortala */
  gap: 6px; /* Sembol boÅŸluÄŸu */
  padding: 8px 16px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Yuvarlak ÅŸekil */
  background: rgba(26, 30, 36, 0.76); /* Arka plan */
  border: 1px solid rgba(255,255,255,0.14); /* Kenar */
  color: var(--text); /* Metin rengi */
  cursor: pointer; /* El imleci */
  transition: background var(--transition), border-color var(--transition), transform var(--transition); /* GeÃ§iÅŸler */
}

.dropdown-toggle:hover { /* Hover tetikleyici */
  background: rgba(100,210,255,0.18); /* Hafif vurgu */
  border-color: rgba(100,210,255,0.36); /* KenarÄ± vurgula */
}

.dropdown-menu { /* AÃ§Ä±lÄ±r menÃ¼ paneli */
  position: absolute; /* Mutlak konum */
  top: calc(100% + 6px); /* Buton altÄ± */
  left: 0; /* Sola hizala */
  background: rgba(18,22,28,0.96); /* MenÃ¼ fonu */
  border-radius: 16px; /* KÃ¶ÅŸe */
  border: 1px solid rgba(255,255,255,0.14); /* Ä°nce kenar */
  box-shadow: 0 18px 40px rgba(0,0,0,0.45); /* GÃ¶lge */
  display: none; /* VarsayÄ±lan gizli */
  min-width: 220px; /* Minimum geniÅŸlik */
  padding: 8px; /* Ä°Ã§ boÅŸluk */
  z-index: 35; /* Katman */
  flex-direction: column; /* Dikey dÃ¼zen */
  gap: 4px; /* Ã–ÄŸeler arasÄ± boÅŸluk */
}

.dropdown-menu button { /* MenÃ¼ Ã¶ÄŸesi */
  width: 100%; /* Tam geniÅŸlik */
  background: transparent; /* Åeffaf */
  border: none; /* Kenar yok */
  color: var(--text); /* Metin rengi */
  padding: 10px 12px; /* Ä°Ã§ boÅŸluk */
  text-align: left; /* Sola hizala */
  border-radius: 12px; /* KÃ¶ÅŸe */
  cursor: pointer; /* El imleci */
  transition: background var(--transition), color var(--transition); /* GeÃ§iÅŸ */
}

.dropdown-menu button:hover { /* Hover menÃ¼ Ã¶ÄŸesi */
  background: rgba(100,210,255,0.22); /* Parlak */
  color: #08202a; /* Kontrast */
}

.dropdown-divider { /* MenÃ¼ ayÄ±rÄ±cÄ±sÄ± */
  height: 1px; /* Ã‡izgi kalÄ±nlÄ±ÄŸÄ± */
  background: rgba(255,255,255,0.08); /* Ã‡izgi rengi */
  margin: 4px 0; /* Dikey boÅŸluk */
}

.dropdown-inline-group { /* MenÃ¼ iÃ§i satÄ±r */
  display: flex; /* Yatay hizala */
  align-items: center; /* Dikey ortala */
  gap: 6px; /* BoÅŸluk */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸeler */
  background: rgba(26,30,36,0.72); /* SatÄ±r fonu */
}

.dropdown-inline-group button { /* SatÄ±r iÃ§i buton */
  flex: 1; /* EÅŸit paylaÅŸtÄ±r */
  text-align: center; /* Ortala */
  padding: 8px 10px; /* Ä°Ã§ boÅŸluk */
}

.dropdown-inline-group button.active { /* Aktif durum */
  background: linear-gradient(135deg, rgba(100,210,255,0.9), rgba(136,118,255,0.9)); /* Degrade vurgu */
  color: #04141c; /* Kontrast metin */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

.dropdown-inline-group button.active:hover { /* Aktif hover */
  background: linear-gradient(135deg, rgba(120,220,255,0.95), rgba(156,138,255,0.95)); /* Parlak degrade */
}

.dropdown-inline-group span[data-role="zoom-value"] { /* Zoom metni */
  min-width: 56px; /* Minimum geniÅŸlik */
  text-align: center; /* Ortala */
  font-weight: 600; /* KalÄ±n */
}

.dropdown-section { /* MenÃ¼ alt baÅŸlÄ±k grubu */
  display: flex; /* Dikey hizala */
  flex-direction: column; /* Kolon halinde diz */
  gap: 4px; /* Eleman arasÄ± boÅŸluk */
  padding: 4px; /* Ä°Ã§ boÅŸluk */
}

.dropdown-section-header { /* Alt baÅŸlÄ±k etiketi */
  font-size: 0.82rem; /* KÃ¼Ã§Ã¼k yazÄ± */
  text-transform: uppercase; /* BÃ¼yÃ¼k harf */
  letter-spacing: 0.08em; /* Harf aralÄ±ÄŸÄ± */
  color: rgba(255,255,255,0.55); /* SÃ¶nÃ¼k ton */
  padding: 4px 4px 2px 4px; /* BoÅŸluk */
}

.dropdown-list { /* KaydedilmiÅŸ senaryo listesi */
  display: flex; /* Dikey hizala */
  flex-direction: column; /* Kolon olarak sÄ±rala */
  max-height: 220px; /* Maks yÃ¼kseklik */
  overflow-y: auto; /* KaydÄ±rma */
  border-radius: 12px; /* KÃ¶ÅŸeler */
  background: rgba(15, 18, 24, 0.58); /* Arka plan */
  padding: 4px; /* Ä°Ã§ boÅŸluk */
  gap: 4px; /* Eleman arasÄ± boÅŸluk */
}

.dropdown-list button { /* Senaryo Ã¶ÄŸesi butonu */
  background: rgba(30, 36, 44, 0.9); /* Koyu fon */
  border-radius: 10px; /* KÃ¶ÅŸeler */
  white-space: nowrap; /* Tek satÄ±r */
  text-overflow: ellipsis; /* TaÅŸma Ã¼Ã§ nokta */
  overflow: hidden; /* TaÅŸan gizle */
}

.dropdown-list button:hover { /* Hover senaryo butonu */
  background: rgba(100,210,255,0.22); /* Vurgu fonu */
  color: #071620; /* Kontrast */
}

.dropdown-empty { /* BoÅŸ liste mesajÄ± */
  padding: 12px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸeler */
  background: rgba(26, 30, 36, 0.6); /* Arka plan */
  color: rgba(255,255,255,0.62); /* Metin tonu */
  text-align: center; /* Ortala */
}

button, input, select { /* Form kontrolleri ortak stil */
  font: inherit; /* YazÄ± tipini devral */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  border: 1px solid transparent; /* Kenar */
  padding: 8px 14px; /* Ä°Ã§ boÅŸluk */
  background: var(--card-light); /* Arka plan */
  color: var(--text); /* Metin rengi */
  transition: border-color var(--transition), background var(--transition), transform var(--transition); /* GeÃ§iÅŸler */
}

#addStationBtn, [data-action="add-station"] { /* Ä°stasyon ekle butonu tÄ±klanabilirliÄŸi */
  pointer-events: auto; /* Fare etkileÅŸimini aÃ§ */
  position: relative; /* Ãœst katman konum */
  z-index: 20; /* DiÄŸer katmanlarÄ±n Ã¼stÃ¼nde */
}

header .controls { /* Kontrol satÄ±rÄ±nÄ±n katman dÃ¼zeni */
  position: relative; /* Z-index etkili olsun */
  z-index: 15; /* Ãœste taÅŸÄ± */
}

button:hover, input:focus, select:focus { /* Odak/hover durumu */
  border-color: var(--accent); /* Kenar renklendir */
  outline: none; /* VarsayÄ±lan odak kaldÄ±r */
}

button.primary { /* Ã–ne Ã§Ä±kan buton */
  background: linear-gradient(135deg, var(--accent), var(--accent-strong)); /* Degrade */
  color: #0a1a23; /* Kontrast metin */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

button.danger { /* Silme/durdurma butonu */
  background: rgba(255,107,107,0.16); /* Hafif kÄ±rmÄ±zÄ± */
  color: var(--danger); /* Metin */
}

button:disabled, input:disabled, select:disabled { /* Pasif durum */
  opacity: 0.45; /* Soluk */
  cursor: not-allowed; /* Ä°ÅŸaretÃ§i */
}

main { /* Ana iÃ§erik */
  padding: 24px; /* Ä°Ã§ boÅŸluk */
  display: grid; /* Izgara */
  gap: 24px; /* BÃ¶lÃ¼mler arasÄ± boÅŸluk */
}

.section { /* BÃ¶lÃ¼m kartÄ± */
  background: var(--card); /* Kart fonu */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  padding: 24px; /* Ä°Ã§ boÅŸluk */
  box-shadow: 0 18px 38px rgba(0,0,0,0.28); /* GÃ¶lge */
}

.section h2 { /* BaÅŸlÄ±k stil */
  margin-top: 0; /* Ãœst boÅŸluk kaldÄ±r */
  font-size: 1.2rem; /* YazÄ± boyutu */
  letter-spacing: 0.01em; /* Harf aralÄ±ÄŸÄ± */
}

#stationList { /* Ä°stasyon kartlarÄ± listesi */
  display: grid; /* Izgara dÃ¼zen */
  gap: 16px; /* Kart arasÄ± boÅŸluk */
}

.station-card { /* Her istasyon kartÄ± */
  background: var(--card-light); /* Kart tonu */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  padding: 18px; /* Ä°Ã§ boÅŸluk */
  display: grid; /* Izgara */
  gap: 12px; /* BoÅŸluk */
  position: relative; /* Ä°Ã§ pozisyonlama */
  border: 1px solid rgba(255,255,255,0.05); /* Ä°nce kenar */
}

.station-card.bottleneck { /* DarboÄŸaz vurgusu */
  border-color: rgba(255,107,107,0.6); /* KÄ±rmÄ±zÄ± kenar */
  box-shadow: 0 0 20px rgba(255,107,107,0.25); /* ParÄ±ltÄ± */
}

.station-card.dragging { /* SÃ¼rÃ¼kleme durumu */
  opacity: 0.6; /* ÅeffaflÄ±k */
}

.station-card.drag-over { /* SÃ¼rÃ¼kleme hedefi */
  border-color: var(--accent); /* Vurgu kenarÄ± */
}

.station-header { /* Kart baÅŸlÄ±k satÄ±rÄ± */
  display: flex; /* Yatay */
  justify-content: space-between; /* Aralara yay */
  gap: 12px; /* BoÅŸluk */
  align-items: center; /* Ortala */
}

.station-header input { /* Ä°sim alanÄ± */
  flex: 1; /* GeniÅŸlik */
}

.task-table { /* GÃ¶rev listesi tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* KenarlarÄ± birleÅŸtir */
  color: var(--text); /* Metin */
}

.task-table th, .task-table td { /* HÃ¼cre stili */
  border-bottom: 1px solid rgba(255,255,255,0.06); /* Alt Ã§izgi */
  padding: 6px 4px; /* Ä°Ã§ boÅŸluk */
  text-align: left; /* Hizalama */
  font-size: 0.92rem; /* YazÄ± boyutu */
}

.task-table input { /* HÃ¼cre iÃ§i input */
  width: 100%; /* Tam geniÅŸlik */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
}

.runtime-line { /* CanlÄ± metrik satÄ±rÄ± */
  display: flex; /* Yatay hizalama */
  gap: 8px; /* Eleman arasÄ± boÅŸluk */
  flex-wrap: wrap; /* SatÄ±r kaydÄ±r */
  font-size: 0.82rem; /* KÃ¼Ã§Ã¼k metin */
  color: var(--muted); /* SÃ¶nÃ¼k renk */
}

.runtime-pill { /* Metrik kapsÃ¼lÃ¼ */
  padding: 4px 8px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Yuvarlak */
  background: rgba(255,255,255,0.06); /* Arka plan */
  color: var(--text); /* Metin rengi */
}

.task-actions { /* GÃ¶rev butonlarÄ± satÄ±rÄ± */
  display: flex; /* Yatay */
  justify-content: space-between; /* Alanla */
  margin-top: 6px; /* Ãœst boÅŸluk */
}

#visualPanel { /* GÃ¶rselleÅŸtirme paneli */
  position: relative; /* Ä°Ã§ yerleÅŸim */
  height: 360px; /* Sabit yÃ¼kseklik */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
  background: radial-gradient(circle at top left, rgba(100,210,255,0.08), transparent 60%), var(--card-light); /* Arka plan */
  overflow: hidden; /* TaÅŸmayÄ± gizle */
  border: 1px solid rgba(255,255,255,0.04); /* Ä°nce kenar */
}

#lineSvg { /* SVG alanÄ± */
  width: 100%; /* Tam geniÅŸlik */
  height: 100%; /* Tam yÃ¼kseklik */
  touch-action: none; /* Dokunma kaydÄ±rmasÄ±nÄ± engelle */
  background: transparent; /* Åeffaf arka plan */
}

.zoom-toolbar { /* Zoom denetimi kutusu */
  position: absolute; /* Panel Ã¼zerinde konumla */
  right: 16px; /* SaÄŸa yasla */
  bottom: 16px; /* Alta yasla */
  display: flex; /* Yatay hizala */
  gap: 6px; /* BoÅŸluk bÄ±rak */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
  background: rgba(12, 14, 18, 0.72); /* Saydam arka plan */
  border-radius: 999px; /* Yuvarlak kutu */
  border: 1px solid rgba(255,255,255,0.08); /* Ä°nce kenar */
  backdrop-filter: blur(6px); /* Cam efekti */
}

.zoom-toolbar button { /* Zoom butonlarÄ± */
  background: rgba(255,255,255,0.08); /* Hafif parlaklÄ±k */
  border-radius: 999px; /* Tam yuvarlak */
  border: none; /* Kenar kaldÄ±r */
  padding: 6px 12px; /* Ä°Ã§ boÅŸluk */
  color: var(--text); /* Metin rengi */
  font-weight: 600; /* KalÄ±nlÄ±k */
  cursor: pointer; /* Ä°ÅŸaretÃ§i */
}

.zoom-toolbar button:hover { /* Hover durumu */
  background: rgba(100,210,255,0.25); /* Vurgu */
  color: #0a1a23; /* Kontrast */
}

.zoom-toolbar span { /* Zoom metni */
  pointer-events: none; /* EtkileÅŸimi kapat */
}

.node-layer, .edge-layer, .metric-layer { /* SVG katmanlarÄ± */
  pointer-events: none; /* VarsayÄ±lan etkileÅŸimi kapat */
}

.station-node { /* Ä°stasyon dÃ¼ÄŸÃ¼mÃ¼ */
  pointer-events: all; /* EtkileÅŸimi aÃ§ */
  cursor: grab; /* SÃ¼rÃ¼kleme imleci */
  transition: transform var(--transition); /* GeÃ§iÅŸ efekti */
}

.station-node:active { /* SÃ¼rÃ¼kleme sÄ±rasÄ±nda */
  cursor: grabbing; /* Grabbing imleci */
}

.node-connector-add .connector-circle { /* BaÄŸlantÄ± ekleme dÃ¼ÄŸmesi */
  fill: rgba(100,210,255,0.25); /* VarsayÄ±lan dolgu */
  stroke: rgba(255,255,255,0.28); /* Kenar */
  stroke-width: 1.4; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
  transition: fill var(--transition), stroke var(--transition), transform var(--transition); /* GeÃ§iÅŸ */
}

.node-connector-add:hover .connector-circle { /* Hover durumu */
  fill: rgba(100,210,255,0.55); /* Vurgu dolgu */
  stroke: rgba(255,255,255,0.7); /* KenarÄ± parlat */
}

.connector-plus { /* ArtÄ± iÅŸareti */
  stroke: rgba(8,25,34,0.85); /* Ã‡izgi rengi */
  stroke-width: 2.2; /* Ã‡izgi kalÄ±nlÄ±ÄŸÄ± */
  stroke-linecap: round; /* UÃ§larÄ± yuvarla */
  pointer-events: none; /* EtkileÅŸimi kapat */
}

.edge-group { /* Kenar grubu */
  pointer-events: none; /* VarsayÄ±lan kapalÄ± */
}

.edge-path { /* Kenar Ã§izgisi */
  opacity: 0.88; /* ÅeffaflÄ±k */
  stroke-linecap: round; /* UÃ§larÄ± yuvarla */
  pointer-events: none; /* EtkileÅŸimi kapat */
}

.edge-draft { /* CanlÄ± baÄŸlantÄ± taslak Ã§izgisi */
  stroke: rgba(100,210,255,0.7); /* Taslak Ã§izgi rengi */
  stroke-width: 3; /* Ã‡izgi kalÄ±nlÄ±ÄŸÄ± */
  stroke-dasharray: 10 6; /* Kesikli desen */
  fill: none; /* Dolgu kapalÄ± */
  pointer-events: none; /* EtkileÅŸim alma */
}

.station-node.drafting .station-shape { /* Kaynak dÃ¼ÄŸÃ¼m vurgusu */
  stroke: rgba(143,123,255,0.75); /* Vurgulu kenar */
  stroke-width: 2; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
}

.station-node.draft-target .station-shape { /* Hedef dÃ¼ÄŸÃ¼m vurgusu */
  stroke: rgba(100,210,255,0.85); /* Hedef kenar rengi */
  stroke-width: 2; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
  filter: drop-shadow(0 0 18px rgba(100,210,255,0.45)); /* Parlama efekti */
}

.edge-label { /* Kenar etiketi */
  fill: rgba(255,255,255,0.68); /* Metin rengi */
  font-size: 0.72rem; /* YazÄ± boyutu */
  pointer-events: none; /* EtkileÅŸimi kapat */
  text-shadow: 0 2px 6px rgba(0,0,0,0.6); /* GÃ¶lge */
}

.edge-remove { /* Kenar silme iÅŸareti */
  fill: rgba(255,255,255,0.82); /* Metin rengi */
  font-size: 1rem; /* YazÄ± boyutu */
  pointer-events: all; /* EtkileÅŸime izin ver */
  cursor: pointer; /* El imleci */
  text-shadow: 0 2px 6px rgba(0,0,0,0.65); /* GÃ¶lge */
  transition: transform var(--transition), fill var(--transition); /* GeÃ§iÅŸ */
}

.edge-remove:hover { /* Hover durumda */
  fill: var(--danger); /* Rengi kÄ±rmÄ±zÄ± yap */
  transform: scale(1.12); /* Hafif bÃ¼yÃ¼t */
}

.fork-indicator { /* Fork simgesi */
  stroke: var(--accent); /* Ã‡izgi rengi */
  stroke-width: 2; /* KalÄ±nlÄ±k */
  fill: none; /* Dolgu yok */
  opacity: 0.9; /* ÅeffaflÄ±k */
  filter: drop-shadow(0 2px 6px rgba(0,0,0,0.4)); /* GÃ¶lge */
  display: none; /* VarsayÄ±lan gizli */
}

.fork-node .station-shape { /* Fork dÃ¼ÄŸÃ¼mÃ¼ vurgusu */
  stroke: rgba(100,210,255,0.45); /* KenarÄ± vurgula */
  stroke-width: 1.6; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
}

.fork-node .fork-indicator { /* Fork simgesi gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ */
  display: block; /* GÃ¶ster */
}

.graph-toast { /* GÃ¶rsel bildirim kutusu */
  position: absolute; /* KonumlandÄ±rma */
  left: 50%; /* Yatay ortala */
  bottom: 18px; /* Alt boÅŸluk */
  transform: translateX(-50%); /* Ortala */
  background: rgba(18,22,28,0.88); /* Arka plan */
  color: rgba(255,255,255,0.9); /* Metin */
  padding: 10px 18px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Yuvarlat */
  font-size: 0.82rem; /* YazÄ± boyutu */
  box-shadow: 0 10px 24px rgba(0,0,0,0.35); /* GÃ¶lge */
  backdrop-filter: blur(8px); /* Cam efekti */
  opacity: 0; /* BaÅŸlangÄ±Ã§ta gizli */
  pointer-events: none; /* EtkileÅŸim yok */
  transition: opacity 200ms ease; /* GeÃ§iÅŸ */
  z-index: 70; /* Ãœst katman */
}

.graph-toast.success { /* BaÅŸarÄ±lÄ± ton */
  background: rgba(46, 204, 113, 0.85); /* YeÅŸil arka plan */
  color: #041b0c; /* Metin rengi */
}

.graph-toast.warning { /* UyarÄ± tonu */
  background: rgba(255, 196, 0, 0.85); /* SarÄ± arka plan */
  color: #2d2300; /* Metin */
}

.graph-toast.error { /* Hata tonu */
  background: rgba(255, 107, 107, 0.88); /* KÄ±rmÄ±zÄ± arka plan */
  color: #220505; /* Metin */
}

.save-layout-btn { /* YerleÅŸim kaydet butonu */
  position: absolute; /* Sabit konum */
  top: 16px; /* Ãœst boÅŸluk */
  right: 16px; /* SaÄŸ boÅŸluk */
  background: linear-gradient(135deg, rgba(100,210,255,0.95), rgba(143,123,255,0.95)); /* Degrade arka plan */
  color: #071821; /* Metin rengi */
  border: none; /* KenarsÄ±z */
  border-radius: 999px; /* Tam yuvarlat */
  padding: 9px 20px; /* Ä°Ã§ boÅŸluk */
  font-weight: 600; /* KalÄ±nlÄ±k */
  box-shadow: 0 14px 32px rgba(0,0,0,0.35); /* GÃ¶lge */
  transition: transform var(--transition), box-shadow var(--transition), filter var(--transition); /* GeÃ§iÅŸler */
  cursor: pointer; /* Ä°mleÃ§ */
  z-index: 40; /* Ãœst katman */
}

.save-layout-btn:hover:not(:disabled) { /* Hover etkisi */
  transform: translateY(-2px); /* Hafif yÃ¼kselt */
  filter: brightness(1.08); /* ParlaklÄ±k artÄ±r */
}

.save-layout-btn:disabled { /* Pasif durum */
  opacity: 0.45; /* SoluklaÅŸtÄ±r */
  cursor: not-allowed; /* Ä°mleÃ§ */
}

.layout-toolbar { /* YerleÅŸim araÃ§ Ã§ubuÄŸu */
  position: absolute; /* Panel Ã¼zerinde konumla */
  left: 16px; /* Sol boÅŸluk */
  bottom: 16px; /* Alt boÅŸluk */
  display: flex; /* Esnek hizalama */
  flex-wrap: wrap; /* SatÄ±r kÄ±r */
  gap: 8px; /* BoÅŸluk */
  padding: 8px 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 14px; /* KÃ¶ÅŸe yuvarla */
  background: rgba(12, 16, 22, 0.78); /* Saydam panel */
  border: 1px solid rgba(255,255,255,0.12); /* Ä°nce kenar */
  box-shadow: 0 18px 34px rgba(0,0,0,0.45); /* GÃ¶lge */
  z-index: 50; /* Katman */
}

.layout-toolbar button { /* AraÃ§ Ã§ubuÄŸu butonu */
  padding: 7px 14px; /* Ä°Ã§ boÅŸluk */
  border-radius: 10px; /* KÃ¶ÅŸe yuvarla */
  background: rgba(255,255,255,0.08); /* Saydam arka plan */
  border: 1px solid rgba(255,255,255,0.18); /* Kenar */
  color: var(--text); /* Metin rengi */
  font-weight: 500; /* KalÄ±nlÄ±k */
  cursor: pointer; /* Ä°mleÃ§ */
  transition: background var(--transition), border-color var(--transition), transform var(--transition); /* GeÃ§iÅŸler */
}

.layout-toolbar button:hover { /* Hover durumu */
  background: rgba(100,210,255,0.25); /* ParlaklaÅŸtÄ±r */
  border-color: rgba(100,210,255,0.65); /* KenarÄ± vurgula */
  transform: translateY(-1px); /* Hafif kaldÄ±r */
}

.layout-toolbar button[data-active="true"] { /* Aktif durumda buton */
  background: linear-gradient(135deg, rgba(100,210,255,0.9), rgba(143,123,255,0.9)); /* Degrade arka plan */
  color: #081822; /* Kontrast metin */
  border-color: transparent; /* KenarÄ± kaldÄ±r */
  box-shadow: 0 10px 24px rgba(0,0,0,0.35); /* GÃ¶lge */
}

body[data-edit-mode="view"] .layout-toolbar [data-edit-only="true"] { /* GÃ¶rÃ¼ntÃ¼le modunda gizlenecekler */
  display: none; /* Gizle */
}

body[data-edit-mode="view"] .layout-toolbar { /* GÃ¶rÃ¼ntÃ¼le modunda araÃ§ Ã§ubuÄŸu */
  background: rgba(12, 16, 22, 0.6); /* Daha hafif fon */
}

.mode-toggle { /* Mod geÃ§iÅŸ kapsayÄ±cÄ± */
  display: inline-flex; /* Yatay dÃ¼zen */
  border-radius: 999px; /* Tam yuvarlak */
  overflow: hidden; /* SÄ±nÄ±rla */
  border: 1px solid rgba(255,255,255,0.12); /* Ä°nce kenar */
  background: rgba(18, 20, 26, 0.8); /* Arka plan */
}

.mode-toggle button { /* Mod butonu */
  border: none; /* Kenar yok */
  background: transparent; /* Åeffaf arka plan */
  color: var(--muted); /* SÃ¶nÃ¼k metin */
  padding: 8px 16px; /* Ä°Ã§ boÅŸluk */
  font-weight: 600; /* KalÄ±nlÄ±k */
  cursor: pointer; /* Ä°mleÃ§ */
  transition: background var(--transition), color var(--transition); /* GeÃ§iÅŸler */
}

.mode-toggle button[data-active="true"] { /* Aktif mod */
  background: linear-gradient(135deg, rgba(100,210,255,0.9), rgba(143,123,255,0.9)); /* Degrade */
  color: #071a23; /* Kontrast */
}

.mode-toggle button:disabled { /* Kilitli mod butonu */
  opacity: 0.4; /* SoluklaÅŸtÄ±r */
  cursor: not-allowed; /* Ä°mleÃ§ deÄŸiÅŸtir */
}

.station-shape { /* SVG istasyon kutusu */
  fill: rgba(255,255,255,0.05); /* Dolgu */
  stroke: rgba(255,255,255,0.1); /* Kenar */
  stroke-width: 2; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
}

.station-shape.bottleneck { /* DarboÄŸaz vurgusu */
  stroke: var(--danger); /* KÄ±rmÄ±zÄ± kenar */
  fill: rgba(255,107,107,0.18); /* KÄ±rmÄ±zÄ±msÄ± dolgu */
}

.station-label { /* SVG istasyon etiketi */
  fill: var(--text); /* YazÄ± rengi */
  font-size: 13px; /* YazÄ± boyutu */
  font-weight: 600; /* KalÄ±n */
}

.metric-tag { /* CanlÄ± metrik etiketi */
  fill: var(--muted); /* Renk */
  font-size: 11px; /* Boyut */
}

.metric-tag.danger { /* Kritik metrik etiketi */
  fill: var(--danger); /* KÄ±rmÄ±zÄ± renk */
  font-weight: 600; /* KalÄ±n */
}

.job-bubble { /* Ä°ÅŸ baloncuÄŸu */
  fill: var(--accent); /* Dolgu */
  stroke: rgba(10,30,40,0.8); /* Kenar */
  stroke-width: 1.5; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.35)); /* GÃ¶lge */
}

.job-bubble.processing { /* Ä°ÅŸlenen balon */
  fill: #ffd86b; /* FarklÄ± ton */
}

.job-bubble.waiting { /* Kuyruk balonu */
  fill: #8895ff; /* Mor ton */
}

.job-bubble.completed { /* Tamamlanan balon */
  fill: #64ff8f; /* YeÅŸil */
}

#emptyState { /* BoÅŸ durum mesajÄ± */
  color: var(--muted); /* SÃ¶nÃ¼k metin */
  text-align: center; /* Ortala */
  padding: 28px; /* Ä°Ã§ boÅŸluk */
  border: 1px dashed rgba(255,255,255,0.08); /* Kesik kenar */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
}

.badge { /* KÃ¼Ã§Ã¼k rozetler */
  display: inline-flex; /* Yatay */
  align-items: center; /* Ortala */
  gap: 6px; /* BoÅŸluk */
  font-size: 0.85rem; /* Boyut */
  padding: 4px 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Tam yuvarlak */
  background: rgba(100,210,255,0.12); /* Arka plan */
}

.hud-badge { /* Ãœst Ã§ubuk rozeti */
  font-weight: 600; /* KalÄ±n metin */
  background: rgba(100,210,255,0.2); /* Daha belirgin arka plan */
  border: 1px solid rgba(100,210,255,0.35); /* Ä°nce kenar */
}

.badge.danger { /* KÄ±rmÄ±zÄ± rozet */
  background: rgba(255,107,107,0.15); /* Arka plan */
  color: var(--danger); /* Metin */
}

.fullscreen-btn { /* Tam ekran butonu */
  position: absolute; /* KonumlandÄ±r */
  top: 12px; /* Ãœst boÅŸluk */
  right: 12px; /* SaÄŸ boÅŸluk */
  background: rgba(0,0,0,0.45); /* YarÄ± saydam arka plan */
  color: #fff; /* Metin rengi */
  border: 1px solid rgba(255,255,255,0.25); /* Ä°nce kenar */
  padding: 6px 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸe */
  cursor: pointer; /* Ä°mleÃ§ */
  display: flex; /* Ä°Ã§ hizalama */
  align-items: center; /* Dikey hizalama */
  gap: 6px; /* AralÄ±k */
  z-index: 11; /* Ãœste taÅŸÄ± */
}

.fullscreen-btn span { /* Buton metni */
  font-size: 0.85rem; /* YazÄ± boyutu */
}

.modal-backdrop { /* Modal arka planÄ± */
  position: fixed; /* Sabit */
  inset: 0; /* TÃ¼m ekran */
  background: rgba(0,0,0,0.6); /* Saydam siyah */
  display: none; /* VarsayÄ±lan gizli */
  align-items: center; /* Dikey ortalama */
  justify-content: center; /* Yatay ortalama */
  z-index: 20; /* Ãœste taÅŸÄ±r */
}

.modal-backdrop.active { /* Aktif modal */
  display: flex; /* GÃ¶ster */
}

.modal { /* Modal kutusu */
  background: var(--card-light); /* Arka plan */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
  padding: 24px 28px; /* Ä°Ã§ boÅŸluk */
  width: min(900px, 92vw); /* Maks geniÅŸlik */
  max-height: 90vh; /* Maks yÃ¼kseklik */
  overflow: auto; /* KaydÄ±r */
  box-shadow: 0 24px 60px rgba(0,0,0,0.45); /* GÃ¶lge */
}

.modal h3 { /* Modal baÅŸlÄ±ÄŸÄ± */
  margin-top: 0; /* Ãœst boÅŸluk kaldÄ±r */
}

.modal-actions { /* Modal buton grubu */
  display: flex; /* Yatay hizala */
  justify-content: flex-end; /* SaÄŸa yasla */
  gap: 12px; /* BoÅŸluk */
  margin-top: 18px; /* Ãœst boÅŸluk */
}


.dashboard-header { /* Dashboard baÅŸlÄ±k alanÄ± */
  display: flex; /* Yatay hizala */
  justify-content: space-between; /* DaÄŸÄ±t */
  align-items: center; /* Dikey hizala */
  gap: 12px; /* AralÄ±k */
  margin-bottom: 12px; /* Alt boÅŸluk */
}

.dashboard-grid { /* Dashboard ana Ä±zgara */
  display: grid; /* Izgara */
  gap: 18px; /* AralÄ±k */
}

.summary-cards { /* Ã–zet kart grubu */
  display: grid; /* Izgara */
  gap: 16px; /* AralÄ±k */
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Uyarlanabilir sÃ¼tun */
}

.summary-card { /* Ã–zet kart */
  background: rgba(255,255,255,0.04); /* Saydam arka plan */
  border: 1px solid rgba(255,255,255,0.08); /* Kenar */
  border-radius: 16px; /* KÃ¶ÅŸe */
  padding: 16px; /* Ä°Ã§ boÅŸluk */
  display: flex; /* Ä°Ã§ hizalama */
  flex-direction: column; /* Dikey yerleÅŸim */
  gap: 6px; /* AralÄ±k */
}

.summary-card h4 { /* Kart baÅŸlÄ±ÄŸÄ± */
  margin: 0; /* BoÅŸluk kaldÄ±r */
  font-size: 0.95rem; /* YazÄ± boyutu */
  color: var(--muted); /* SÃ¶nÃ¼k ton */
}

.summary-card strong { /* Kart deÄŸeri */
  font-size: 1.4rem; /* BÃ¼yÃ¼k metin */
  font-weight: 700; /* KalÄ±n */
}

.dashboard-section { /* Dashboard bÃ¶lÃ¼mÃ¼ */
  background: rgba(0,0,0,0.25); /* Arka plan */
  border: 1px solid rgba(255,255,255,0.08); /* Kenar */
  border-radius: 18px; /* KÃ¶ÅŸe */
  padding: 18px; /* Ä°Ã§ boÅŸluk */
}

.dashboard-section h4 { /* BÃ¶lÃ¼m baÅŸlÄ±ÄŸÄ± */
  margin-top: 0; /* Ãœst boÅŸluk yok */
}

.dashboard-table { /* Dashboard tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* Kenar birleÅŸtir */
  font-size: 0.9rem; /* YazÄ± boyutu */
}

.dashboard-table th, .dashboard-table td { /* HÃ¼creler */
  border-bottom: 1px solid rgba(255,255,255,0.08); /* Alt Ã§izgi */
  padding: 8px 6px; /* Ä°Ã§ boÅŸluk */
  text-align: left; /* Hizalama */
}

.dashboard-table th { /* BaÅŸlÄ±k */
  color: var(--muted); /* SÃ¶nÃ¼k */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

.chart-card { /* Grafik kapsayÄ±cÄ± */
  display: grid; /* Izgara */
  gap: 12px; /* AralÄ±k */
}

.chart-wrapper { /* Grafik alanÄ± */
  position: relative; /* GÃ¶receli */
  width: 100%; /* Tam geniÅŸlik */
  height: 220px; /* Sabit yÃ¼kseklik */
  min-height: 220px; /* Minimum yÃ¼kseklik */
}

.chart-canvas { /* Grafik canvas */
  display: block; /* Blok eleman */
  width: 100%; /* Tam geniÅŸlik */
  max-width: 100%; /* TaÅŸmayÄ± engelle */
  height: 100%; /* Tam yÃ¼kseklik */
  background: rgba(255,255,255,0.03); /* Hafif arka plan */
  border-radius: 12px; /* KÃ¶ÅŸe */
  border: 1px solid rgba(255,255,255,0.06); /* Ä°nce kenar */
}

.analysis-panel { /* Dashboard analiz paneli */
  display: grid; /* Izgara */
  gap: 10px; /* AralÄ±k */
}

.analysis-panel p { /* Analiz paragrafÄ± */
  margin: 0; /* BoÅŸluk yok */
  line-height: 1.6; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.analysis-panel ul { /* Analiz listesi */
  margin: 0; /* Ãœst-alt yok */
  padding-left: 18px; /* Sol boÅŸluk */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.analysis-form { /* Analiz form satÄ±rÄ± */
  display: flex; /* Yatay hizala */
  gap: 16px; /* AralÄ±k */
  align-items: flex-end; /* Alt hizala */
  margin-bottom: 12px; /* Alt boÅŸluk */
}

.analysis-section { /* Analiz bloklarÄ± */
  margin-top: 18px; /* Ãœst boÅŸluk */
}

.analysis-table { /* Analiz tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* KenarlarÄ± birleÅŸtir */
}

.analysis-table th, .analysis-table td { /* Analiz hÃ¼creleri */
  border-bottom: 1px solid rgba(255,255,255,0.08); /* Alt Ã§izgi */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
  font-size: 0.88rem; /* YazÄ± boyutu */
}

.analysis-table th { /* Analiz baÅŸlÄ±klarÄ± */
  color: var(--muted); /* SÃ¶nÃ¼k renk */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

.analysis-text { /* Analiz aÃ§Ä±klama metni */
  margin: 0; /* BoÅŸluk kaldÄ±r */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.analysis-list { /* What-if listesi */
  margin: 8px 0 0 0; /* BoÅŸluklar */
  padding-left: 18px; /* Liste iÃ§ boÅŸluk */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

footer { /* Alt bilgi */
  margin-top: 24px; /* Ãœst boÅŸluk */
  padding: 24px 32px; /* Ä°Ã§ boÅŸluk */
  background: rgba(17,19,22,0.72); /* Arka plan */
  border-top: 1px solid rgba(255,255,255,0.08); /* Ãœst kenar */
}

.footer-content { /* Footer iÃ§ dÃ¼zeni */
  display: flex; /* Yatay hizala */
  flex-wrap: wrap; /* SatÄ±r kÄ±r */
  align-items: center; /* Dikey ortala */
  justify-content: space-between; /* AlanÄ± yay */
  gap: 16px; /* Eleman boÅŸluÄŸu */
}

.footer-brand { /* Kurumsal bilgi */
  font-family: 'Poppins', 'Segoe UI', sans-serif; /* YazÄ± tipi */
  font-weight: 600; /* KalÄ±nlÄ±k */
  letter-spacing: 0.08em; /* Harf aralÄ±ÄŸÄ± */
  text-transform: uppercase; /* BÃ¼yÃ¼k harf */
  color: rgba(255,255,255,0.88); /* Metin rengi */
}

.footer-hints { /* KÄ±sayol bilgisi */
  color: var(--muted); /* SÃ¶nÃ¼k metin */
  font-size: 0.9rem; /* YazÄ± boyutu */
}

.footer-signature { /* Ä°mza metni */
  font-family: 'Poppins', 'Segoe UI', sans-serif; /* YazÄ± tipi */
  font-weight: 600; /* KalÄ±nlÄ±k */
  letter-spacing: 0.08em; /* Harf aralÄ±ÄŸÄ± */
  text-transform: uppercase; /* BÃ¼yÃ¼k harf */
  color: rgba(255,255,255,0.88); /* Metin rengi */
}

.footer-meta { /* SaÄŸ taraftaki meta */
  display: flex; /* Yatay hizala */
  gap: 12px; /* BoÅŸluk */
  align-items: center; /* Dikey ortala */
  color: rgba(255,255,255,0.68); /* Metin rengi */
  font-size: 0.9rem; /* YazÄ± boyutu */
}

input[type="number"]::-webkit-inner-spin-button { /* Spin butonlarÄ±nÄ± gizle */
  opacity: 0; /* GÃ¶rÃ¼nmez */
}

input[type="range"] { /* Slider stili */
  width: 220px; /* GeniÅŸlik */
  -webkit-appearance: none; /* Safari uyumu */
  background: transparent; /* Arka plan */
}

input[type="range"]::-webkit-slider-runnable-track { /* Slider yolu */
  height: 6px; /* YÃ¼kseklik */
  background: rgba(255,255,255,0.18); /* Arka plan */
  border-radius: 999px; /* Tam yuvarlak */
}

input[type="range"]::-webkit-slider-thumb { /* Slider tutamaÄŸÄ± */
  -webkit-appearance: none; /* Safari uyumu */
  width: 16px; /* GeniÅŸlik */
  height: 16px; /* YÃ¼kseklik */
  border-radius: 50%; /* Yuvarlak */
  background: var(--accent); /* Renk */
  margin-top: -5px; /* Hizalama */
}

input[type="range"]::-moz-range-thumb { /* Firefox tutamak */
  width: 16px; /* GeniÅŸlik */
  height: 16px; /* YÃ¼kseklik */
  border-radius: 50%; /* Yuvarlak */
  background: var(--accent); /* Renk */
}

@media (max-width: 960px) { /* Mobil uyum */
  header .controls { /* Kontroller */
    flex-direction: column; /* Dikey sÄ±rala */
    align-items: stretch; /* GeniÅŸlet */
  }
  input[type="range"] { /* Slider */
    width: 100%; /* Tam geniÅŸlik */
  }
}
</style> <!-- Stil bitiÅŸi -->
</head>
<body> <!-- GÃ¶vde baÅŸlangÄ±cÄ± -->
<header> <!-- Ãœst Ã§ubuk -->
  <div class="tab-bar" id="tabBar" role="tablist" aria-label="Senaryo sekmeleri"> <!-- Sekme Ã§ubuÄŸu -->
    <button id="newTabBtn" type="button" class="new-tab-btn" data-i18n="tabs.new" data-i18n-title="title.newTab" title="Yeni sekme aÃ§">+ Yeni Sekme</button> <!-- Yeni sekme -->
  </div>
  <div class="controls"> <!-- Kontrol satÄ±rlarÄ± -->
    <div class="toolbar-row"> <!-- Ãœst satÄ±r -->
      <div class="toolbar-dropdown" data-menu="simulation"> <!-- SimÃ¼lasyon menÃ¼sÃ¼ -->
        <button id="simulationMenuBtn" type="button" class="dropdown-toggle" data-i18n="toolbar.simulationMenu" data-i18n-title="title.simulationMenu" title="SimÃ¼lasyon iÅŸlemleri" aria-haspopup="true" aria-expanded="false">âš™ï¸ SimÃ¼lasyon â–¾</button> <!-- SimÃ¼lasyon tetikleyici -->
        <div class="dropdown-menu" id="simulationMenu" role="menu" aria-label="SimÃ¼lasyon kontrolleri"> <!-- SimÃ¼lasyon menÃ¼sÃ¼ -->
          <button id="startBtn" type="button" class="primary" data-i18n="toolbar.start" data-i18n-title="title.start" title="SimÃ¼lasyonu baÅŸlat (B)">BaÅŸlat</button> <!-- BaÅŸlat -->
          <button id="stopBtn" type="button" class="danger" data-i18n="toolbar.stop" data-i18n-title="title.stop" title="SimÃ¼lasyonu durdur (D)" disabled>Durdur</button> <!-- Durdur -->
          <button id="resetBtn" type="button" data-i18n="toolbar.reset" data-i18n-title="title.reset" title="SimÃ¼lasyonu sÄ±fÄ±rla (R)">SÄ±fÄ±rla</button> <!-- SÄ±fÄ±rla -->
          <button id="clearBtn" type="button" data-i18n="toolbar.clear" data-i18n-title="title.clear" title="Aktif sekmeyi temizle">Temizle</button> <!-- Temizle -->
        </div>
      </div>
      <div class="toolbar-dropdown" data-menu="view"> <!-- GÃ¶rÃ¼nÃ¼m menÃ¼sÃ¼ -->
        <button id="viewMenuBtn" type="button" class="dropdown-toggle" data-i18n="toolbar.viewMenu" data-i18n-title="title.viewMenu" title="GÃ¶rÃ¼nÃ¼m ve dil ayarlarÄ±" aria-haspopup="true" aria-expanded="false">ğŸ–¥ï¸ GÃ¶rÃ¼nÃ¼m â–¾</button> <!-- GÃ¶rÃ¼nÃ¼m tetikleyici -->
        <div class="dropdown-menu" id="viewMenu" role="menu" aria-label="GÃ¶rÃ¼nÃ¼m kontrolleri"> <!-- GÃ¶rÃ¼nÃ¼m menÃ¼sÃ¼ -->
          <button id="fullscreenBtn" type="button" class="fullscreen-btn" data-i18n-title="title.fullscreen" title="SimÃ¼lasyon alanÄ±nÄ± tam ekran yap"><span data-i18n="toolbar.fullscreen">ğŸ”³ Tam Ekran</span></button> <!-- Tam ekran -->
          <div class="dropdown-inline-group" role="group" aria-label="Zoom"> <!-- MenÃ¼ iÃ§i zoom -->
            <button id="viewZoomOutBtn" type="button" data-i18n-title="title.zoomOut" title="GÃ¶rÃ¼nÃ¼mÃ¼ kÃ¼Ã§Ã¼lt">âˆ’</button> <!-- Zoom azalt -->
            <button id="viewZoomResetBtn" type="button" data-i18n-title="title.zoomReset" title="Ã–lÃ§eÄŸi 100% yap">100%</button> <!-- Zoom sÄ±fÄ±rla -->
            <button id="viewZoomInBtn" type="button" data-i18n-title="title.zoomIn" title="GÃ¶rÃ¼nÃ¼mÃ¼ bÃ¼yÃ¼t">+</button> <!-- Zoom artÄ±r -->
            <span data-role="zoom-value">100%</span> <!-- Zoom gÃ¶stergesi -->
          </div>
          <div class="dropdown-section" role="group" aria-label="Dil seÃ§enekleri"> <!-- Dil bÃ¶lÃ¼mÃ¼ -->
            <div class="dropdown-section-header" data-i18n="toolbar.languageLabel">Dil</div> <!-- Dil baÅŸlÄ±ÄŸÄ± -->
            <div class="dropdown-inline-group" data-role="language-options"> <!-- Dil butonlarÄ± grubu -->
              <button type="button" data-lang="tr">TÃ¼rkÃ§e</button> <!-- TÃ¼rkÃ§e -->
              <button type="button" data-lang="en">English</button> <!-- Ä°ngilizce -->
              <button type="button" data-lang="de">Deutsch</button> <!-- Almanca -->
            </div>
          </div>
        </div>
      </div>
      <div class="toolbar-dropdown" data-menu="storage"> <!-- KayÄ±t menÃ¼sÃ¼ -->
        <button id="storageMenuBtn" type="button" class="dropdown-toggle" data-i18n="toolbar.storageMenu" data-i18n-title="title.storageMenu" title="KayÄ±t ve sekme iÅŸlemleri" aria-haspopup="true" aria-expanded="false">ğŸ’¾ KayÄ±t/Sekmeler â–¾</button> <!-- KayÄ±t tetikleyici -->
        <div class="dropdown-menu" id="storageMenu" role="menu" aria-label="KayÄ±t ve sekme yÃ¶netimi"> <!-- KayÄ±t menÃ¼sÃ¼ -->
          <button id="saveScenarioBtn" type="button" data-i18n="toolbar.save" data-i18n-title="title.save" title="GeÃ§erli sekmeyi kaydet">Kaydet</button> <!-- Kaydet -->
          <div class="dropdown-section" aria-live="polite"> <!-- YÃ¼kleme bÃ¶lÃ¼mÃ¼ -->
            <div class="dropdown-section-header" data-i18n="toolbar.loadList">YÃ¼kle</div> <!-- YÃ¼kle baÅŸlÄ±ÄŸÄ± -->
            <div id="loadMenuList" class="dropdown-list" role="menu"></div> <!-- Senaryo listesi -->
          </div>
          <div class="dropdown-divider"></div> <!-- AyÄ±rÄ±cÄ± -->
          <button id="newTabToolbarBtn" type="button" data-i18n="toolbar.newTab" data-i18n-title="title.newTab" title="Yeni sekme aÃ§">Yeni Sekme</button> <!-- Yeni sekme -->
          <button id="closeTabBtn" type="button" data-i18n="toolbar.closeTab" data-i18n-title="title.closeTab" title="Aktif sekmeyi kapat">Sekmeyi Kapat</button> <!-- Sekme kapat -->
        </div>
      </div>
      <div class="toolbar-dropdown" data-menu="other"> <!-- DiÄŸer menÃ¼sÃ¼ -->
        <button id="otherMenuBtn" type="button" class="dropdown-toggle" data-i18n="toolbar.other" data-i18n-title="title.other" title="DiÄŸer araÃ§lar" aria-haspopup="true" aria-expanded="false">DiÄŸer â–¾</button> <!-- DiÄŸer tetikleyici -->
        <div class="dropdown-menu" id="otherMenu" role="menu" aria-label="DiÄŸer iÅŸlemler"> <!-- DiÄŸer menÃ¼ -->
          <button id="analysisBtn" type="button" data-i18n="menu.analysis" data-i18n-title="title.analysis" title="Analiz ve Ã¶nerileri aÃ§">Analiz/Ã–neri</button> <!-- Analiz -->
          <button id="resultsBtn" type="button" data-i18n="menu.results" data-i18n-title="title.results" title="SimÃ¼lasyon sonuÃ§larÄ±nÄ± aÃ§">SonuÃ§larÄ± GÃ¶r</button> <!-- SonuÃ§ -->
          <button id="sampleSetupBtn" type="button" data-i18n="menu.sample" data-i18n-title="title.sample" title="Ã–rnek kurulum yÃ¼kle">Ã–rnek Kurulum</button> <!-- Ã–rnek -->
        </div>
      </div>
    </div>
    <div class="toolbar-row"> <!-- Alt satÄ±r -->
      <div class="control-group" data-group="model"> <!-- Modelleme -->
        <button id="addStationBtn" type="button" class="primary" data-i18n="toolbar.addStation" data-i18n-title="title.addStation" title="Yeni istasyon ekle">+ Ä°stasyon Ekle</button> <!-- Ä°stasyon ekle -->
      </div>
      <div class="control-group" data-group="mode"> <!-- Mod seÃ§imi -->
        <div class="mode-toggle" role="group" aria-label="DÃ¼zenleme modu"> <!-- Mod toggle -->
          <button id="viewModeBtn" type="button" data-active="true" data-i18n="mode.view" data-i18n-title="title.modeView" title="GÃ¶rÃ¼ntÃ¼leme moduna geÃ§">GÃ¶rÃ¼ntÃ¼le</button> <!-- GÃ¶rÃ¼ntÃ¼le -->
          <button id="editModeBtn" type="button" data-i18n="mode.edit" data-i18n-title="title.modeEdit" title="YerleÅŸimi dÃ¼zenle">DÃ¼zenle</button> <!-- DÃ¼zenle -->
        </div>
      </div>
      <div class="control-group" data-group="speed"> <!-- HÄ±z kontrolÃ¼ -->
        <label for="speedSlider" data-i18n="toolbar.speed" data-i18n-title="title.speed" title="Animasyon hÄ±zÄ±nÄ± ayarla">HÄ±z</label> <!-- HÄ±z etiketi -->
        <input id="speedSlider" type="range" min="0.25" max="16" step="0.25" value="1" data-i18n-title="title.speed" title="Animasyon hÄ±zÄ±nÄ± ayarla"> <!-- Slider -->
        <span id="speedValue" class="badge">1Ã—</span> <!-- HÄ±z gÃ¶stergesi -->
      </div>
      <div class="control-group" data-group="target"> <!-- Hedef kontrolÃ¼ -->
        <label for="targetInput" data-i18n="toolbar.target" data-i18n-title="title.target" title="Hedef tamamlanacak Ã¼rÃ¼n adedi">Hedef adet</label> <!-- Hedef etiketi -->
        <input id="targetInput" type="number" min="1" placeholder="sonsuz" data-i18n-placeholder="toolbar.target" data-i18n-title="title.target" title="Hedef tamamlanacak Ã¼rÃ¼n adedi"> <!-- Hedef giriÅŸi -->
      </div>
      <div class="control-group" data-group="entry"> <!-- GiriÅŸ politikasÄ± -->
        <label for="entryPolicySelect" data-i18n="toolbar.entry" data-i18n-title="title.entry" title="GiriÅŸ politikasÄ±">GiriÅŸ</label> <!-- GiriÅŸ etiketi -->
        <select id="entryPolicySelect"> <!-- Politika seÃ§imi -->
          <option value="trigger" data-i18n="entry.trigger">ÃœrÃ¼n, tamamlandÄ±kÃ§a girsin</option> <!-- SeÃ§enek 1 -->
          <option value="interval" data-i18n="entry.interval">Sabit giriÅŸ aralÄ±ÄŸÄ±</option> <!-- SeÃ§enek 2 -->
        </select>
        <input id="entryIntervalInput" type="number" min="1" value="30" style="width:120px;display:none;" placeholder="sn" data-i18n-title="title.entry" title="GiriÅŸ politikasÄ±"> <!-- AralÄ±k giriÅŸi -->
      </div>
      <span id="completedCounter" class="badge hud-badge" aria-live="polite">Tamamlanan: 0</span> <!-- Tamamlanan sayaÃ§ -->
    </div>
  </div>
</header>
<main> <!-- Ana iÃ§erik -->
  <section class="section" aria-labelledby="stationsTitle"> <!-- Ä°stasyonlar bÃ¶lÃ¼mÃ¼ -->
    <h2 id="stationsTitle">Ä°stasyonlar</h2> <!-- BaÅŸlÄ±k -->
    <p id="emptyState">Ä°stasyon ekleyin veya <strong>Ã–rnek Kurulum</strong> butonunu kullanÄ±n.</p> <!-- BoÅŸ durum -->
    <div id="stationList" aria-live="polite"></div> <!-- Kart listesi -->
  </section>
  <section class="section" aria-labelledby="vizTitle"> <!-- GÃ¶rselleÅŸtirme bÃ¶lÃ¼mÃ¼ -->
    <h2 id="vizTitle">Hat AkÄ±ÅŸÄ±</h2> <!-- BaÅŸlÄ±k -->
    <div id="visualPanel"> <!-- GÃ¶rsel panel -->
      <button id="saveLayoutBtn" type="button" class="save-layout-btn" title="GeÃ§erli yerleÅŸimi kaydet">YerleÅŸimi Kaydet</button> <!-- YerleÅŸim kaydet butonu -->
      <div class="layout-toolbar" role="group" aria-label="YerleÅŸim araÃ§larÄ±">
        <button id="centerLayoutBtn" type="button" title="GÃ¶rÃ¼nÃ¼mÃ¼ merkeze getir">Merkeze Topla</button>
        <button id="resetLayoutBtn" type="button" data-edit-only="true" title="YerleÅŸimi varsayÄ±lana dÃ¶ndÃ¼r">YerleÅŸimi SÄ±fÄ±rla</button>
        <button id="normalizeLayoutBtn" type="button" data-edit-only="true" title="TransformlarÄ± yeniden hizala">DÃ¼zeni Onar</button>
        <button id="refreshBubblesBtn" type="button" title="Baloncuk konumlarÄ±nÄ± yenile">BaloncuklarÄ± Yenile</button>
      </div>
      <div class="zoom-toolbar" id="viewportZoom" role="group" aria-label="YakÄ±nlaÅŸtÄ±rma paneli"> <!-- Zoom paneli -->
        <button id="zoomOutBtn" type="button" data-i18n-title="title.zoomOut" title="GÃ¶rÃ¼nÃ¼mÃ¼ kÃ¼Ã§Ã¼lt">âˆ’</button> <!-- Zoom azalt -->
        <button id="zoomResetBtn" type="button" data-i18n-title="title.zoomReset" title="Ã–lÃ§eÄŸi 100% yap"><span id="zoomValue" data-role="zoom-value">100%</span></button> <!-- Zoom sÄ±fÄ±rla -->
        <button id="zoomInBtn" type="button" data-i18n-title="title.zoomIn" title="GÃ¶rÃ¼nÃ¼mÃ¼ bÃ¼yÃ¼t">+</button> <!-- Zoom artÄ±r -->
      </div>
      <svg id="lineSvg" role="img" aria-label="Hat akÄ±ÅŸÄ± animasyonu"></svg> <!-- SVG alanÄ± -->
    </div>
  </section>
</main>
<footer> <!-- Alt bilgi -->
  <div class="footer-content"> <!-- Footer iÃ§eriÄŸi -->
    <div class="footer-brand">Franz Kiel TÃ¼rkiye (FKT)</div> <!-- Kurumsal metin -->
    <div class="footer-hints"> <!-- KÄ±sayol bilgisi -->
      Klavyeden: <strong>B</strong> BaÅŸlat Â· <strong>D</strong> Durdur Â· <strong>R</strong> SÄ±fÄ±rla
    </div>
    <div class="footer-signature"> <!-- Ä°mza alanÄ± -->
      <span>E.DEMIR</span>
    </div>
  </div>
</footer>

<div class="modal-backdrop" id="analysisModal"> <!-- Analiz modal arka planÄ± -->
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="analysisTitle"> <!-- Analiz modal kutusu -->
    <h3 id="analysisTitle">Analiz ve Ã–neri</h3> <!-- Analiz baÅŸlÄ±ÄŸÄ± -->
    <p style="margin-top:0;color:var(--muted);">Hat kapasitesi ve takt time senaryolarÄ±nÄ± inceleyin.</p> <!-- AÃ§Ä±klama -->
    <div class="analysis-form"> <!-- Takt formu -->
      <label for="taktInput" style="display:flex;flex-direction:column;gap:6px;flex:1;"> <!-- Takt etiket -->
        <span>Takt Time (sn/Ã¼rÃ¼n)</span> <!-- Etiket metni -->
        <input id="taktInput" type="number" min="1" placeholder="Ã–rn: 60" /> <!-- Takt giriÅŸi -->
      </label>
      <button id="analysisRecalcBtn" type="button" class="primary" style="align-self:flex-end;">Hesapla</button> <!-- Yenile butonu -->
    </div>
    <div id="analysisSummary" class="analysis-section"> <!-- Toplam sÃ¼reler -->
      <h4>Ä°stasyon Ã–zeti</h4> <!-- Ã–zet baÅŸlÄ±ÄŸÄ± -->
      <table class="analysis-table" aria-label="Ä°stasyon sÃ¼releri ve kapasite"> <!-- Analiz tablosu -->
        <thead>
          <tr>
            <th>Ä°stasyon</th>
            <th>Toplam SÃ¼re (sn)</th>
            <th>OperatÃ¶r</th>
            <th>Paralel</th>
            <th>Teorik Kapasite (Ã¼rÃ¼n/sn)</th>
          </tr>
        </thead>
        <tbody id="analysisTableBody"></tbody>
      </table>
    </div>
    <div id="analysisInsights" class="analysis-section"> <!-- Bottleneck yorumlarÄ± -->
      <h4>Bottleneck ve Takt DeÄŸerlendirmesi</h4> <!-- BaÅŸlÄ±k -->
      <p class="analysis-text"></p> <!-- Dinamik yorum -->
    </div>
    <div id="analysisWhatIf" class="analysis-section"> <!-- What-if senaryosu -->
      <h4>What-if: OperatÃ¶r ArtÄ±rÄ±mÄ±</h4> <!-- BaÅŸlÄ±k -->
      <ul class="analysis-list"></ul> <!-- Senaryo listesi -->
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:18px;"> <!-- Alt buton satÄ±rÄ± -->
      <button id="closeAnalysisBtn" class="primary">Kapat</button> <!-- Kapat butonu -->
    </div>
  </div>
</div>

<div class="modal-backdrop" id="reportModal"> <!-- Dashboard modal arka planÄ± -->
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reportTitle"> <!-- Dashboard kutusu -->
    <div class="dashboard-header"> <!-- BaÅŸlÄ±k satÄ±rÄ± -->
      <h3 id="reportTitle">SimÃ¼lasyon SonuÃ§larÄ±</h3> <!-- Modal baÅŸlÄ±ÄŸÄ± -->
      <div style="display:flex;gap:8px;"> <!-- Buton grubu -->
        <button id="downloadCsvBtn" type="button">CSV Olarak Ä°ndir</button> <!-- CSV butonu -->
        <button id="downloadPdfBtn" type="button">PDF Olarak Kaydet</button> <!-- PDF butonu -->
        <button id="closeReportBtn" type="button" class="danger">Kapat</button> <!-- Kapat butonu -->
      </div>
    </div>
    <div class="dashboard-grid"> <!-- Dashboard iÃ§erik -->
      <section class="summary-cards" aria-label="Genel Ã¶zet kartlarÄ±"> <!-- Ã–zet kart grubu -->
        <article class="summary-card"> <!-- Cycle kartÄ± -->
          <h4>Ortalama Cycle Time</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardCycle">0 sn</strong> <!-- DeÄŸer -->
          <span>GiriÅŸten Ã§Ä±kÄ±ÅŸa ortalama sÃ¼re</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- Tamamlanan kartÄ± -->
          <h4>Toplam Tamamlanan</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardCompleted">0</strong> <!-- DeÄŸer -->
          <span>Hedeflenen Ã¼rÃ¼nlerden biten</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- Throughput kartÄ± -->
          <h4>Throughput</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardThroughput">0 /sn</strong> <!-- DeÄŸer -->
          <span>ÃœrÃ¼n/sn ve Ã¼rÃ¼n/dk</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- WIP kartÄ± -->
          <h4>Ortalama WIP</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardWip">0</strong> <!-- DeÄŸer -->
          <span>EÅŸzamanlÄ± sistemdeki Ã¼rÃ¼n</span> <!-- AÃ§Ä±klama -->
        </article>
      </section>
      <section class="dashboard-section" aria-label="Ä°stasyon performans tablosu"> <!-- Performans bÃ¶lÃ¼mÃ¼ -->
        <h4>Ä°stasyon BazlÄ± Performans</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- Performans tablosu -->
          <thead>
            <tr>
              <th>Ä°stasyon</th>
              <th>OperatÃ¶r (Paralel)</th>
              <th>Servis SÃ¼resi (sn)</th>
              <th>Idle/Starved SÃ¼re (sn)</th>
              <th>Ortalama Kuyruk</th>
              <th>Bekleme (sn)</th>
              <th>Utilization (%)</th>
              <th>Tamamlanan Ä°ÅŸ</th>
            </tr>
          </thead>
          <tbody id="stationPerformanceBody"></tbody> <!-- Tablo gÃ¶vdesi -->
        </table>
      </section>
      <section class="dashboard-section" aria-label="DarboÄŸaz Ã¶zeti"> <!-- DarboÄŸaz bÃ¶lÃ¼mÃ¼ -->
        <h4>DarboÄŸaz Ã–zeti</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- DarboÄŸaz tablosu -->
          <thead>
            <tr>
              <th>Kriter</th>
              <th>Ä°stasyon</th>
              <th>Ã–neri</th>
            </tr>
          </thead>
          <tbody id="bottleneckTableBody"></tbody> <!-- DarboÄŸaz satÄ±rlarÄ± -->
        </table>
      </section>
      <section class="dashboard-section" aria-label="Fork Ã§Ä±kÄ±ÅŸlarÄ± Ã¶zeti"> <!-- Fork bÃ¶lÃ¼mÃ¼ -->
        <h4>Fork Ã‡Ä±kÄ±ÅŸlarÄ±</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- Fork tablosu -->
          <thead>
            <tr>
              <th>Ä°stasyon</th>
              <th>Ã‡Ä±kÄ±ÅŸ SayÄ±sÄ±</th>
              <th>Ãœretilen ParÃ§a</th>
              <th>Fork OlayÄ±</th>
            </tr>
          </thead>
          <tbody id="forkSummaryBody"></tbody> <!-- Fork satÄ±rlarÄ± -->
        </table>
      </section>
      <section class="dashboard-section" aria-label="Tamamlanan iÅŸ rotalarÄ±"> <!-- Ä°ÅŸ akÄ±ÅŸÄ± bÃ¶lÃ¼mÃ¼ -->
        <h4>Tamamlanan Ä°ÅŸ AkÄ±ÅŸlarÄ±</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- Ä°ÅŸ tablosu -->
          <thead>
            <tr>
              <th>Ä°ÅŸ KimliÄŸi</th>
              <th>Ãœst Ä°ÅŸ</th>
              <th>Rota</th>
              <th>Ã‡Ä±kÄ±ÅŸ Ä°stasyonu</th>
              <th>Ã‡Ä±kÄ±ÅŸ ZamanÄ± (sn)</th>
            </tr>
          </thead>
          <tbody id="jobLineageBody"></tbody> <!-- Ä°ÅŸ satÄ±rlarÄ± -->
        </table>
        <p style="margin:6px 0 0 0;color:var(--muted);font-size:0.8rem;">Tablo, en gÃ¼ncel tamamlanan iÅŸleri rota ve soy bilgisi ile listeler.</p> <!-- AÃ§Ä±klama -->
      </section>
      <section class="dashboard-section chart-card" aria-label="Kuyruk grafiÄŸi"> <!-- Kuyruk grafik bÃ¶lÃ¼mÃ¼ -->
        <h4>Kuyruk ve Utilization Profili</h4> <!-- BaÅŸlÄ±k -->
        <div class="chart-wrapper"> <!-- Grafik alanÄ± -->
          <canvas id="queueChart" class="chart-canvas" aria-label="Ä°stasyon kuyruk uzunluklarÄ±"></canvas> <!-- Kuyruk grafiÄŸi -->
        </div>
        <p style="margin:0;color:var(--muted);">Ä°stasyonlara gÃ¶re ortalama kuyruk uzunluÄŸu ve utilization yoÄŸunluÄŸu.</p> <!-- AÃ§Ä±klama -->
      </section>
      <section class="dashboard-section chart-card" aria-label="Ã‡Ä±kÄ±ÅŸ grafiÄŸi"> <!-- Throughput grafik bÃ¶lÃ¼mÃ¼ -->
        <h4>Zaman Ä°Ã§inde Tamamlanan ÃœrÃ¼nler</h4> <!-- BaÅŸlÄ±k -->
        <div class="chart-wrapper"> <!-- Grafik alanÄ± -->
          <canvas id="throughputChart" class="chart-canvas" aria-label="Tamamlanan Ã¼rÃ¼n trendi"></canvas> <!-- Zaman serisi -->
        </div>
        <p style="margin:0;color:var(--muted);">MantÄ±ksal zaman ekseninde kÃ¼mÃ¼latif tamamlanan Ã¼rÃ¼n.</p> <!-- AÃ§Ä±klama -->
      </section>
      <section class="dashboard-section analysis-panel" aria-label="Analiz ve Ã¶neriler"> <!-- Analiz sekmesi -->
        <h4>Analiz / Ã–neriler</h4> <!-- BaÅŸlÄ±k -->
        <p id="dashboardAnalysisText">Analiz yÃ¼kleniyor...</p> <!-- Analiz metni -->
        <ul id="dashboardAnalysisList"></ul> <!-- What-if listesi -->
      </section>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="restoreModal"> <!-- Kurtarma modal arka planÄ± -->
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="restoreTitle"> <!-- Kurtarma modal kutusu -->
    <h3 id="restoreTitle" data-i18n="restore.title">Son denemeyi geri yÃ¼klemek ister misiniz?</h3> <!-- BaÅŸlÄ±k -->
    <p data-i18n="restore.message">Uygulama kapanmadan Ã¶nceki son oturum bulundu. Geri yÃ¼klensin mi?</p> <!-- Mesaj -->
    <div class="modal-actions"> <!-- Buton grubu -->
      <button id="restoreYesBtn" type="button" class="primary" data-i18n="restore.yes">Evet, geri yÃ¼kle</button> <!-- Evet butonu -->
      <button id="restoreNoBtn" type="button" data-i18n="restore.no">HayÄ±r, boÅŸ baÅŸla</button> <!-- HayÄ±r butonu -->
      <button id="restoreNeverBtn" type="button" data-i18n="restore.never">Bir daha sorma</button> <!-- Bir daha sorma -->
    </div>
  </div>
</div>

<script> // Uygulama betiÄŸi baÅŸlangÄ±cÄ±

window.addEventListener('error', event => console.error('Global error:', event.error || event.message)); // Global hata yakala

const APP_VERSION = '2024.09.1'; // Uygulama sÃ¼rÃ¼mÃ¼
const OPEN_TABS_KEY = 'line-sim-tabs-v1'; // AÃ§Ä±k sekmeleri saklayan anahtar
const LEGACY_STORAGE_KEY = 'line-sim-state'; // Eski tek sekmeli kayÄ±t anahtarÄ±
const SCENARIO_STORE_KEY = 'line-sim-scenarios-v1'; // KaydedilmiÅŸ senaryolar deposu
const SNAPSHOT_KEY = 'line-sim-last-session'; // Ã‡Ã¶kme kurtarma gÃ¶rÃ¼ntÃ¼sÃ¼ anahtarÄ±
const RESTORE_PROMPT_KEY = 'line-sim-restore-prompt'; // Kurtarma uyarÄ± tercihi anahtarÄ±
const LANGUAGE_KEY = 'line-sim-language'; // Dil tercihi anahtarÄ±
const persistedState = loadPersistedState(); // Ã–nceden kaydedilmiÅŸ sekmeler
let savedScenarios = loadScenarioStore(); // KaydedilmiÅŸ senaryolar listesi

const translations = { // Ã‡ok dilli sÃ¶zlÃ¼k
  tr: { // TÃ¼rkÃ§e
    'tabs.new': '+ Yeni Sekme',
    'tabs.default': 'Sekme {{index}}',
    'tabs.restore': 'Son Deneme ({{stamp}})',
    'toolbar.simulationMenu': 'âš™ï¸ SimÃ¼lasyon â–¾',
    'toolbar.viewMenu': 'ğŸ–¥ï¸ GÃ¶rÃ¼nÃ¼m â–¾',
    'toolbar.storageMenu': 'ğŸ’¾ KayÄ±t/Sekmeler â–¾',
    'toolbar.start': 'BaÅŸlat',
    'toolbar.stop': 'Durdur',
    'toolbar.reset': 'SÄ±fÄ±rla',
    'toolbar.clear': 'Temizle',
    'toolbar.fullscreen': 'ğŸ”³ Tam Ekran',
    'toolbar.save': 'Kaydet',
    'toolbar.load': 'YÃ¼kle',
    'toolbar.newTab': 'Yeni Sekme',
    'toolbar.other': 'DiÄŸer â–¸',
    'toolbar.addStation': '+ Ä°stasyon Ekle',
    'toolbar.speed': 'HÄ±z',
    'toolbar.target': 'Hedef adet',
    'toolbar.entry': 'GiriÅŸ',
    'toolbar.languageLabel': 'Dil',
    'toolbar.loadList': 'YÃ¼kle',
    'toolbar.closeTab': 'Sekmeyi Kapat',
    'toolbar.noScenarios': 'KayÄ±t bulunamadÄ±',
    'title.start': 'SimÃ¼lasyonu baÅŸlat (B)',
    'title.stop': 'SimÃ¼lasyonu durdur (D)',
    'title.reset': 'SimÃ¼lasyonu sÄ±fÄ±rla (R)',
    'title.clear': 'Aktif sekmeyi temizle',
    'title.fullscreen': 'SimÃ¼lasyon alanÄ±nÄ± tam ekran yap',
    'title.save': 'GeÃ§erli sekmeyi kaydet',
    'title.load': 'KayÄ±tlÄ± senaryoyu yÃ¼kle',
    'title.newTab': 'Yeni sekme aÃ§',
    'title.other': 'DiÄŸer araÃ§lar',
    'title.simulationMenu': 'SimÃ¼lasyon iÅŸlemleri',
    'title.viewMenu': 'GÃ¶rÃ¼nÃ¼m ve dil ayarlarÄ±',
    'title.storageMenu': 'KayÄ±t ve sekme iÅŸlemleri',
    'title.closeTab': 'Aktif sekmeyi kapat',
    'title.analysis': 'Analiz ve Ã¶nerileri aÃ§',
    'title.results': 'SimÃ¼lasyon sonuÃ§larÄ±nÄ± aÃ§',
    'title.sample': 'Ã–rnek kurulum yÃ¼kle',
    'title.addStation': 'Yeni istasyon ekle',
    'title.modeView': 'GÃ¶rÃ¼ntÃ¼leme moduna geÃ§',
    'title.modeEdit': 'YerleÅŸimi dÃ¼zenle',
    'title.speed': 'Animasyon hÄ±zÄ±nÄ± ayarla',
    'title.target': 'Hedef tamamlanacak Ã¼rÃ¼n adedi',
    'title.entry': 'GiriÅŸ politikasÄ±',
    'title.language': 'Dili deÄŸiÅŸtir',
    'title.zoomOut': 'GÃ¶rÃ¼nÃ¼mÃ¼ kÃ¼Ã§Ã¼lt',
    'title.zoomIn': 'GÃ¶rÃ¼nÃ¼mÃ¼ bÃ¼yÃ¼t',
    'title.zoomReset': 'Ã–lÃ§eÄŸi 100% yap',
    'mode.view': 'GÃ¶rÃ¼ntÃ¼le',
    'mode.edit': 'DÃ¼zenle',
    'entry.trigger': 'ÃœrÃ¼n, tamamlandÄ±kÃ§a girsin',
    'entry.interval': 'Sabit giriÅŸ aralÄ±ÄŸÄ±',
    'menu.analysis': 'Analiz/Ã–neri',
    'menu.results': 'SonuÃ§larÄ± GÃ¶r',
    'menu.sample': 'Ã–rnek Kurulum',
    'toast.runningLock': 'SimÃ¼lasyon sÃ¼rerken baÄŸlantÄ±lar dÃ¼zenlenemez.',
    'toast.noTargets': 'Uygun hedef istasyon bulunamadÄ±.',
    'toast.edgeExists': 'Bu istasyon zaten seÃ§ilen hedefe baÄŸlÄ±.',
    'toast.edgeCycle': 'DÃ¶ngÃ¼ oluÅŸturduÄŸu iÃ§in baÄŸlantÄ± reddedildi.',
    'toast.edgeAdded': '{{source}} â†’ {{target}} baÄŸlantÄ±sÄ± eklendi.',
    'toast.edgeRemoved': '{{source}} â†’ {{target}} baÄŸlantÄ±sÄ± silindi.',
    'toast.edgeCancelled': 'BaÄŸlantÄ± oluÅŸturma iptal edildi.',
    'toast.edgePrompt': '{{source}} Ã§Ä±kÄ±ÅŸÄ±nÄ± baÄŸlamak iÃ§in hedef istasyona tÄ±klayÄ±n.',
    'toast.edgeMissing': 'Silinecek baÄŸlantÄ± bulunamadÄ±.',
    'toast.clearDone': 'Aktif sekme temizlendi.',
    'toast.saveSuccess': '"{{name}}" kaydedildi.',
    'toast.saveOverwrite': '"{{name}}" gÃ¼ncellendi.',
    'toast.saveCancelled': 'Kaydetme iptal edildi.',
    'toast.loadEmpty': 'LÃ¼tfen yÃ¼klenecek bir senaryo seÃ§in.',
    'toast.loadSuccess': '"{{name}}" yeni sekmede aÃ§Ä±ldÄ±.',
    'toast.snapshotFailed': 'Kurtarma baÅŸarÄ±sÄ±z. BoÅŸ sekme ile baÅŸlandÄ±.',
    'toast.snapshotRestored': 'Son oturum geri yÃ¼klendi.',
    'toast.snapshotDeclined': 'Kurtarma atlandÄ±.',
    'toast.languageUpdated': 'Dil {{language}} olarak ayarlandÄ±.',
    'toast.renameDone': 'Sekme adÄ± gÃ¼ncellendi.',
    'toast.renameCancelled': 'Yeniden adlandÄ±rma iptal edildi.',
    'toast.renameRequired': 'Sekme adÄ± boÅŸ olamaz.',
    'confirm.clear': 'Aktif sekmedeki tÃ¼m veri silinsin mi?',
    'confirm.unsavedTabSwitch': 'KaydedilmemiÅŸ deÄŸiÅŸiklikler var. Sekme deÄŸiÅŸtirilsin mi?',
    'confirm.overwrite': 'Bu adla bir kayÄ±t var. Ãœzerine yazmak ister misiniz?',
    'prompt.saveName': 'Senaryo adÄ±nÄ± girin',
    'prompt.renameTab': 'Sekme adÄ±nÄ± girin',
    'prompt.loadName': 'YÃ¼klenecek senaryo adÄ±nÄ± girin',
    'counter.completed': 'Tamamlanan: {{count}}',
    'restore.title': 'Son denemeyi geri yÃ¼klemek ister misiniz?',
    'restore.message': 'Uygulama kapanmadan Ã¶nceki son oturum bulundu. Geri yÃ¼klensin mi?',
    'restore.yes': 'Evet, geri yÃ¼kle',
    'restore.no': 'HayÄ±r, boÅŸ baÅŸla',
    'restore.never': 'Bir daha sorma'
  },
  en: { // Ä°ngilizce
    'tabs.new': '+ New Tab',
    'tabs.default': 'Tab {{index}}',
    'tabs.restore': 'Last Session ({{stamp}})',
    'toolbar.simulationMenu': 'âš™ï¸ Simulation â–¾',
    'toolbar.viewMenu': 'ğŸ–¥ï¸ View â–¾',
    'toolbar.storageMenu': 'ğŸ’¾ Save/Tabs â–¾',
    'toolbar.start': 'Start',
    'toolbar.stop': 'Stop',
    'toolbar.reset': 'Reset',
    'toolbar.clear': 'Clear',
    'toolbar.fullscreen': 'ğŸ”³ Full Screen',
    'toolbar.save': 'Save',
    'toolbar.load': 'Load',
    'toolbar.newTab': 'New Tab',
    'toolbar.other': 'More â–¸',
    'toolbar.addStation': '+ Add Station',
    'toolbar.speed': 'Speed',
    'toolbar.target': 'Target count',
    'toolbar.entry': 'Entry',
    'toolbar.languageLabel': 'Language',
    'toolbar.loadList': 'Load',
    'toolbar.closeTab': 'Close Tab',
    'toolbar.noScenarios': 'No saved scenarios yet',
    'title.start': 'Start the simulation (B)',
    'title.stop': 'Stop the simulation (D)',
    'title.reset': 'Reset the simulation (R)',
    'title.clear': 'Clear the active tab',
    'title.fullscreen': 'Toggle full screen for the flow view',
    'title.save': 'Save the current tab',
    'title.load': 'Load a saved scenario',
    'title.newTab': 'Open a new tab',
    'title.other': 'Other tools',
    'title.simulationMenu': 'Simulation controls',
    'title.viewMenu': 'View and language options',
    'title.storageMenu': 'Save and tab actions',
    'title.closeTab': 'Close active tab',
    'title.analysis': 'Open analysis and suggestions',
    'title.results': 'Open simulation results',
    'title.sample': 'Load the sample layout',
    'title.addStation': 'Add a new station',
    'title.modeView': 'Switch to view mode',
    'title.modeEdit': 'Switch to edit mode',
    'title.speed': 'Adjust animation speed',
    'title.target': 'Target number of completed items',
    'title.entry': 'Entry policy',
    'title.language': 'Change language',
    'title.zoomOut': 'Zoom out',
    'title.zoomIn': 'Zoom in',
    'title.zoomReset': 'Reset zoom to 100%',
    'mode.view': 'View',
    'mode.edit': 'Edit',
    'entry.trigger': 'Inject when upstream frees',
    'entry.interval': 'Fixed entry interval',
    'menu.analysis': 'Analysis & Advice',
    'menu.results': 'Simulation Results',
    'menu.sample': 'Sample Layout',
    'toast.runningLock': 'Connections cannot be edited while the simulation is running.',
    'toast.noTargets': 'No valid target stations available.',
    'toast.edgeExists': 'This station already connects to that target.',
    'toast.edgeCycle': 'Connection rejected because it would create a cycle.',
    'toast.edgeAdded': '{{source}} â†’ {{target}} connection added.',
    'toast.edgeRemoved': '{{source}} â†’ {{target}} connection removed.',
    'toast.edgeCancelled': 'Connection creation cancelled.',
    'toast.edgePrompt': 'Click a target station to link {{source}}.',
    'toast.edgeMissing': 'No connection found to remove.',
    'toast.clearDone': 'Active tab cleared.',
    'toast.saveSuccess': '"{{name}}" saved.',
    'toast.saveOverwrite': '"{{name}}" updated.',
    'toast.saveCancelled': 'Save cancelled.',
    'toast.loadEmpty': 'Please select a scenario to load.',
    'toast.loadSuccess': '"{{name}}" opened in a new tab.',
    'toast.snapshotFailed': 'Recovery failed. Starting with an empty tab.',
    'toast.snapshotRestored': 'Last session restored.',
    'toast.snapshotDeclined': 'Recovery skipped.',
    'toast.languageUpdated': 'Language set to {{language}}.',
    'toast.renameDone': 'Tab name updated.',
    'toast.renameCancelled': 'Rename cancelled.',
    'toast.renameRequired': 'Tab name cannot be empty.',
    'confirm.clear': 'Clear all data in the active tab?',
    'confirm.unsavedTabSwitch': 'You have unsaved changes. Switch tabs anyway?',
    'confirm.overwrite': 'A scenario with this name exists. Overwrite it?',
    'prompt.saveName': 'Enter scenario name',
    'prompt.renameTab': 'Enter tab name',
    'prompt.loadName': 'Enter scenario name to load',
    'counter.completed': 'Completed: {{count}}',
    'restore.title': 'Restore last session?',
    'restore.message': 'A previous session snapshot was found. Do you want to restore it?',
    'restore.yes': 'Restore',
    'restore.no': 'Start fresh',
    'restore.never': 'Donâ€™t ask again'
  },
  de: { // Almanca
    'tabs.new': '+ Neuer Tab',
    'tabs.default': 'Tab {{index}}',
    'tabs.restore': 'Letzter Versuch ({{stamp}})',
    'toolbar.simulationMenu': 'âš™ï¸ Simulation â–¾',
    'toolbar.viewMenu': 'ğŸ–¥ï¸ Ansicht â–¾',
    'toolbar.storageMenu': 'ğŸ’¾ Speicher/Tabs â–¾',
    'toolbar.start': 'Starten',
    'toolbar.stop': 'Stopp',
    'toolbar.reset': 'ZurÃ¼cksetzen',
    'toolbar.clear': 'Leeren',
    'toolbar.fullscreen': 'ğŸ”³ Vollbild',
    'toolbar.save': 'Speichern',
    'toolbar.load': 'Laden',
    'toolbar.newTab': 'Neuer Tab',
    'toolbar.other': 'Weitere â–¸',
    'toolbar.addStation': '+ Station hinzufÃ¼gen',
    'toolbar.speed': 'Geschwindigkeit',
    'toolbar.target': 'Zielmenge',
    'toolbar.entry': 'Zufluss',
    'toolbar.languageLabel': 'Sprache',
    'toolbar.loadList': 'Laden',
    'toolbar.closeTab': 'Tab schlieÃŸen',
    'toolbar.noScenarios': 'Keine gespeicherten Szenarien',
    'title.start': 'Simulation starten (B)',
    'title.stop': 'Simulation stoppen (D)',
    'title.reset': 'Simulation zurÃ¼cksetzen (R)',
    'title.clear': 'Aktiven Tab leeren',
    'title.fullscreen': 'Flussansicht in den Vollbildmodus wechseln',
    'title.save': 'Aktuellen Tab speichern',
    'title.load': 'Gespeichertes Szenario laden',
    'title.newTab': 'Neuen Tab Ã¶ffnen',
    'title.other': 'Weitere Werkzeuge',
    'title.simulationMenu': 'Simulationsaktionen',
    'title.viewMenu': 'Ansicht- und Spracheinstellungen',
    'title.storageMenu': 'Speicher- und Tab-Verwaltung',
    'title.closeTab': 'Aktiven Tab schlieÃŸen',
    'title.analysis': 'Analyse und Empfehlungen Ã¶ffnen',
    'title.results': 'Simulationsergebnisse Ã¶ffnen',
    'title.sample': 'Beispielaufbau laden',
    'title.addStation': 'Neue Station hinzufÃ¼gen',
    'title.modeView': 'In den Anzeige-Modus wechseln',
    'title.modeEdit': 'In den Bearbeitungsmodus wechseln',
    'title.speed': 'Animationsgeschwindigkeit anpassen',
    'title.target': 'Zielmenge abgeschlossener Teile',
    'title.entry': 'Zuflussregel',
    'title.language': 'Sprache Ã¤ndern',
    'title.zoomOut': 'Verkleinern',
    'title.zoomIn': 'VergrÃ¶ÃŸern',
    'title.zoomReset': 'Zoom auf 100Â % zurÃ¼cksetzen',
    'mode.view': 'Anzeigen',
    'mode.edit': 'Bearbeiten',
    'entry.trigger': 'Produkte eintreten, wenn frei',
    'entry.interval': 'Fester Eintrittsabstand',
    'menu.analysis': 'Analyse & Empfehlung',
    'menu.results': 'Simulationsergebnisse',
    'menu.sample': 'Beispielaufbau',
    'toast.runningLock': 'WÃ¤hrend der Simulation kÃ¶nnen Verbindungen nicht geÃ¤ndert werden.',
    'toast.noTargets': 'Keine gÃ¼ltigen Zielstationen gefunden.',
    'toast.edgeExists': 'Diese Station ist bereits mit dem Ziel verbunden.',
    'toast.edgeCycle': 'Verbindung abgelehnt, da ein Zyklus entstehen wÃ¼rde.',
    'toast.edgeAdded': 'Verbindung {{source}} â†’ {{target}} hinzugefÃ¼gt.',
    'toast.edgeRemoved': 'Verbindung {{source}} â†’ {{target}} entfernt.',
    'toast.edgeCancelled': 'Verbindungsaufbau abgebrochen.',
    'toast.edgePrompt': 'Klicken Sie auf eine Zielstation, um {{source}} zu verbinden.',
    'toast.edgeMissing': 'Keine zu entfernende Verbindung gefunden.',
    'toast.clearDone': 'Aktiver Tab geleert.',
    'toast.saveSuccess': '"{{name}}" gespeichert.',
    'toast.saveOverwrite': '"{{name}}" aktualisiert.',
    'toast.saveCancelled': 'Speichern abgebrochen.',
    'toast.loadEmpty': 'Bitte wÃ¤hlen Sie ein Szenario zum Laden.',
    'toast.loadSuccess': '"{{name}}" wurde in einem neuen Tab geÃ¶ffnet.',
    'toast.snapshotFailed': 'Wiederherstellung fehlgeschlagen. Leerer Tab gestartet.',
    'toast.snapshotRestored': 'Letzte Sitzung wiederhergestellt.',
    'toast.snapshotDeclined': 'Wiederherstellung Ã¼bersprungen.',
    'toast.languageUpdated': 'Sprache auf {{language}} gesetzt.',
    'toast.renameDone': 'Tab-Name aktualisiert.',
    'toast.renameCancelled': 'Umbenennen abgebrochen.',
    'toast.renameRequired': 'Tab-Name darf nicht leer sein.',
    'confirm.clear': 'Alle Daten im aktiven Tab lÃ¶schen?',
    'confirm.unsavedTabSwitch': 'Es gibt ungespeicherte Ã„nderungen. Trotzdem wechseln?',
    'confirm.overwrite': 'Ein Szenario mit diesem Namen existiert. Ãœberschreiben?',
    'prompt.saveName': 'Szenarionamen eingeben',
    'prompt.renameTab': 'Tab-Namen eingeben',
    'prompt.loadName': 'Zu ladenden Szenarionamen eingeben',
    'counter.completed': 'Fertiggestellt: {{count}}',
    'restore.title': 'Letzte Sitzung wiederherstellen?',
    'restore.message': 'Eine vorherige Sitzung wurde gefunden. MÃ¶chten Sie sie wiederherstellen?',
    'restore.yes': 'Wiederherstellen',
    'restore.no': 'Neu starten',
    'restore.never': 'Nicht erneut fragen'
  }
};

const languageNames = { tr: 'TÃ¼rkÃ§e', en: 'English', de: 'Deutsch' }; // Dil adlarÄ±

function t(key, params = {}, fallback = '') { // Ã‡eviri yardÄ±mcÄ± fonksiyonu
  const lang = appState.language && translations[appState.language] ? appState.language : 'tr'; // GeÃ§erli dil
  const table = translations[lang] || translations.tr; // Dil tablosu
  const base = table[key] !== undefined ? table[key] : translations.tr[key]; // Ä°lk bulunan deÄŸer
  const template = base !== undefined ? base : (fallback || key); // Åablon seÃ§
  if (typeof template !== 'string') return template; // Åablon metin deÄŸilse direkt dÃ¶ndÃ¼r
  return template.replace(/\{\{(\w+)\}\}/g, (_, token) => (params[token] !== undefined ? params[token] : `{{${token}}}`)); // DeÄŸiÅŸkenleri yerleÅŸtir
}

function applyTranslations(root = document) { // Veri-Ã¶zniteliklerine gÃ¶re metinleri gÃ¼ncelle
  root.querySelectorAll('[data-i18n]').forEach(node => { // Metin iÃ§erenler
    const key = node.dataset.i18n; // Anahtar
    node.textContent = t(key); // Ã‡eviri uygula
  });
  root.querySelectorAll('[data-i18n-placeholder]').forEach(node => { // Placeholder iÃ§in
    const key = node.dataset.i18nPlaceholder; // Anahtar
    node.placeholder = t(key); // Ã‡eviri uygula
  });
  root.querySelectorAll('[data-i18n-title]').forEach(node => { // BaÅŸlÄ±k iÃ§in
    const key = node.dataset.i18nTitle; // Anahtar
    node.title = t(key); // Ã‡eviri uygula
  });
}

function createEmptySnapshot() { // BoÅŸ bir sekme snapshotÄ± Ã¼ret
  return {
    stations: [], // Ä°stasyon listesi
    targetCount: null, // Hedef Ã¼rÃ¼n
    entryPolicy: 'trigger', // GiriÅŸ politikasÄ±
    entryInterval: 30, // VarsayÄ±lan aralÄ±k
    speed: 1, // HÄ±z
    zoom: 1, // YakÄ±nlaÅŸtÄ±rma
    taktTime: null, // Takt sÃ¼resi
    nextStationId: 1, // Ä°lk istasyon kimliÄŸi
    mode: 'view', // BaÅŸlangÄ±Ã§ modu
    language: appState.language, // Aktif dil
    timestamp: Date.now(), // Zaman damgasÄ±
    appVersion: APP_VERSION // SÃ¼rÃ¼m
  };
}

function normalizeSnapshot(snapshot) { // Snapshot verisini gÃ¼venli hale getir
  const base = createEmptySnapshot(); // BoÅŸ ÅŸablon
  if (!snapshot || typeof snapshot !== 'object') return base; // GeÃ§ersizse boÅŸ dÃ¶ndÃ¼r
  const safeStations = Array.isArray(snapshot.stations) ? snapshot.stations : []; // GÃ¼venli istasyon listesi
  return {
    ...base,
    ...snapshot,
    stations: safeStations // Ä°stasyonlarÄ± ata
  };
}

function normalizeStoredTab(raw, index = 0) { // Depodan gelen sekmeyi normalize et
  const snapshot = normalizeSnapshot(raw?.snapshot); // Snapshot temizle
  const fallbackName = t('tabs.default', { index: index + 1 }); // VarsayÄ±lan ad
  const name = typeof raw?.name === 'string' && raw.name.trim().length ? raw.name.trim() : fallbackName; // Ad seÃ§
  const id = typeof raw?.id === 'string' && raw.id.trim().length ? raw.id : `tab-${Date.now()}-${index}`; // Kimlik Ã¼ret
  return {
    id,
    name,
    snapshot,
    dirty: !!raw?.dirty,
    createdAt: raw?.createdAt || Date.now(),
    updatedAt: raw?.updatedAt || Date.now()
  };
}

function getActiveTab() { // Aktif sekmeyi dÃ¶ndÃ¼r
  return appState.tabs.find(tab => tab.id === appState.activeTabId) || null; // Yoksa null
}

function renderTabs() { // Sekme Ã§ubuÄŸunu yeniden Ã§iz
  if (!tabBarEl || !newTabBtn) return; // Eleman yoksa Ã§Ä±k
  const preservedButton = newTabBtn; // Yeni sekme butonunu sakla
  tabBarEl.innerHTML = ''; // Ä°Ã§eriÄŸi temizle
  appState.tabs.forEach(tab => { // Her sekme iÃ§in
    const button = document.createElement('button'); // Sekme dÃ¼ÄŸmesi
    button.type = 'button'; // Buton tipi
    button.className = 'tab-button'; // Stil sÄ±nÄ±fÄ±
    button.dataset.tabId = tab.id; // Kimlik
    button.dataset.active = tab.id === appState.activeTabId ? 'true' : 'false'; // Aktiflik
    button.dataset.dirty = tab.dirty ? 'true' : 'false'; // Kirli bayraÄŸÄ±
    button.draggable = true; // SÃ¼rÃ¼klenebilir yap
    const titleSpan = document.createElement('span'); // Ad etiketi
    titleSpan.textContent = tab.name; // AdÄ± yaz
    button.appendChild(titleSpan); // Butona ekle
    const closeSpan = document.createElement('span'); // Kapatma alanÄ±
    closeSpan.className = 'tab-close'; // Stil sÄ±nÄ±fÄ±
    closeSpan.setAttribute('role', 'button'); // EriÅŸilebilirlik
    closeSpan.setAttribute('aria-label', 'Close'); // ARIA etiketi
    closeSpan.textContent = 'Ã—'; // Simge
    button.appendChild(closeSpan); // Butona ekle
    tabBarEl.appendChild(button); // Sekme Ã§ubuÄŸuna ekle
  });
  tabBarEl.appendChild(preservedButton); // Yeni sekme butonunu sona ekle
  applyTranslations(tabBarEl); // Metinleri gÃ¼ncelle
}

function updateCompletedCounter(count = 0) { // Tamamlanan Ã¼rÃ¼n sayacÄ±nÄ± gÃ¼ncelle
  appState.completedDisplayCount = count; // Son deÄŸeri sakla
  if (!completedCounterEl) return; // SayaÃ§ yoksa Ã§Ä±k
  completedCounterEl.textContent = t('counter.completed', { count }); // Ã‡eviriyle yaz
}

function initializeTabs() { // Saklanan sekmeleri yÃ¼kle
  const storedTabs = Array.isArray(persistedState.tabs) ? persistedState.tabs.map((tab, index) => normalizeStoredTab(tab, index)) : []; // Depodan gelen sekmeler
  if (!storedTabs.length && persistedState.legacySnapshot) { // Eski tek snapshot varsa
    storedTabs.push(normalizeStoredTab({ snapshot: persistedState.legacySnapshot, name: t('tabs.default', { index: 1 }), dirty: true }, 0)); // Legacy verisini sekmeye dÃ¶nÃ¼ÅŸtÃ¼r
  }
  if (!storedTabs.length) { // HiÃ§ sekme yoksa
    storedTabs.push(normalizeStoredTab({ snapshot: createEmptySnapshot(), name: t('tabs.default', { index: 1 }), dirty: false }, 0)); // BoÅŸ sekme oluÅŸtur
  }
  appState.tabs = storedTabs; // Sekmeleri ata
  const activeCandidate = storedTabs.some(tab => tab.id === persistedState.activeTabId) ? persistedState.activeTabId : storedTabs[0].id; // Aktif sekmeyi seÃ§
  appState.activeTabId = activeCandidate; // Aktif kimliÄŸi ata
  const maxCounter = storedTabs.reduce((max, tab) => { // SayaÃ§ iÃ§in maksimumu bul
    const match = String(tab.id).match(/tab-\d+-(\d+)/); // Kimlikten sayÄ± Ã§Ä±kar
    const value = match ? Number(match[1]) : 0; // SayÄ±ya Ã§evir
    return Number.isFinite(value) ? Math.max(max, value) : max; // Maks al
  }, 0); // BaÅŸlangÄ±Ã§
  appState.tabCounter = Math.max(maxCounter + 1, storedTabs.length + 1); // SayaÃ§ gÃ¼ncelle
  renderTabs(); // Sekmeleri Ã§iz
  const activeTab = getActiveTab(); // Aktif sekme
  if (activeTab) { // Aktif sekme varsa
    if (activeTab.snapshot?.language && activeTab.snapshot.language !== appState.language) setLanguage(activeTab.snapshot.language, { silent: true }); // Dil uygula
    restoreFromSnapshot(activeTab.snapshot, { persist: false, applyLanguage: false }); // SnapshotÄ± uygula
  }
  persistTabsState(); // Sekmeleri sakla
}

function handleNewTab() { // Yeni boÅŸ sekme aÃ§
  const snapshot = createEmptySnapshot(); // BoÅŸ snapshot
  const name = t('tabs.default', { index: appState.tabs.length + 1 }); // VarsayÄ±lan ad
  const id = `tab-${Date.now()}-${appState.tabCounter++}`; // Benzersiz kimlik
  const tab = { id, name, snapshot, dirty: false, createdAt: Date.now(), updatedAt: Date.now() }; // Sekme nesnesi
  appState.tabs.push(tab); // Listeye ekle
  appState.activeTabId = tab.id; // Aktif yap
  renderTabs(); // Sekmeleri yenile
  restoreFromSnapshot(snapshot, { persist: false, applyLanguage: false }); // BoÅŸ snapshotÄ± uygula
  persistTabsState(); // Sekmeleri sakla
}

function closeTab(tabId) { // Sekmeyi kapat
  const index = appState.tabs.findIndex(tab => tab.id === tabId); // Sekme indeksini bul
  if (index === -1) return; // Bulunamazsa Ã§Ä±k
  const tab = appState.tabs[index]; // Sekme referansÄ±
  if (appState.activeTabId === tabId) storeActiveTabSnapshot('close'); // Aktif sekmeyse snapshot al
  appState.tabs.splice(index, 1); // Sekmeyi listeden Ã§Ä±kar
  if (!appState.tabs.length) { // HiÃ§ sekme kalmadÄ±ysa
    const fallback = normalizeStoredTab({ snapshot: createEmptySnapshot(), name: t('tabs.default', { index: 1 }), dirty: false }, 0); // Yeni sekme oluÅŸtur
    appState.tabs.push(fallback); // Listeye ekle
    appState.activeTabId = fallback.id; // Aktif yap
    renderTabs(); // Sekmeleri Ã§iz
    restoreFromSnapshot(fallback.snapshot, { persist: false, applyLanguage: false }); // SnapshotÄ± uygula
    persistTabsState(); // Sekmeleri kaydet
    return; // TamamlandÄ±
  }
  if (appState.activeTabId === tabId) { // KapatÄ±lan sekme aktifse
    const nextIndex = index >= appState.tabs.length ? appState.tabs.length - 1 : index; // Yeni aktif indeks
    appState.activeTabId = appState.tabs[nextIndex].id; // Aktif kimliÄŸi ata
    restoreFromSnapshot(appState.tabs[nextIndex].snapshot, { persist: false, applyLanguage: false }); // SnapshotÄ± uygula
  }
  renderTabs(); // Sekmeleri yenile
  persistTabsState(); // Kaydet
}

function renameTab(tabId) { // Sekmeyi yeniden adlandÄ±r
  const tab = appState.tabs.find(item => item.id === tabId); // Sekmeyi bul
  if (!tab) return; // BulunamadÄ±ysa Ã§Ä±k
  const proposal = window.prompt(t('prompt.renameTab'), tab.name); // KullanÄ±cÄ± girdisi
  if (proposal === null) { // Ä°ptal edildi
    showGraphToast(t('toast.renameCancelled'), 'info'); // Bildirim
    return; // Ã‡Ä±k
  }
  const trimmed = proposal.trim(); // KÄ±rpÄ±lmÄ±ÅŸ metin
  if (!trimmed) { // BoÅŸsa
    showGraphToast(t('toast.renameRequired'), 'warning'); // UyarÄ± gÃ¶ster
    return; // Ã‡Ä±k
  }
  tab.name = trimmed; // Yeni adÄ± ata
  tab.updatedAt = Date.now(); // GÃ¼ncelleme zamanÄ± yaz
  renderTabs(); // Sekmeleri yenile
  persistTabsState(); // Sekmeleri kaydet
  showGraphToast(t('toast.renameDone'), 'success'); // BaÅŸarÄ± bildirimi
}

function reorderTabs(sourceId, targetId = null) { // Sekmeleri yeniden sÄ±rala
  const fromIndex = appState.tabs.findIndex(tab => tab.id === sourceId); // Kaynak indeks
  if (fromIndex === -1) return; // BulunamadÄ±ysa Ã§Ä±k
  const [tab] = appState.tabs.splice(fromIndex, 1); // Sekmeyi listeden Ã§Ä±kar
  if (!targetId) { // Hedef belirtilmediyse
    appState.tabs.push(tab); // Sona ekle
  } else {
    const toIndex = appState.tabs.findIndex(item => item.id === targetId); // Hedef indeks
    const safeIndex = toIndex === -1 ? appState.tabs.length : toIndex; // GÃ¼venli indeks
    appState.tabs.splice(safeIndex, 0, tab); // Ä°stenen yere ekle
  }
}

function storeActiveTabSnapshot(reason = 'update') { // Aktif sekmenin snapshotÄ±nÄ± gÃ¼ncelle
  const active = getActiveTab(); // Aktif sekme
  if (!active) return; // Yoksa Ã§Ä±k
  const snapshot = captureStatePayload(); // AnlÄ±k gÃ¶rÃ¼ntÃ¼
  updateActiveTabSnapshot(snapshot, { markDirty: undefined, reason }); // Kaydet ama kirli durumunu koru
}

function activateTab(tabId, options = {}) { // Sekme deÄŸiÅŸtir
  if (appState.activeTabId === tabId) return true; // Zaten aktif
  const target = appState.tabs.find(tab => tab.id === tabId); // Hedef sekme
  if (!target) return false; // BulunamadÄ±
  const current = getActiveTab(); // Mevcut aktif
  if (current && current.dirty && !options.force) { // KaydedilmemiÅŸ deÄŸiÅŸiklik varsa
    const proceed = window.confirm(t('confirm.unsavedTabSwitch')); // Onay iste
    if (!proceed) return false; // Ä°ptal edildi
  }
  if (current) storeActiveTabSnapshot('switch'); // Mevcut sekmeyi sakla
  appState.activeTabId = target.id; // Aktif kimliÄŸi gÃ¼ncelle
  renderTabs(); // Sekmeleri yenile
  restoreFromSnapshot(target.snapshot, { persist: false, applyLanguage: false }); // Hedef snapshotÄ± uygula
  persistTabsState(); // Sekmeleri kaydet
  return true; // BaÅŸarÄ±lÄ±
}

function handleTabClick(event) { // Sekme tÄ±klama delegasyonu
  const closeTarget = event.target.closest('.tab-close'); // Kapatma simgesi var mÄ±
  if (closeTarget && closeTarget.parentElement?.dataset?.tabId) { // Kapatma tÄ±klandÄ±ysa
    event.stopPropagation(); // KabarcÄ±ÄŸÄ± durdur
    closeTab(closeTarget.parentElement.dataset.tabId); // Sekmeyi kapat
    return; // Ä°ÅŸlem bitti
  }
  const button = event.target.closest('.tab-button'); // Sekme butonunu bul
  if (!button) return; // Yoksa Ã§Ä±k
  activateTab(button.dataset.tabId); // Sekmeyi etkinleÅŸtir
}

function handleTabDoubleClick(event) { // Sekme Ã§ift tÄ±klama iÅŸlemi
  const button = event.target.closest('.tab-button'); // Sekme butonunu al
  if (!button) return; // Yoksa Ã§Ä±k
  event.preventDefault(); // VarsayÄ±lanÄ± engelle
  renameTab(button.dataset.tabId); // Yeniden adlandÄ±r
}

function handleTabDragStart(event) { // Sekme sÃ¼rÃ¼kleme baÅŸlangÄ±cÄ±
  const button = event.target.closest('.tab-button'); // SÃ¼rÃ¼klenen buton
  if (!button) return; // Yoksa Ã§Ä±k
  draggingTabId = button.dataset.tabId; // KimliÄŸi sakla
  if (event.dataTransfer) { // DataTransfer varsa
    event.dataTransfer.setData('text/plain', draggingTabId); // KimliÄŸi veriye yaz
    event.dataTransfer.effectAllowed = 'move'; // Hareket izni ver
  }
}

function handleTabDragOver(event) { // Sekme sÃ¼rÃ¼kleme Ã¼stÃ¼nde
  if (!draggingTabId) return; // SÃ¼rÃ¼kleme yoksa Ã§Ä±k
  event.preventDefault(); // BÄ±rakmaya izin ver
  if (event.dataTransfer) event.dataTransfer.dropEffect = 'move'; // Etkiyi ayarla
}

function handleTabDrop(event) { // Sekme bÄ±rakma olayÄ±
  if (!draggingTabId) return; // SÃ¼rÃ¼klenen yoksa Ã§Ä±k
  event.preventDefault(); // VarsayÄ±lanÄ± engelle
  const button = event.target.closest('.tab-button'); // Hedef buton
  const targetId = button ? button.dataset.tabId : null; // Hedef kimlik
  reorderTabs(draggingTabId, targetId); // Sekmeleri sÄ±rala
  renderTabs(); // Sekme Ã§ubuÄŸunu yenile
  persistTabsState(); // Durumu kaydet
  draggingTabId = null; // SÃ¼rÃ¼kleme durumunu sÄ±fÄ±rla
}

function handleTabDragEnd() { // SÃ¼rÃ¼kleme bitiÅŸi
  draggingTabId = null; // BayraÄŸÄ± temizle
}

function renderSavedScenarioMenu() { // KayÄ±tlÄ± senaryo listesini menÃ¼ye yaz
  if (!loadMenuList) return; // Liste elemanÄ± yoksa Ã§Ä±k
  loadMenuList.innerHTML = ''; // Ä°Ã§eriÄŸi temizle
  const entries = loadScenarioStore(); // Depodaki kayÄ±tlarÄ± oku
  savedScenarios = entries.slice(); // Global listeyi gÃ¼ncelle
  if (!entries.length) { // HiÃ§ kayÄ±t yoksa
    const empty = document.createElement('div'); // BoÅŸ mesaj elemanÄ± oluÅŸtur
    empty.className = 'dropdown-empty'; // Stil sÄ±nÄ±fÄ± ata
    empty.dataset.i18n = 'toolbar.noScenarios'; // Ã‡eviri anahtarÄ± yaz
    empty.textContent = t('toolbar.noScenarios'); // Metni doldur
    loadMenuList.appendChild(empty); // Listeye ekle
    applyTranslations(loadMenuList); // Ã‡evirileri uygula
    return; // Ã‡Ä±k
  }
  entries.forEach(entry => { // Her kayÄ±t iÃ§in
    const button = document.createElement('button'); // MenÃ¼ butonu oluÅŸtur
    button.type = 'button'; // Buton tipini ayarla
    button.dataset.scenario = entry.name; // Senaryo adÄ±nÄ± veri olarak ata
    button.textContent = entry.name; // Buton metni
    if (entry.timestamp) { // Zaman bilgisi varsa
      try { // GÃ¼venli tarih formatÄ±
        button.title = new Date(entry.timestamp).toLocaleString(); // Ä°pucu olarak tarih yaz
      } catch (error) { // Hata yakala
        button.title = entry.name; // Yedek ipucu kullan
      }
    }
    loadMenuList.appendChild(button); // Butonu listeye ekle
  });
}

function handleSaveScenario() { // Senaryoyu kaydet
  storeActiveTabSnapshot('save'); // Aktif sekme snapshotÄ±nÄ± gÃ¼ncelle
  const active = getActiveTab(); // Aktif sekmeyi al
  const defaultName = active ? active.name : t('prompt.saveName'); // Ã–nerilen ad
  const input = window.prompt(t('prompt.saveName'), defaultName); // KullanÄ±cÄ±dan ad iste
  if (input === null) { // Ä°ptal edildiyse
    showGraphToast(t('toast.saveCancelled'), 'info'); // Bilgi ver
    return false; // BaÅŸarÄ±sÄ±z
  }
  const name = input.trim(); // AdÄ± kÄ±rp
  if (!name) { // BoÅŸ ad
    showGraphToast(t('toast.renameRequired'), 'warning'); // UyarÄ± gÃ¶ster
    return false; // BaÅŸarÄ±sÄ±z
  }
  const snapshot = captureStatePayload(); // Snapshot Ã§Ä±kar
  const entry = { name, snapshot, language: appState.language, timestamp: Date.now(), appVersion: APP_VERSION }; // KayÄ±t nesnesi
  const existingIndex = savedScenarios.findIndex(item => item.name === name); // Var olan kayÄ±t var mÄ±
  if (existingIndex !== -1) { // Ãœzerine yazma durumu
    const confirmOverwrite = window.confirm(t('confirm.overwrite')); // Onay al
    if (!confirmOverwrite) { // Reddedildiyse
      showGraphToast(t('toast.saveCancelled'), 'info'); // Bilgi ver
      return false; // Ã‡Ä±k
    }
    savedScenarios[existingIndex] = entry; // KaydÄ± gÃ¼ncelle
    showGraphToast(t('toast.saveOverwrite', { name }), 'success'); // BaÅŸarÄ± bildirimi
  } else {
    savedScenarios.push(entry); // Yeni kayÄ±t ekle
    showGraphToast(t('toast.saveSuccess', { name }), 'success'); // BaÅŸarÄ± bildirimi
  }
  persistScenarioStore(savedScenarios); // Depoyu yaz
  updateActiveTabSnapshot(snapshot, { markDirty: false, reason: 'save' }); // Sekmeyi temiz olarak iÅŸaretle
  renderTabs(); // Sekmeleri yenile
  renderSavedScenarioMenu(); // KayÄ±t listesini tazele
  return true; // BaÅŸarÄ±lÄ±
}

function handleLoadScenario(name) { // Senaryoyu yÃ¼kle
  if (!name) { // GeÃ§ersiz ad kontrolÃ¼
    showGraphToast(t('toast.loadEmpty'), 'info'); // Bilgi ver
    return false; // BaÅŸarÄ±sÄ±z
  }
  savedScenarios = loadScenarioStore(); // Depoyu tazele
  if (!savedScenarios.length) { // KayÄ±t yoksa
    showGraphToast(t('toast.loadEmpty'), 'info'); // Bilgi ver
    renderSavedScenarioMenu(); // Listeyi boÅŸ gÃ¶ster
    return false; // Ã‡Ä±k
  }
  const entry = savedScenarios.find(item => item.name === name); // KaydÄ± bul
  if (!entry) { // BulunamadÄ±ysa
    showGraphToast(t('toast.loadEmpty'), 'info'); // Bilgi ver
    renderSavedScenarioMenu(); // Listeyi gÃ¼ncelle
    return false; // Ã‡Ä±k
  }
  if (entry.language && entry.language !== appState.language) setLanguage(entry.language, { silent: true }); // Dil uygula
  const snapshot = normalizeSnapshot(entry.snapshot); // SnapshotÄ± temizle
  const id = `tab-${Date.now()}-${appState.tabCounter++}`; // Benzersiz sekme kimliÄŸi
  const tab = { id, name: entry.name, snapshot, dirty: false, createdAt: entry.timestamp || Date.now(), updatedAt: Date.now() }; // Sekme nesnesi
  appState.tabs.push(tab); // Listeye ekle
  appState.activeTabId = id; // Aktif yap
  renderTabs(); // Sekmeleri yenile
  restoreFromSnapshot(snapshot, { persist: false, applyLanguage: false }); // Durumu uygula
  updateActiveTabSnapshot(snapshot, { markDirty: false, reason: 'load' }); // Sekmeyi temizle
  persistTabsState(); // Sekmeleri sakla
  showGraphToast(t('toast.loadSuccess', { name: entry.name }), 'success'); // BaÅŸarÄ± bildirimi
  renderSavedScenarioMenu(); // KayÄ±t listesini gÃ¼ncelle
  return true; // BaÅŸarÄ±lÄ±
}

function clearActiveTab() { // Aktif sekmeyi temizle
  const confirmClear = window.confirm(t('confirm.clear')); // Onay iste
  if (!confirmClear) return false; // Ä°ptal edildi
  cancelConnectionDraft('mode-change'); // Aktif taslaÄŸÄ± kapat
  if (appState.simulation) stopSimulation(false); // SimÃ¼lasyonu durdur
  resetSimulation(); // Motoru sÄ±fÄ±rla
  appState.simulation = null; // Motor referansÄ±nÄ± temizle
  appState.stations = []; // Ä°stasyon listesini boÅŸalt
  appState.nextStationId = 1; // Kimlik sayacÄ±nÄ± sÄ±fÄ±rla
  appState.targetCount = null; // Hedefi sÄ±fÄ±rla
  appState.entryPolicy = 'trigger'; // GiriÅŸ politikasÄ±nÄ± varsay
  appState.entryInterval = 30; // AralÄ±ÄŸÄ± varsay
  appState.taktTime = null; // Takt time sÄ±fÄ±rla
  appState.zoom = 1; // Zoom sÄ±fÄ±rla
  appState.speed = 1; // HÄ±zÄ± varsay
  viz.clearJobs(); // BaloncuklarÄ± temizle
  viz.setSpeed(appState.speed); // GÃ¶rsel hÄ±zÄ±nÄ± sÄ±fÄ±rla
  updateZoomDisplay(); // Zoom gÃ¶stergesini yenile
  syncControlsFromState(); // Kontrolleri hizala
  renderStations(); // KartlarÄ± boÅŸalt
  renderGraph(appState.stations); // GrafiÄŸi temizle
  updateCompletedCounter(0); // SayaÃ§ sÄ±fÄ±rla
  const snapshot = captureStatePayload(); // Yeni snapshot Ã§Ä±kar
  updateActiveTabSnapshot(snapshot, { markDirty: true, reason: 'clear' }); // Sekmeyi kirli iÅŸaretle
  showGraphToast(t('toast.clearDone'), 'success'); // BaÅŸarÄ± bildirimi
  renderTabs(); // Sekme gÃ¶stergesini yenile
  return true; // BaÅŸarÄ±lÄ±
}

function syncLanguageOptions() { // Dil buton durumlarÄ±nÄ± senkronize et
  if (!viewMenu) return; // MenÃ¼ yoksa Ã§Ä±k
  const buttons = viewMenu.querySelectorAll('button[data-lang]'); // Dil butonlarÄ±nÄ± seÃ§
  buttons.forEach(button => { // Her butonu iÅŸle
    const isActive = button.dataset.lang === appState.language; // Aktif mi kontrol et
    button.classList.toggle('active', isActive); // SÄ±nÄ±fÄ± gÃ¼ncelle
    button.setAttribute('aria-pressed', isActive ? 'true' : 'false'); // ARIA durumunu yaz
  });
}

function setLanguage(lang, options = {}) { // Dili deÄŸiÅŸtir
  const { silent = false } = options; // Sessiz mod parametresi
  const normalized = translations[lang] ? lang : 'tr'; // GeÃ§erli dili seÃ§
  if (appState.language === normalized) return; // Zaten seÃ§iliyse Ã§Ä±k
  appState.language = normalized; // Durumu gÃ¼ncelle
  document.documentElement.lang = normalized; // HTML dilini ayarla
  persistLanguagePreference(normalized); // Tercihi kaydet
  applyTranslations(document); // Metinleri Ã§evir
  syncLanguageOptions(); // Dil butonlarÄ±nÄ± gÃ¼ncelle
  renderTabs(); // Sekme baÅŸlÄ±klarÄ±nÄ± yenile
  renderStations(); // Ä°stasyon kartlarÄ±nÄ± yeniden Ã§iz
  syncControlsFromState(); // Kontrolleri hizala
  updateCompletedCounter(appState.completedDisplayCount || 0); // SayaÃ§ Ã§evirisini yenile
  if (!silent) { // Sessiz deÄŸilse
    const label = languageNames[normalized] || normalized.toUpperCase(); // Dil adÄ±
    showGraphToast(t('toast.languageUpdated', { language: label }), 'info'); // Bildirim gÃ¶ster
  }
}

function closeDropdownMenu() { // AÃ§Ä±k menÃ¼yÃ¼ kapat
  if (openDropdownMenu) openDropdownMenu.style.display = 'none'; // MenÃ¼ gizle
  if (openDropdownTrigger) openDropdownTrigger.setAttribute('aria-expanded', 'false'); // Tetikleyici durumunu sÄ±fÄ±rla
  if (dropdownOutsideHandler) document.removeEventListener('mousedown', dropdownOutsideHandler, true); // Dinleyiciyi kaldÄ±r
  openDropdownMenu = null; // MenÃ¼ referansÄ±nÄ± sÄ±fÄ±rla
  openDropdownTrigger = null; // Tetikleyici referansÄ±nÄ± temizle
  dropdownOutsideHandler = null; // Dinleyiciyi sÄ±fÄ±rla
}

function openDropdownMenuFor(menuEl, triggerBtn = null) { // Belirli menÃ¼yÃ¼ aÃ§
  if (!menuEl) return; // MenÃ¼ yoksa Ã§Ä±k
  if (openDropdownMenu && openDropdownMenu !== menuEl) closeDropdownMenu(); // Ã–ncekini kapat
  menuEl.style.display = 'flex'; // GÃ¶ster
  menuEl.style.flexDirection = 'column'; // Dikey sÄ±rala
  openDropdownMenu = menuEl; // MenÃ¼ referansÄ±nÄ± kaydet
  openDropdownTrigger = triggerBtn || null; // Tetikleyiciyi sakla
  if (openDropdownTrigger) openDropdownTrigger.setAttribute('aria-expanded', 'true'); // Tetikleyiciyi iÅŸaretle
  dropdownOutsideHandler = event => { // DÄ±ÅŸ tÄ±klama dinleyicisi
    if (!openDropdownMenu) return; // MenÃ¼ yoksa Ã§Ä±k
    if (openDropdownMenu.contains(event.target)) return; // MenÃ¼ iÃ§inde ise Ã§Ä±k
    if (openDropdownTrigger && (openDropdownTrigger === event.target || openDropdownTrigger.contains(event.target))) return; // Tetikleyici ise Ã§Ä±k
    closeDropdownMenu(); // MenÃ¼yÃ¼ kapat
  }; // Dinleyici sonu
  document.addEventListener('mousedown', dropdownOutsideHandler, true); // Dinleyiciyi baÄŸla
}

function toggleDropdown(menuEl, triggerBtn = null) { // AÃ§Ä±lÄ±r menÃ¼yÃ¼ aÃ§/kapat
  if (!menuEl) return; // MenÃ¼ yoksa Ã§Ä±k
  if (openDropdownMenu === menuEl) { // Zaten aÃ§Ä±k mÄ±
    closeDropdownMenu(); // Kapat
  } else {
    openDropdownMenuFor(menuEl, triggerBtn); // AÃ§
    applyTranslations(menuEl); // MenÃ¼ metinlerini gÃ¼ncelle
  }
}

// YardÄ±mcÄ± sabitler //
const MAX_SERVERS = 16; // Maksimum paralel sunucu sayÄ±sÄ±
const UPDATE_INTERVAL_MS = 150; // UI metrik gÃ¼ncelleme aralÄ±ÄŸÄ±
const MOVE_DURATION_MS = 900; // Baloncuk hareket sÃ¼resi
const LOGICAL_RATE = 4; // 1 saniyede iÅŸlenecek mantÄ±ksal saniye

// KÃ¼resel durum //
const appState = window.appState ?? { // Uygulama genel durumu
  stations: [], // Ä°stasyon model listesi
  running: false, // SimÃ¼lasyon Ã§alÄ±ÅŸÄ±yor mu
  targetCount: null, // Hedef Ã¼rÃ¼n adedi
  entryPolicy: 'trigger', // GiriÅŸ politikasÄ± seÃ§imi
  entryInterval: 30, // Sabit giriÅŸ aralÄ±ÄŸÄ±
  speed: 1, // Animasyon hÄ±zÄ±
  zoom: 1, // GÃ¶rsel Ã¶lÃ§ek
  taktTime: null, // Takt time deÄŸeri
  simulation: null, // SimÃ¼lasyon motoru referansÄ±
  lastUpdate: 0, // Son UI gÃ¼ncelleme zamanÄ±
  lastMetricRefresh: 0, // Son metrik yenileme zamanÄ±
  visualCursor: 0, // GÃ¶rsel zaman imleci
  nextStationId: 1, // Bir sonraki istasyon numarasÄ±
  mode: 'view', // Ekran modu
  pausedForEdit: false, // DÃ¼zenleme iÃ§in duraklatÄ±ldÄ± mÄ±
  language: loadLanguagePreference(), // Aktif dil
  tabs: [], // AÃ§Ä±k sekmeler
  activeTabId: null, // Aktif sekme kimliÄŸi
  tabCounter: 1, // Sekme kimliÄŸi Ã¼reteci
  edgeDraft: null, // BaÄŸlantÄ± oluÅŸturma durumu
  completedDisplayCount: 0 // GÃ¶rÃ¼ntÃ¼lenen tamamlanan sayÄ±sÄ±
};
window.appState = appState; // Durumu kÃ¼resele yaz
document.body.dataset.editMode = appState.mode; // BaÅŸlangÄ±Ã§ modunu body'ye iÅŸle
document.documentElement.lang = appState.language; // HTML dilini ayarla

let renderingPaused = false; // GeÃ§ici olarak yeniden Ã§izimi durdurma bayraÄŸÄ±

function loadPersistedState() { // Yerel depolamadan aÃ§Ä±k sekmeleri oku
  if (typeof localStorage === 'undefined') { // TarayÄ±cÄ± desteklemiyorsa
    return { tabs: [], activeTabId: null, legacySnapshot: null }; // BoÅŸ dÃ¶nÃ¼ÅŸ
  }
  try {
    const raw = localStorage.getItem(OPEN_TABS_KEY); // Sekme dizisini al
    if (raw) { // Veri bulunduysa
      const parsed = JSON.parse(raw); // JSON Ã§Ã¶z
      const tabs = Array.isArray(parsed.tabs) ? parsed.tabs : []; // Sekmeleri doÄŸrula
      const activeTabId = typeof parsed.activeTabId === 'string' ? parsed.activeTabId : (tabs[0]?.id ?? null); // Aktif sekme seÃ§
      return { tabs, activeTabId, legacySnapshot: null }; // Sonucu dÃ¶ndÃ¼r
    }
    const legacyRaw = localStorage.getItem(LEGACY_STORAGE_KEY); // Eski anahtarÄ± dene
    if (legacyRaw) { // Eski kayÄ±t varsa
      const legacySnapshot = JSON.parse(legacyRaw); // JSON Ã§Ã¶z
      return { tabs: [], activeTabId: null, legacySnapshot }; // Eski snapshot ile dÃ¶n
    }
  } catch (error) {
    console.warn('Sekme durumu yÃ¼klenirken hata:', error); // Hata logla
  }
  return { tabs: [], activeTabId: null, legacySnapshot: null }; // VarsayÄ±lan
}

function loadLanguagePreference() { // Dil tercihlerini oku
  if (typeof localStorage === 'undefined') return 'tr'; // VarsayÄ±lan TÃ¼rkÃ§e
  const stored = localStorage.getItem(LANGUAGE_KEY); // KaydÄ± al
  return stored === 'en' || stored === 'de' ? stored : 'tr'; // GeÃ§erli dillerden birini dÃ¶ndÃ¼r
}

function persistLanguagePreference(lang) { // Dil tercihini kaydet
  if (typeof localStorage === 'undefined') return; // Ortam korumasÄ±
  try {
    localStorage.setItem(LANGUAGE_KEY, lang); // Dil deÄŸerini yaz
  } catch (error) {
    console.warn('Dil tercihi kaydedilemedi:', error); // Hata logla
  }
}

function loadScenarioStore() { // KaydedilmiÅŸ senaryolarÄ± oku
  if (typeof localStorage === 'undefined') return []; // TarayÄ±cÄ± korumasÄ±
  try {
    const raw = localStorage.getItem(SCENARIO_STORE_KEY); // Ham veri al
    if (!raw) return []; // Veri yoksa boÅŸ
    const parsed = JSON.parse(raw); // JSON Ã§Ã¶z
    if (!Array.isArray(parsed)) return []; // Dizi deÄŸilse boÅŸ
    return parsed.filter(item => item && typeof item === 'object' && typeof item.name === 'string'); // GeÃ§erli kayÄ±tlarÄ± dÃ¶ndÃ¼r
  } catch (error) {
    console.warn('Senaryo deposu okunamadÄ±:', error); // Hata logla
    return []; // GÃ¼venli dÃ¶nÃ¼ÅŸ
  }
}

function persistScenarioStore(store) { // Senaryo deposunu yaz
  if (typeof localStorage === 'undefined') return; // TarayÄ±cÄ± korumasÄ±
  try {
    localStorage.setItem(SCENARIO_STORE_KEY, JSON.stringify(store)); // JSON olarak kaydet
  } catch (error) {
    console.warn('Senaryo deposu kaydedilirken hata:', error); // Hata logla
  }
}

function loadCrashSnapshotPayload() { // Kurtarma anlÄ±k gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ oku
  if (typeof localStorage === 'undefined') return null; // TarayÄ±cÄ± korumasÄ±
  try {
    const raw = localStorage.getItem(SNAPSHOT_KEY); // Ham veriyi al
    if (!raw) return null; // Veri yoksa Ã§Ä±k
    if (raw.length > 2 * 1024 * 1024) { // Boyut sÄ±nÄ±rÄ±
      localStorage.removeItem(SNAPSHOT_KEY); // AÅŸÄ±mda temizle
      return null; // Veri yok say
    }
    const parsed = JSON.parse(raw); // JSON Ã§Ã¶z
    if (!parsed || typeof parsed !== 'object' || !parsed.snapshot) return null; // GeÃ§ersizse Ã§Ä±k
    return {
      snapshot: parsed.snapshot, // Snapshot verisi
      savedAt: parsed.savedAt || Date.now(), // Kaydedilme zamanÄ±
      reason: parsed.reason || 'unknown' // Sebep bilgisi
    }; // YapÄ±yÄ± dÃ¶ndÃ¼r
  } catch (error) {
    console.warn('Kurtarma verisi okunamadÄ±:', error); // Hata logla
    return null; // GÃ¼venli Ã§Ä±k
  }
}

function clearCrashSnapshot() { // Kurtarma verisini temizle
  if (typeof localStorage === 'undefined') return; // TarayÄ±cÄ± korumasÄ±
  try {
    localStorage.removeItem(SNAPSHOT_KEY); // AnahtarÄ± sil
  } catch (error) {
    console.warn('Kurtarma verisi silinemedi:', error); // Hata logla
  }
}

function shouldPromptRestore() { // Kurtarma uyarÄ±sÄ± gÃ¶sterilmeli mi
  if (typeof localStorage === 'undefined') return false; // TarayÄ±cÄ± korumasÄ±
  return localStorage.getItem(RESTORE_PROMPT_KEY) !== 'off'; // Tercihi kontrol et
}

function showRestorePrompt(payload) { // Kurtarma modalÄ±nÄ± aÃ§
  if (!restoreModal) return; // Modal yoksa Ã§Ä±k
  pendingRestoreSnapshot = payload; // Veriyi sakla
  restoreModal.classList.add('active'); // ModalÄ± gÃ¶rÃ¼nÃ¼r yap
  applyTranslations(restoreModal); // Metinleri gÃ¼ncelle
}

function hideRestorePrompt() { // Kurtarma modalÄ±nÄ± kapat
  if (!restoreModal) return; // Modal yoksa Ã§Ä±k
  restoreModal.classList.remove('active'); // SÄ±nÄ±fÄ± kaldÄ±r
  pendingRestoreSnapshot = null; // Veriyi temizle
}

function handleRestoreConfirm() { // Kurtarma onayÄ± iÅŸle
  if (!pendingRestoreSnapshot) { hideRestorePrompt(); return; } // Veri yoksa Ã§Ä±k
  const payload = pendingRestoreSnapshot; // Veriyi al
  hideRestorePrompt(); // ModalÄ± kapat
  clearCrashSnapshot(); // SnapshotÄ± temizle
  const snapshot = normalizeSnapshot(payload.snapshot); // SnapshotÄ± temizle
  const locale = appState.language === 'en' ? 'en-US' : appState.language === 'de' ? 'de-DE' : 'tr-TR'; // Tarih yereli
  const formatter = new Intl.DateTimeFormat(locale, { dateStyle: 'short', timeStyle: 'short' }); // FormatlayÄ±cÄ±
  const stamp = formatter.format(new Date(payload.savedAt || Date.now())); // Zaman damgasÄ±
  const tabName = t('tabs.restore', { stamp }); // Sekme adÄ±
  const id = `tab-${Date.now()}-${appState.tabCounter++}`; // Benzersiz kimlik
  const tab = { id, name: tabName, snapshot, dirty: false, createdAt: payload.savedAt || Date.now(), updatedAt: Date.now() }; // Sekme nesnesi
  appState.tabs.push(tab); // Sekme ekle
  appState.activeTabId = id; // Aktif yap
  renderTabs(); // Sekmeleri yenile
  if (snapshot.language && snapshot.language !== appState.language) setLanguage(snapshot.language, { silent: true }); // Dil uygula
  restoreFromSnapshot(snapshot, { persist: false, applyLanguage: false }); // SnapshotÄ± uygula
  updateActiveTabSnapshot(snapshot, { markDirty: false, reason: 'restore' }); // Sekmeyi temizle
  persistTabsState(); // Sekmeleri kaydet
  showGraphToast(t('toast.snapshotRestored'), 'success'); // BaÅŸarÄ± bildirimi
}

function handleRestoreDecline() { // Kurtarma reddi
  hideRestorePrompt(); // ModalÄ± kapat
  clearCrashSnapshot(); // SnapshotÄ± temizle
  showGraphToast(t('toast.snapshotDeclined'), 'info'); // Bilgi ver
}

function handleRestoreNever() { // Bir daha sorma seÃ§eneÄŸi
  hideRestorePrompt(); // ModalÄ± kapat
  clearCrashSnapshot(); // SnapshotÄ± temizle
  if (typeof localStorage !== 'undefined') localStorage.setItem(RESTORE_PROMPT_KEY, 'off'); // Tercihi yaz
  showGraphToast(t('toast.snapshotDeclined'), 'info'); // Bilgi ver
}

function captureStatePayload(state = appState) { // Aktif sekme anlÄ±k gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ hazÄ±rla
  return {
    stations: state.stations.map(st => ({ // Her istasyon iÃ§in kopya
      id: st.id, // Kimlik
      name: st.name, // Ä°sim
      parallelServers: st.parallelServers, // OperatÃ¶r
      position: st.position ? { x: st.position.x, y: st.position.y } : null, // Konum
      outputs: Array.isArray(st.outputs) ? st.outputs.slice() : [], // Ã‡Ä±kÄ±ÅŸlar
      tasks: st.tasks.map(task => ({ // GÃ¶rev listesi
        name: task.name, // GÃ¶rev adÄ±
        operators: task.operators, // OperatÃ¶r sayÄ±sÄ±
        durationSec: task.durationSec // SÃ¼re
      }))
    })),
    targetCount: state.targetCount ?? null, // Hedef adet
    entryPolicy: state.entryPolicy, // GiriÅŸ politikasÄ±
    entryInterval: state.entryInterval, // GiriÅŸ aralÄ±ÄŸÄ±
    speed: state.speed, // HÄ±z deÄŸeri
    zoom: state.zoom, // YakÄ±nlaÅŸtÄ±rma
    taktTime: state.taktTime ?? null, // Takt zamanÄ±
    nextStationId: state.nextStationId, // Sonraki istasyon kimliÄŸi
    mode: state.mode, // ArayÃ¼z modu
    language: state.language, // Dil ayarÄ±
    timestamp: Date.now(), // Zaman damgasÄ±
    appVersion: APP_VERSION // SÃ¼rÃ¼m bilgisi
  }; // Snapshot dÃ¶ndÃ¼r
}

function persistTabsState() { // Sekme durumunu yerelde sakla
  if (typeof localStorage === 'undefined') return; // Ortam korumasÄ±
  try {
    const payload = { // YazÄ±lacak veri
      tabs: appState.tabs.map(tab => ({ // Her sekme iÃ§in
        id: tab.id, // Kimlik
        name: tab.name, // Ad
        snapshot: tab.snapshot, // AnlÄ±k gÃ¶rÃ¼ntÃ¼
        createdAt: tab.createdAt, // OluÅŸturulma
        updatedAt: tab.updatedAt, // GÃ¼ncellenme
        dirty: !!tab.dirty // KaydedilmemiÅŸ deÄŸiÅŸiklik bayraÄŸÄ±
      })),
      activeTabId: appState.activeTabId // Aktif sekme kimliÄŸi
    };
    localStorage.setItem(OPEN_TABS_KEY, JSON.stringify(payload)); // JSON olarak kaydet
  } catch (error) {
    console.warn('Sekme durumu kaydedilemedi:', error); // Hata logla
  }
}

let crashSnapshotTimer = null; // Ã‡Ã¶kme anlÄ±k gÃ¶rÃ¼ntÃ¼sÃ¼ zamanlayÄ±cÄ±sÄ±

function scheduleCrashSnapshot(reason = 'update') { // Ã‡Ã¶kme kurtarma iÃ§in zamanlayÄ±cÄ± ayarla
  if (typeof localStorage === 'undefined') return; // Ortam korumasÄ±
  if (crashSnapshotTimer) clearTimeout(crashSnapshotTimer); // Ã–nceki zamanlayÄ±cÄ±yÄ± iptal et
  crashSnapshotTimer = window.setTimeout(() => writeCrashSnapshot(reason), 1000); // 1 sn sonra yaz
}

function writeCrashSnapshot(reason = 'manual') { // Ã‡Ã¶kme kurtarma gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ yaz
  if (typeof localStorage === 'undefined') return; // Ortam korumasÄ±
  try {
    const snapshot = captureStatePayload(); // GÃ¼ncel snapshot
    const payload = { snapshot, reason, savedAt: Date.now() }; // Kaydedilecek veri
    localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(payload)); // JSON olarak sakla
  } catch (error) {
    console.warn('Kurtarma gÃ¶rÃ¼ntÃ¼sÃ¼ kaydedilemedi:', error); // Hata logla
  }
}

function saveState(state = appState, reason = 'update') { // Aktif sekmeyi gÃ¼ncelle
  const snapshot = captureStatePayload(state); // Snapshot Ã¼ret
  updateActiveTabSnapshot(snapshot, { markDirty: true, reason }); // Sekmeye uygula
}

function updateActiveTabSnapshot(snapshot, options = {}) { // Sekme snapshotÄ±nÄ± gÃ¼ncelle
  if (!snapshot) return; // GeÃ§ersizse Ã§Ä±k
  const active = appState.tabs.find(tab => tab.id === appState.activeTabId); // Aktif sekmeyi bul
  if (!active) return; // Yoksa Ã§Ä±k
  active.snapshot = snapshot; // Snapshot ata
  active.updatedAt = Date.now(); // GÃ¼ncelleme zamanÄ± yaz
  if (options.markDirty === true) active.dirty = true; // Kirli bayraÄŸÄ±nÄ± ayarla
  if (options.markDirty === false) active.dirty = false; // Temiz olarak iÅŸaretle
  persistTabsState(); // Sekmeleri kaydet
  scheduleCrashSnapshot(options.reason || 'update'); // Kurtarma iÃ§in zamanla
}

// Model sÄ±nÄ±flarÄ± //
class Task { // GÃ¶rev modeli
  constructor(name, operators, durationSec) { // Kurucu
    this.name = name; // GÃ¶rev adÄ±
    this.operators = operators; // OperatÃ¶r sayÄ±sÄ±
    this.durationSec = durationSec; // SÃ¼re
  }
}

class Station { // Ä°stasyon modeli
  constructor(id, name) { // Kurucu
    this.id = id; // Kimlik
    this.name = name; // Ä°sim
    this.tasks = []; // GÃ¶rev listesi
    this.parallelServers = 1; // Paralel sunucu sayÄ±sÄ±
    this.outputs = []; // Ã‡Ä±kÄ±ÅŸ baÄŸlantÄ±larÄ± listesi
    this.position = { x: 0, y: 0 }; // YerleÅŸim koordinatÄ±
  }
  totalDuration() { // Toplam gÃ¶rev sÃ¼resi hesaplar
    return this.tasks.reduce((sum, task) => sum + task.durationSec, 0); // SÃ¼relerin toplamÄ±
  }
}

class FastQueue { // O(1) kuyruk yapÄ±sÄ±
  constructor() { // Kurucu
    this.store = []; // Ä°Ã§ dizi
    this.head = 0; // BaÅŸ iÅŸaretÃ§isi
  }
  enqueue(item) { // KuyruÄŸa ekle
    this.store.push(item); // Dizinin sonuna ekle
  }
  dequeue() { // Kuyruktan Ã§Ä±kar
    if (this.head >= this.store.length) return null; // BoÅŸsa null dÃ¶ndÃ¼r
    const value = this.store[this.head]; // Ä°lk elemanÄ± al
    this.head += 1; // BaÅŸ iÅŸaretÃ§isini ilerlet
    if (this.head > 32 && this.head * 2 > this.store.length) { // Temizlik eÅŸiÄŸi
      this.store = this.store.slice(this.head); // Diziyi daralt
      this.head = 0; // BaÅŸ iÅŸaretÃ§isini sÄ±fÄ±rla
    }
    return value; // ElemanÄ± dÃ¶ndÃ¼r
  }
  peekAll() { // Kuyruktaki aktif elemanlarÄ± dÃ¶ndÃ¼r
    return this.store.slice(this.head); // Aktif parÃ§ayÄ± kopyala
  }
  get length() { // Uzunluk hesapla
    return this.store.length - this.head; // Aktif eleman sayÄ±sÄ±
  }
}

class MinHeap { // Ã–ncelik kuyruÄŸu
  constructor(compare) { // Kurucu
    this.compare = compare; // KarÅŸÄ±laÅŸtÄ±rma fonksiyonu
    this.data = []; // Depolama dizisi
  }
  peek() { // En kÃ¼Ã§Ã¼k elemanÄ± getir
    return this.data.length ? this.data[0] : null; // Ä°lk eleman veya null
  }
  push(value) { // Yeni eleman ekle
    this.data.push(value); // Dizinin sonuna ekle
    this.bubbleUp(this.data.length - 1); // YukarÄ± dÃ¼zelt
  }
  pop() { // En kÃ¼Ã§Ã¼k elemanÄ± Ã§Ä±kar
    if (!this.data.length) return null; // BoÅŸsa null
    const top = this.data[0]; // KÃ¶kÃ¼ sakla
    const last = this.data.pop(); // Son elemanÄ± al
    if (this.data.length) { // HÃ¢lÃ¢ eleman varsa
      this.data[0] = last; // KÃ¶kÃ¼ son elemanla deÄŸiÅŸtir
      this.bubbleDown(0); // AÅŸaÄŸÄ± dÃ¼zelt
    }
    return top; // Eski kÃ¶kÃ¼ dÃ¶ndÃ¼r
  }
  size() { // Eleman sayÄ±sÄ±
    return this.data.length; // Uzunluk dÃ¶ndÃ¼r
  }
  bubbleUp(index) { // YukarÄ± taÅŸÄ±ma
    while (index > 0) { // KÃ¶k deÄŸilse
      const parent = Math.floor((index - 1) / 2); // Ebeveyn indeks
      if (this.compare(this.data[index], this.data[parent]) >= 0) break; // Yerinde ise Ã§Ä±k
      [this.data[index], this.data[parent]] = [this.data[parent], this.data[index]]; // ElemanlarÄ± deÄŸiÅŸtir
      index = parent; // Ä°ndeksi ebeveyne ayarla
    }
  }
  bubbleDown(index) { // AÅŸaÄŸÄ± taÅŸÄ±ma
    const length = this.data.length; // Uzunluk Ã¶nbelleÄŸi
    while (true) { // DÃ¶ngÃ¼
      let smallest = index; // En kÃ¼Ã§Ã¼k baÅŸlangÄ±Ã§
      const left = 2 * index + 1; // Sol Ã§ocuk
      const right = left + 1; // SaÄŸ Ã§ocuk
      if (left < length && this.compare(this.data[left], this.data[smallest]) < 0) smallest = left; // Sol daha kÃ¼Ã§Ã¼kse
      if (right < length && this.compare(this.data[right], this.data[smallest]) < 0) smallest = right; // SaÄŸ daha kÃ¼Ã§Ã¼kse
      if (smallest === index) break; // Yerinde ise Ã§Ä±k
      [this.data[index], this.data[smallest]] = [this.data[smallest], this.data[index]]; // ElemanlarÄ± deÄŸiÅŸtir
      index = smallest; // Ä°ndeksi gÃ¼ncelle
    }
  }
}

// SimÃ¼lasyon motoru //
class SimulationEngine { // Motor sÄ±nÄ±fÄ±
  constructor(stations, options, viz) { // Kurucu
    this.stations = stations; // Ä°stasyon modelleri
    this.options = options; // SeÃ§enekler
    this.viz = viz; // GÃ¶rselleÅŸtirme referansÄ±
    this.onLiveUpdate = null; // CanlÄ± snapshot geri Ã§aÄŸrÄ±sÄ±
    this.stationIndexById = new Map(); // Ä°stasyon indeks haritasÄ±
    this.stations.forEach((station, index) => { // TÃ¼m istasyonlarÄ± dolaÅŸ
      if (!Array.isArray(station.outputs)) station.outputs = []; // Ã‡Ä±kÄ±ÅŸ listesini normalize et
      this.stationIndexById.set(station.id, index); // Kimlikten indeks ata
    });
    const incoming = new Set(); // GiriÅŸ yapan istasyonlarÄ± takip et
    this.stations.forEach(station => { // Her istasyon iÃ§in
      (Array.isArray(station.outputs) ? station.outputs : []).forEach(targetId => incoming.add(targetId)); // Hedefleri iÅŸaretle
    });
    this.entryStations = this.stations // GiriÅŸ dÃ¼ÄŸÃ¼mlerini hesapla
      .filter(station => !incoming.has(station.id)) // GiriÅŸi olmayanlarÄ± seÃ§
      .map(station => station.id); // Kimlik listesi
    if (!this.entryStations.length && this.stations.length) { // HiÃ§ giriÅŸ yoksa
      this.entryStations = [this.stations[0].id]; // Ä°lk istasyonu varsay
    }
    this.reset(); // BaÅŸlangÄ±Ã§ sÄ±fÄ±rlama
  }
  reset() { // TÃ¼m durum sÄ±fÄ±rlama
    this.currentTime = 0; // MantÄ±ksal zaman
    this.eventQueue = new MinHeap(this.compareEvents); // Olay Ã¶ncelik kuyruÄŸu
    this.nextJobId = 1; // Yeni iÅŸ kimliÄŸi
    this.running = false; // Ã‡alÄ±ÅŸma bayraÄŸÄ±
    this.completedJobs = []; // Tamamlanan iÅŸler
    this.runtimeStations = this.stations.map(station => ({ // Ã‡alÄ±ÅŸma zamanlÄ± istasyon durumlarÄ±
      station, // Referans
      queue: new FastQueue(), // Kuyruk iÅŸ kimlikleri
      servers: Array.from({ length: station.parallelServers }, () => null), // Sunucular
      queueLength: 0, // AnlÄ±k kuyruk uzunluÄŸu
      lastQueueUpdate: 0, // Son gÃ¼ncelleme zamanÄ±
      queueArea: 0, // Kuyruk uzunluÄŸu integrali
      busyCount: 0, // AnlÄ±k meÅŸgul sunucu adedi
      lastBusyUpdate: 0, // Son meÅŸgul gÃ¼ncellemesi
      busyArea: 0, // MeÅŸgul integrali
      idleArea: 0, // BoÅŸ kalan sunucu zamanÄ±
      totalWaitTime: 0, // Toplam bekleme sÃ¼resi
      serviceTimeAccum: 0, // Toplam servis sÃ¼resi
      serviceCount: 0, // Toplam servis adedi
      dispatchCursor: 0 // Round-robin Ã§Ä±kÄ±ÅŸ imleci
    }));
    this.entrySpawnCursor = 0; // GiriÅŸ istasyon seÃ§im imlecini sÄ±fÄ±rla
    this.jobs = new Map(); // Ä°ÅŸ nesneleri haritasÄ±
    this.wipCount = 0; // AnlÄ±k WIP
    this.wipArea = 0; // WIP integrali
    this.lastWipUpdate = 0; // Son WIP gÃ¼ncellemesi
    this.lastEventTime = 0; // Son iÅŸlem zamanÄ±
    this.engineCursor = 0; // MantÄ±ksal hedef zaman
    this.pendingStop = false; // Durdurma isteÄŸi
    this.viz.clearJobs(); // GÃ¶rsel baloncuklarÄ± temizle
    this.forkStats = new Map(this.stations.map(station => [station.id, { producedParts: 0, forkEvents: 0 }])); // Fork istatistiklerini sÄ±fÄ±rla
  }
  compareEvents = (a, b) => (a.time - b.time) || ((a.order || 0) - (b.order || 0)); // Olay karÅŸÄ±laÅŸtÄ±rÄ±cÄ±sÄ±
  schedule(event) { // OlayÄ± kuyruÄŸa ekle
    this.eventQueue.push(event); // KuyruÄŸa ekle
  }
  resolveEntryStation(preferredId) { // GiriÅŸ istasyonunu belirle
    const total = this.entryStations.length; // Toplam giriÅŸ sayÄ±sÄ±
    const hasCandidate = id => this.stationIndexById.has(id); // Ä°stasyonun geÃ§erli olup olmadÄ±ÄŸÄ±nÄ± denetle
    if (preferredId && this.entryStations.includes(preferredId) && hasCandidate(preferredId)) { // Tercih geÃ§erliyse
      const index = this.entryStations.indexOf(preferredId); // Tercihin indeksini bul
      this.entrySpawnCursor = total ? (index + 1) % total : 0; // Ä°mleci bir sonraki giriÅŸe hazÄ±rla
      return preferredId; // Tercih edilen kimliÄŸi dÃ¶ndÃ¼r
    }
    if (!total) return null; // KayÄ±tlÄ± giriÅŸ yoksa null dÃ¶n
    let cursor = this.entrySpawnCursor % (total || 1); // DÃ¶ngÃ¼ baÅŸlangÄ±Ã§ konumunu hesapla
    for (let attempt = 0; attempt < total; attempt++) { // TÃ¼m giriÅŸleri sÄ±rayla kontrol et
      const candidate = this.entryStations[cursor]; // Aday kimliÄŸi seÃ§
      if (hasCandidate(candidate)) { // GeÃ§erliyse
        this.entrySpawnCursor = (cursor + 1) % total; // Ä°mleci sonraki adaya ilerlet
        return candidate; // Aday kimliÄŸi dÃ¶ndÃ¼r
      }
      cursor = (cursor + 1) % total; // SÄ±radaki adayÄ± dene
    }
    return null; // HiÃ§ geÃ§erli giriÅŸ bulunamazsa null dÃ¶n
  }
  spawnJob(atTime, preferredStationId = null) { // Yeni iÅŸ oluÅŸturma
    const entryStationId = this.resolveEntryStation(preferredStationId); // Ä°ÅŸin gireceÄŸi istasyonu seÃ§
    if (!entryStationId) { // Uygun giriÅŸ yoksa
      console.warn('[Motor] GiriÅŸ istasyonu bulunamadÄ±, iÅŸ oluÅŸturulamadÄ±.'); // UyarÄ± logla
      return; // Fonksiyondan Ã§Ä±k
    }
    const entryIndex = this.stationIndexById.get(entryStationId); // GiriÅŸ istasyon indeksini al
    if (entryIndex === undefined) { // Ä°ndeks bulunamadÄ±ysa
      console.warn(`[Motor] GiriÅŸ istasyonu ${entryStationId} iÃ§in indeks bulunamadÄ±.`); // UyarÄ± logla
      return; // Fonksiyondan Ã§Ä±k
    }
    const jobId = this.nextJobId++; // Kimlik Ã¼ret
    const job = { // Ä°ÅŸ nesnesi
      id: jobId, // Kimlik
      stage: 0, // Åu anki istasyon
      enterTime: atTime, // Sisteme giriÅŸ zamanÄ±
      exitTime: null, // Ã‡Ä±kÄ±ÅŸ zamanÄ±
      history: [], // AÅŸamalar geÃ§miÅŸi
      parentId: null, // Ãœst iÅŸ kimliÄŸi
      forkIndex: null, // Fork dalÄ±
      materialType: 'default', // Malzeme tÃ¼rÃ¼
      attrs: {}, // Ã–zellik sÃ¶zlÃ¼ÄŸÃ¼
      lineage: [], // Soy aÄŸacÄ±
      route: [], // Ziyaret edilen istasyonlar
      routeId: '', // Rota kimliÄŸi
      currentStationId: null, // BulunduÄŸu istasyon
      lastTargetId: null // Son hedef istasyon
    };
    this.jobs.set(jobId, job); // Haritaya ekle
    this.updateWip(this.wipCount + 1, atTime); // WIP artÄ±r
    this.schedule({ type: 'arrival', jobId, stationIndex: entryIndex, time: atTime, order: 0 }); // GiriÅŸ istasyonuna varÄ±ÅŸ planla
    this.viz.ensureJob(jobId); // GÃ¶rsel balon hazÄ±rla
    console.debug(`[Motor] Ä°ÅŸ ${jobId} oluÅŸturuldu, zaman ${atTime.toFixed(2)}`); // OluÅŸturma logu
  }
  start() { // SimÃ¼lasyonu baÅŸlat
    if (this.running) return; // Zaten Ã§alÄ±ÅŸÄ±yorsa Ã§Ä±k
    this.running = true; // BayraÄŸÄ± iÅŸaretle
    this.engineCursor = this.currentTime; // ZamanÄ± hizala
    if (this.currentTime === 0) { // Ä°lk baÅŸlangÄ±Ã§ mÄ±
      if (this.options.entryPolicy === 'interval') { // Sabit aralÄ±k ise
        const interval = Math.max(1, this.options.entryInterval); // GÃ¼venli aralÄ±k
        const limit = this.options.targetCount ? this.options.targetCount : 1000; // GÃ¼venli sÄ±nÄ±r
        for (let t = 0; t < limit; t++) { // DÃ¶ngÃ¼
          const spawnTime = t * interval; // VarÄ±ÅŸ zamanÄ±
          this.schedule({ type: 'spawn', time: spawnTime, order: -1, index: t }); // Spawn olayÄ±
        }
      } else { // Tetiklemeli giriÅŸ
        this.schedule({ type: 'spawn', time: 0, order: -1, index: 0 }); // Ä°lk Ã¼rÃ¼n
      }
    }
  }
  stop() { // SimÃ¼lasyonu durdur
    this.running = false; // BayraÄŸÄ± kapat
  }
  requestStop() { // Durdurma talebi
    this.pendingStop = true; // BayraÄŸÄ± ayarla
  }
  processUntil(targetTime) { // Belirli zamana kadar olay iÅŸle
    if (!this.running) return; // Ã‡alÄ±ÅŸmÄ±yorsa Ã§Ä±k
    this.engineCursor = targetTime; // Ä°leri hedefi gÃ¼ncelle
    let next = this.eventQueue.peek(); // SÄ±radaki olayÄ± al
    while (next && next.time <= this.engineCursor && this.running) { // Hedefe kadar dÃ¶ngÃ¼
      const event = this.eventQueue.pop(); // En erken olayÄ± Ã§Ä±kar
      this.currentTime = event.time; // MantÄ±ksal zamanÄ± gÃ¼ncelle
      this.handleEvent(event); // OlayÄ± iÅŸle
      if (this.pendingStop) { // Durdurma istekliyse
        this.stop(); // Durdur
        this.pendingStop = false; // BayraÄŸÄ± temizle
        break; // DÃ¶ngÃ¼yÃ¼ kÄ±r
      }
      next = this.eventQueue.peek(); // Sonraki olayÄ± hazÄ±rla
    }
  }
  peekNextEventTime() { // SÄ±radaki olay zamanÄ±nÄ± dÃ¶ndÃ¼r
    const next = this.eventQueue.peek(); // Tepe elemanÄ± al
    return next ? next.time : null; // Zaman veya null
  }
  handleEvent(event) { // Olay iÅŸleyici
    switch (event.type) { // TÃ¼r kontrolÃ¼
      case 'spawn': // Ä°ÅŸ oluÅŸturma
        this.handleSpawn(event); // Spawn iÅŸle
        break; // Ã‡Ä±k
      case 'arrival': // Ä°stasyona varÄ±ÅŸ
        this.handleArrival(event); // VarÄ±ÅŸÄ± iÅŸle
        break; // Ã‡Ä±k
      case 'serviceComplete': // Hizmet bitiÅŸi
        this.handleServiceCompletion(event); // TamamlamayÄ± iÅŸle
        break; // Ã‡Ä±k
    }
  }
  handleSpawn(event) { // Spawn iÅŸlemi
    if (this.options.targetCount && this.completedJobs.length >= this.options.targetCount) return; // Hedef sÄ±nÄ±rÄ±
    this.spawnJob(event.time, event.entryStationId); // Belirlenen giriÅŸ iÃ§in yeni iÅŸ oluÅŸtur
    if (this.options.entryPolicy === 'interval') { // Sabit aralÄ±kta
      const nextIndex = (event.index || 0) + 1; // Sonraki indeks
      if (!this.options.targetCount || nextIndex < this.options.targetCount) { // Hedef kontrolÃ¼
        const interval = Math.max(1, this.options.entryInterval); // AralÄ±k
        const nextTime = nextIndex * interval; // Sonraki zaman
        this.schedule({ type: 'spawn', time: nextTime, order: -1, index: nextIndex }); // Yeni spawn planla
      }
    }
  }
  handleArrival(event) { // VarÄ±ÅŸ iÅŸlemleri
    const rt = this.runtimeStations[event.stationIndex]; // Ä°lgili istasyon runtime
    if (!rt) return; // GÃ¼venlik
    const job = this.jobs.get(event.jobId); // Ä°ÅŸ nesnesi
    if (!job) return; // GÃ¼venlik
    console.debug(`[Motor] Ä°ÅŸ ${job.id} ${rt.station.name} istasyonuna ${event.time.toFixed(2)} zamanÄ±nda geldi`); // VarÄ±ÅŸ logu
    job.stage = event.stationIndex; // Ä°stasyon kaydÄ±
    job.currentStationId = rt.station.id; // GÃ¼ncel istasyon kimliÄŸi
    job.lastTargetId = rt.station.id; // Son hedefi gÃ¼ncelle
    if (!Array.isArray(job.route)) job.route = []; // Rota dizisini hazÄ±rla
    if (job.route[job.route.length - 1] !== rt.station.id) job.route.push(rt.station.id); // TekrarsÄ±z ekle
    job.routeId = job.route.join('â†’'); // Rota metnini gÃ¼ncelle
    const arrivalRecord = { jobId: job.id, arrival: event.time }; // Kuyruk kaydÄ±
    rt.queue.enqueue(arrivalRecord); // KuyruÄŸa ekle
    this.updateQueue(rt, rt.queue.length, event.time); // Kuyruk artÄ±ÅŸÄ±
    this.viz.ensureJob(job.id); // Balon var mÄ± kontrol
    this.viz.tagJob(job.id, 'waiting'); // GÃ¶rsel durumu gÃ¼ncelle
    this.tryStartService(rt, event.stationIndex, event.time); // Servis kontrolÃ¼
    this.updateLayoutTargets(); // YerleÅŸimi gÃ¼ncelle
  }
  tryStartService(rt, stationIndex, time) { // Servise baÅŸlatma giriÅŸimi
    const serviceTime = rt.station.totalDuration(); // Servis sÃ¼resi
    if (serviceTime <= 0) return; // SÃ¼re yoksa Ã§Ä±k
    for (let i = 0; i < rt.servers.length; i++) { // Her sunucuyu dolaÅŸ
      if (rt.servers[i]) continue; // Doluysa geÃ§
      const queued = rt.queue.dequeue(); // FIFO ilk iÅŸ
      if (!queued) break; // Kuyruk boÅŸsa Ã§Ä±k
      this.updateQueue(rt, rt.queue.length, time); // KuyruÄŸu azalt
      const job = this.jobs.get(queued.jobId); // Ä°ÅŸ nesnesi
      if (!job) continue; // GÃ¼venlik
      const wait = time - queued.arrival; // Bekleme sÃ¼resi
      rt.totalWaitTime += wait; // Toplam bekleme artÄ±ÅŸÄ±
      job.history.push({ // TarihÃ§e kaydÄ±
        stationId: rt.station.id, // Ä°stasyon kimliÄŸi
        start: time, // BaÅŸlangÄ±Ã§
        wait, // Bekleme
        serviceTime // Servis sÃ¼resi
      });
      this.updateBusy(rt, rt.busyCount + 1, time); // MeÅŸgul artÄ±r
      const endTime = time + serviceTime; // BitiÅŸ zamanÄ±
      rt.servers[i] = { jobId: job.id, end: endTime, start: time }; // Sunucuya ata
      rt.serviceTimeAccum += serviceTime; // Servis sÃ¼re toplamÄ±
      rt.serviceCount += 1; // Servis sayÄ±sÄ±
      this.schedule({ type: 'serviceComplete', jobId: job.id, stationIndex, serverIndex: i, time: endTime, order: 1 }); // Hizmet bitiÅŸ planÄ±
      this.viz.tagJob(job.id, 'processing'); // GÃ¶rsel durum
      console.debug(`[Motor] Ä°ÅŸ ${job.id} ${rt.station.name} servisinde ${time.toFixed(2)}â†’${endTime.toFixed(2)} aralÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±yor`); // Servis baÅŸlangÄ±Ã§ logu
    }
  }
  handleServiceCompletion(event) { // Servis bitiÅŸ iÅŸlemi
    const rt = this.runtimeStations[event.stationIndex]; // Ä°stasyon runtime
    if (!rt) return; // GÃ¼venlik
    const server = rt.servers[event.serverIndex]; // Sunucu kaydÄ±
    if (!server || server.jobId !== event.jobId) return; // Kontrol
    this.updateBusy(rt, Math.max(0, rt.busyCount - 1), event.time); // MeÅŸgul azalt
    rt.servers[event.serverIndex] = null; // Sunucuyu boÅŸalt
    const job = this.jobs.get(event.jobId); // Ä°ÅŸ nesnesi
    if (!job) return; // GÃ¼venlik
    console.debug(`[Motor] Ä°ÅŸ ${event.jobId} ${rt.station.name} servisinden ${event.time.toFixed(2)} zamanÄ±nda ayrÄ±ldÄ±`); // Tamamlama logu
    const station = rt.station; // Ä°lgili istasyon
    const rawTargets = Array.isArray(station.outputs) ? station.outputs : []; // TanÄ±mlÄ± hedefler
    const validTargets = rawTargets // GeÃ§erli hedefleri Ã§Ä±kar
      .map(targetId => ({ targetId, index: this.stationIndexById.get(targetId) })) // Kimlik ve indeks eÅŸleÅŸtir
      .filter(entry => entry.index !== undefined); // Ä°ndeksi olmayanlarÄ± ele
    const sink = validTargets.length === 0; // Ã‡Ä±kÄ±ÅŸ yok mu kontrolÃ¼
    if (sink) { // Ã‡Ä±kÄ±ÅŸsÄ±z istasyon
      const baseHistory = job.history.map(record => ({ ...record })); // TarihÃ§e kopyasÄ±
      const baseRoute = Array.isArray(job.route) ? job.route.slice() : []; // Rota kopyasÄ±
      const baseLineage = Array.isArray(job.lineage) ? job.lineage.slice() : []; // Soy kopyasÄ±
      const completed = { // Tamamlanan iÅŸ Ã¶zeti
        id: job.id, // Kimlik
        parentId: job.parentId, // Ãœst iÅŸ
        forkIndex: job.forkIndex, // Fork dalÄ±
        materialType: job.materialType, // Malzeme tÃ¼rÃ¼
        attrs: { ...(job.attrs || {}) }, // Ã–zellikler
        lineage: baseLineage, // Soy aÄŸacÄ±
        enterTime: job.enterTime, // GiriÅŸ zamanÄ±
        exitTime: event.time, // Ã‡Ä±kÄ±ÅŸ zamanÄ±
        history: baseHistory, // TarihÃ§e
        route: baseRoute, // Rota dizisi
        routeId: job.routeId || baseRoute.join('â†’'), // Rota metni
        exitStationId: station.id, // Ã‡Ä±kÄ±ÅŸ istasyonu kimliÄŸi
        exitStationName: station.name // Ã‡Ä±kÄ±ÅŸ istasyonu adÄ±
      }; // Nesne sonu
      this.completedJobs.push(completed); // Tamamlananlara ekle
      this.updateWip(Math.max(0, this.wipCount - 1), event.time); // WIP azalt
      this.viz.tagJob(job.id, 'completed'); // GÃ¶rsel tamamlandÄ±
      this.viz.markForRemoval(job.id); // Balonu kaldÄ±r
      this.jobs.delete(job.id); // Ä°ÅŸ kaydÄ±nÄ± sil
      if (this.options.targetCount && this.completedJobs.length >= this.options.targetCount) { // Hedefe ulaÅŸÄ±ldÄ± mÄ±
        this.requestStop(); // SimÃ¼lasyonu durdur
      }
    } else { // Ã‡ok Ã§Ä±kÄ±ÅŸlÄ± istasyon
      const stats = this.forkStats.get(station.id); // Fork istatistiÄŸi
      const totalTargets = validTargets.length; // GeÃ§erli hedef sayÄ±sÄ±
      const cursorBase = Number.isFinite(rt.dispatchCursor) ? rt.dispatchCursor : 0; // Mevcut imleÃ§
      const normalizedCursor = totalTargets ? ((cursorBase % totalTargets) + totalTargets) % totalTargets : 0; // GÃ¼venli imleÃ§
      const target = validTargets[normalizedCursor]; // SeÃ§ilen hedef
      rt.dispatchCursor = totalTargets ? (normalizedCursor + 1) % totalTargets : 0; // Sonraki imleÃ§
      if (stats) { // Ä°statistik varsa
        stats.producedParts += 1; // Ãœretilen parÃ§a sayÄ±sÄ±nÄ± artÄ±r
        stats.forkEvents += 1; // YÃ¶nlendirme olayÄ±nÄ± say
      }
      job.lastTargetId = target.targetId; // Son hedef kimliÄŸi
      this.viz.tagJob(job.id, 'waiting'); // Balonu beklemede iÅŸaretle
      this.schedule({ type: 'arrival', jobId: job.id, stationIndex: target.index, time: event.time, order: 0 }); // VarÄ±ÅŸÄ± planla
      console.debug(`[Motor] Ä°ÅŸ ${event.jobId} ${station.name} Ã§Ä±kÄ±ÅŸÄ±ndan ${target.targetId} hedefine yÃ¶nlendirildi (RR).`); // RR logu
    }
    if (this.entryStations.includes(station.id) && this.options.entryPolicy === 'trigger') { // GiriÅŸ tetikleyicisi kontrolÃ¼
      if (!this.options.targetCount || this.completedJobs.length < this.options.targetCount) { // Hedef kontrolÃ¼
        this.schedule({ type: 'spawn', time: event.time, order: -1, entryStationId: station.id }); // AynÄ± giriÅŸ istasyonu iÃ§in yeni iÅŸ planla
      }
    }
    this.tryStartService(rt, event.stationIndex, event.time); // Kuyruktan yeni iÅŸ al
    this.updateLayoutTargets(); // YerleÅŸim gÃ¼ncelle
  }
  updateQueue(rt, newLength, time) { // Kuyruk metriÄŸi gÃ¼ncelle
    rt.queueArea += rt.queueLength * (time - rt.lastQueueUpdate); // Alan artÄ±ÅŸÄ±
    rt.queueLength = Math.max(0, newLength); // Yeni deÄŸer
    rt.lastQueueUpdate = time; // Zaman kaydÄ±
  }
  updateBusy(rt, newBusy, time) { // MeÅŸgul metriÄŸi gÃ¼ncelle
    const delta = time - rt.lastBusyUpdate; // Zaman farkÄ±
    if (delta > 0) { // Pozitif sÃ¼re varsa
      const serverCount = Array.isArray(rt.servers) ? rt.servers.length : rt.station.parallelServers; // Toplam sunucu
      const idleServers = Math.max(0, serverCount - rt.busyCount); // BoÅŸta kalan sunucular
      rt.busyArea += rt.busyCount * delta; // MeÅŸgul alanÄ±nÄ± artÄ±r
      rt.idleArea += idleServers * delta; // BoÅŸta alanÄ±nÄ± artÄ±r
    }
    rt.busyCount = Math.max(0, Math.min(newBusy, rt.servers.length)); // Yeni deÄŸer
    rt.lastBusyUpdate = time; // Zaman kaydÄ±
  }
  updateWip(newWip, time) { // WIP gÃ¼ncellemesi
    this.wipArea += this.wipCount * (time - this.lastWipUpdate); // Alan artÄ±ÅŸÄ±
    this.wipCount = Math.max(0, newWip); // Yeni deÄŸer
    this.lastWipUpdate = time; // Zaman kaydÄ±
  }
  updateLayoutTargets(timeCursor = this.currentTime) { // GÃ¶rsel yerleÅŸimi tetikle
    const renderTime = Math.max(timeCursor, this.currentTime); // GÃ¶sterim zamanÄ±
    const elapsed = Math.max(renderTime, 0.0001); // GeÃ§en sÃ¼re
    const layout = this.runtimeStations.map(rt => { // Her istasyon iÃ§in durum
      const queueEntries = rt.queue.peekAll(); // Kuyruktaki iÅŸler
      const servers = rt.servers.map(server => { // SunucularÄ± gez
        if (!server) return null; // BoÅŸsa null
        const duration = Math.max(0.0001, server.end - server.start); // SÃ¼re
        const remaining = Math.max(0, server.end - renderTime); // Kalan sÃ¼re
        const progress = Math.min(1, Math.max(0, (renderTime - server.start) / duration)); // Ä°lerleme
        return { // Sunucu verisi
          jobId: server.jobId, // Ä°ÅŸ kimliÄŸi
          start: server.start, // BaÅŸlangÄ±Ã§ zamanÄ±
          end: server.end, // BitiÅŸ zamanÄ±
          duration, // SÃ¼re
          remaining, // Kalan sÃ¼re
          progress // Ä°lerleme oranÄ±
        };
      });
      const busyCount = servers.filter(server => !!server).length; // AnlÄ±k meÅŸgul sayÄ±sÄ±
      const queueLength = queueEntries.length; // AnlÄ±k kuyruk uzunluÄŸu
      const avgQueue = (rt.queueArea + queueLength * (renderTime - rt.lastQueueUpdate)) / elapsed; // Ortalama kuyruk
      const capacity = Math.max(1, rt.servers.length); // Kapasite
      const rawUtil = (rt.busyArea + rt.busyCount * (renderTime - rt.lastBusyUpdate)) / (elapsed * capacity); // Ham util
      const avgUtil = Math.min(1, Math.max(0, rawUtil)); // SÄ±nÄ±rlandÄ±rÄ±lmÄ±ÅŸ util
      return { // YerleÅŸim verisi
        stationId: rt.station.id, // Kimlik
        stationName: rt.station.name, // Ä°stasyon adÄ±
        queue: queueEntries.map(entry => ({ jobId: entry.jobId, arrival: entry.arrival })), // Kuyruk iÅŸ listesi
        servers, // Sunucu iÅŸ listesi
        metrics: { // CanlÄ± metrikler
          queueLength, // AnlÄ±k kuyruk
          busyCount, // AnlÄ±k meÅŸgul sayÄ±sÄ±
          capacity, // Kapasite
          avgQueue, // Ortalama kuyruk
          avgUtil // Ortalama util
        }
      };
    });
    if (this.viz) this.viz.applyLayout(layout, renderTime); // Viz'e gÃ¶nder
    const snapshot = { // AnlÄ±k durum
      time: renderTime, // GÃ¶sterim zamanÄ±
      completedCount: this.completedJobs.length, // Tamamlanan adet
      wip: this.wipCount, // AnlÄ±k WIP
      layout // YerleÅŸim verisi
    };
    if (typeof this.onLiveUpdate === 'function') this.onLiveUpdate(snapshot); // Callback Ã§aÄŸÄ±r
    return snapshot; // Snapshot dÃ¶ndÃ¼r
  }
  buildReport() { // Rapor verisini hazÄ±rla
    this.runtimeStations.forEach(rt => { // Nihai alan gÃ¼ncellemesi
      this.updateQueue(rt, rt.queueLength, this.currentTime); // Kuyruk alanÄ±nÄ± gÃ¼ncelle
      this.updateBusy(rt, rt.busyCount, this.currentTime); // MeÅŸgul alanÄ±nÄ± gÃ¼ncelle
    });
    this.updateWip(this.wipCount, this.currentTime); // WIP alanÄ±nÄ± gÃ¼ncelle
    const totalCompleted = this.completedJobs.length; // Tamamlanan adet
    const horizon = this.currentTime || 1; // Toplam mantÄ±ksal sÃ¼re
    const cycleTimes = this.completedJobs.map(job => job.exitTime - job.enterTime); // Ã‡evrim sÃ¼releri
    const avgCycle = cycleTimes.length ? cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length : 0; // Ortalama Ã§evrim
    const throughputPerSec = horizon ? totalCompleted / horizon : 0; // ÃœrÃ¼n/sn
    const throughputPerMin = throughputPerSec * 60; // ÃœrÃ¼n/dk
    const avgWip = this.wipArea / horizon; // Ortalama WIP
    const stationRows = this.runtimeStations.map(rt => { // Ä°stasyon raporu
      const serverSlots = Math.max(1, (Array.isArray(rt.servers) ? rt.servers.length : rt.station.parallelServers)); // Sunucu adetini belirle
      const util = horizon ? (rt.busyArea / (horizon * serverSlots)) : 0; // Utilizasyon
      const avgQ = horizon ? (rt.queueArea / horizon) : 0; // Ortalama kuyruk
      const wait = rt.serviceCount ? (rt.totalWaitTime / rt.serviceCount) : 0; // Ortalama bekleme
      const serviceTime = rt.station.totalDuration(); // Tek iÅŸ servis sÃ¼resi
      const capacityPerSec = serviceTime > 0 ? rt.station.parallelServers / serviceTime : 0; // Teorik kapasite
      const idle = horizon ? (rt.idleArea / serverSlots) : 0; // Ortalama idle sÃ¼resi
      return { // SatÄ±r nesnesi
        stationId: rt.station.id, // Kimlik
        stationName: rt.station.name, // Ä°sim
        parallelServers: rt.station.parallelServers, // Paralel sayÄ±sÄ±
        utilization: util, // Utilizasyon
        avgQueue: avgQ, // Kuyruk
        avgWait: wait, // Bekleme
        serviceTime, // Servis sÃ¼resi
        capacityPerSec, // Kapasite
        serviceCount: rt.serviceCount, // Tamamlanan iÅŸ adedi
        idleTime: idle // BoÅŸ/atÄ±l kalma sÃ¼resi
      };
    });
    const bottleneckUtil = stationRows.reduce((max, row) => (!max || row.utilization > max.utilization ? row : max), null); // Util darboÄŸazÄ±
    const bottleneckService = stationRows.reduce((max, row) => (!max || row.serviceTime > max.serviceTime ? row : max), null); // Servis darboÄŸazÄ±
    const completionSeries = this.completedJobs // Tamamlanan zaman serisi
      .slice() // Kopya al
      .sort((a, b) => a.exitTime - b.exitTime) // Zaman sÄ±ralamasÄ±
      .map((job, index) => ({ time: job.exitTime, count: index + 1 })); // KÃ¼mÃ¼latif nokta
    const forkSummary = this.stations.map(station => { // Fork Ã¶zetini hazÄ±rla
      const stats = this.forkStats.get(station.id) || { producedParts: 0, forkEvents: 0 }; // Ä°statistiÄŸi al
      return { // SatÄ±r nesnesi
        stationId: station.id, // Kimlik
        stationName: station.name, // Ä°sim
        outDegree: Array.isArray(station.outputs) ? station.outputs.length : 0, // Ã‡Ä±kÄ±ÅŸ sayÄ±sÄ±
        producedParts: stats.producedParts || 0, // Ãœretilen parÃ§a sayÄ±sÄ±
        forkEvents: stats.forkEvents || 0 // YÃ¶nlendirme olayÄ± sayÄ±sÄ±
      }; // Nesne sonu
    });
    const completedRows = this.completedJobs.map(job => ({ // Tamamlanan iÅŸ satÄ±rlarÄ±
      id: job.id, // Kimlik
      parentId: job.parentId ?? null, // Ãœst iÅŸ
      routeId: job.routeId || (Array.isArray(job.route) ? job.route.join('â†’') : ''), // Rota metni
      exitStationId: job.exitStationId || '', // Ã‡Ä±kÄ±ÅŸ istasyonu kimliÄŸi
      exitStationName: job.exitStationName || '', // Ã‡Ä±kÄ±ÅŸ istasyonu adÄ±
      exitTime: job.exitTime || 0 // Ã‡Ä±kÄ±ÅŸ zamanÄ±
    }));
    return { // Rapor objesi
      totalCompleted, // Tamamlanan
      horizon, // SimÃ¼lasyon sÃ¼resi
      avgCycle, // Ã‡evrim zamanÄ±
      throughputPerSec, // ÃœrÃ¼n/sn
      throughputPerMin, // ÃœrÃ¼n/dk
      avgWip, // Ortalama WIP
      stationRows, // Ä°stasyon satÄ±rlarÄ±
      bottleneckUtil, // Util darboÄŸazÄ±
      bottleneckService, // Servis darboÄŸazÄ±
      completionSeries, // Tamamlanma serisi
      forkSummary, // Fork Ã¶zeti
      completedJobs: completedRows // Tamamlanan iÅŸ listesi
    };
  }
}

// GÃ¶rselleÅŸtirme sÄ±nÄ±fÄ± //

class Visualization { // GÃ¶rsel katman
  constructor(svg) { // Kurucu
    this.svg = svg; // SVG referansÄ±
    this.jobs = new Map(); // Baloncuk haritasÄ±
    this.stationLayout = []; // Ä°stasyon yerleÅŸimi listesi
    this.layoutById = new Map(); // Kimlikten yerleÅŸim eriÅŸimi
    this.metricGroup = null; // Metrik yazÄ±larÄ± grubu
    this.speed = 1; // Animasyon hÄ±zÄ±
    this.zoom = 1; // YakÄ±nlaÅŸtÄ±rma Ã¶lÃ§eÄŸi
    this.editing = false; // DÃ¼zenleme modu aktif mi
    this.viewPadding = 200; // GÃ¶rÃ¼nÃ¼m tamponu
    this.minViewWidth = 1200; // Minimum gÃ¶rÃ¼nÃ¼m geniÅŸliÄŸi
    this.minViewHeight = 800; // Minimum gÃ¶rÃ¼nÃ¼m yÃ¼ksekliÄŸi
    this.viewCenter = { x: 0, y: 0 }; // GÃ¶rÃ¼nÃ¼m merkezi
    this.viewExtent = { width: this.minViewWidth, height: this.minViewHeight }; // GÃ¶rÃ¼nÃ¼m boyutu
    this.panOffset = { x: 0, y: 0 }; // Pan kaymasÄ±
    this.worldLimits = { minX: -1600, maxX: 1600, minY: -900, maxY: 900 }; // DÃ¼nya sÄ±nÄ±rlarÄ±
    this.hasCentered = false; // Ä°lk merkezleme yapÄ±ldÄ± mÄ±
    this.edgeElements = new Map(); // Kenar Ã¶ÄŸeleri haritasÄ±
    this.nodeElements = new Map(); // DÃ¼ÄŸÃ¼m Ã¶ÄŸeleri haritasÄ±
    this.handlers = { beginEdge: null, completeEdge: null, cancelEdge: null, removeEdge: null, moveNode: null }; // Olay geri Ã§aÄŸrÄ±larÄ±
    this.dragState = null; // SÃ¼rÃ¼kleme durumu
    this.edgeDraft = null; // Aktif baÄŸlantÄ± taslaÄŸÄ±
    this.nodeWidth = 180; // Kutu geniÅŸliÄŸi
    this.nodeHeight = 140; // Kutu yÃ¼ksekliÄŸi
    this.markerId = `edge-arrow-${Math.random().toString(36).slice(2)}`; // Benzersiz ok belirteci
    this.resizeObserver = new ResizeObserver(() => this.drawStations()); // Yeniden Ã§izim dinleyicisi
    if (svg && svg.parentElement) this.resizeObserver.observe(svg.parentElement); // Paneli izle
    this.frame = this.frame.bind(this); // Animasyon baÄŸlama
    this.updateViewBox(); // BaÅŸlangÄ±Ã§ gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ ayarla
    if (this.svg) { // SVG mevcutsa
      this.svg.addEventListener('pointermove', event => this.handleDraftPointer(event), { passive: true }); // Taslak Ã§izgiyi gÃ¼ncelle
      this.svg.addEventListener('mouseleave', () => this.handleDraftExit()); // Ä°mleÃ§ ayrÄ±ldÄ±ÄŸÄ±nda taslaÄŸÄ± koru
      this.svg.addEventListener('click', event => { // Arka plana tÄ±klama
        if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
        const isSvgTarget = event.target === this.svg; // Hedef doÄŸrudan SVG mi
        const clickedDraft = event.target.classList && event.target.classList.contains('edge-draft'); // Taslak Ã§izgi mi
        if ((isSvgTarget || clickedDraft) && typeof this.handlers.cancelEdge === 'function') { // Arka plan veya taslaksa
          this.handlers.cancelEdge('background'); // TaslaÄŸÄ± iptal et
        }
      });
    }
    requestAnimationFrame(this.frame); // Animasyon dÃ¶ngÃ¼sÃ¼nÃ¼ baÅŸlat
  }
  setHandlers(handlers = {}) { // Geri Ã§aÄŸrÄ± atayÄ±cÄ±
    this.handlers = { ...this.handlers, ...handlers }; // Yeni handlerlarÄ± birleÅŸtir
  }
  handleDraftPointer(event) { // Taslak Ã§izgiyi iÅŸaretÃ§i ile gÃ¼ncelle
    if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
    const point = this.toSvgPoint(event); // KoordinatÄ± SVG sistemine Ã§evir
    this.updateEdgeDraft(point.x, point.y); // Taslak Ã§izgiyi yeni noktaya taÅŸÄ±
  }
  handleDraftExit() { // Ä°ÅŸaretÃ§i SVG'den ayrÄ±ldÄ±ÄŸÄ±nda Ã§aÄŸrÄ±lÄ±r
    if (!this.edgeDraft || !this.edgeDraft.lastPoint) return; // Taslak yoksa Ã§Ä±k
    this.updateEdgeDraft(this.edgeDraft.lastPoint.x, this.edgeDraft.lastPoint.y); // Son noktayÄ± koru
  }
  beginEdgeDraft(sourceId, targetIds = []) { // BaÄŸlantÄ± taslaÄŸÄ±nÄ± baÅŸlat
    const layout = this.layoutById.get(sourceId); // Kaynak yerleÅŸimi al
    if (!layout || !this.edgeLayer) return false; // GeÃ§erli deÄŸilse Ã§Ä±k
    this.cancelEdgeDraft(); // Ã–nceki taslaÄŸÄ± temizle
    const start = { x: layout.x + layout.width, y: layout.y + layout.height / 2 }; // BaÅŸlangÄ±Ã§ noktasÄ±
    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); // Taslak Ã§izgi oluÅŸtur
    path.classList.add('edge-draft'); // Stil sÄ±nÄ±fÄ± ekle
    path.setAttribute('marker-end', `url(#${this.markerId})`); // Ok ucu ata
    this.edgeLayer.appendChild(path); // Ã‡izgiyi katmana ekle
    const targets = Array.isArray(targetIds) ? targetIds.map(id => String(id)) : []; // Hedef kimliklerini hazÄ±rla
    this.edgeDraft = { sourceId, start, path, targetIds: targets, lastPoint: { x: start.x + 120, y: start.y } }; // Taslak durumunu sakla
    const sourceNode = this.nodeElements.get(sourceId); // Kaynak dÃ¼ÄŸÃ¼m referansÄ±
    if (sourceNode) sourceNode.group.classList.add('drafting'); // KaynaÄŸÄ± vurgula
    targets.forEach(id => { const node = this.nodeElements.get(id); if (node) node.group.classList.add('draft-target'); }); // Hedefleri vurgula
    this.updateEdgeDraft(this.edgeDraft.lastPoint.x, this.edgeDraft.lastPoint.y); // Ä°lk Ã§izgiyi Ã§iz
    return true; // BaÅŸarÄ±lÄ±
  }
  updateEdgeDraft(x, y) { // Taslak Ã§izgiyi gÃ¼ncelle
    if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
    const end = { x, y }; // BitiÅŸ noktasÄ± hazÄ±rla
    const dx = Math.max(60, Math.abs(end.x - this.edgeDraft.start.x)); // X farkÄ±nÄ± hesapla
    const control1 = `${this.edgeDraft.start.x + dx * 0.35} ${this.edgeDraft.start.y - 60}`; // Birinci kontrol
    const control2 = `${end.x - dx * 0.35} ${end.y + 60}`; // Ä°kinci kontrol
    this.edgeDraft.path.setAttribute('d', `M ${this.edgeDraft.start.x} ${this.edgeDraft.start.y} C ${control1}, ${control2}, ${end.x} ${end.y}`); // Yolu gÃ¼ncelle
    this.edgeDraft.lastPoint = end; // Son noktayÄ± sakla
  }
  completeEdgeDraft(targetId) { // Taslak Ã§izgiyi hedefle tamamla
    if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
    const targetLayout = this.layoutById.get(targetId); // Hedef yerleÅŸimi al
    if (targetLayout) { // Hedef bulunduysa
      const anchor = { x: targetLayout.x, y: targetLayout.y + targetLayout.height / 2 }; // Hedef noktasÄ±nÄ± hesapla
      this.updateEdgeDraft(anchor.x, anchor.y); // Ã‡izgiyi hedefe taÅŸÄ±
    }
    this.cancelEdgeDraft(); // TaslaÄŸÄ± temizle
  }
  cancelEdgeDraft() { // Taslak Ã§izgiyi iptal et
    if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
    const sourceNode = this.nodeElements.get(this.edgeDraft.sourceId); // Kaynak dÃ¼ÄŸÃ¼mÃ¼ al
    if (sourceNode) sourceNode.group.classList.remove('drafting'); // Kaynak vurgusunu kaldÄ±r
    const targets = Array.isArray(this.edgeDraft.targetIds) ? this.edgeDraft.targetIds : []; // Hedefleri al
    targets.forEach(id => { const node = this.nodeElements.get(id); if (node) node.group.classList.remove('draft-target'); }); // Hedef vurgularÄ±nÄ± kaldÄ±r
    if (this.edgeDraft.path && this.edgeDraft.path.parentNode) this.edgeDraft.path.parentNode.removeChild(this.edgeDraft.path); // Ã‡izgiyi DOM'dan kaldÄ±r
    this.edgeDraft = null; // Durumu sÄ±fÄ±rla
  }
  clearJobs() { // BaloncuklarÄ± temizle
    this.jobs.forEach(node => node.circle.remove()); // TÃ¼m daireleri kaldÄ±r
    this.jobs.clear(); // HaritayÄ± sÄ±fÄ±rla
  }
  ensureJob(jobId) { // Balon var mÄ± kontrol et
    if (this.jobs.has(jobId)) return; // Varsa Ã§Ä±k
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); // Daire oluÅŸtur
    circle.classList.add('job-bubble'); // SÄ±nÄ±f ekle
    circle.setAttribute('r', 12); // YarÄ±Ã§ap belirle
    circle.setAttribute('cx', 0); // BaÅŸlangÄ±Ã§ X
    circle.setAttribute('cy', 0); // BaÅŸlangÄ±Ã§ Y
    this.svg.appendChild(circle); // SVG'ye ekle
    this.jobs.set(jobId, { circle, targetX: 0, targetY: 0, x: 0, y: 0, startX: 0, startY: 0, startTime: performance.now(), duration: MOVE_DURATION_MS, removeAt: null, progress: 0 }); // Haritaya kaydet
  }
  tagJob(jobId, state) { // Balon durum etiketi
    const node = this.jobs.get(jobId); // Balonu al
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.circle.classList.remove('waiting', 'processing', 'completed'); // Ã–nceki sÄ±nÄ±flarÄ± kaldÄ±r
    node.circle.classList.add(state); // Yeni durumu ekle
  }
  markForRemoval(jobId) { // Balonu kaldÄ±rmaya hazÄ±rla
    const node = this.jobs.get(jobId); // Balon referansÄ±
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.removeAt = performance.now() + MOVE_DURATION_MS / this.speed; // KaldÄ±rma zamanÄ±nÄ± ata
  }
  removeJob(jobId) { // Balonu kalÄ±cÄ± kaldÄ±r
    const node = this.jobs.get(jobId); // Balon referansÄ±
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.circle.remove(); // SVG'den kaldÄ±r
    this.jobs.delete(jobId); // Haritadan sil
  }
  setSpeed(speed) { // GÃ¶rsel hÄ±z ayarÄ±
    this.speed = speed; // DeÄŸeri sakla
  }
  setZoom(scale) { // YakÄ±nlaÅŸtÄ±rma ayarÄ±
    this.zoom = Math.max(0.5, Math.min(3, scale)); // Ã–lÃ§eÄŸi sÄ±nÄ±rla
    this.updateViewBox(); // ViewBox'Ä± gÃ¼ncelle
  }
  updateViewBox() { // ViewBox deÄŸerini yenile
    if (!this.svg) return; // SVG yoksa Ã§Ä±k
    const width = this.viewExtent.width / this.zoom; // Ã–lÃ§eklenmiÅŸ geniÅŸlik
    const height = this.viewExtent.height / this.zoom; // Ã–lÃ§eklenmiÅŸ yÃ¼kseklik
    const x = this.viewCenter.x - width / 2 + this.panOffset.x; // Sol Ã¼st X
    const y = this.viewCenter.y - height / 2 + this.panOffset.y; // Sol Ã¼st Y
    this.svg.setAttribute('viewBox', `${x} ${y} ${width} ${height}`); // ViewBox ata
  }
  setEditing(enabled) { // DÃ¼zenleme modunu ayarla
    this.editing = !!enabled; // BayraÄŸÄ± sakla
    this.nodeElements.forEach(entry => { // TÃ¼m dÃ¼ÄŸÃ¼mleri dolaÅŸ
      if (!entry || !entry.group) return; // GeÃ§ersizse geÃ§
      entry.group.style.cursor = this.editing ? 'grab' : 'default'; // Ä°mleci gÃ¼ncelle
      entry.group.classList.toggle('editing-enabled', this.editing); // SÄ±nÄ±fÄ± deÄŸiÅŸtir
      if (entry.addGroup) { // BaÄŸlantÄ± dÃ¼ÄŸmesi varsa
        entry.addGroup.style.pointerEvents = this.editing ? 'all' : 'none'; // EtkileÅŸimi ayarla
        entry.addGroup.style.opacity = this.editing ? '1' : '0.35'; // GÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ dÃ¼zenle
        entry.addGroup.style.cursor = this.editing ? 'pointer' : 'not-allowed'; // Ä°mleci deÄŸiÅŸtir
      }
    });
    if (!this.editing) this.cancelEdgeDraft(); // DÃ¼zenleme kapatÄ±ldÄ±ÄŸÄ±nda taslaÄŸÄ± temizle
  }
  calculateBounds() { // YerleÅŸim sÄ±nÄ±rlarÄ±nÄ± hesapla
    if (!this.stationLayout.length) { // Ä°stasyon yoksa
      return { minX: -400, maxX: 400, minY: -200, maxY: 200 }; // VarsayÄ±lan sÄ±nÄ±rlar
    }
    let minX = Infinity; // Minimum X
    let minY = Infinity; // Minimum Y
    let maxX = -Infinity; // Maksimum X
    let maxY = -Infinity; // Maksimum Y
    this.stationLayout.forEach(layout => { // Her istasyonu dolaÅŸ
      minX = Math.min(minX, layout.x); // Minimum X gÃ¼ncelle
      minY = Math.min(minY, layout.y); // Minimum Y gÃ¼ncelle
      maxX = Math.max(maxX, layout.x + layout.width); // Maksimum X gÃ¼ncelle
      maxY = Math.max(maxY, layout.y + layout.height); // Maksimum Y gÃ¼ncelle
    });
    return { // Tampon uygulanmÄ±ÅŸ sÄ±nÄ±rlar
      minX: minX - this.viewPadding,
      maxX: maxX + this.viewPadding,
      minY: minY - this.viewPadding,
      maxY: maxY + this.viewPadding
    };
  }
  centerViewOnBounds() { // TÃ¼m yerleÅŸimi merkeze al
    const bounds = this.calculateBounds(); // SÄ±nÄ±rlarÄ± hesapla
    this.bounds = bounds; // Kaydet
    const width = Math.max(this.minViewWidth, bounds.maxX - bounds.minX); // GeniÅŸliÄŸi belirle
    const height = Math.max(this.minViewHeight, bounds.maxY - bounds.minY); // YÃ¼ksekliÄŸi belirle
    this.viewExtent = { width, height }; // GÃ¶rÃ¼nÃ¼m boyutunu ata
    this.viewCenter = { // Merkezi hesapla
      x: (bounds.minX + bounds.maxX) / 2,
      y: (bounds.minY + bounds.maxY) / 2
    };
    this.panOffset = { x: 0, y: 0 }; // Pan kaymasÄ±nÄ± sÄ±fÄ±rla
    this.updateViewBox(); // ViewBox'Ä± gÃ¼ncelle
  }
  updateBounds() { // SÄ±nÄ±rlarÄ± yenile
    this.bounds = this.calculateBounds(); // SÄ±nÄ±rlarÄ± hesapla
    const width = this.bounds.maxX - this.bounds.minX; // GeniÅŸlik
    const height = this.bounds.maxY - this.bounds.minY; // YÃ¼kseklik
    this.viewExtent.width = Math.max(this.viewExtent.width, Math.max(this.minViewWidth, width)); // GeniÅŸlik sÄ±nÄ±rÄ±
    this.viewExtent.height = Math.max(this.viewExtent.height, Math.max(this.minViewHeight, height)); // YÃ¼kseklik sÄ±nÄ±rÄ±
    this.updateViewBox(); // ViewBox'Ä± gÃ¼ncelle
  }
  clampPosition(layout, x, y) { // SÄ±nÄ±rlar iÃ§inde konumla
    const minX = this.worldLimits.minX; // Minimum X
    const maxX = this.worldLimits.maxX - layout.width; // Maksimum X
    const minY = this.worldLimits.minY; // Minimum Y
    const maxY = this.worldLimits.maxY - layout.height; // Maksimum Y
    return { // SÄ±nÄ±rlandÄ±rÄ±lmÄ±ÅŸ koordinatlar
      x: Math.max(minX, Math.min(maxX, x)),
      y: Math.max(minY, Math.min(maxY, y))
    };
  }
  rectsOverlap(a, b, padding = 0) { // DikdÃ¶rtgen Ã§akÄ±ÅŸma testi
    return !(a.x + a.width + padding <= b.x || b.x + b.width + padding <= a.x || a.y + a.height + padding <= b.y || b.y + b.height + padding <= a.y); // Ã‡akÄ±ÅŸma kontrolÃ¼
  }
  resolveCollisions(layout) { // Ã‡akÄ±ÅŸmalarÄ± gider
    const padding = 32; // Minimum boÅŸluk
    for (let attempt = 0; attempt < 8; attempt++) { // SÄ±nÄ±rlÄ± iterasyon
      let collided = false; // Ã‡akÄ±ÅŸma bayraÄŸÄ±
      for (const other of this.stationLayout) { // DiÄŸer istasyonlarÄ± dolaÅŸ
        if (other === layout) continue; // AynÄ±ysa geÃ§
        if (!this.rectsOverlap(layout, other, padding)) continue; // Ã‡akÄ±ÅŸma yoksa geÃ§
        collided = true; // Ã‡akÄ±ÅŸma var
        const dx = (layout.x + layout.width / 2) - (other.x + other.width / 2); // Merkez farkÄ± X
        const dy = (layout.y + layout.height / 2) - (other.y + other.height / 2); // Merkez farkÄ± Y
        if (Math.abs(dx) >= Math.abs(dy)) { // X yÃ¶nÃ¼ baskÄ±nsa
          layout.x += dx >= 0 ? padding : -padding; // SaÄŸ/sola kaydÄ±r
        } else { // Y yÃ¶nÃ¼ baskÄ±nsa
          layout.y += dy >= 0 ? padding : -padding; // YukarÄ±/aÅŸaÄŸÄ± kaydÄ±r
        }
        const clamped = this.clampPosition(layout, layout.x, layout.y); // SÄ±nÄ±rla
        layout.x = clamped.x; // X ata
        layout.y = clamped.y; // Y ata
      }
      if (!collided) break; // Ã‡akÄ±ÅŸma kalmadÄ±ysa Ã§Ä±k
    }
  }
  translateJob(jobId, dx, dy) { // Tek baloncuÄŸu kaydÄ±r
    if (!dx && !dy) return; // KaydÄ±rma yoksa Ã§Ä±k
    const node = this.jobs.get(jobId); // Balonu al
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.x += dx; // X gÃ¼ncelle
    node.y += dy; // Y gÃ¼ncelle
    node.startX += dx; // BaÅŸlangÄ±Ã§ X kaydÄ±r
    node.startY += dy; // BaÅŸlangÄ±Ã§ Y kaydÄ±r
    node.targetX += dx; // Hedef X kaydÄ±r
    node.targetY += dy; // Hedef Y kaydÄ±r
    node.circle.setAttribute('cx', node.x); // SVG X
    node.circle.setAttribute('cy', node.y); // SVG Y
  }
  translateStationJobs(layout, dx, dy) { // Ä°stasyona baÄŸlÄ± balonlarÄ± kaydÄ±r
    if (!dx && !dy) return; // DeÄŸiÅŸim yoksa Ã§Ä±k
    const queue = Array.isArray(layout.queue) ? layout.queue : []; // Kuyruk iÅŸleri
    queue.forEach(item => this.translateJob(item.jobId, dx, dy)); // Kuyruktakileri kaydÄ±r
    const servers = Array.isArray(layout.servers) ? layout.servers : []; // Servis iÅŸleri
    servers.forEach(server => { if (server) this.translateJob(server.jobId, dx, dy); }); // Servistekileri kaydÄ±r
  }
  refreshJobAnchors(forceInstant = false) { // Baloncuk konumlarÄ±nÄ± yeniden hesapla
    const assigned = new Set(); // Atanan iÅŸ kÃ¼mesi
    this.stationLayout.forEach((layout, stationIdx) => { // Her istasyonu dolaÅŸ
      const queue = Array.isArray(layout.queue) ? layout.queue : []; // Kuyruk listesi
      queue.forEach((entry, queueIdx) => { // Her kuyruk elemanÄ±
        const pos = this.queuePosition(stationIdx, queueIdx); // Hedef konum
        this.ensureJob(entry.jobId); // Balonu hazÄ±rla
        if (forceInstant) this.moveNodeInstant(entry.jobId, pos.x, pos.y); else this.moveNode(entry.jobId, pos.x, pos.y); // Konumu uygula
        assigned.add(entry.jobId); // AtandÄ± olarak iÅŸaretle
      });
      const servers = Array.isArray(layout.servers) ? layout.servers : []; // Sunucu listesi
      servers.forEach((server, serverIdx) => { // Her sunucu
        if (!server) return; // BoÅŸsa geÃ§
        const pos = this.serverPosition(stationIdx, serverIdx, servers.length); // Konumu hesapla
        this.ensureJob(server.jobId); // Balonu hazÄ±rla
        if (forceInstant) this.moveNodeInstant(server.jobId, pos.x, pos.y); else this.moveNode(server.jobId, pos.x, pos.y); // Konumu uygula
        assigned.add(server.jobId); // AtandÄ± olarak iÅŸaretle
      });
    });
    return assigned; // Atanan kÃ¼mesini dÃ¶ndÃ¼r
  }
  normalizeWorld() { // TransformlarÄ± sÄ±fÄ±rla
    this.stationLayout.forEach(layout => this.updateNodeTransform(layout)); // Her dÃ¼ÄŸÃ¼mÃ¼ tazele
    this.updateEdges(); // KenarlarÄ± gÃ¼ncelle
    this.refreshJobAnchors(true); // BaloncuklarÄ± hizala
    this.updateBounds(); // GÃ¶rÃ¼nÃ¼mÃ¼ gÃ¼ncelle
  }
  setStations(stations) { // Ä°stasyon yerleÅŸimini gÃ¼ncelle
    this.stationLayout = stations.map((station, index) => { // TÃ¼m istasyonlarÄ± dolaÅŸ
      const hasValidX = station.position && Number.isFinite(station.position.x); // X koordinat kontrolÃ¼
      const hasValidY = station.position && Number.isFinite(station.position.y); // Y koordinat kontrolÃ¼
      const fallback = suggestStationPosition(index); // VarsayÄ±lan konum
      const x = hasValidX ? station.position.x : fallback.x; // X koordinatÄ±nÄ± seÃ§
      const y = hasValidY ? station.position.y : fallback.y; // Y koordinatÄ±nÄ± seÃ§
      if (!station.position) station.position = { x, y }; // Eksikse konum nesnesi oluÅŸtur
      station.position.x = x; // X deÄŸerini yaz
      station.position.y = y; // Y deÄŸerini yaz
      return { station, index, x, y, width: this.nodeWidth, height: this.nodeHeight }; // YerleÅŸim objesini dÃ¶ndÃ¼r
    });
    this.layoutById = new Map(this.stationLayout.map(item => [item.station.id, item])); // Kimlik haritasÄ±nÄ± gÃ¼ncelle
    this.drawStations(); // SVG'yi yeniden Ã§iz
    if (!this.hasCentered) { // Ä°lk yÃ¼kleme
      this.centerViewOnBounds(); // GÃ¶rÃ¼nÃ¼mÃ¼ ortala
      this.hasCentered = true; // BayraÄŸÄ± ata
    } else {
      this.updateBounds(); // SÄ±nÄ±rlarÄ± gÃ¼ncelle
    }
    this.setEditing(this.editing); // DÃ¼zenleme imlecini uygula
  }
  ensureMarkers() { // Ok iÅŸaretini oluÅŸtur
    if (!this.svg) return; // SVG yoksa Ã§Ä±k
    const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs'); // Defs oluÅŸtur
    const marker = document.createElementNS('http://www.w3.org/2000/svg', 'marker'); // Marker oluÅŸtur
    marker.setAttribute('id', this.markerId); // Kimlik ata
    marker.setAttribute('markerWidth', '12'); // GeniÅŸlik
    marker.setAttribute('markerHeight', '12'); // YÃ¼kseklik
    marker.setAttribute('refX', '10'); // Referans X
    marker.setAttribute('refY', '6'); // Referans Y
    marker.setAttribute('orient', 'auto'); // YÃ¶nlendirme
    marker.setAttribute('markerUnits', 'userSpaceOnUse'); // Ã–lÃ§ek birimi
    const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path'); // Ok ÅŸekli
    arrow.setAttribute('d', 'M 0 0 L 12 6 L 0 12 Z'); // ÃœÃ§gen Ã§iz
    arrow.setAttribute('fill', 'rgba(100,210,255,0.7)'); // Dolgu rengi
    marker.appendChild(arrow); // Oku markere ekle
    defs.appendChild(marker); // Markeri defs iÃ§ine ekle
    this.svg.appendChild(defs); // Defs'i SVG'ye ekle
  }
  drawStations() { // Ä°stasyon dÃ¼ÄŸÃ¼mlerini Ã§iz
    this.cancelEdgeDraft(); // Mevcut baÄŸlantÄ± taslaÄŸÄ±nÄ± temizle
    while (this.svg.firstChild) this.svg.removeChild(this.svg.firstChild); // TÃ¼m Ã§ocuklarÄ± temizle
    this.ensureMarkers(); // Ok markerÄ±nÄ± ekle
    this.edgeLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Kenar katmanÄ± oluÅŸtur
    this.edgeLayer.classList.add('edge-layer'); // SÄ±nÄ±f ata
    this.svg.appendChild(this.edgeLayer); // SVG'ye ekle
    this.nodeLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // DÃ¼ÄŸÃ¼m katmanÄ± oluÅŸtur
    this.nodeLayer.classList.add('node-layer'); // SÄ±nÄ±f ata
    this.svg.appendChild(this.nodeLayer); // SVG'ye ekle
    this.metricGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Metrik katmanÄ± oluÅŸtur
    this.metricGroup.classList.add('metric-layer'); // SÄ±nÄ±f ata
    this.svg.appendChild(this.metricGroup); // SVG'ye ekle
    this.nodeElements.clear(); // DÃ¼ÄŸÃ¼m referanslarÄ±nÄ± temizle
    this.stationLayout.forEach(layout => this.buildNodeGroup(layout)); // Her dÃ¼ÄŸÃ¼mÃ¼ oluÅŸtur
    this.drawEdges(); // KenarlarÄ± Ã§iz
    this.jobs.forEach(node => this.svg.appendChild(node.circle)); // BaloncuklarÄ± Ã¼ste taÅŸÄ±
  }
  buildNodeGroup(layout) { // Tek dÃ¼ÄŸÃ¼mÃ¼ oluÅŸtur
    const group = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Grup oluÅŸtur
    group.classList.add('station-node'); // SÄ±nÄ±f ekle
    group.dataset.id = layout.station.id; // Veri kimliÄŸi ata
    this.nodeLayer.appendChild(group); // Katmana ekle
    group.style.touchAction = 'none'; // Dokunma kaydÄ±rmasÄ±nÄ± engelle
    group.style.pointerEvents = 'all'; // EtkileÅŸime izin ver
    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect'); // Kutu oluÅŸtur
    rect.setAttribute('x', 0); // X konumu
    rect.setAttribute('y', 0); // Y konumu
    rect.setAttribute('width', layout.width); // GeniÅŸlik ata
    rect.setAttribute('height', layout.height); // YÃ¼kseklik ata
    rect.setAttribute('rx', 22); // KÃ¶ÅŸe yumuÅŸatma
    rect.classList.add('station-shape'); // SÄ±nÄ±f ekle
    group.appendChild(rect); // Gruba ekle
    const label = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Etiket oluÅŸtur
    label.classList.add('station-label'); // SÄ±nÄ±f ekle
    label.setAttribute('x', layout.width / 2); // Merkez X
    label.setAttribute('y', 26); // Y konumu
    label.setAttribute('text-anchor', 'middle'); // Ortala
    label.textContent = layout.station.name || layout.station.id; // Metin ata
    group.appendChild(label); // Gruba ekle
    const addGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // BaÄŸlantÄ± ekleme grubu
    addGroup.classList.add('node-connector-add'); // SÄ±nÄ±f ekle
    addGroup.style.pointerEvents = 'all'; // EtkileÅŸimi aÃ§
    addGroup.style.cursor = 'pointer'; // Ä°mleÃ§ tipi
    const addCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); // Ã‡ember oluÅŸtur
    addCircle.setAttribute('cx', layout.width - 14); // Merkez X
    addCircle.setAttribute('cy', layout.height / 2); // Merkez Y
    addCircle.setAttribute('r', 12); // YarÄ±Ã§ap
    addCircle.classList.add('connector-circle'); // Stil sÄ±nÄ±fÄ±
    addGroup.appendChild(addCircle); // Gruba ekle
    const addHoriz = document.createElementNS('http://www.w3.org/2000/svg', 'line'); // Yatay Ã§izgi
    addHoriz.setAttribute('x1', layout.width - 20); // BaÅŸlangÄ±Ã§ X
    addHoriz.setAttribute('x2', layout.width - 8); // BitiÅŸ X
    addHoriz.setAttribute('y1', layout.height / 2); // BaÅŸlangÄ±Ã§ Y
    addHoriz.setAttribute('y2', layout.height / 2); // BitiÅŸ Y
    addHoriz.classList.add('connector-plus'); // Stil sÄ±nÄ±fÄ±
    addGroup.appendChild(addHoriz); // Gruba ekle
    const addVert = document.createElementNS('http://www.w3.org/2000/svg', 'line'); // Dikey Ã§izgi
    addVert.setAttribute('x1', layout.width - 14); // BaÅŸlangÄ±Ã§ X
    addVert.setAttribute('x2', layout.width - 14); // BitiÅŸ X
    addVert.setAttribute('y1', layout.height / 2 - 6); // BaÅŸlangÄ±Ã§ Y
    addVert.setAttribute('y2', layout.height / 2 + 6); // BitiÅŸ Y
    addVert.classList.add('connector-plus'); // Stil sÄ±nÄ±fÄ±
    addGroup.appendChild(addVert); // Gruba ekle
    group.appendChild(addGroup); // Gruba ekle
    addGroup.addEventListener('click', event => { // TÄ±klama dinleyicisi
      event.stopPropagation(); // KabarcÄ±ÄŸÄ± durdur
      if (typeof this.handlers.beginEdge === 'function') { // Handler var mÄ±
        this.handlers.beginEdge(layout.station.id); // Taslak oluÅŸturmayÄ± baÅŸlat
      }
    });
    const forkIcon = document.createElementNS('http://www.w3.org/2000/svg', 'path'); // Fork simgesi
    forkIcon.setAttribute('d', 'M 0 0 L 12 -10 M 0 0 L -12 -10 M 0 0 L 0 12'); // Y ÅŸekli
    forkIcon.setAttribute('transform', `translate(${layout.width - 36}, ${layout.height / 2 - 4})`); // KonumlandÄ±r
    forkIcon.classList.add('fork-indicator'); // Stil sÄ±nÄ±fÄ±
    group.appendChild(forkIcon); // Gruba ekle
    layout.rect = rect; // YerleÅŸim referansÄ±
    layout.group = group; // Grup referansÄ±
    layout.forkIcon = forkIcon; // Fork simgesi referansÄ±
    this.nodeElements.set(layout.station.id, { group, addGroup, forkIcon, rect }); // ReferanslarÄ± sakla
    this.updateNodeTransform(layout); // Konumu uygula
    this.bindDrag(group, layout); // SÃ¼rÃ¼klemeyi baÄŸla
    group.addEventListener('click', event => { // DÃ¼ÄŸÃ¼m tÄ±klamasÄ±
      if (!this.edgeDraft) return; // Taslak yoksa Ã§Ä±k
      if (this.edgeDraft.sourceId === layout.station.id) return; // KaynaÄŸa tÄ±klamayÄ± yoksay
      event.stopPropagation(); // KabarcÄ±ÄŸÄ± durdur
      if (typeof this.handlers.completeEdge === 'function') { // Handler var mÄ±
        this.handlers.completeEdge(this.edgeDraft.sourceId, layout.station.id); // TaslaÄŸÄ± tamamla
      }
    });
  }
  bindDrag(group, layout) { // SÃ¼rÃ¼kleme olaylarÄ±nÄ± baÄŸla
    group.addEventListener('pointerdown', event => { // BaÅŸlangÄ±Ã§ olayÄ±
      if (!this.editing) return; // DÃ¼zenleme modunda deÄŸilse Ã§Ä±k
      if (event.button !== 0) return; // Sol tuÅŸ deÄŸilse Ã§Ä±k
      event.preventDefault(); // VarsayÄ±lanÄ± engelle
      const point = this.toSvgPoint(event); // SVG koordinatÄ±na Ã§evir
      const offsetX = point.x - layout.x; // X offsetini hesapla
      const offsetY = point.y - layout.y; // Y offsetini hesapla
      this.dragState = { layout, offsetX, offsetY, pointerId: event.pointerId }; // Durumu sakla
      group.setPointerCapture(event.pointerId); // Ä°ÅŸaretÃ§iyi yakala
    });
    group.addEventListener('pointermove', event => { // Hareket olayÄ±
      if (!this.dragState || this.dragState.pointerId !== event.pointerId) return; // GeÃ§erli sÃ¼rÃ¼kleme yoksa Ã§Ä±k
      const point = this.toSvgPoint(event); // KoordinatÄ± hesapla
      const proposedX = point.x - this.dragState.offsetX; // Ã–nerilen X
      const proposedY = point.y - this.dragState.offsetY; // Ã–nerilen Y
      const clamped = this.clampPosition(this.dragState.layout, proposedX, proposedY); // SÄ±nÄ±rla
      const dx = clamped.x - this.dragState.layout.x; // Delta X
      const dy = clamped.y - this.dragState.layout.y; // Delta Y
      if (!dx && !dy) return; // Hareket yoksa Ã§Ä±k
      this.dragState.layout.x = clamped.x; // X'i gÃ¼ncelle
      this.dragState.layout.y = clamped.y; // Y'yi gÃ¼ncelle
      this.updateNodeTransform(this.dragState.layout); // GÃ¶rseli gÃ¼ncelle
      this.translateStationJobs(this.dragState.layout, dx, dy); // BaloncuklarÄ± kaydÄ±r
      this.updateEdges(); // KenarlarÄ± tazele
      if (typeof this.handlers.moveNode === 'function') { // Handler varsa
        this.handlers.moveNode(this.dragState.layout.station.id, this.dragState.layout.x, this.dragState.layout.y, { live: true }); // CanlÄ± gÃ¼ncelle
      }
    });
    const finish = event => { // SÃ¼rÃ¼kleme bitiÅŸ iÅŸlemi
      if (!this.dragState || (event.pointerId !== undefined && this.dragState.pointerId !== event.pointerId)) return; // GeÃ§erli deÄŸilse Ã§Ä±k
      const state = this.dragState; // Durumu al
      this.dragState = null; // SÄ±fÄ±rla
      if (event.pointerId !== undefined) group.releasePointerCapture(event.pointerId); // YakalamayÄ± bÄ±rak
      const before = { x: state.layout.x, y: state.layout.y }; // Ã–nceki konum
      this.resolveCollisions(state.layout); // Ã‡akÄ±ÅŸmalarÄ± dÃ¼zelt
      const fixDx = state.layout.x - before.x; // DÃ¼zeltme X
      const fixDy = state.layout.y - before.y; // DÃ¼zeltme Y
      if (fixDx || fixDy) { // Ek kaydÄ±rma olduysa
        this.updateNodeTransform(state.layout); // Transformu gÃ¼ncelle
        this.translateStationJobs(state.layout, fixDx, fixDy); // BaloncuklarÄ± taÅŸÄ±
      }
      this.updateEdges(); // KenarlarÄ± yenile
      this.refreshJobAnchors(true); // BaloncuklarÄ± hizala
      this.updateBounds(); // GÃ¶rÃ¼nÃ¼m sÄ±nÄ±rlarÄ±nÄ± gÃ¼ncelle
      if (typeof this.handlers.moveNode === 'function') { // Handler varsa
        this.handlers.moveNode(state.layout.station.id, state.layout.x, state.layout.y, { live: false }); // KalÄ±cÄ± gÃ¼ncelle
      }
    }; // finish sonu
    group.addEventListener('pointerup', finish); // BitiÅŸ olayÄ±
    group.addEventListener('pointercancel', finish); // Ä°ptal olayÄ±
    group.addEventListener('pointerleave', event => { // AlanÄ± terk ettiÄŸinde
      if (!this.dragState) return; // SÃ¼rÃ¼kleme yoksa Ã§Ä±k
      if (event.buttons === 0) finish(event); // TuÅŸ bÄ±rakÄ±ldÄ±ysa bitir
    });
  }
  toSvgPoint(event) { // Ekran koordinatÄ±nÄ± SVG koordinatÄ±na Ã§evir
    const point = this.svg.createSVGPoint(); // Nokta oluÅŸtur
    point.x = event.clientX; // X deÄŸerini ata
    point.y = event.clientY; // Y deÄŸerini ata
    const matrix = this.svg.getScreenCTM(); // DÃ¶nÃ¼ÅŸÃ¼m matrisini al
    return matrix ? point.matrixTransform(matrix.inverse()) : { x: point.x, y: point.y }; // Matrisi uygula
  }
  toScreenPoint(x, y) { // SVG koordinatÄ±nÄ± ekran koordinatÄ±na Ã§evir
    const point = this.svg.createSVGPoint(); // Nokta oluÅŸtur
    point.x = x; // X deÄŸeri
    point.y = y; // Y deÄŸeri
    const matrix = this.svg.getScreenCTM(); // Matris al
    const transformed = matrix ? point.matrixTransform(matrix) : point; // DÃ¶nÃ¼ÅŸtÃ¼r
    return { x: transformed.x, y: transformed.y }; // Sonucu dÃ¶ndÃ¼r
  }
  updateNodeTransform(layout) { // DÃ¼ÄŸÃ¼m pozisyonunu uygula
    const node = this.nodeElements.get(layout.station.id); // DÃ¼ÄŸÃ¼m referansÄ±
    if (node) node.group.setAttribute('transform', `translate(${layout.x}, ${layout.y})`); // SVG transformunu gÃ¼ncelle
    if (!layout.station.position) layout.station.position = { x: layout.x, y: layout.y }; // Konum nesnesini hazÄ±rla
    layout.station.position.x = layout.x; // X deÄŸerini yaz
    layout.station.position.y = layout.y; // Y deÄŸerini yaz
  }
  drawEdges() { // KenarlarÄ± Ã§iz
    while (this.edgeLayer.firstChild) this.edgeLayer.removeChild(this.edgeLayer.firstChild); // Mevcut kenarlarÄ± temizle
    this.edgeElements.clear(); // Kenar referanslarÄ±nÄ± temizle
    this.stationLayout.forEach(layout => { // Her istasyonu dolaÅŸ
      const outputs = Array.isArray(layout.station.outputs) ? layout.station.outputs : []; // Ã‡Ä±kÄ±ÅŸ listesi
      outputs.forEach((targetId, index) => { // Her baÄŸlantÄ± iÃ§in
        const targetLayout = this.layoutById.get(targetId); // Hedef yerleÅŸimi al
        if (!targetLayout) return; // Yoksa geÃ§
        const group = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Kenar grubu oluÅŸtur
        group.classList.add('edge-group'); // SÄ±nÄ±f ekle
        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path'); // Kenar yolu
        path.classList.add('edge-path'); // SÄ±nÄ±f ekle
        path.setAttribute('fill', 'none'); // Dolgu yok
        path.setAttribute('stroke', this.edgeStrokeFor(layout.station.id, index)); // Renk ata
        path.setAttribute('stroke-width', '3'); // KalÄ±nlÄ±k ata
        path.setAttribute('marker-end', `url(#${this.markerId})`); // Ok ucu ata
        group.appendChild(path); // Gruba ekle
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Etiket oluÅŸtur
        label.classList.add('edge-label'); // SÄ±nÄ±f ekle
        label.setAttribute('text-anchor', 'middle'); // Ortala
        label.textContent = `${layout.station.name || layout.station.id}â†’${targetLayout.station.name || targetLayout.station.id}`; // Metin ata
        group.appendChild(label); // Gruba ekle
        const remove = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Silme butonu
        remove.classList.add('edge-remove'); // SÄ±nÄ±f ekle
        remove.textContent = 'Ã—'; // Metin ata
        remove.addEventListener('click', event => { // TÄ±klama dinleyicisi
          event.stopPropagation(); // KabarcÄ±ÄŸÄ± durdur
          if (typeof this.handlers.removeEdge === 'function') { // Handler varsa
            this.handlers.removeEdge(layout.station.id, targetId); // Handler Ã§aÄŸÄ±r
          }
        });
        group.appendChild(remove); // Gruba ekle
        this.edgeLayer.appendChild(group); // Katmana ekle
        this.edgeElements.set(`${layout.station.id}->${targetId}`, { path, label, remove, sourceId: layout.station.id, targetId }); // Haritaya kaydet
      });
    });
    this.updateEdges(); // KonumlarÄ± hesapla
    this.refreshForkIndicators(); // Fork simgelerini gÃ¼ncelle
  }
  edgeStrokeFor(sourceId, index) { // Kenar rengi Ã¼ret
    const seed = Array.from(sourceId).reduce((sum, char) => sum + char.charCodeAt(0), 0) + index * 53; // Ã‡ekirdek hesapla
    const hue = seed % 360; // Hue deÄŸeri
    return `hsla(${hue}, 68%, 58%, 0.85)`; // HSL renk dÃ¶ndÃ¼r
  }
  updateEdges() { // Kenar konumlarÄ±nÄ± gÃ¼ncelle
    this.edgeElements.forEach(edge => { // Her kenar iÃ§in
      const source = this.layoutById.get(edge.sourceId); // Kaynak yerleÅŸim
      const target = this.layoutById.get(edge.targetId); // Hedef yerleÅŸim
      if (!source || !target) return; // Eksikse Ã§Ä±k
      const start = { x: source.x + source.width, y: source.y + source.height / 2 }; // BaÅŸlangÄ±Ã§ noktasÄ±
      const end = { x: target.x, y: target.y + target.height / 2 }; // BitiÅŸ noktasÄ±
      const deltaX = Math.max(60, Math.abs(end.x - start.x)); // X farkÄ±
      const controlOffset = deltaX * 0.35; // Kontrol offseti
      const control1 = `${start.x + controlOffset} ${start.y - 60}`; // Ä°lk kontrol
      const control2 = `${end.x - controlOffset} ${end.y + 60}`; // Ä°kinci kontrol
      edge.path.setAttribute('d', `M ${start.x} ${start.y} C ${control1}, ${control2}, ${end.x} ${end.y}`); // Yolu yaz
      const midX = (start.x + end.x) / 2; // Orta X
      const midY = (start.y + end.y) / 2 - 24; // Orta Y
      edge.label.setAttribute('x', midX); // Etiket X
      edge.label.setAttribute('y', midY); // Etiket Y
      edge.remove.setAttribute('x', midX); // Silme X
      edge.remove.setAttribute('y', midY - 14); // Silme Y
    });
  }
  refreshForkIndicators() { // Fork simgelerini gÃ¼ncelle
    this.stationLayout.forEach(layout => { // Her istasyonu dolaÅŸ
      const outputs = Array.isArray(layout.station.outputs) ? layout.station.outputs.length : 0; // Ã‡Ä±kÄ±ÅŸ sayÄ±sÄ±nÄ± al
      const node = this.nodeElements.get(layout.station.id); // DÃ¼ÄŸÃ¼m referansÄ±
      if (!node) return; // Yoksa geÃ§
      if (outputs > 1) { // Birden fazla Ã§Ä±kÄ±ÅŸ varsa
        node.forkIcon.style.display = 'block'; // Simgesini gÃ¶ster
        node.group.classList.add('fork-node'); // Stil sÄ±nÄ±fÄ± ekle
      } else {
        node.forkIcon.style.display = 'none'; // Simgesini gizle
        node.group.classList.remove('fork-node'); // Stil sÄ±nÄ±fÄ±nÄ± kaldÄ±r
      }
    });
  }
  applyLayout(layout, timeCursor = 0) { // SimÃ¼lasyon yerleÅŸimini uygula
    layout.forEach((item, idx) => { // Her istasyon iÃ§in
      const nodeLayout = this.stationLayout[idx]; // YerleÅŸimi al
      if (!nodeLayout) return; // Bulunamazsa geÃ§
      nodeLayout.queue = item.queue; // Kuyruk verisini sakla
      nodeLayout.servers = item.servers; // Sunucu verisini sakla
    });
    this.updateEdges(); // KenarlarÄ± gÃ¼ncelle
    this.refreshJobAnchors(); // BaloncuklarÄ± yeni geometriye taÅŸÄ±
    this.renderMetrics(layout, timeCursor); // Metrikleri Ã§iz
    this.jobs.forEach(node => this.svg.appendChild(node.circle)); // BaloncuklarÄ± Ã¼stte tut
  }
  queuePosition(stationIdx, queueIdx) { // Kuyruktaki balon konumu
    const layout = this.stationLayout[stationIdx]; // YerleÅŸimi al
    const x = layout.x + layout.width / 2; // Merkez X
    const y = layout.y - 26 - queueIdx * 28; // Ãœstte sÄ±ralÄ± pozisyon
    return { x, y }; // KoordinatÄ± dÃ¶ndÃ¼r
  }
  serverPosition(stationIdx, serverIdx, totalServers) { // Servis iÃ§i balon konumu
    const layout = this.stationLayout[stationIdx]; // YerleÅŸimi al
    const spacing = layout.width / Math.max(1, totalServers + 1); // AralÄ±k hesapla
    const x = layout.x + spacing * (serverIdx + 1); // X pozisyonu
    const y = layout.y + layout.height / 2 + 30; // Y pozisyonu
    return { x, y }; // KoordinatÄ± dÃ¶ndÃ¼r
  }
  moveNode(jobId, x, y) { // Balonu hareket ettir
    const node = this.jobs.get(jobId); // Balonu al
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.startX = node.x; // BaÅŸlangÄ±Ã§ X
    node.startY = node.y; // BaÅŸlangÄ±Ã§ Y
    node.targetX = x; // Hedef X
    node.targetY = y; // Hedef Y
    node.startTime = performance.now(); // Animasyon baÅŸlangÄ±cÄ±
    node.duration = MOVE_DURATION_MS / this.speed; // SÃ¼re hesapla
  }
  moveNodeInstant(jobId, x, y) { // Balonu anÄ±nda taÅŸÄ± (iÃ§ kullanÄ±m iÃ§in)
    const node = this.jobs.get(jobId); // Balonu al
    if (!node) return; // BulunamadÄ±ysa Ã§Ä±k
    node.x = x; // X ata
    node.y = y; // Y ata
    node.circle.setAttribute('cx', x); // SVG X
    node.circle.setAttribute('cy', y); // SVG Y
  }
  renderMetrics(layout, timeCursor) { // Metrikleri Ã§iz
    while (this.metricGroup.firstChild) this.metricGroup.removeChild(this.metricGroup.firstChild); // Ã–nceki metinleri temizle
    layout.forEach((item, idx) => { // Her istasyon iÃ§in
      const layoutInfo = this.stationLayout[idx]; // YerleÅŸimi al
      if (!layoutInfo) return; // Yoksa geÃ§
      const nodeRefs = this.nodeElements.get(layoutInfo.station.id); // DÃ¼ÄŸÃ¼m referansÄ±
      if (nodeRefs) nodeRefs.group.classList.remove('bottleneck'); // Ã–nceki vurguyu temizle
      const queueText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Kuyruk etiketi
      queueText.classList.add('metric-tag'); // Stil sÄ±nÄ±fÄ±
      queueText.setAttribute('x', layoutInfo.x + layoutInfo.width / 2); // X deÄŸeri
      queueText.setAttribute('y', layoutInfo.y + layoutInfo.height + 18); // Y deÄŸeri
      queueText.setAttribute('text-anchor', 'middle'); // Ortala
      queueText.textContent = `Kuyruk: ${item.metrics.queueLength} Â· Ort:${item.metrics.avgQueue.toFixed(1)}`; // Metni yaz
      const danger = item.metrics.avgQueue > 1.5 || item.metrics.avgUtil > 0.85; // Tehlike durumu
      if (danger) queueText.classList.add('danger'); // SÄ±nÄ±f ekle
      this.metricGroup.appendChild(queueText); // SVG'ye ekle
      const serviceText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Servis etiketi
      serviceText.classList.add('metric-tag'); // Stil sÄ±nÄ±fÄ±
      serviceText.setAttribute('x', layoutInfo.x + layoutInfo.width / 2); // X deÄŸeri
      serviceText.setAttribute('y', layoutInfo.y + layoutInfo.height + 34); // Y deÄŸeri
      serviceText.setAttribute('text-anchor', 'middle'); // Ortala
      const activeServers = item.servers.filter(server => !!server); // Aktif sunucular
      if (activeServers.length) { // Serviste iÅŸ varsa
        const avgProgress = activeServers.reduce((sum, server) => sum + server.progress, 0) / activeServers.length; // Ortalama ilerleme
        const maxRemaining = Math.max(...activeServers.map(server => server.remaining)); // Maks kalan sÃ¼re
        serviceText.textContent = `Servis: ${item.metrics.busyCount}/${item.metrics.capacity} Â· %${(avgProgress * 100).toFixed(0)} Â· kalan ${maxRemaining.toFixed(1)}sn`; // Metni yaz
      } else {
        serviceText.textContent = 'Servis: boÅŸ'; // Servis yoksa metin
      }
      if (danger) serviceText.classList.add('danger'); // Tehlike sÄ±nÄ±fÄ±
      this.metricGroup.appendChild(serviceText); // SVG'ye ekle
      if (danger && nodeRefs) nodeRefs.group.classList.add('bottleneck'); // DÃ¼ÄŸÃ¼mÃ¼ vurgula
    });
  }
  frame(timestamp) { // Animasyon karesi
    const removal = []; // KaldÄ±rÄ±lacak balonlar listesi
    this.jobs.forEach((node, jobId) => { // Her balonu dolaÅŸ
      const progress = Math.min(1, (timestamp - node.startTime) / Math.max(1, node.duration)); // Ä°lerleme yÃ¼zdesi
      const eased = progress < 1 ? (1 - Math.pow(1 - progress, 3)) : 1; // Ease-out kÃ¼p
      node.progress = progress; // Ham ilerleme oranÄ±
      node.x = node.startX + (node.targetX - node.startX) * eased; // X hesapla
      node.y = node.startY + (node.targetY - node.startY) * eased; // Y hesapla
      node.circle.setAttribute('cx', node.x); // SVG X gÃ¼ncelle
      node.circle.setAttribute('cy', node.y); // SVG Y gÃ¼ncelle
      if (node.removeAt && timestamp >= node.removeAt) removal.push(jobId); // Silme zamanÄ± geldi mi
    });
    removal.forEach(jobId => this.removeJob(jobId)); // BalonlarÄ± kaldÄ±r
    requestAnimationFrame(this.frame); // Sonraki kareyi iste
  }
}

// UI yardÄ±mcÄ±larÄ± //
const stationListEl = document.getElementById('stationList'); // Ä°stasyon liste alanÄ±
const emptyStateEl = document.getElementById('emptyState'); // BoÅŸ durum mesajÄ±
const addStationBtn = document.getElementById('addStationBtn'); // Ä°stasyon ekleme butonu
const startBtn = document.getElementById('startBtn'); // BaÅŸlat butonu
const stopBtn = document.getElementById('stopBtn'); // Durdur butonu
const resetBtn = document.getElementById('resetBtn'); // SÄ±fÄ±rla butonu
const clearBtn = document.getElementById('clearBtn'); // Temizleme butonu
const viewModeBtn = document.getElementById('viewModeBtn'); // GÃ¶rÃ¼ntÃ¼leme modu butonu
const editModeBtn = document.getElementById('editModeBtn'); // DÃ¼zenleme modu butonu
const sampleBtn = document.getElementById('sampleSetupBtn'); // Ã–rnek kurulum butonu
const analysisBtn = document.getElementById('analysisBtn'); // Analiz butonu
const saveScenarioBtn = document.getElementById('saveScenarioBtn'); // Senaryo kaydet butonu
const newTabToolbarBtn = document.getElementById('newTabToolbarBtn'); // Yeni sekme butonu (araÃ§ Ã§ubuÄŸu)
const closeTabBtn = document.getElementById('closeTabBtn'); // Sekme kapatma butonu
const newTabBtn = document.getElementById('newTabBtn'); // Sekme Ã§ubuÄŸu yeni sekme butonu
const tabBarEl = document.getElementById('tabBar'); // Sekme Ã§ubuÄŸu kapsayÄ±cÄ±
const speedSlider = document.getElementById('speedSlider'); // HÄ±z slider
const speedValue = document.getElementById('speedValue'); // HÄ±z deÄŸeri
const targetInput = document.getElementById('targetInput'); // Hedef giriÅŸi
const entryPolicySelect = document.getElementById('entryPolicySelect'); // GiriÅŸ politikasÄ± seÃ§imi
const entryIntervalInput = document.getElementById('entryIntervalInput'); // AralÄ±k giriÅŸi
const taktInput = document.getElementById('taktInput'); // Takt time giriÅŸi
const simulationMenuBtn = document.getElementById('simulationMenuBtn'); // SimÃ¼lasyon menÃ¼ butonu
const simulationMenu = document.getElementById('simulationMenu'); // SimÃ¼lasyon menÃ¼ paneli
const viewMenuBtn = document.getElementById('viewMenuBtn'); // GÃ¶rÃ¼nÃ¼m menÃ¼ butonu
const viewMenu = document.getElementById('viewMenu'); // GÃ¶rÃ¼nÃ¼m menÃ¼ paneli
const storageMenuBtn = document.getElementById('storageMenuBtn'); // KayÄ±t menÃ¼ butonu
const storageMenu = document.getElementById('storageMenu'); // KayÄ±t menÃ¼ paneli
const loadMenuList = document.getElementById('loadMenuList'); // KayÄ±tlÄ± senaryo listesi
const viewZoomOutBtn = document.getElementById('viewZoomOutBtn'); // MenÃ¼lÃ¼ zoom azalt butonu
const viewZoomResetBtn = document.getElementById('viewZoomResetBtn'); // MenÃ¼lÃ¼ zoom sÄ±fÄ±rla butonu
const viewZoomInBtn = document.getElementById('viewZoomInBtn'); // MenÃ¼lÃ¼ zoom artÄ±r butonu
const zoomOutBtn = document.getElementById('zoomOutBtn'); // Zoom kÃ¼Ã§Ã¼lt butonu
const zoomInBtn = document.getElementById('zoomInBtn'); // Zoom bÃ¼yÃ¼t butonu
const zoomResetBtn = document.getElementById('zoomResetBtn'); // Zoom sÄ±fÄ±rlama butonu
const zoomValueEls = Array.from(document.querySelectorAll('[data-role="zoom-value"]')); // Zoom deÄŸer etiketleri
const visualPanel = document.getElementById('visualPanel'); // GÃ¶rsel panel kapsayÄ±cÄ±
const fullscreenBtn = document.getElementById('fullscreenBtn'); // Tam ekran butonu
const fullscreenLabel = fullscreenBtn ? fullscreenBtn.querySelector('span') : null; // Tam ekran etiket metni
const otherMenuBtn = document.getElementById('otherMenuBtn'); // DiÄŸer menÃ¼ butonu
const otherMenu = document.getElementById('otherMenu'); // DiÄŸer menÃ¼ paneli
const saveLayoutBtn = document.getElementById('saveLayoutBtn'); // YerleÅŸim kaydet butonu
const centerLayoutBtn = document.getElementById('centerLayoutBtn'); // Merkeze toplama butonu
const resetLayoutBtn = document.getElementById('resetLayoutBtn'); // YerleÅŸimi sÄ±fÄ±rlama butonu
const normalizeLayoutBtn = document.getElementById('normalizeLayoutBtn'); // DÃ¼zeni onarma butonu
const refreshBubblesBtn = document.getElementById('refreshBubblesBtn'); // Baloncuk yenileme butonu
const resultsBtn = document.getElementById('resultsBtn'); // SonuÃ§ aÃ§ma butonu
const reportModal = document.getElementById('reportModal'); // Rapor modalÄ±
const closeReportBtn = document.getElementById('closeReportBtn'); // Modal kapatma butonu
const downloadCsvBtn = document.getElementById('downloadCsvBtn'); // CSV butonu
const downloadPdfBtn = document.getElementById('downloadPdfBtn'); // PDF butonu
const restoreModal = document.getElementById('restoreModal'); // Kurtarma modalÄ±
const restoreYesBtn = document.getElementById('restoreYesBtn'); // Kurtarma evet butonu
const restoreNoBtn = document.getElementById('restoreNoBtn'); // Kurtarma hayÄ±r butonu
const restoreNeverBtn = document.getElementById('restoreNeverBtn'); // Kurtarma hiÃ§ sorma butonu
const cardCycleEl = document.getElementById('cardCycle'); // Cycle kartÄ± metni
const cardCompletedEl = document.getElementById('cardCompleted'); // Tamamlanan kart metni
const cardThroughputEl = document.getElementById('cardThroughput'); // Throughput kart metni
const cardWipEl = document.getElementById('cardWip'); // WIP kart metni
const stationPerformanceBody = document.getElementById('stationPerformanceBody'); // Ä°stasyon tablo gÃ¶vdesi
const bottleneckTableBody = document.getElementById('bottleneckTableBody'); // DarboÄŸaz tablo gÃ¶vdesi
const forkSummaryBody = document.getElementById('forkSummaryBody'); // Fork tablosu gÃ¶vdesi
const jobLineageBody = document.getElementById('jobLineageBody'); // Ä°ÅŸ rotasÄ± tablo gÃ¶vdesi
const queueChartCanvas = document.getElementById('queueChart'); // Kuyruk grafiÄŸi canvasÄ±
const throughputChartCanvas = document.getElementById('throughputChart'); // Throughput grafiÄŸi canvasÄ±
const dashboardAnalysisText = document.getElementById('dashboardAnalysisText'); // Dashboard analiz metni
const dashboardAnalysisList = document.getElementById('dashboardAnalysisList'); // Dashboard analiz listesi
const completedCounterEl = document.getElementById('completedCounter'); // Tamamlanan sayaÃ§ etiketi
const analysisModal = document.getElementById('analysisModal'); // Analiz modalÄ±
const closeAnalysisBtn = document.getElementById('closeAnalysisBtn'); // Analiz kapanÄ±ÅŸ butonu
const analysisRecalcBtn = document.getElementById('analysisRecalcBtn'); // Analiz hesaplama butonu
const analysisTableBody = document.getElementById('analysisTableBody'); // Analiz tablo gÃ¶vdesi
const analysisText = document.querySelector('#analysisInsights .analysis-text'); // Analiz yorum metni
const analysisList = document.querySelector('#analysisWhatIf .analysis-list'); // What-if listesi
let latestReport = null; // Son oluÅŸturulan rapor referansÄ±
let scheduledChartFrame = 0; // requestAnimationFrame kimliÄŸi

updateFullscreenLabel(); // BaÅŸlangÄ±Ã§ta tam ekran etiketi hizala

const viz = new Visualization(document.getElementById('lineSvg')); // GÃ¶rselleÅŸtirme Ã¶rneÄŸi
const stationRuntimeRefs = new Map(); // CanlÄ± metrik referans haritasÄ±

let graphToastEl = null; // Grafik bildirim etiketi
let graphToastTimer = 0; // Bildirim zamanlayÄ±cÄ±sÄ±
let openDropdownMenu = null; // AÃ§Ä±k menÃ¼ referansÄ±
let dropdownOutsideHandler = null; // MenÃ¼ dÄ±ÅŸÄ± tÄ±klama dinleyicisi
let openDropdownTrigger = null; // AÃ§Ä±k menÃ¼nÃ¼n tetikleyicisi referansÄ±
let draggingTabId = null; // SÃ¼rÃ¼klenen sekme kimliÄŸi
let edgeDraftKeyHandler = null; // Taslak klavye dinleyicisi
let pendingRestoreSnapshot = null; // Kurtarma modalÄ± iÃ§in bekleyen veri

function showGraphToast(message, tone = 'info') { // GÃ¶rsel panelde uyarÄ± gÃ¶ster
  if (!visualPanel) return; // Panel yoksa Ã§Ä±k
  if (!graphToastEl) { // Ä°lk oluÅŸturma
    graphToastEl = document.createElement('div'); // Bildirim kutusu
    graphToastEl.className = 'graph-toast'; // Stil sÄ±nÄ±fÄ±
    visualPanel.appendChild(graphToastEl); // Panele ekle
  }
  graphToastEl.textContent = message; // MesajÄ± yaz
  graphToastEl.className = `graph-toast ${tone}`; // Ton sÄ±nÄ±fÄ±nÄ± ata
  graphToastEl.style.opacity = '1'; // GÃ¶rÃ¼nÃ¼r yap
  clearTimeout(graphToastTimer); // Ã–nceki zamanlayÄ±cÄ±yÄ± temizle
  graphToastTimer = window.setTimeout(() => { // Yeni zamanlayÄ±cÄ±
    if (graphToastEl) graphToastEl.style.opacity = '0'; // YumuÅŸak kaybolma
  }, 3200); // SÃ¼re
}

function cancelConnectionDraft(reason = 'manual') { // BaÄŸlantÄ± taslaÄŸÄ±nÄ± iptal et
  const hadDraft = !!appState.edgeDraft; // Taslak var mÄ±
  if (viz) viz.cancelEdgeDraft(); // GÃ¶rsel taslaÄŸÄ± sil
  if (edgeDraftKeyHandler) { // Klavye dinleyicisi varsa
    document.removeEventListener('keydown', edgeDraftKeyHandler, true); // Dinleyiciyi kaldÄ±r
    edgeDraftKeyHandler = null; // ReferansÄ± sÄ±fÄ±rla
  }
  appState.edgeDraft = null; // Uygulama durumunu temizle
  if (hadDraft && (reason === 'manual' || reason === 'background')) { // KullanÄ±cÄ± kaynaklÄ± iptal ise
    showGraphToast(t('toast.edgeCancelled'), 'info'); // Bildirim gÃ¶ster
  }
}

function beginConnectionDraft(sourceId) { // Yeni baÄŸlantÄ± taslaÄŸÄ± baÅŸlat
  if (appState.running) { // SimÃ¼lasyon Ã§alÄ±ÅŸÄ±yorsa
    showGraphToast(t('toast.runningLock'), 'warning'); // UyarÄ± gÃ¶ster
    return false; // BaÅŸarÄ±sÄ±z
  }
  if (appState.mode !== 'edit') return false; // DÃ¼zenleme modunda deÄŸilse Ã§Ä±k
  const source = appState.stations.find(station => station.id === sourceId); // Kaynak istasyonu bul
  if (!source) return false; // BulunamadÄ±ysa Ã§Ä±k
  const targets = listPotentialTargets(sourceId); // Uygun hedefleri listele
  if (!targets.length) { // Hedef yoksa
    showGraphToast(t('toast.noTargets'), 'info'); // Bilgi ver
    return false; // BaÅŸarÄ±sÄ±z
  }
  cancelConnectionDraft('replace'); // Var olan taslaÄŸÄ± sessizce sil
  const targetIds = targets.map(target => target.id); // Hedef kimliklerini hazÄ±rla
  appState.edgeDraft = { sourceId, sourceName: source.name || source.id, targets: targetIds }; // Taslak durumunu kaydet
  const began = viz ? viz.beginEdgeDraft(sourceId, targetIds) : false; // GÃ¶rsel taslaÄŸÄ± oluÅŸtur
  if (!began) { // BaÅŸlatÄ±lamadÄ±ysa
    appState.edgeDraft = null; // Durumu temizle
    return false; // BaÅŸarÄ±sÄ±z
  }
  if (!edgeDraftKeyHandler) { // Klavye dinleyicisi yoksa
    edgeDraftKeyHandler = event => { // Dinleyiciyi tanÄ±mla
      if (event.key === 'Escape') { // Escape tuÅŸu
        event.preventDefault(); // VarsayÄ±lanÄ± engelle
        cancelConnectionDraft('manual'); // TaslaÄŸÄ± kapat
      }
    }; // Dinleyici sonu
    document.addEventListener('keydown', edgeDraftKeyHandler, true); // Dinleyiciyi baÄŸla
  }
  showGraphToast(t('toast.edgePrompt', { source: source.name || source.id }), 'info'); // KullanÄ±cÄ±yÄ± yÃ¶nlendir
  return true; // BaÅŸarÄ±lÄ±
}

function completeConnectionDraft(sourceId, targetId) { // Taslak baÄŸlantÄ±yÄ± tamamla
  const draft = appState.edgeDraft; // Taslak durumunu al
  if (!draft || draft.sourceId !== sourceId) return; // GeÃ§erli taslak yoksa Ã§Ä±k
  const source = appState.stations.find(station => station.id === sourceId); // Kaynak istasyonu bul
  const target = appState.stations.find(station => station.id === targetId); // Hedef istasyonu bul
  const success = addConnection(sourceId, targetId, { silent: true }); // BaÄŸlantÄ±yÄ± ekle
  if (!success) return; // BaÅŸarÄ±sÄ±zsa Ã§Ä±k
  cancelConnectionDraft('complete'); // TaslaÄŸÄ± temizle
  renderGraph(appState.stations); // GrafiÄŸi yenile
  const sourceName = source ? (source.name || source.id) : sourceId; // Kaynak adÄ±
  const targetName = target ? (target.name || targetId) : targetId; // Hedef adÄ±
  showGraphToast(t('toast.edgeAdded', { source: sourceName, target: targetName }), 'success'); // BaÅŸarÄ± mesajÄ±
}

function normalizeStationTopology(stations) { // Ä°stasyon topolojisini normalize et
  stations.forEach((station, index) => { // Her istasyonu dolaÅŸ
    if (!Array.isArray(station.outputs)) station.outputs = []; // Ã‡Ä±kÄ±ÅŸ listesi oluÅŸtur
    station.outputs = station.outputs.map(target => String(target)).filter((target, idx, arr) => arr.indexOf(target) === idx); // Benzersiz ve string hale getir
    if (!station.position || !Number.isFinite(station.position.x) || !Number.isFinite(station.position.y)) { // Konum yoksa
      const fallback = suggestStationPosition(index); // VarsayÄ±lan konumu al
      station.position = { x: fallback.x, y: fallback.y }; // Konumu ata
    }
  });
}

function listPotentialTargets(sourceId) { // Uygun hedef istasyonlarÄ± listele
  const source = appState.stations.find(station => station.id === sourceId); // Kaynak istasyonu bul
  if (!source) return []; // Yoksa boÅŸ
  const existing = new Set(Array.isArray(source.outputs) ? source.outputs : []); // Mevcut baÄŸlantÄ±lar
  return appState.stations.filter(target => { // Ä°stasyonlarÄ± filtrele
    if (target.id === sourceId) return false; // Kendine baÄŸlantÄ±yÄ± engelle
    if (existing.has(target.id)) return false; // MÃ¼kerrer baÄŸlantÄ±yÄ± engelle
    return !wouldCreateCycle(sourceId, target.id); // DÃ¶ngÃ¼yÃ¼ engelle
  });
}

function wouldCreateCycle(sourceId, targetId) { // DÃ¶ngÃ¼ kontrolÃ¼
  if (sourceId === targetId) return true; // AynÄ± dÃ¼ÄŸÃ¼m dÃ¶ngÃ¼
  const adjacency = new Map(); // KomÅŸuluk haritasÄ±
  appState.stations.forEach(station => { // TÃ¼m istasyonlarÄ± dolaÅŸ
    const outputs = Array.isArray(station.outputs) ? station.outputs.map(out => String(out)) : []; // Ã‡Ä±kÄ±ÅŸ listesi
    adjacency.set(station.id, new Set(outputs)); // KomÅŸularÄ± kaydet
  });
  if (!adjacency.has(sourceId)) adjacency.set(sourceId, new Set()); // Kaynak yoksa oluÅŸtur
  adjacency.get(sourceId).add(String(targetId)); // Yeni baÄŸlantÄ±yÄ± ekle
  const visited = new Set(); // Ziyaret edilenler
  const stack = [String(targetId)]; // DFS yÄ±ÄŸÄ±nÄ±
  while (stack.length) { // DFS dÃ¶ngÃ¼sÃ¼
    const node = stack.pop(); // Bir dÃ¼ÄŸÃ¼m Ã§ek
    if (node === sourceId) return true; // KaynaÄŸa ulaÅŸÄ±ldÄ±ysa dÃ¶ngÃ¼ var
    if (visited.has(node)) continue; // Ziyaret edildiyse geÃ§
    visited.add(node); // Ziyaret iÅŸaretle
    const neighbors = adjacency.get(node); // KomÅŸularÄ± al
    if (neighbors) neighbors.forEach(child => stack.push(child)); // KomÅŸularÄ± yÄ±ÄŸÄ±na ekle
  }
  return false; // DÃ¶ngÃ¼ yok
}

function reorderStationsByTopology() { // BaÄŸlantÄ±lara gÃ¶re istasyonlarÄ± sÄ±rala
  if (!Array.isArray(appState.stations) || appState.stations.length <= 1) return; // Yetersiz istasyon varsa Ã§Ä±k
  const idToStation = new Map(); // Kimlikten istasyona sÃ¶zlÃ¼k
  const indegree = new Map(); // GiriÅŸ dereceleri
  const adjacency = new Map(); // KomÅŸuluk listesi
  appState.stations.forEach((station, index) => { // Her istasyon iÃ§in
    const id = String(station.id); // KimliÄŸi string yap
    idToStation.set(id, station); // Ä°stasyonu haritaya yaz
    indegree.set(id, 0); // BaÅŸlangÄ±Ã§ indegree
    const neighbors = Array.isArray(station.outputs) ? station.outputs.map(output => String(output)) : []; // Ã‡Ä±kÄ±ÅŸ listesi
    adjacency.set(id, neighbors); // KomÅŸularÄ± kaydet
    station._originalIndex = index; // GeÃ§ici sÄ±rayÄ± sakla
  });
  adjacency.forEach(neighbors => { // TÃ¼m komÅŸuluklarÄ± dolaÅŸ
    neighbors.forEach(neighbor => { // Her hedef iÃ§in
      if (indegree.has(neighbor)) indegree.set(neighbor, indegree.get(neighbor) + 1); // GiriÅŸ derecesini artÄ±r
    });
  });
  const queue = Array.from(indegree.entries()) // GiriÅŸ derecesi sÄ±fÄ±r olanlar
    .filter(([, degree]) => degree === 0) // SÄ±fÄ±r filtrele
    .sort((a, b) => (idToStation.get(a[0])._originalIndex ?? 0) - (idToStation.get(b[0])._originalIndex ?? 0)) // Orijinal sÄ±raya gÃ¶re sÄ±rala
    .map(([id]) => id); // Kimlik listesi
  const ordered = []; // Son sÄ±ra
  while (queue.length) { // Kahn algoritmasÄ±
    const current = queue.shift(); // Kuyruktan al
    ordered.push(current); // SÄ±raya ekle
    const neighbors = adjacency.get(current) || []; // KomÅŸularÄ± al
    neighbors.forEach(neighbor => { // Her komÅŸu iÃ§in
      if (!indegree.has(neighbor)) return; // Bilinmiyorsa geÃ§
      indegree.set(neighbor, indegree.get(neighbor) - 1); // Derece azalt
      if (indegree.get(neighbor) === 0) { // SÄ±fÄ±ra dÃ¼ÅŸtÃ¼yse
        queue.push(neighbor); // KuyruÄŸa ekle
        queue.sort((a, b) => (idToStation.get(a)._originalIndex ?? 0) - (idToStation.get(b)._originalIndex ?? 0)); // Orijinale gÃ¶re sÄ±rala
      }
    });
  }
  appState.stations.forEach(station => delete station._originalIndex); // GeÃ§ici alanÄ± temizle
  if (ordered.length !== appState.stations.length) return; // TÃ¼m dÃ¼ÄŸÃ¼mler sÄ±ralanamadÄ±ysa Ã§Ä±k
  const reordered = ordered.map(id => idToStation.get(id)).filter(Boolean); // Yeni diziyi oluÅŸtur
  if (reordered.length === appState.stations.length) appState.stations = reordered; // Diziyi gÃ¼ncelle
}

function addConnection(sourceId, targetId, options = {}) { // BaÄŸlantÄ± ekle
  const { silent = false } = options; // Sessiz mod parametresi
  if (appState.running) { // SimÃ¼lasyon Ã§alÄ±ÅŸÄ±yorsa
    if (!silent) showGraphToast(t('toast.runningLock'), 'warning'); // UyarÄ± gÃ¶ster
    return false; // BaÅŸarÄ±sÄ±z
  }
  const source = appState.stations.find(station => station.id === sourceId); // Kaynak bul
  const target = appState.stations.find(station => station.id === targetId); // Hedef bul
  if (!source || !target) return false; // GeÃ§ersizse Ã§Ä±k
  if (!Array.isArray(source.outputs)) source.outputs = []; // Ã‡Ä±kÄ±ÅŸ listesini hazÄ±rla
  if (source.outputs.includes(targetId)) { // MÃ¼kerrer baÄŸlantÄ±
    if (!silent) showGraphToast(t('toast.edgeExists'), 'info'); // Bilgi ver
    return false; // BaÅŸarÄ±sÄ±z
  }
  if (wouldCreateCycle(sourceId, targetId)) { // DÃ¶ngÃ¼ kontrolÃ¼
    if (!silent) showGraphToast(t('toast.edgeCycle'), 'error'); // Hata bildir
    return false; // BaÅŸarÄ±sÄ±z
  }
  source.outputs.push(targetId); // BaÄŸlantÄ±yÄ± ekle
  reorderStationsByTopology(); // Diziyi yeniden sÄ±rala
  saveState(appState); // Durumu kaydet
  if (!silent) { // Sessiz deÄŸilse
    showGraphToast(t('toast.edgeAdded', { source: source.name || source.id, target: target.name || target.id }), 'success'); // BaÅŸarÄ± bildirimi
    renderGraph(appState.stations); // GrafiÄŸi yenile
  }
  return true; // BaÅŸarÄ±lÄ±
}

function removeConnection(sourceId, targetId, options = {}) { // BaÄŸlantÄ± sil
  const { silent = false } = options; // Sessiz mod parametresi
  if (appState.running) { // SimÃ¼lasyon Ã§alÄ±ÅŸÄ±yorsa
    if (!silent) showGraphToast(t('toast.runningLock'), 'warning'); // UyarÄ± gÃ¶ster
    return false; // BaÅŸarÄ±sÄ±z
  }
  const source = appState.stations.find(station => station.id === sourceId); // KaynaÄŸÄ± bul
  if (!source || !Array.isArray(source.outputs)) return false; // GeÃ§ersizse Ã§Ä±k
  const before = source.outputs.length; // Ã–nceki uzunluk
  source.outputs = source.outputs.filter(output => output !== targetId); // BaÄŸlantÄ±yÄ± Ã§Ä±kar
  if (source.outputs.length === before) { // DeÄŸiÅŸiklik yoksa
    if (!silent) showGraphToast(t('toast.edgeMissing'), 'info'); // Bilgi ver
    return false; // BaÅŸarÄ±sÄ±z
  }
  reorderStationsByTopology(); // Diziyi yeniden sÄ±rala
  saveState(appState); // Durumu kaydet
  if (!silent) { // Sessiz deÄŸilse
    const target = appState.stations.find(station => station.id === targetId); // Hedefi bul
    const targetName = target ? (target.name || target.id) : targetId; // Hedef adÄ±
    showGraphToast(t('toast.edgeRemoved', { source: source.name || source.id, target: targetName }), 'info'); // Bilgi ver
    renderGraph(appState.stations); // GrafiÄŸi yenile
  }
  return true; // BaÅŸarÄ±lÄ±
}

function handleNodeMove(stationId, x, y, meta = {}) { // DÃ¼ÄŸÃ¼m taÅŸÄ±ma geri Ã§aÄŸrÄ±sÄ±
  const station = appState.stations.find(item => item.id === stationId); // Ä°stasyonu bul
  if (!station) return; // Yoksa Ã§Ä±k
  if (!station.position) station.position = { x: 0, y: 0 }; // Konum nesnesi oluÅŸtur
  station.position.x = Math.round(x); // X deÄŸerini yuvarlayÄ±p yaz
  station.position.y = Math.round(y); // Y deÄŸerini yuvarlayÄ±p yaz
  if (!meta || meta.live) return; // CanlÄ± gÃ¼ncellemede kaydetme
  saveState(appState); // SÃ¼rÃ¼kleme bittiÄŸinde kaydet
}

function renderGraph(stations) { // AkÄ±ÅŸ grafiÄŸini Ã§iz
  reorderStationsByTopology(); // Ä°stasyon sÄ±rasÄ±nÄ± baÄŸlara gÃ¶re hizala
  normalizeStationTopology(stations); // Ä°stasyonlarÄ± normalize et
  const editingEnabled = !appState.running && appState.mode === 'edit'; // DÃ¼zenleme aktif mi
  if (!editingEnabled) cancelConnectionDraft('mode-change'); // DÃ¼zenleme kapalÄ±ysa taslaÄŸÄ± temizle
  const handlerConfig = editingEnabled // Ã‡alÄ±ÅŸma durumuna gÃ¶re handler seÃ§
    ? { beginEdge: beginConnectionDraft, completeEdge: completeConnectionDraft, cancelEdge: cancelConnectionDraft, removeEdge: removeConnection, moveNode: handleNodeMove } // Tam dÃ¼zenleme
    : { beginEdge: null, completeEdge: null, cancelEdge: null, removeEdge: null, moveNode: null }; // EtkileÅŸimi kapat
  viz.setHandlers(handlerConfig); // HandlerlarÄ± ata
  viz.setEditing(editingEnabled); // SÃ¼rÃ¼kleme izinlerini ayarla
  viz.setStations(stations); // GÃ¶rselleÅŸtirme modelini gÃ¼ncelle
}

function updateZoomDisplay() { // Zoom metnini gÃ¼ncelle
  const display = `${Math.round(appState.zoom * 100)}%`; // YÃ¼zdelik metin
  zoomValueEls.forEach(node => { // Her etiketi dolaÅŸ
    if (node) node.textContent = display; // Metni yaz
  });
  if (zoomResetBtn) zoomResetBtn.title = `Ã–lÃ§eÄŸi ${display} durumundan 100% yap`; // Ä°pucu gÃ¼ncelle
  viz.setZoom(appState.zoom); // GÃ¶rsel Ã¶lÃ§eÄŸi uygula
}

function adjustZoom(delta) { // Zoom deÄŸerini deÄŸiÅŸtir
  const next = Math.max(0.25, Math.min(2, parseFloat((appState.zoom + delta).toFixed(2)))); // SÄ±nÄ±rla ve yuvarla
  appState.zoom = next; // Duruma yaz
  updateZoomDisplay(); // GÃ¶rseli gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function resetZoom() { // Zoom'u sÄ±fÄ±rla
  appState.zoom = 1; // VarsayÄ±lan Ã¶lÃ§ek
  updateZoomDisplay(); // GÃ¶rseli gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function cloneStationsForRun() { // SimÃ¼lasyon iÃ§in istasyon kopyala
  return appState.stations.map(source => { // Her istasyon iÃ§in
    const clone = new Station(source.id, source.name); // Yeni istasyon oluÅŸtur
    clone.parallelServers = source.parallelServers; // Paralel sunucularÄ± aktar
    clone.tasks = source.tasks.map(task => new Task(task.name, task.operators, task.durationSec)); // GÃ¶revleri kopyala
    clone.outputs = Array.isArray(source.outputs) ? source.outputs.slice() : []; // Ã‡Ä±kÄ±ÅŸ baÄŸlantÄ±larÄ±nÄ± kopyala
    clone.position = source.position ? { x: source.position.x, y: source.position.y } : { x: 0, y: 0 }; // YerleÅŸimi kopyala
    return clone; // Sonucu dÃ¶ndÃ¼r
  });
}

function computeDefaultGridPosition(index, total) { // VarsayÄ±lan merkezli Ä±zgara pozisyonu
  const baseCols = 4; // Maks kolon
  const gapX = 240; // Yatay boÅŸluk
  const gapY = 180; // Dikey boÅŸluk
  const row = Math.floor(index / baseCols); // SatÄ±r
  const col = index % baseCols; // Kolon
  const totalRows = Math.max(1, Math.ceil(total / baseCols)); // Toplam satÄ±r
  const isLastRow = row === totalRows - 1; // Son satÄ±r mÄ±
  const itemsInRow = isLastRow ? Math.max(1, total - row * baseCols) : Math.min(baseCols, total); // SatÄ±rdaki eleman sayÄ±sÄ±
  const rowWidth = (itemsInRow - 1) * gapX; // SatÄ±r geniÅŸliÄŸi
  const clampedCol = Math.min(col, itemsInRow - 1); // Son satÄ±r iÃ§in kolon sÄ±nÄ±rÄ±
  const offsetX = itemsInRow === 1 ? 0 : clampedCol * gapX; // X offseti
  const originX = -rowWidth / 2; // SatÄ±r baÅŸlangÄ±Ã§ X
  const totalHeight = (totalRows - 1) * gapY; // Toplam yÃ¼kseklik
  const originY = -totalHeight / 2; // BaÅŸlangÄ±Ã§ Y
  return { x: originX + offsetX, y: originY + row * gapY }; // Hesaplanan koordinat
}

function suggestStationPosition(index, total = null) { // Yeni istasyon iÃ§in varsayÄ±lan koordinat Ã¼ret
  const safeTotal = Number.isFinite(total) && total > 0 ? total : Math.max(index + 1, appState?.stations?.length || 1); // GÃ¼venli toplam
  return computeDefaultGridPosition(index, safeTotal); // Konumu dÃ¶ndÃ¼r
}

function addStation(name = null) { // Ä°stasyon ekleme fonksiyonu
  const stationNumber = appState.nextStationId++; // ArdÄ±ÅŸÄ±k numarayÄ± al
  const stationId = `station-${stationNumber}`; // KimliÄŸi Ã¼ret
  const stationName = name ? String(name) : `Ä°stasyon ${stationNumber}`; // Ä°smi belirle
  const station = new Station(stationId, stationName); // Yeni istasyon nesnesi
  station.parallelServers = 1; // VarsayÄ±lan kapasite
  station.tasks = []; // GÃ¶revleri boÅŸ baÅŸlat
  station.outputs = []; // Ã‡Ä±kÄ±ÅŸ baÄŸlantÄ±larÄ±nÄ± sÄ±fÄ±rla
  const gridIndex = appState.stations.length; // Izgara indeksi
  station.position = suggestStationPosition(gridIndex, gridIndex + 1); // VarsayÄ±lan konumu ata
  appState.stations.push(station); // Listeye ekle
  if (!renderingPaused) { // Yeniden Ã§izim aÃ§Ä±ksa
    renderStations(); // Kart listesini gÃ¼ncelle
    renderGraph(appState.stations); // AkÄ±ÅŸ diyagramÄ±nÄ± tazele
    saveState(appState); // Durumu kaydet
  }
  console.info('Station added:', station); // Konsola bilgi dÃ¼ÅŸ
  return station; // Yeni istasyonu dÃ¶ndÃ¼r
}

function resetLayoutToDefault() { // YerleÅŸimi varsayÄ±lana dÃ¶ndÃ¼r
  if (!appState.stations.length) { showGraphToast('VarsayÄ±lan yerleÅŸim iÃ§in istasyon bulunamadÄ±.', 'info'); return; } // BoÅŸsa uyar
  const total = appState.stations.length; // Toplam istasyon sayÄ±sÄ±
  appState.stations.forEach((station, index) => { // Her istasyonu dolaÅŸ
    const pos = suggestStationPosition(index, total); // VarsayÄ±lan konumu al
    station.position = { x: pos.x, y: pos.y }; // Konumu ata
  });
  renderGraph(appState.stations); // GrafiÄŸi gÃ¼ncelle
  if (viz) viz.centerViewOnBounds(); // GÃ¶rÃ¼nÃ¼mÃ¼ ortala
  saveState(appState); // Durumu kaydet
  showGraphToast('YerleÅŸim varsayÄ±lan Ä±zgaraya sÄ±fÄ±rlandÄ±.', 'success'); // KullanÄ±cÄ±yÄ± bilgilendir
}

function onAddStationClick(event) { // Ä°stasyon ekle buton tÄ±klamasÄ±
  event?.preventDefault?.(); // VarsayÄ±lanÄ± engelle
  event?.stopPropagation?.(); // KabarcÄ±k yayÄ±lmasÄ±nÄ± durdur
  addStation(); // Yeni istasyon oluÅŸtur
}

function removeStation(id) { // Ä°stasyon silme fonksiyonu
  appState.stations = appState.stations.filter(station => station.id !== id); // Filtrele
  appState.stations.forEach(station => { // Kalan istasyonlarÄ± dolaÅŸ
    station.outputs = station.outputs.filter(targetId => targetId !== id); // Silinen istasyona giden baÄŸlantÄ±larÄ± temizle
  });
  renderStations(); // Yeniden Ã§iz
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function moveStation(id, direction) { // Ä°stasyon sÄ±ralama fonksiyonu
  const index = appState.stations.findIndex(st => st.id === id); // Ä°ndeks bul
  if (index === -1) return; // BulunamadÄ±
  const newIndex = index + direction; // Yeni indeks
  if (newIndex < 0 || newIndex >= appState.stations.length) return; // SÄ±nÄ±r kontrolÃ¼
  const [station] = appState.stations.splice(index, 1); // Ä°stasyonu Ã§Ä±kar
  appState.stations.splice(newIndex, 0, station); // Yeni konuma ekle
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function addTask(stationId) { // GÃ¶rev ekleme fonksiyonu
  const station = appState.stations.find(st => st.id === stationId); // Ä°stasyon bul
  if (!station) return; // Yoksa Ã§Ä±k
  station.tasks.push(new Task('GÃ¶rev', 1, 10)); // VarsayÄ±lan gÃ¶rev ekle
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function removeTask(stationId, taskIndex) { // GÃ¶rev silme fonksiyonu
  const station = appState.stations.find(st => st.id === stationId); // Ä°stasyon bul
  if (!station) return; // Yoksa Ã§Ä±k
  if (station.tasks.length <= 1) return; // En az bir gÃ¶rev bÄ±rak
  station.tasks.splice(taskIndex, 1); // GÃ¶revi Ã§Ä±kar
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function renderStations() { // Ä°stasyon kartlarÄ±nÄ± Ã§iz
  stationListEl.innerHTML = ''; // Listeyi temizle
  stationRuntimeRefs.clear(); // CanlÄ± referanslarÄ± sÄ±fÄ±rla
  if (!appState.stations.length) { // Ä°stasyon yoksa
    emptyStateEl.style.display = 'block'; // BoÅŸ mesaj gÃ¶ster
  } else {
    emptyStateEl.style.display = 'none'; // MesajÄ± gizle
  }
  appState.stations.forEach((station, index) => { // Her istasyon iÃ§in
    const card = document.createElement('div'); // Kart divi
    card.className = 'station-card'; // SÄ±nÄ±f ata
    card.dataset.id = station.id; // Veri ata
    card.draggable = !appState.running; // Ã‡alÄ±ÅŸÄ±rken sÃ¼rÃ¼klemeyi kapat
    const header = document.createElement('div'); // BaÅŸlÄ±k satÄ±rÄ±
    header.className = 'station-header'; // SÄ±nÄ±f ata
    const nameInput = document.createElement('input'); // Ä°sim inputu
    nameInput.value = station.name; // DeÄŸer ata
    nameInput.disabled = appState.running; // Ã‡alÄ±ÅŸÄ±rken kilitle
    nameInput.addEventListener('input', () => { station.name = nameInput.value; renderGraph(appState.stations); saveState(appState); }); // Ä°sim deÄŸiÅŸince gÃ¼ncelle
    header.appendChild(nameInput); // BaÅŸlÄ±ÄŸa ekle
    const totalLabel = document.createElement('span'); // SÃ¼re etiketi
    totalLabel.className = 'badge'; // SÄ±nÄ±f ata
    totalLabel.textContent = `Toplam: ${station.totalDuration()} sn`; // Metin
    header.appendChild(totalLabel); // BaÅŸlÄ±ÄŸa ekle
    card.appendChild(header); // Kart iÃ§ine ekle

    const runtimeLine = document.createElement('div'); // CanlÄ± metrik satÄ±rÄ±
    runtimeLine.className = 'runtime-line'; // SÄ±nÄ±f ata
    const capacityPill = document.createElement('span'); // Kapasite rozeti
    capacityPill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    capacityPill.textContent = `OperatÃ¶r: ${station.parallelServers} (Paralel: ${station.parallelServers})`; // VarsayÄ±lan metin
    const queuePill = document.createElement('span'); // Kuyruk rozeti
    queuePill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    queuePill.textContent = 'Kuyruk: 0'; // VarsayÄ±lan metin
    const servicePill = document.createElement('span'); // Servis rozeti
    servicePill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    servicePill.textContent = `Servis: 0/${station.parallelServers}`; // VarsayÄ±lan metin
    const remainingPill = document.createElement('span'); // Kalan sÃ¼re rozeti
    remainingPill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    remainingPill.textContent = 'Kalan: -'; // VarsayÄ±lan metin
    runtimeLine.appendChild(capacityPill); // Kapasiteyi ekle
    runtimeLine.appendChild(queuePill); // KuyruÄŸu ekle
    runtimeLine.appendChild(servicePill); // Servisi ekle
    runtimeLine.appendChild(remainingPill); // KalanÄ± ekle
    card.appendChild(runtimeLine); // Kart iÃ§ine yerleÅŸtir
    stationRuntimeRefs.set(station.id, { card, capacity: capacityPill, queue: queuePill, service: servicePill, remaining: remainingPill }); // ReferansÄ± kaydet

    const serverRow = document.createElement('div'); // Sunucu satÄ±rÄ±
    serverRow.style.display = 'flex'; // Yatay dÃ¼zen
    serverRow.style.gap = '8px'; // BoÅŸluk
    serverRow.style.alignItems = 'center'; // Ortala
    const serverLabel = document.createElement('span'); // Etiket
    serverLabel.textContent = 'OperatÃ¶r (Paralel Kapasite)'; // Metin
    serverRow.appendChild(serverLabel); // SatÄ±ra ekle
    const serverInput = document.createElement('input'); // SayÄ±sal girdi
    serverInput.type = 'number'; // Tip
    serverInput.min = 1; // Minimum
    serverInput.max = MAX_SERVERS; // Maksimum
    serverInput.value = station.parallelServers; // DeÄŸer
    serverInput.disabled = appState.running; // Ã‡alÄ±ÅŸÄ±rken kapat
    serverInput.style.width = '80px'; // GeniÅŸlik
    serverInput.addEventListener('change', () => { // DeÄŸiÅŸim dinleyici
      const value = Math.max(1, Math.min(MAX_SERVERS, Number(serverInput.value) || 1)); // SÄ±nÄ±rla
      station.parallelServers = value; // Ata
      renderStations(); // Yeniden Ã§iz
      renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
      saveState(appState); // Durumu kaydet
    });
    serverRow.appendChild(serverInput); // SatÄ±ra ekle
    card.appendChild(serverRow); // Kart iÃ§ine ekle

    const table = document.createElement('table'); // GÃ¶rev tablosu
    table.className = 'task-table'; // SÄ±nÄ±f ata
    const thead = document.createElement('thead'); // BaÅŸlÄ±k
    thead.innerHTML = '<tr><th>GÃ¶rev AdÄ±</th><th>OperatÃ¶r</th><th>SÃ¼re (sn)</th><th></th></tr>'; // BaÅŸlÄ±k satÄ±rÄ±
    table.appendChild(thead); // Tabloya ekle
    const tbody = document.createElement('tbody'); // GÃ¶vde
    station.tasks.forEach((task, taskIndex) => { // Her gÃ¶rev iÃ§in
      const row = document.createElement('tr'); // SatÄ±r
      const nameCell = document.createElement('td'); // HÃ¼cre
      const nameField = document.createElement('input'); // Girdi
      nameField.value = task.name; // DeÄŸer
      nameField.disabled = appState.running; // Kilit
      nameField.addEventListener('input', () => { task.name = nameField.value; saveState(appState); }); // GÃ¼ncelle
      nameCell.appendChild(nameField); // HÃ¼creye ekle
      row.appendChild(nameCell); // SatÄ±ra ekle

      const opCell = document.createElement('td'); // OperatÃ¶r hÃ¼cresi
      const opField = document.createElement('input'); // Girdi
      opField.type = 'number'; // Tip
      opField.min = 1; // Minimum
      opField.value = task.operators; // DeÄŸer
      opField.disabled = appState.running; // Kilit
      opField.addEventListener('change', () => { // DeÄŸiÅŸim
        const value = Math.max(1, Number(opField.value) || 1); // SÄ±nÄ±rla
        task.operators = value; // Ata
        saveState(appState); // Durumu kaydet
      });
      opCell.appendChild(opField); // HÃ¼creye ekle
      row.appendChild(opCell); // SatÄ±ra ekle

      const durationCell = document.createElement('td'); // SÃ¼re hÃ¼cresi
      const durationField = document.createElement('input'); // Girdi
      durationField.type = 'number'; // Tip
      durationField.min = 1; // Minimum
      durationField.value = task.durationSec; // DeÄŸer
      durationField.disabled = appState.running; // Kilit
      durationField.addEventListener('change', () => { // DeÄŸiÅŸim
        const value = Math.max(1, Number(durationField.value) || 1); // SÄ±nÄ±rla
        task.durationSec = value; // Ata
        renderStations(); // Toplam sÃ¼reyi gÃ¼ncelle
        renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
        saveState(appState); // Durumu kaydet
      });
      durationCell.appendChild(durationField); // HÃ¼creye ekle
      row.appendChild(durationCell); // SatÄ±ra ekle

      const actionCell = document.createElement('td'); // Aksiyon hÃ¼cresi
      if (!appState.running) { // SimÃ¼lasyon kapalÄ±ysa
        const removeBtn = document.createElement('button'); // Silme butonu
        removeBtn.textContent = 'Sil'; // Metin
        removeBtn.addEventListener('click', () => removeTask(station.id, taskIndex)); // Olay baÄŸla
        actionCell.appendChild(removeBtn); // HÃ¼creye ekle
      }
      row.appendChild(actionCell); // SatÄ±ra ekle
      tbody.appendChild(row); // GÃ¶vdeye ekle
    });
    table.appendChild(tbody); // Tabloya ekle
    card.appendChild(table); // Kart iÃ§ine ekle

    if (!appState.running) { // SimÃ¼lasyon dururken
      const actions = document.createElement('div'); // Aksiyon satÄ±rÄ±
      actions.className = 'task-actions'; // SÄ±nÄ±f ata
      const addTaskBtn = document.createElement('button'); // GÃ¶rev ekleme butonu
      addTaskBtn.textContent = '+ GÃ¶rev'; // Metin
      addTaskBtn.addEventListener('click', () => addTask(station.id)); // Olay baÄŸla
      actions.appendChild(addTaskBtn); // SatÄ±ra ekle
      const moveGroup = document.createElement('div'); // TaÅŸÄ±ma grubu
      moveGroup.style.display = 'flex'; // Yatay
      moveGroup.style.gap = '8px'; // BoÅŸluk
      const upBtn = document.createElement('button'); // YukarÄ± buton
      upBtn.textContent = 'â†‘'; // Metin
      upBtn.disabled = index === 0; // Ä°lk ise kilit
      upBtn.addEventListener('click', () => moveStation(station.id, -1)); // TaÅŸÄ±
      const downBtn = document.createElement('button'); // AÅŸaÄŸÄ± buton
      downBtn.textContent = 'â†“'; // Metin
      downBtn.disabled = index === appState.stations.length - 1; // Son ise kilit
      downBtn.addEventListener('click', () => moveStation(station.id, 1)); // TaÅŸÄ±
      const deleteBtn = document.createElement('button'); // Silme butonu
      deleteBtn.textContent = 'Sil'; // Metin
      deleteBtn.className = 'danger'; // Renk
      deleteBtn.addEventListener('click', () => removeStation(station.id)); // Sil
      moveGroup.appendChild(upBtn); // Gruba ekle
      moveGroup.appendChild(downBtn); // Gruba ekle
      moveGroup.appendChild(deleteBtn); // Gruba ekle
      actions.appendChild(moveGroup); // SatÄ±ra ekle
      card.appendChild(actions); // Kart iÃ§ine ekle
    }
    stationListEl.appendChild(card); // Listeye ekle
  });
}

function applyLiveStationSnapshot(snapshot) { // CanlÄ± metrikleri karta yaz
  if (!snapshot || !Array.isArray(snapshot.layout)) return; // GeÃ§erli veri kontrolÃ¼
  snapshot.layout.forEach(item => { // Her istasyon verisi
    const refs = stationRuntimeRefs.get(item.stationId); // ReferansÄ± al
    if (!refs) return; // Yoksa geÃ§
    const busyServers = item.servers.filter(server => !!server); // Aktif sunucular
    const avgProgress = busyServers.length ? busyServers.reduce((sum, server) => sum + server.progress, 0) / busyServers.length : 0; // Ortalama ilerleme
    const maxRemaining = busyServers.length ? Math.max(...busyServers.map(server => server.remaining)) : 0; // Maks kalan sÃ¼re
    refs.capacity.textContent = `OperatÃ¶r: ${item.metrics.capacity} (Paralel: ${item.metrics.capacity})`; // Kapasite metni
    refs.queue.textContent = `Kuyruk: ${item.metrics.queueLength}`; // Kuyruk metni
    refs.service.textContent = `Servis: ${item.metrics.busyCount}/${item.metrics.capacity}`; // Servis metni
    refs.remaining.textContent = busyServers.length ? `Kalan: ${maxRemaining.toFixed(1)}sn Â· %${(avgProgress * 100).toFixed(0)}` : 'Kalan: -'; // Kalan sÃ¼re metni
    if (item.metrics.avgQueue > 1.5 || item.metrics.avgUtil > 0.85) { // DarboÄŸaz koÅŸulu
      refs.card.classList.add('bottleneck'); // KartÄ± vurgula
    } else {
      refs.card.classList.remove('bottleneck'); // Vurguyu kaldÄ±r
    }
  });
  updateCompletedCounter(snapshot.completedCount ?? 0); // SayaÃ§ gÃ¼ncelle
}

let dragSourceId = null; // SÃ¼rÃ¼klenen istasyon kimliÄŸi

stationListEl.addEventListener('dragstart', event => { // SÃ¼rÃ¼kleme baÅŸlangÄ±cÄ±
  const card = event.target.closest('.station-card'); // KartÄ± bul
  if (!card) return; // Kart yoksa Ã§Ä±k
  dragSourceId = card.dataset.id; // KaynaÄŸÄ± kaydet
  card.classList.add('dragging'); // Stil ekle
  if (event.dataTransfer) { // DataTransfer mevcut mu
    event.dataTransfer.effectAllowed = 'move'; // TaÅŸÄ±ma modu
    event.dataTransfer.setData('text/plain', dragSourceId); // Veri aktar
  }
});

stationListEl.addEventListener('dragover', event => { // Kart Ã¼zerinde gezinme
  if (!dragSourceId) return; // Kaynak yoksa Ã§Ä±k
  event.preventDefault(); // BÄ±rakmaya izin ver
  const card = event.target.closest('.station-card'); // Hedef kart
  if (!card || card.dataset.id === dragSourceId) return; // GeÃ§ersiz hedef
  stationListEl.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); // Eski vurgularÄ± temizle
  card.classList.add('drag-over'); // Yeni vurguyu ekle
});

stationListEl.addEventListener('dragleave', event => { // Kart dÄ±ÅŸÄ±na Ã§Ä±kÄ±ÅŸ
  const card = event.target.closest('.station-card'); // Kart bul
  if (card) card.classList.remove('drag-over'); // Vurguyu kaldÄ±r
});

stationListEl.addEventListener('drop', event => { // BÄ±rakma iÅŸlemi
  if (!dragSourceId) return; // Kaynak yoksa Ã§Ä±k
  event.preventDefault(); // VarsayÄ±lanÄ± engelle
  const targetCard = event.target.closest('.station-card'); // Hedef kart
  stationListEl.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); // VurgularÄ± temizle
  const sourceIndex = appState.stations.findIndex(st => st.id === dragSourceId); // Kaynak indeks
  if (sourceIndex === -1) return; // GeÃ§ersiz kaynak
  const targetId = targetCard ? targetCard.dataset.id : null; // Hedef kimliÄŸi
  if (targetId && targetId === dragSourceId) { // AynÄ± karta bÄ±rakÄ±ldÄ±ysa
    dragSourceId = null; // KaynaÄŸÄ± temizle
    renderStations(); // Yeniden Ã§iz
    renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
    return; // Ã‡Ä±k
  }
  const [moved] = appState.stations.splice(sourceIndex, 1); // KaynaÄŸÄ± Ã§Ä±kar
  let insertIndex = targetId ? appState.stations.findIndex(st => st.id === targetId) : appState.stations.length; // Hedef sonrasÄ± indeks
  if (insertIndex === -1) insertIndex = appState.stations.length; // Hedef yoksa sona ekle
  if (targetCard) { // Kart varsa konumu deÄŸerlendir
    const rect = targetCard.getBoundingClientRect(); // Kart geometrisi
    const after = event.clientY > rect.top + rect.height / 2; // Alt yarÄ±da mÄ±
    if (after) insertIndex += 1; // SonrasÄ±na ekle
  }
  appState.stations.splice(insertIndex, 0, moved); // Yeni konuma yerleÅŸtir
  dragSourceId = null; // KaynaÄŸÄ± sÄ±fÄ±rla
  renderStations(); // Listeyi yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
});

stationListEl.addEventListener('dragend', () => { // SÃ¼rÃ¼kleme bitiÅŸi
  stationListEl.querySelectorAll('.station-card').forEach(card => card.classList.remove('dragging', 'drag-over')); // SÄ±nÄ±flarÄ± temizle
  dragSourceId = null; // KaynaÄŸÄ± sÄ±fÄ±rla
});

function validateSetup() { // Kurulum doÄŸrulama
  if (!appState.stations.length) { // Ä°stasyon yoksa
    alert('En az bir istasyon ekleyin.'); // UyarÄ±
    return false; // BaÅŸarÄ±sÄ±z
  }
  for (const station of appState.stations) { // Her istasyon iÃ§in
    if (!station.tasks.length) { // GÃ¶rev yoksa
      alert(`${station.name} iÃ§in en az bir gÃ¶rev tanÄ±mlayÄ±n.`); // UyarÄ±
      return false; // BaÅŸarÄ±sÄ±z
    }
    if (station.parallelServers < 1 || station.parallelServers > MAX_SERVERS) { // Sunucu sÄ±nÄ±rÄ±
      alert(`${station.name} paralel operatÃ¶r 1-${MAX_SERVERS} aralÄ±ÄŸÄ±nda olmalÄ±.`); // UyarÄ±
      return false; // BaÅŸarÄ±sÄ±z
    }
    for (const task of station.tasks) { // GÃ¶rev doÄŸrula
      if (!task.name.trim()) { // BoÅŸ isim
        alert('GÃ¶rev adÄ± boÅŸ bÄ±rakÄ±lamaz.'); // UyarÄ±
        return false; // BaÅŸarÄ±sÄ±z
      }
      if (task.durationSec <= 0) { // SÃ¼re kontrolÃ¼
        alert("GÃ¶rev sÃ¼releri 0'dan bÃ¼yÃ¼k olmalÄ±."); // UyarÄ±
        return false; // BaÅŸarÄ±sÄ±z
      }
    }
  }
  return true; // BaÅŸarÄ±lÄ±
}

function startSimulation() { // SimÃ¼lasyonu baÅŸlat
  if (appState.pausedForEdit && appState.simulation) { // DÃ¼zenlemeden dÃ¶nerken
    setMode('view'); // GÃ¶rÃ¼ntÃ¼leme moduna geÃ§ip devam et
    return; // Yeni motor kurma
  }
  if (!validateSetup()) return; // GeÃ§ersizse Ã§Ä±k
  if (appState.mode !== 'view') setMode('view'); // Ã‡alÄ±ÅŸma Ã¶ncesi gÃ¶rÃ¼ntÃ¼le moduna dÃ¶n
  const options = { // SeÃ§enekler
    entryPolicy: appState.entryPolicy, // GiriÅŸ politikasÄ±
    entryInterval: appState.entryInterval, // GiriÅŸ aralÄ±ÄŸÄ±
    targetCount: appState.targetCount // Hedef adet
  };
  appState.simulation = new SimulationEngine(cloneStationsForRun(), options, viz); // Motor oluÅŸtur
  appState.simulation.onLiveUpdate = snapshot => applyLiveStationSnapshot(snapshot); // CanlÄ± gÃ¼ncelleme baÄŸla
  appState.simulation.start(); // BaÅŸlat
  appState.running = true; // Durum gÃ¼ncelle
  appState.pausedForEdit = false; // DÃ¼zenleme duraklamasÄ±nÄ± temizle
  appState.lastUpdate = performance.now(); // Zaman kaydÄ±
  appState.lastMetricRefresh = appState.lastUpdate; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  appState.visualCursor = appState.simulation.currentTime; // GÃ¶rsel zamanÄ± hizala
  appState.simulation.updateLayoutTargets(appState.visualCursor); // Ä°lk snapshot
  updateCompletedCounter(0); // SayaÃ§ sÄ±fÄ±rla
  toggleEditing(false); // UI kilitle
  startBtn.disabled = true; // BaÅŸlat kilit
  stopBtn.disabled = false; // Durdur aÃ§
  runLoop(); // DÃ¶ngÃ¼yÃ¼ baÅŸlat
}

function stopSimulation(showReport = true) { // SimÃ¼lasyonu durdur
  if (!appState.simulation) return; // Motor yoksa Ã§Ä±k
  appState.simulation.stop(); // Motor durdur
  appState.visualCursor = appState.simulation.currentTime; // GÃ¶rsel zamanÄ± gÃ¼ncelle
  appState.simulation.updateLayoutTargets(appState.visualCursor); // Son durumu aktar
  appState.running = false; // Durum gÃ¼ncelle
  appState.pausedForEdit = false; // DÃ¼zenleme bayraÄŸÄ±nÄ± temizle
  toggleEditing(true); // UI aÃ§
  startBtn.disabled = false; // BaÅŸlat aÃ§
  stopBtn.disabled = true; // Durdur kilit
  appState.lastMetricRefresh = 0; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  const canShowReport = showReport && document.fullscreenElement !== visualPanel; // Tam ekranda mÄ±
  if (canShowReport) openReportModal(); // Uygunsa raporu aÃ§
}

function resetSimulation() { // SimÃ¼lasyonu sÄ±fÄ±rla
  appState.running = false; // Durum
  startBtn.disabled = false; // BaÅŸlat aÃ§
  stopBtn.disabled = true; // Durdur kilit
  appState.pausedForEdit = false; // DÃ¼zenleme duraklamasÄ±nÄ± sÄ±fÄ±rla
  toggleEditing(true); // UI aÃ§
  if (appState.simulation) { // Motor varsa
    appState.simulation.reset(); // SÄ±fÄ±rla
  }
  appState.lastMetricRefresh = 0; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  appState.visualCursor = 0; // GÃ¶rsel zamanÄ± sÄ±fÄ±rla
  viz.clearJobs(); // BalonlarÄ± temizle
  updateCompletedCounter(0); // SayaÃ§ sÄ±fÄ±rla
  stationRuntimeRefs.forEach((refs, stationId) => { // Her kart iÃ§in
    const station = appState.stations.find(st => st.id === stationId); // Ä°stasyonu bul
    const capacity = station ? station.parallelServers : 0; // Kapasite al
    refs.card.classList.remove('bottleneck'); // Vurguyu kaldÄ±r
    refs.capacity.textContent = `OperatÃ¶r: ${capacity} (Paralel: ${capacity})`; // Kapasiteyi sÄ±fÄ±rla
    refs.queue.textContent = 'Kuyruk: 0'; // KuyruÄŸu sÄ±fÄ±rla
    refs.service.textContent = `Servis: 0/${capacity}`; // Servisi sÄ±fÄ±rla
    refs.remaining.textContent = 'Kalan: -'; // Kalan sÃ¼reyi sÄ±fÄ±rla
  });
}

function pauseSimulationForEdit() { // DÃ¼zenleme iÃ§in simÃ¼lasyonu duraklat
  if (!appState.simulation || !appState.simulation.running) return false; // Ã‡alÄ±ÅŸmÄ±yorsa Ã§Ä±k
  appState.simulation.stop(); // Motoru duraklat
  appState.pausedForEdit = true; // Duraklat bayraÄŸÄ±
  appState.running = false; // UI durumu
  stopBtn.disabled = true; // Durdur butonunu kilitle
  startBtn.disabled = false; // BaÅŸlat butonunu aÃ§
  toggleEditing(true); // Kontrolleri aÃ§
  showGraphToast('SimÃ¼lasyon dÃ¼zenleme iÃ§in duraklatÄ±ldÄ±.', 'warning'); // KullanÄ±cÄ±yÄ± bilgilendir
  return true; // BaÅŸarÄ±lÄ±
}

function resumeSimulationAfterEdit() { // DÃ¼zenleme sonrasÄ±nda devam ettir
  if (!appState.simulation || !appState.pausedForEdit) return false; // DuraklatÄ±lmamÄ±ÅŸsa Ã§Ä±k
  appState.simulation.running = true; // Motoru yeniden Ã§alÄ±ÅŸtÄ±r
  appState.running = true; // UI durumunu gÃ¼ncelle
  appState.pausedForEdit = false; // BayraÄŸÄ± temizle
  appState.lastUpdate = performance.now(); // Zaman damgasÄ±nÄ± yenile
  appState.lastMetricRefresh = 0; // Metrik yenilemeyi sÄ±fÄ±rla
  startBtn.disabled = true; // BaÅŸlat butonunu kilitle
  stopBtn.disabled = false; // Durdur butonunu aÃ§
  toggleEditing(false); // Kontrolleri kilitle
  runLoop(); // DÃ¶ngÃ¼yÃ¼ yeniden baÅŸlat
  showGraphToast('SimÃ¼lasyon kaldÄ±ÄŸÄ± yerden devam ediyor.', 'success'); // Bilgilendir
  return true; // BaÅŸarÄ±lÄ±
}

function setMode(mode) { // GÃ¶rÃ¼nÃ¼m/dÃ¼zenleme modunu deÄŸiÅŸtir
  if (mode !== 'view' && mode !== 'edit') return; // GeÃ§ersiz modlarÄ± yoksay
  if (appState.mode === mode) return; // Zaten bu moddaysa Ã§Ä±k
  if (mode === 'edit') { // DÃ¼zenleme moduna geÃ§erken
    pauseSimulationForEdit(); // SimÃ¼lasyonu duraklat
  } else if (mode === 'view') { // GÃ¶rÃ¼ntÃ¼leme moduna dÃ¶nerken
    resumeSimulationAfterEdit(); // Gerekirse devam ettir
  }
  appState.mode = mode; // Modu gÃ¼ncelle
  document.body.dataset.editMode = appState.mode; // Body veri niteliÄŸini gÃ¼ncelle
  if (viz) viz.setEditing(appState.mode === 'edit' && !appState.running); // GÃ¶rsel dÃ¼zenlemeyi ayarla
  syncControlsFromState(); // Kontrolleri yenile
  renderGraph(appState.stations); // GrafiÄŸi modla uyumlu Ã§iz
  saveState(appState); // Durumu sakla
  console.info('Mod gÃ¼ncellendi:', appState.mode); // Konsol kaydÄ±
}

function toggleEditing(enabled) { // UI dÃ¼zenleme durumunu ayarla
  const inputs = stationListEl.querySelectorAll('input, button'); // TÃ¼m kontroller
  inputs.forEach(el => { // Her biri
    if (el.dataset.lock === 'runtime') return; // Kilitli olanlar
    if (el.id === 'stopBtn') return; // Durdur hariÃ§
    if (el.id === 'startBtn') return; // BaÅŸlat hariÃ§
    el.disabled = !enabled && !el.classList.contains('danger'); // Duruma gÃ¶re kilitle
  });
  addStationBtn.disabled = !enabled; // Ä°stasyon eklemeyi kilitle
  sampleBtn.disabled = !enabled; // Ã–rnek kurulum kilidi
  entryPolicySelect.disabled = !enabled; // GiriÅŸ seÃ§imini kilitle
  entryIntervalInput.disabled = !enabled || appState.entryPolicy !== 'interval'; // AralÄ±k giriÅŸi
  targetInput.disabled = !enabled; // Hedef giriÅŸi
  if (saveLayoutBtn) saveLayoutBtn.disabled = !enabled; // YerleÅŸim kaydet dÃ¼ÄŸmesi
}

function runLoop() { // SimÃ¼lasyon dÃ¶ngÃ¼sÃ¼
  if (!appState.simulation || !appState.simulation.running) return; // Motor Ã§alÄ±ÅŸmÄ±yorsa Ã§Ä±k
  const now = performance.now(); // Åimdiki zaman
  const deltaSec = (now - appState.lastUpdate) / 1000; // GeÃ§en sÃ¼re saniye
  appState.lastUpdate = now; // Zaman gÃ¼ncelle
  const nextEvent = appState.simulation.peekNextEventTime(); // Sonraki olay zamanÄ±
  let targetTime = appState.visualCursor + deltaSec * LOGICAL_RATE; // Hedef zaman
  if (nextEvent !== null) targetTime = Math.min(targetTime, nextEvent); // OlayÄ± aÅŸma
  targetTime = Math.max(targetTime, appState.simulation.currentTime); // Geri gitme
  appState.visualCursor = targetTime; // GÃ¶rsel zamanÄ± gÃ¼ncelle
  appState.simulation.processUntil(appState.visualCursor); // OlaylarÄ± iÅŸle
  viz.setSpeed(appState.speed); // HÄ±zÄ± gÃ¼ncelle
  if (!appState.lastMetricRefresh || now - appState.lastMetricRefresh >= UPDATE_INTERVAL_MS) { // Periyodik metrik kontrolÃ¼
    appState.simulation.updateLayoutTargets(appState.visualCursor); // YerleÅŸim gÃ¼ncelle
    appState.lastMetricRefresh = now; // Zaman kaydÄ±
  }
  if (!appState.simulation.running) { // Durduysa
    stopSimulation(true); // Raporla durdur
    return; // Ã‡Ä±k
  }
  requestAnimationFrame(runLoop); // Sonraki karede devam
}

function collectStationSummaries(report) { // Ä°stasyon Ã¶zetlerini hazÄ±rla
  return appState.stations.map(station => { // TÃ¼m istasyonlarÄ± gez
    const duration = station.totalDuration(); // Servis sÃ¼resi toplamÄ±
    const parallel = Math.max(1, station.parallelServers); // Paralel kapasite
    const capacityPerSec = duration > 0 ? parallel / duration : 0; // Teorik kapasite
    const reportRow = report?.stationRows?.find(row => row.stationId === station.id) || null; // Rapor satÄ±rÄ±
    const utilization = reportRow ? reportRow.utilization : null; // Utilizasyon deÄŸeri
    const avgQueue = reportRow ? reportRow.avgQueue : null; // Ortalama kuyruk
    const serviceCount = reportRow ? reportRow.serviceCount : 0; // Tamamlanan iÅŸ adedi
    const idleTime = reportRow ? reportRow.idleTime : null; // Idle sÃ¼resi
    return { station, duration, parallel, capacityPerSec, utilization, avgQueue, serviceCount, idleTime }; // Ã–zet nesnesi
  });
}

function createAnalysisNarrative(summaries, report, taktTime) { // Analiz anlatÄ±sÄ±nÄ± Ã¼ret
  if (!summaries.length) { // Ã–zet yoksa
    return { text: 'Analiz iÃ§in Ã¶nce istasyon tanÄ±mlayÄ±n.', scenarios: [] }; // Bilgi mesajÄ± dÃ¶ndÃ¼r
  }
  const taktRate = taktTime && taktTime > 0 ? 1 / taktTime : null; // Takt oranÄ±
  const bottleneckService = summaries.reduce((max, row) => (!max || row.duration > max.duration ? row : max), null); // SÃ¼re darboÄŸazÄ±
  const bottleneckUtil = summaries.reduce((max, row) => { // Util darboÄŸazÄ±
    if (row.utilization === null) return max; // Veri yoksa geÃ§
    if (!max || row.utilization > (max.utilization ?? 0)) return row; // Daha yÃ¼ksekse seÃ§
    return max; // Aksi halde mevcut
  }, null); // SonuÃ§
  const serviceName = bottleneckService ? bottleneckService.station.name : '-'; // Servis darboÄŸaz adÄ±
  const utilName = bottleneckUtil ? bottleneckUtil.station.name : '-'; // Util darboÄŸaz adÄ±
  let text = `Bottleneck (servis): ${serviceName}.`; // Temel metin
  text += ` Utilizasyon analizinde Ã¶ne Ã§Ä±kan istasyon: ${utilName}.`; // Util bilgisi ekle
  if (bottleneckService && bottleneckService.avgQueue !== null) { // Kuyruk bilgisi varsa
    text += ` Ortalama kuyruk ${bottleneckService.avgQueue.toFixed(2)} iÅŸ.`; // Kuyruk metni
  }
  if (taktTime && bottleneckService) { // Takt girdisi varsa
    if (bottleneckService.duration > taktTime) { // SÃ¼re taktÄ± aÅŸÄ±yorsa
      text += ` Takt ${taktTime.toFixed(2)} sn; bu istasyonda tek Ã¼rÃ¼n sÃ¼resi ${bottleneckService.duration.toFixed(2)} sn olduÄŸundan paralel kapasite artÄ±ÅŸÄ± Ã¶nerilir.`; // Ã–neri metni
    } else {
      text += ` Takt ${taktTime.toFixed(2)} sn deÄŸerini bu istasyon karÅŸÄ±lÄ±yor; paralel artÄ±ÅŸÄ± daha Ã§ok kuyruk dengesi iÃ§in dÃ¼ÅŸÃ¼nÃ¼lmeli.`; // Bilgi metni
    }
  } else {
    text += ' Takt time girilmedi; Ã¶neriler teorik kapasite Ã¼zerinden hesaplandÄ±.'; // VarsayÄ±lan bilgi
  }
  text += ' Paralel operatÃ¶r eklemek servis sÃ¼resini kÄ±saltmaz, yalnÄ±z eÅŸzamanlÄ± iÅŸ kapasitesini artÄ±rÄ±r.'; // Sabit sÃ¼re vurgusu
  const targetRow = report?.bottleneckService?.stationId // Senaryo hedefi
    ? summaries.find(row => row.station.id === report.bottleneckService.stationId) || bottleneckService
    : bottleneckService; // VarsayÄ±lan hedef
  if (!targetRow) return { text, scenarios: [] }; // Hedef yoksa Ã§Ä±k
  const baseThroughput = targetRow.duration > 0 ? targetRow.parallel / targetRow.duration : 0; // Mevcut kapasite
  const scenarios = []; // Senaryo listesi
  [1, 2].forEach(delta => { // +1 ve +2 operatÃ¶r
    const proposed = Math.min(MAX_SERVERS, targetRow.parallel + delta); // Yeni paralel kapasite
    if (proposed === targetRow.parallel) { // ArtÄ±ÅŸ yoksa
      scenarios.push(`+${delta} operatÃ¶r: Kapasite ${MAX_SERVERS} sÄ±nÄ±rÄ±nda; artÄ±ÅŸ uygulanamaz.`); // SÄ±nÄ±r mesajÄ±
      return; // Sonraki
    }
    const newThroughput = targetRow.duration > 0 ? proposed / targetRow.duration : 0; // Yeni kapasite
    let queueNote = 'Kuyruk etkisi: '; // Kuyruk yorumu
    if (taktRate) { // Takt oranÄ± varsa
      if (newThroughput >= taktRate) { // Takt yakalandÄ±ysa
        queueNote += 'takt hÄ±zÄ±nÄ± yakalayÄ±p kuyruklarÄ± eritmesi beklenir.'; // Eriyen kuyruk
      } else if (newThroughput > baseThroughput) { // Ä°yileÅŸme var
        queueNote += 'kuyruk bÃ¼yÃ¼me hÄ±zÄ±nÄ± azaltÄ±r ancak takt altÄ±nda kalÄ±r.'; // Azalan bÃ¼yÃ¼me
      } else {
        queueNote += 'takt altÄ±nda kaldÄ±ÄŸÄ± iÃ§in etkisi sÄ±nÄ±rlÄ± olacaktÄ±r.'; // SÄ±nÄ±rlÄ± etki
      }
    } else if (newThroughput > baseThroughput) { // Takt yok ama artÄ±ÅŸ var
      queueNote += 'daha yÃ¼ksek paralel kapasite ile bekleme sÃ¼releri kÄ±salÄ±r.'; // Olumlu etki
    } else {
      queueNote += 'deÄŸiÅŸim yok.'; // Etki yok
    }
    scenarios.push(`+${delta} operatÃ¶r â†’ ${targetRow.parallel}â†’${proposed} paralel, kapasite ${baseThroughput.toFixed(3)}â†’${newThroughput.toFixed(3)} Ã¼rÃ¼n/sn. ${queueNote} Servis sÃ¼resi sabit kalÄ±r.`); // Senaryo metni
  });
  return { text, scenarios }; // SonuÃ§ dÃ¶ndÃ¼r
}

function toggleFullscreen() { // Tam ekran modunu deÄŸiÅŸtir
  if (!visualPanel) return; // Panel yoksa Ã§Ä±k
  const active = document.fullscreenElement === visualPanel; // Åu an tam ekran mÄ±
  if (active) { // Zaten tam ekran ise
    if (document.exitFullscreen) document.exitFullscreen().catch(error => console.warn('Tam ekran Ã§Ä±kÄ±ÅŸÄ± baÅŸarÄ±sÄ±z:', error)); // Ã‡Ä±kÄ±ÅŸ dene
    return; // Ã‡Ä±k
  }
  closeReport(); // Mevcut dashboard'u gizle
  if (visualPanel.requestFullscreen) { // API varsa
    visualPanel.requestFullscreen().catch(error => console.warn('Tam ekran isteÄŸi baÅŸarÄ±sÄ±z:', error)); // Hata logla
  }
}

function updateFullscreenLabel() { // Tam ekran etiketini gÃ¼ncelle
  if (!fullscreenLabel || !fullscreenBtn) return; // Elemanlar yoksa Ã§Ä±k
  const active = document.fullscreenElement === visualPanel; // Durumu kontrol et
  fullscreenLabel.textContent = active ? 'â¤º Ã‡Ä±k' : 'ğŸ”³ Tam Ekran'; // Metni ayarla
  fullscreenBtn.setAttribute('aria-pressed', active ? 'true' : 'false'); // Durum niteliÄŸini gÃ¼ncelle
}

function openAnalysisModal() { // Analiz modalÄ±nÄ± aÃ§
  runAnalysis(); // Ä°Ã§eriÄŸi Ã¼ret
  if (analysisModal) analysisModal.classList.add('active'); // ModalÄ± gÃ¶ster
}

function closeAnalysisModal() { // Analiz modalÄ±nÄ± kapat
  if (analysisModal) analysisModal.classList.remove('active'); // ModalÄ± gizle
}

function runAnalysis() { // Analiz iÃ§eriÄŸini hesapla
  if (!analysisTableBody || !analysisText || !analysisList) return; // Eleman kontrolÃ¼
  const taktTime = appState.taktTime && appState.taktTime > 0 ? appState.taktTime : null; // Takt deÄŸeri
  let report = null; // Rapor saklama
  try { // GÃ¼venli Ã§aÄŸrÄ±
    if (appState.simulation) report = appState.simulation.buildReport(); // Mevcut raporu al
  } catch (error) { // Hata durumunda
    console.warn('Analiz raporu oluÅŸturulamadÄ±:', error); // UyarÄ±
  }
  analysisTableBody.innerHTML = ''; // Tabloyu temizle
  const summaries = collectStationSummaries(report); // Ã–zet listesini Ã¼ret
  summaries.forEach(summary => { // Her Ã¶zet iÃ§in satÄ±r oluÅŸtur
    const tr = document.createElement('tr'); // Tablo satÄ±rÄ±
    tr.innerHTML = `<td>${summary.station.name}</td><td>${summary.duration.toFixed(2)}</td><td>${summary.parallel}</td><td>${summary.parallel}</td><td>${summary.capacityPerSec.toFixed(3)}</td>`; // HÃ¼creler
    analysisTableBody.appendChild(tr); // Tabloya ekle
  });
  if (!summaries.length) { // Ä°stasyon yoksa
    analysisText.textContent = 'Analiz iÃ§in Ã¶nce en az bir istasyon tanÄ±mlayÄ±n.'; // Bilgi metni
    analysisList.innerHTML = ''; // Listeyi temizle
    return; // Ã‡Ä±k
  }
  const narrative = createAnalysisNarrative(summaries, report, taktTime); // AnlatÄ±yÄ± hazÄ±rla
  analysisText.textContent = narrative.text; // Metni yaz
  analysisList.innerHTML = ''; // Listeyi temizle
  narrative.scenarios.forEach(entry => { // SenaryolarÄ± ekle
    const li = document.createElement('li'); // Liste elemanÄ±
    li.textContent = entry; // Metni ata
    analysisList.appendChild(li); // Listeye ekle
  });
}

  
function openReportModal() { // Rapor modalÄ±nÄ± aÃ§
  if (!appState.simulation) return; // Motor yoksa Ã§Ä±k
  if (document.fullscreenElement === visualPanel && document.exitFullscreen) { // Tam ekranda ise
    const exitResult = document.exitFullscreen(); // Ã‡Ä±kÄ±ÅŸ isteÄŸi
    if (exitResult && typeof exitResult.then === 'function') { // Promise dÃ¶ndÃ¼yse
      exitResult.then(() => openReportModal()).catch(error => console.warn('Tam ekran Ã§Ä±kÄ±ÅŸÄ± sÄ±rasÄ±nda rapor aÃ§Ä±lamadÄ±:', error)); // Yeniden dene
    } else {
      setTimeout(() => openReportModal(), 0); // Asenkron tekrar dene
    }
    return; // Bekle
  }
  const report = appState.simulation.buildReport(); // Raporu Ã¼ret
  if (cardCycleEl) cardCycleEl.textContent = `${report.avgCycle.toFixed(2)} sn`; // Cycle kartÄ±nÄ± gÃ¼ncelle
  if (cardCompletedEl) cardCompletedEl.textContent = `${report.totalCompleted}`; // Tamamlanan kartÄ±nÄ± gÃ¼ncelle
  if (cardThroughputEl) cardThroughputEl.textContent = `${report.throughputPerSec.toFixed(3)} /sn Â· ${report.throughputPerMin.toFixed(2)} /dk`; // Throughput kartÄ±nÄ± gÃ¼ncelle
  if (cardWipEl) cardWipEl.textContent = report.avgWip.toFixed(2); // WIP kartÄ±nÄ± gÃ¼ncelle
  if (stationPerformanceBody) { // Ä°stasyon tablosunu doldur
    stationPerformanceBody.innerHTML = ''; // Tabloyu temizle
    if (!report.stationRows.length) { // SatÄ±r yoksa
      const tr = document.createElement('tr'); // Tek satÄ±r
      tr.innerHTML = '<td colspan="8">Veri yok</td>'; // Mesaj
      stationPerformanceBody.appendChild(tr); // Tabloya ekle
    } else {
      report.stationRows.forEach(row => { // Her istasyon iÃ§in
        const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
        const serviceTime = Number.isFinite(row.serviceTime) ? row.serviceTime : 0; // Servis sÃ¼resi deÄŸeri
        const idleTime = Number.isFinite(row.idleTime) ? row.idleTime : 0; // Idle sÃ¼resi deÄŸeri
        const avgQueue = Number.isFinite(row.avgQueue) ? row.avgQueue : 0; // Kuyruk deÄŸeri
        const avgWait = Number.isFinite(row.avgWait) ? row.avgWait : 0; // Bekleme deÄŸeri
        const utilization = Number.isFinite(row.utilization) ? row.utilization : 0; // Utilizasyon deÄŸeri
        tr.innerHTML = `<td>${row.stationName}</td><td>${row.parallelServers}</td><td>${serviceTime.toFixed(2)}</td><td>${idleTime.toFixed(2)}</td><td>${avgQueue.toFixed(2)}</td><td>${avgWait.toFixed(2)}</td><td>${(utilization * 100).toFixed(1)}</td><td>${row.serviceCount}</td>`; // HÃ¼creler
        stationPerformanceBody.appendChild(tr); // Tabloya ekle
      });
    }
  }
  if (bottleneckTableBody) { // DarboÄŸaz tablosunu doldur
    bottleneckTableBody.innerHTML = ''; // Tabloyu temizle
    const entries = [ // Kriter listesi
      { label: 'Utilizasyon (en yÃ¼ksek)', row: report.bottleneckUtil }, // Utilizasyon kriteri
      { label: 'Servis SÃ¼resi (en uzun)', row: report.bottleneckService } // Servis sÃ¼resi kriteri
    ];
    entries.forEach(entry => { // Her kriter iÃ§in
      const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
      const stationName = entry.row ? entry.row.stationName : '-'; // Ä°stasyon adÄ±
      const suggestion = buildBottleneckSuggestion(entry.row); // Ã–neriyi hesapla
      tr.innerHTML = `<td>${entry.label}</td><td>${stationName}</td><td>${suggestion}</td>`; // HÃ¼creler
      bottleneckTableBody.appendChild(tr); // Tabloya ekle
    });
  }
  if (forkSummaryBody) { // Fork tablosunu doldur
    forkSummaryBody.innerHTML = ''; // Temizle
    if (!report.forkSummary.length) { // Veri yoksa
      const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
      tr.innerHTML = '<td colspan="4">Veri yok</td>'; // Mesaj
      forkSummaryBody.appendChild(tr); // Tabloya ekle
    } else {
      report.forkSummary.forEach(row => { // Her istasyon iÃ§in
        const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
        tr.innerHTML = `<td>${row.stationName}</td><td>${row.outDegree}</td><td>${row.producedParts}</td><td>${row.forkEvents}</td>`; // HÃ¼creler
        forkSummaryBody.appendChild(tr); // Tabloya ekle
      });
    }
  }
  if (jobLineageBody) { // Ä°ÅŸ rotasÄ± tablosunu doldur
    jobLineageBody.innerHTML = ''; // Temizle
    if (!report.completedJobs.length) { // Veri yoksa
      const tr = document.createElement('tr'); // SatÄ±r
      tr.innerHTML = '<td colspan="5">HenÃ¼z tamamlanan iÅŸ bulunmuyor.</td>'; // Mesaj
      jobLineageBody.appendChild(tr); // Tabloya ekle
    } else {
      const recent = report.completedJobs.slice(-25); // Son 25 iÅŸi al
      recent.forEach(job => { // Her iÅŸ iÃ§in
        const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
        const parentText = job.parentId !== null && job.parentId !== undefined ? job.parentId : '-'; // Ãœst iÅŸ metni
        const routeText = job.routeId || '-'; // Rota metni
        const exitName = job.exitStationName || job.exitStationId || '-'; // Ã‡Ä±kÄ±ÅŸ adÄ±
        tr.innerHTML = `<td>${job.id}</td><td>${parentText}</td><td>${routeText}</td><td>${exitName}</td><td>${job.exitTime.toFixed(2)}</td>`; // HÃ¼creler
        jobLineageBody.appendChild(tr); // Tabloya ekle
      });
      if (report.completedJobs.length > recent.length) { // Daha fazla kayÄ±t varsa
        const noteRow = document.createElement('tr'); // Bilgi satÄ±rÄ±
        noteRow.innerHTML = `<td colspan="5">Toplam ${report.completedJobs.length} iÅŸten son ${recent.length} tanesi gÃ¶steriliyor.</td>`; // Mesaj
        jobLineageBody.appendChild(noteRow); // Tabloya ekle
      }
    }
  }
  latestReport = report; // Raporu hafÄ±zada sakla
  const taktTime = appState.taktTime && appState.taktTime > 0 ? appState.taktTime : null; // Takt deÄŸeri
  const narrative = createAnalysisNarrative(collectStationSummaries(report), report, taktTime); // AnlatÄ±yÄ± hazÄ±rla
  if (dashboardAnalysisText) dashboardAnalysisText.textContent = narrative.text; // Analiz metnini yaz
  if (dashboardAnalysisList) { // Analiz listesini hazÄ±rla
    dashboardAnalysisList.innerHTML = ''; // Temizle
    if (narrative.scenarios.length) { // Senaryolar varsa
      narrative.scenarios.forEach(entry => { // Her senaryo iÃ§in
        const li = document.createElement('li'); // Liste elemanÄ±
        li.textContent = entry; // Metni ata
        dashboardAnalysisList.appendChild(li); // Listeye ekle
      });
    } else {
      const li = document.createElement('li'); // Bilgi elemanÄ±
      li.textContent = 'Ek senaryo bulunamadÄ±.'; // Mesaj
      dashboardAnalysisList.appendChild(li); // Listeye ekle
    }
  }
  if (reportModal) reportModal.classList.add('active'); // ModalÄ± gÃ¶ster
  scheduleDashboardCharts(); // Grafiklerin Ã§izimini planla
  if (downloadCsvBtn) downloadCsvBtn.onclick = () => latestReport && downloadCsv(latestReport); // CSV butonunu gÃ¼ncel rapora baÄŸla
  if (downloadPdfBtn) { // PDF dÃ¼ÄŸmesi iÃ§in kontrol
    const canPrint = typeof window.print === 'function'; // YazdÄ±rma desteÄŸini sorgula
    downloadPdfBtn.disabled = !canPrint; // Destek yoksa pasifleÅŸtir
    downloadPdfBtn.title = canPrint ? 'YazdÄ±r veya PDF olarak kaydet' : 'TarayÄ±cÄ± yazdÄ±rma desteÄŸi bulunamadÄ±'; // Ä°pucu ayarla
    downloadPdfBtn.onclick = canPrint ? () => window.print() : null; // OlayÄ± tanÄ±mla
  }
}

function closeReport() { // Rapor modalÄ±nÄ± kapat
  if (reportModal) reportModal.classList.remove('active'); // ModalÄ± gizle
  if (scheduledChartFrame) { // Bekleyen Ã§izim varsa
    cancelAnimationFrame(scheduledChartFrame); // Kareyi iptal et
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
  }
}

function csvEscape(value) { // CSV alanÄ±nÄ± gÃ¼venle biÃ§imlendir
  if (value === null || value === undefined) return ''; // BoÅŸ deÄŸerleri boÅŸ string yap
  const text = String(value); // DeÄŸeri metne Ã§evir
  const escaped = text.replace(/"/g, '""'); // Ã‡ift tÄ±rnaklarÄ± kaÃ§Ä±r
  return /[",\n\r]/.test(text) ? `"${escaped}"` : escaped; // VirgÃ¼l veya satÄ±r sonu varsa tÄ±rnakla
}
function formatRouteForCsv(job) { // CSV iÃ§in rota metnini hazÄ±rla
  if (!job) return '-'; // GeÃ§ersiz iÅŸ iÃ§in tire dÃ¶ndÃ¼r
  const rawRoute = typeof job.routeId === 'string' && job.routeId.length ? job.routeId : Array.isArray(job.route) ? job.route.join('â†’') : ''; // Kaynak rota metnini belirle
  if (!rawRoute) return '-'; // Rota yoksa tire dÃ¶n
  const sanitized = rawRoute.replace(/,/g, 'â†’'); // VirgÃ¼lleri ok yÃ¶nÃ¼ne dÃ¶nÃ¼ÅŸtÃ¼r
  return sanitized || '-'; // Sonucu dÃ¶ndÃ¼r
}
function downloadCsv(report) { // CSV indirme fonksiyonu
  const lines = []; // SatÄ±r listesi
  lines.push([ 'Kategori', 'DeÄŸer' ].map(csvEscape).join(',')); // BaÅŸlÄ±k satÄ±rÄ±
  lines.push([ 'Tamamlanan', report.totalCompleted ].map(csvEscape).join(',')); // Tamamlanan Ã¼rÃ¼n
  lines.push([ 'SÃ¼re(sn)', report.horizon.toFixed(2) ].map(csvEscape).join(',')); // SimÃ¼lasyon sÃ¼resi
  lines.push([ 'Cycle(sn)', report.avgCycle.toFixed(2) ].map(csvEscape).join(',')); // Cycle time
  lines.push([ 'Throughput(sn)', report.throughputPerSec.toFixed(3) ].map(csvEscape).join(',')); // ÃœrÃ¼n/sn
  lines.push([ 'Throughput(dk)', report.throughputPerMin.toFixed(3) ].map(csvEscape).join(',')); // ÃœrÃ¼n/dk
  lines.push([ 'Ortalama WIP', report.avgWip.toFixed(2) ].map(csvEscape).join(',')); // Ortalama WIP
  lines.push(''); // BoÅŸ satÄ±r
  lines.push('Ä°stasyon,OperatÃ¶r(Paralel),Servis SÃ¼resi(sn),Idle/Starved SÃ¼re(sn),Tamamlanan Ä°ÅŸ,Teorik Kapasite(Ã¼rÃ¼n/sn),Utilizasyon(%),Ortalama Kuyruk,Ortalama Bekleme(sn)'); // Tablo baÅŸlÄ±ÄŸÄ±
  report.stationRows.forEach(row => { // Her istasyon iÃ§in
    const idleTime = Number.isFinite(row.idleTime) ? row.idleTime : 0; // Idle sÃ¼resi deÄŸeri
    lines.push([
      row.stationName, // Ä°stasyon adÄ±
      row.parallelServers, // OperatÃ¶r sayÄ±sÄ±
      row.serviceTime.toFixed(2), // Servis sÃ¼resi
      idleTime.toFixed(2), // Idle sÃ¼resi
      row.serviceCount, // Tamamlanan iÅŸ
      row.capacityPerSec.toFixed(3), // Teorik kapasite
      (row.utilization * 100).toFixed(1), // Utilizasyon
      row.avgQueue.toFixed(2), // Ortalama kuyruk
      row.avgWait.toFixed(2) // Ortalama bekleme
    ].map(csvEscape).join(',')); // SatÄ±rÄ± ekle
  });
  lines.push(''); // BoÅŸ satÄ±r
  lines.push('Fork Ã‡Ä±kÄ±ÅŸlarÄ±'); // BaÅŸlÄ±k
  lines.push('Ä°stasyon,Ã‡Ä±kÄ±ÅŸ SayÄ±sÄ±,Ãœretilen ParÃ§a,Fork OlayÄ±'); // Fork baÅŸlÄ±ÄŸÄ±
  report.forkSummary.forEach(row => { // Her fork satÄ±rÄ± iÃ§in
    lines.push([
      row.stationName, // Ä°stasyon adÄ±
      row.outDegree, // Ã‡Ä±kÄ±ÅŸ sayÄ±sÄ±
      row.producedParts, // Ãœretilen parÃ§a adedi
      row.forkEvents // YÃ¶nlendirme olay sayÄ±sÄ±
    ].map(csvEscape).join(',')); // SatÄ±rÄ± ekle
  });
  lines.push(''); // BoÅŸ satÄ±r
  lines.push('Tamamlanan Ä°ÅŸler'); // Ä°ÅŸ baÅŸlÄ±ÄŸÄ±
  lines.push('Ä°ÅŸ KimliÄŸi,Ãœst Ä°ÅŸ,Rota,Ã‡Ä±kÄ±ÅŸ Ä°stasyonu,Ã‡Ä±kÄ±ÅŸ ZamanÄ±(sn)'); // Ä°ÅŸ tablo baÅŸlÄ±ÄŸÄ±
  report.completedJobs.forEach(job => { // Her iÅŸ iÃ§in
    const parentText = job.parentId !== null && job.parentId !== undefined ? job.parentId : '-'; // Ãœst iÅŸ metni
    const routeText = formatRouteForCsv(job); // Rota metni
    const exitName = job.exitStationName || job.exitStationId || '-'; // Ã‡Ä±kÄ±ÅŸ adÄ±
    lines.push([
      job.id, // Ä°ÅŸ kimliÄŸi
      parentText, // Ãœst iÅŸ
      routeText, // Rota metni
      exitName, // Ã‡Ä±kÄ±ÅŸ istasyonu
      job.exitTime.toFixed(2) // Ã‡Ä±kÄ±ÅŸ zamanÄ±
    ].map(csvEscape).join(',')); // SatÄ±rÄ± ekle
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' }); // Blob oluÅŸtur
  const url = URL.createObjectURL(blob); // URL Ã¼ret
  const link = document.createElement('a'); // Link oluÅŸtur
  link.href = url; // URL ata
  link.download = 'rapor.csv'; // Dosya adÄ±
  document.body.appendChild(link); // DOM'a ekle
  link.click(); // Ä°ndirmeyi tetikle
  document.body.removeChild(link); // DOM'dan kaldÄ±r
  URL.revokeObjectURL(url); // URL temizle
}

function buildBottleneckSuggestion(row) { // DarboÄŸaz Ã¶nerisini Ã¼ret
  if (!row) return 'Veri yok.'; // Veri yoksa mesaj
  if (row.parallelServers >= MAX_SERVERS) return `OperatÃ¶r sayÄ±sÄ± ${MAX_SERVERS} sÄ±nÄ±rÄ±nda; artÄ±ÅŸ uygulanamaz.`; // SÄ±nÄ±r mesajÄ±
  const nextParallel = row.parallelServers + 1; // Yeni paralel kapasite
  const baseCapacity = row.serviceTime > 0 ? row.parallelServers / row.serviceTime : 0; // Mevcut kapasite
  const newCapacity = row.serviceTime > 0 ? nextParallel / row.serviceTime : baseCapacity; // Yeni kapasite
  const ratio = baseCapacity > 0 ? newCapacity / baseCapacity : nextParallel; // ArtÄ±ÅŸ oranÄ±
  return `OperatÃ¶r sayÄ±sÄ± +1 olursa kapasite ${ratio.toFixed(2)} kat artar, servis sÃ¼resi sabit kalÄ±r.`; // Metni dÃ¶ndÃ¼r
}

function prepareChartCanvas(canvas) { // Canvas boyutunu hazÄ±rla
  if (!canvas) return null; // Eleman yoksa Ã§Ä±k
  const ctx = canvas.getContext('2d'); // BaÄŸlamÄ± al
  if (!ctx) return null; // BaÄŸlam yoksa Ã§Ä±k
  const dpr = window.devicePixelRatio || 1; // Piksel oranÄ±
  const bounds = canvas.getBoundingClientRect(); // Piksel boyutlarÄ±nÄ± al
  const width = Math.floor(bounds.width || canvas.clientWidth || 0); // GÃ¶rÃ¼nen geniÅŸlik
  const height = Math.floor(bounds.height || canvas.clientHeight || 0); // GÃ¶rÃ¼nen yÃ¼kseklik
  if (!width || !height) return null; // Ã–lÃ§Ã¼ yoksa Ã§Ä±k
  canvas.width = width * dpr; // Piksel geniÅŸliÄŸi ayarla
  canvas.height = height * dpr; // Piksel yÃ¼ksekliÄŸi ayarla
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // Ã–lÃ§eÄŸi uygula
  ctx.clearRect(0, 0, width, height); // Canvas'Ä± temizle
  ctx.font = '12px sans-serif'; // YazÄ± tipini ayarla
  ctx.textBaseline = 'middle'; // Baz Ã§izgi
  return { ctx, width, height }; // Sonucu dÃ¶ndÃ¼r
}

function scheduleDashboardCharts() { // Dashboard grafikleri iÃ§in Ã§izim zamanla
  if (!reportModal || !reportModal.classList.contains('active')) return; // Modal kapalÄ±ysa Ã§Ä±k
  if (!latestReport) return; // Rapor yoksa Ã§Ä±k
  if (scheduledChartFrame) { // Ã–nceden planlanmÄ±ÅŸ kare varsa
    cancelAnimationFrame(scheduledChartFrame); // Eski kareyi iptal et
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
  }
  scheduledChartFrame = requestAnimationFrame(() => { // Yeni kare planla
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
    renderQueueChart(latestReport.stationRows); // Kuyruk grafiÄŸini Ã§iz
    renderThroughputChart(latestReport.completionSeries, latestReport.horizon); // Throughput grafiÄŸini Ã§iz
  });
}

function renderQueueChart(rows) { // Kuyruk grafiÄŸini Ã§iz
  if (!queueChartCanvas) return; // Canvas yoksa Ã§Ä±k
  const surface = prepareChartCanvas(queueChartCanvas); // Canvas hazÄ±rlÄ±ÄŸÄ±
  if (!surface) return; // HazÄ±rlÄ±k baÅŸarÄ±sÄ±zsa Ã§Ä±k
  const { ctx, width, height } = surface; // BoyutlarÄ± al
  if (!rows || !rows.length) { // Veri yoksa
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; // Metin rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText('Veri yok', width / 2, height / 2); // Mesaj yaz
    return; // Ã‡Ä±k
  }
  const padding = { top: 24, right: 18, bottom: 48, left: 54 }; // Kenar boÅŸluklarÄ±
  const chartWidth = Math.max(10, width - padding.left - padding.right); // Grafik geniÅŸliÄŸi
  const chartHeight = Math.max(10, height - padding.top - padding.bottom); // Grafik yÃ¼ksekliÄŸi
  const maxQueue = Math.max(...rows.map(row => row.avgQueue), 1); // Maks kuyruk
  const maxUtil = Math.max(...rows.map(row => row.utilization), 0.01); // Maks util
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; // Izgara rengi
  ctx.beginPath(); // Ã‡izim baÅŸlat
  ctx.moveTo(padding.left, height - padding.bottom); // X ekseni baÅŸlangÄ±cÄ±
  ctx.lineTo(width - padding.right, height - padding.bottom); // X ekseni
  ctx.stroke(); // Ã‡iz
  const gap = chartWidth / rows.length; // SÃ¼tun aralÄ±ÄŸÄ±
  const barWidth = Math.min(48, gap * 0.6); // SÃ¼tun geniÅŸliÄŸi
  rows.forEach((row, index) => { // Her istasyon iÃ§in
    const center = padding.left + gap * index + gap / 2; // Merkez x
    const barHeight = (row.avgQueue / maxQueue) * chartHeight; // Bar yÃ¼ksekliÄŸi
    const barX = center - barWidth / 2; // Bar sol x
    const barY = height - padding.bottom - barHeight; // Bar Ã¼st y
    ctx.fillStyle = 'rgba(100,210,255,0.45)'; // Bar rengi
    ctx.fillRect(barX, barY, barWidth, barHeight); // Bar Ã§iz
    const utilY = height - padding.bottom - (row.utilization / maxUtil) * chartHeight; // Util y
    ctx.fillStyle = 'rgba(255,107,107,0.85)'; // Nokta rengi
    ctx.beginPath(); // Yeni yol
    ctx.arc(center, utilY, 4, 0, Math.PI * 2); // Nokta Ã§iz
    ctx.fill(); // Doldur
    ctx.fillStyle = 'rgba(255,255,255,0.7)'; // Etiket rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText(row.stationName, center, height - padding.bottom + 18); // Ä°sim yaz
  });
  ctx.fillStyle = 'rgba(255,255,255,0.6)'; // BaÅŸlÄ±k rengi
  ctx.textAlign = 'left'; // Sol hizala
  ctx.fillText('Ortalama Kuyruk', padding.left, padding.top - 10); // Kuyruk etiketi
  ctx.textAlign = 'right'; // SaÄŸ hizala
  ctx.fillText('Utilizasyon %', width - padding.right, padding.top - 10); // Util etiketi
}

function renderThroughputChart(series, horizon) { // Zaman grafiÄŸini Ã§iz
  if (!throughputChartCanvas) return; // Canvas yoksa Ã§Ä±k
  const surface = prepareChartCanvas(throughputChartCanvas); // Canvas hazÄ±rlÄ±ÄŸÄ±
  if (!surface) return; // HazÄ±rlÄ±k baÅŸarÄ±sÄ±zsa Ã§Ä±k
  const { ctx, width, height } = surface; // BoyutlarÄ± al
  if (!series || !series.length) { // Veri yoksa
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; // Metin rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText('HenÃ¼z tamamlanan Ã¼rÃ¼n yok', width / 2, height / 2); // Mesaj yaz
    return; // Ã‡Ä±k
  }
  const padding = { top: 24, right: 20, bottom: 42, left: 58 }; // Kenar boÅŸluklarÄ±
  const chartWidth = Math.max(10, width - padding.left - padding.right); // Grafik geniÅŸliÄŸi
  const chartHeight = Math.max(10, height - padding.top - padding.bottom); // Grafik yÃ¼ksekliÄŸi
  const maxTime = Math.max(series[series.length - 1].time, horizon, 1); // Maks zaman
  const maxCount = Math.max(series[series.length - 1].count, 1); // Maks adet
  const points = series.map(point => ({ // NoktalarÄ± Ã¶lÃ§ekle
    x: padding.left + (point.time / maxTime) * chartWidth, // X koordinatÄ±
    y: height - padding.bottom - (point.count / maxCount) * chartHeight // Y koordinatÄ±
  }));
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; // Eksen rengi
  ctx.beginPath(); // Yol
  ctx.moveTo(padding.left, padding.top); // Sol Ã¼st
  ctx.lineTo(padding.left, height - padding.bottom); // Y ekseni
  ctx.lineTo(width - padding.right, height - padding.bottom); // X ekseni
  ctx.stroke(); // Ã‡iz
  ctx.strokeStyle = 'rgba(100,210,255,0.85)'; // Ã‡izgi rengi
  ctx.lineWidth = 2; // Ã‡izgi kalÄ±nlÄ±ÄŸÄ±
  ctx.beginPath(); // Ã‡izgi yolu
  points.forEach((point, index) => { // Her nokta iÃ§in
    if (index === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); // Ã‡izgi oluÅŸtur
  });
  ctx.stroke(); // Ã‡iz
  ctx.beginPath(); // Alan doldurma
  points.forEach((point, index) => { // NoktalarÄ± tekrar gez
    if (index === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); // Yol Ã§iz
  });
  ctx.lineTo(points[points.length - 1].x, height - padding.bottom); // SaÄŸ alt
  ctx.lineTo(points[0].x, height - padding.bottom); // Sol alt
  ctx.closePath(); // Yolu kapat
  ctx.fillStyle = 'rgba(100,210,255,0.15)'; // Alan rengi
  ctx.fill(); // AlanÄ± doldur
  ctx.fillStyle = 'rgba(255,255,255,0.6)'; // YazÄ± rengi
  ctx.textAlign = 'center'; // X ekseni metni
  for (let i = 0; i <= 4; i += 1) { // 5 bÃ¶lme
    const time = (maxTime / 4) * i; // Zaman deÄŸeri
    const x = padding.left + (time / maxTime) * chartWidth; // X koordinatÄ±
    ctx.fillText(`${time.toFixed(0)} sn`, x, height - padding.bottom + 18); // Etiketi yaz
  }
  ctx.textAlign = 'right'; // Y ekseni metni
  for (let i = 0; i <= 4; i += 1) { // 5 bÃ¶lme
    const count = (maxCount / 4) * i; // Adet deÄŸeri
    const y = height - padding.bottom - (count / maxCount) * chartHeight; // Y koordinatÄ±
    ctx.fillText(`${count.toFixed(0)}`, padding.left - 6, y + 4); // Etiketi yaz
  }
}

function loadSample() { // Ã–rnek kurulum yÃ¼kle
  appState.stations = []; // Listeyi temizle
  appState.nextStationId = 1; // SayaÃ§ sÄ±fÄ±rla
  const s1 = new Station(`station-${appState.nextStationId++}`, 'S1'); // Ä°stasyon1
  s1.tasks = [new Task('Kesim', 1, 18), new Task('Montaj', 1, 38)]; // GÃ¶revler
  const s2 = new Station(`station-${appState.nextStationId++}`, 'S2'); // Ä°stasyon2
  s2.tasks = [new Task('Kaynak', 1, 30)]; // GÃ¶rev
  const s3 = new Station(`station-${appState.nextStationId++}`, 'S3'); // Ä°stasyon3
  s3.tasks = [new Task('Boyama', 1, 40)]; // GÃ¶rev
  s1.outputs = [s2.id]; // Ã‡Ä±kÄ±ÅŸ baÄŸlantÄ±sÄ± tanÄ±mla
  s2.outputs = [s3.id]; // Zinciri devam ettir
  s3.outputs = []; // Son istasyon
  s1.position = suggestStationPosition(0, 3); // VarsayÄ±lan konum
  s2.position = suggestStationPosition(1, 3); // VarsayÄ±lan konum
  s3.position = suggestStationPosition(2, 3); // VarsayÄ±lan konum
  appState.stations.push(s1, s2, s3); // Listeye ekle
  appState.entryPolicy = 'trigger'; // Tetikleme politikasÄ±
  appState.targetCount = 20; // Hedef 20
  syncControlsFromState(); // Kontrolleri hizala
  renderStations(); // UI gÃ¼ncelle
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function syncControlsFromState() { // Kontrolleri duruma gÃ¶re hizala
  targetInput.value = appState.targetCount ?? ''; // Hedef alanÄ±
  entryPolicySelect.value = appState.entryPolicy; // Politika seÃ§imi
  entryIntervalInput.value = appState.entryInterval; // AralÄ±k alanÄ±
  entryIntervalInput.style.display = appState.entryPolicy === 'interval' ? 'block' : 'none'; // GÃ¶rÃ¼nÃ¼rlÃ¼k
  entryIntervalInput.disabled = appState.entryPolicy !== 'interval'; // Kilit durumu
  speedSlider.value = appState.speed; // HÄ±z kaydÄ±rgacÄ±
  const display = Number.isInteger(appState.speed) ? appState.speed.toFixed(0) : appState.speed.toFixed(2); // GÃ¶sterim metni
  speedValue.textContent = `${display}Ã—`; // HÄ±z etiketi
  if (taktInput) taktInput.value = appState.taktTime ?? ''; // Takt alanÄ±
  updateZoomDisplay(); // Zoom gÃ¶stergesini yenile
  document.body.dataset.editMode = appState.mode; // Mod niteliÄŸini gÃ¼ncelle
  if (viewModeBtn) { // GÃ¶rÃ¼ntÃ¼le butonu durumunu ayarla
    viewModeBtn.dataset.active = appState.mode === 'view' ? 'true' : 'false'; // Aktif veri niteliÄŸi
    viewModeBtn.disabled = appState.mode === 'view'; // Aktifken kilitle
  }
  if (editModeBtn) { // DÃ¼zenle butonu durumunu ayarla
    editModeBtn.dataset.active = appState.mode === 'edit' ? 'true' : 'false'; // Aktif veri niteliÄŸi
    editModeBtn.disabled = appState.mode === 'edit'; // Aktifken kilitle
  }
}

function restoreFromSnapshot(snapshot, options = {}) { // Yerel depolamadan gelen durumu uygula
  const { persist = true, applyLanguage = true } = options; // SeÃ§enekleri al
  if (!snapshot || typeof snapshot !== 'object') { // Veri yoksa
    renderStations(); // VarsayÄ±lan Ã§iz
    renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
    syncControlsFromState(); // Kontrolleri hizala
    return; // Ã‡Ä±k
  }
  if (applyLanguage && snapshot.language && snapshot.language !== appState.language) { // Dil uygulanacak mÄ±
    setLanguage(snapshot.language, { silent: true }); // Dili gÃ¼ncelle
  }
  if (appState.simulation) stopSimulation(false); // Ã‡alÄ±ÅŸan simÃ¼lasyonu durdur
  appState.simulation = null; // Motor referansÄ±nÄ± temizle
  viz.clearJobs(); // BaloncuklarÄ± temizle
  updateCompletedCounter(0); // SayaÃ§ sÄ±fÄ±rla
  const safeStations = Array.isArray(snapshot.stations) ? snapshot.stations : []; // GÃ¼venli istasyon listesi
  appState.stations = safeStations.map(raw => { // Her istasyon iÃ§in
    const stationId = raw.id ? String(raw.id) : `station-${appState.nextStationId++}`; // KimliÄŸi belirle
    const stationName = raw.name ? String(raw.name) : stationId; // Ä°smi seÃ§
    const station = new Station(stationId, stationName); // Yeni istasyon
    station.parallelServers = Math.max(1, Math.min(MAX_SERVERS, Number(raw.parallelServers) || 1)); // Paralel sÄ±nÄ±r
    const rawTasks = Array.isArray(raw.tasks) ? raw.tasks : []; // GÃ¶rev listesi
    station.tasks = rawTasks.map(taskRaw => new Task( // Her gÃ¶rev iÃ§in
      taskRaw.name ? String(taskRaw.name) : 'GÃ¶rev', // GÃ¶rev adÄ±
      Math.max(1, Number(taskRaw.operators) || 1), // OperatÃ¶r
      Math.max(1, Number(taskRaw.durationSec) || 1) // SÃ¼re
    ));
    const rawOutputs = Array.isArray(raw.outputs) ? raw.outputs : []; // Ã‡Ä±kÄ±ÅŸ listesi
    station.outputs = rawOutputs.map(out => String(out)).filter((out, idx, arr) => arr.indexOf(out) === idx); // Benzersiz Ã§Ä±kÄ±ÅŸlar
    const rawPos = raw.position; // Ham koordinat
    if (rawPos && Number.isFinite(rawPos.x) && Number.isFinite(rawPos.y)) { // GeÃ§erliyse
      station.position = { x: Number(rawPos.x), y: Number(rawPos.y) }; // Konumu aktar
    }
    return station; // HazÄ±r istasyon
  });
  const snapshotNext = snapshot.nextStationId ? Number(snapshot.nextStationId) : appState.nextStationId; // Sonraki sayaÃ§
  const computedNext = appState.stations.length ? Math.max(...appState.stations.map(st => {
    const numeric = Number(String(st.id).split('-').pop()); // Kimlikten sayÄ± Ã§Ä±kar
    return Number.isFinite(numeric) ? numeric + 1 : 1; // Sonraki tahmin
  })) : 1; // BoÅŸsa 1
  appState.nextStationId = Math.max(1, snapshotNext, computedNext); // SayaÃ§ hizala
  if (typeof snapshot.targetCount === 'number' && snapshot.targetCount > 0) { // Hedef geÃ§erli mi
    appState.targetCount = Math.floor(snapshot.targetCount); // Hedefi ata
  }
  if (typeof snapshot.entryInterval === 'number' && snapshot.entryInterval > 0) { // AralÄ±k geÃ§erli mi
    appState.entryInterval = Math.floor(snapshot.entryInterval); // AralÄ±ÄŸÄ± ata
  }
  if (snapshot.entryPolicy === 'interval' || snapshot.entryPolicy === 'trigger') { // Politika doÄŸrulama
    appState.entryPolicy = snapshot.entryPolicy; // PolitikayÄ± ata
  }
  if (typeof snapshot.speed === 'number' && snapshot.speed > 0) { // HÄ±z geÃ§erli mi
    appState.speed = Math.max(0.25, Math.min(16, snapshot.speed)); // HÄ±zÄ± sÄ±nÄ±rla
  }
  if (typeof snapshot.zoom === 'number' && snapshot.zoom > 0) { // Zoom geÃ§erli mi
    appState.zoom = Math.max(0.25, Math.min(2, snapshot.zoom)); // Zoom aralÄ±ÄŸÄ±nÄ± sÄ±nÄ±rla
  }
  if (typeof snapshot.taktTime === 'number' && snapshot.taktTime > 0) { // Takt deÄŸeri geÃ§erli mi
    appState.taktTime = snapshot.taktTime; // Takt time ata
  }
  if (snapshot.mode === 'edit' || snapshot.mode === 'view') { // Mod bilgisi geÃ§erli mi
    appState.mode = snapshot.mode; // Modu ata
  }
  reorderStationsByTopology(); // BaÄŸlantÄ± sÄ±rasÄ±na gÃ¶re diz
  document.body.dataset.editMode = appState.mode; // Body veri niteliÄŸini gÃ¼ncelle
  syncControlsFromState(); // Kontrolleri gÃ¼ncelle
  renderStations(); // KartlarÄ± Ã§iz
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  if (persist) { // Persist gerekiyorsa
    const payload = captureStatePayload(); // Snapshot Ã¼ret
    updateActiveTabSnapshot(payload, { markDirty: false, reason: 'restore' }); // Sekmeyi gÃ¼ncelle
  }
}

let eventsBound = false; // Olay baÄŸlama bayraÄŸÄ±

function bindKeyboardShortcuts(event) { // Klavye kÄ±sayol dinleyicisi
  if (!event || !event.key) return; // GeÃ§ersizse Ã§Ä±k
  const tagName = event.target?.tagName; // Hedef etiketi
  if (tagName === 'INPUT' || tagName === 'TEXTAREA') return; // Form odakta ise Ã§Ä±k
  const key = event.key.toLowerCase(); // Harfi kÃ¼Ã§Ã¼lt
  if (key === 'b') startSimulation(); // B ile baÅŸlat
  if (key === 'd') stopSimulation(true); // D ile durdur
  if (key === 'r') resetSimulation(); // R ile sÄ±fÄ±rla
}

function guardControlForm() { // Kontrol formu gÃ¶nderimini engelle
  document.querySelector('form#controls')?.addEventListener('submit', event => event.preventDefault()); // Submit engelle
}

function attachUiEvents() { // UI olaylarÄ±nÄ± baÄŸla
  if (eventsBound) return; // Zaten baÄŸlÄ±ysa Ã§Ä±k
  eventsBound = true; // BayraÄŸÄ± iÅŸaretle
  guardControlForm(); // Form korumasÄ± ekle
  const addBtn = document.querySelector('#addStationBtn, [data-action="add-station"]'); // Butonu bul
  console.assert(addBtn, 'Add Station button not found'); // Kontrol
  addBtn?.addEventListener('click', onAddStationClick, { once: false }); // TÄ±klama baÄŸla
  sampleBtn?.addEventListener('click', () => { closeDropdownMenu(); loadSample(); }); // Ã–rnek kurulum
  clearBtn?.addEventListener('click', () => clearActiveTab()); // Sekmeyi temizle
  startBtn?.addEventListener('click', () => startSimulation()); // BaÅŸlat
  stopBtn?.addEventListener('click', () => stopSimulation(true)); // Durdur
  resetBtn?.addEventListener('click', () => resetSimulation()); // SÄ±fÄ±rla
  saveScenarioBtn?.addEventListener('click', () => handleSaveScenario()); // Senaryoyu kaydet
  newTabToolbarBtn?.addEventListener('click', () => handleNewTab()); // Yeni sekme aÃ§
  closeTabBtn?.addEventListener('click', () => { // Sekme kapat butonu
    if (appState.activeTabId) closeTab(appState.activeTabId); // Aktif sekmeyi kapat
    closeDropdownMenu(); // MenÃ¼leri kapat
  });
  newTabBtn?.addEventListener('click', () => handleNewTab()); // Sekme Ã§ubuÄŸunda yeni sekme
  tabBarEl?.addEventListener('click', handleTabClick); // Sekme tÄ±klamasÄ±
  tabBarEl?.addEventListener('dblclick', handleTabDoubleClick); // Sekme Ã§ift tÄ±klamasÄ±
  tabBarEl?.addEventListener('dragstart', handleTabDragStart); // Sekme sÃ¼rÃ¼kleme
  tabBarEl?.addEventListener('dragover', handleTabDragOver); // SÃ¼rÃ¼kleme sÄ±rasÄ±nda
  tabBarEl?.addEventListener('drop', handleTabDrop); // Sekme bÄ±rakma
  tabBarEl?.addEventListener('dragend', handleTabDragEnd); // SÃ¼rÃ¼kleme bitiÅŸi
  analysisBtn?.addEventListener('click', () => { closeDropdownMenu(); openAnalysisModal(); }); // Analiz modalÄ±nÄ± aÃ§
  resultsBtn?.addEventListener('click', () => { closeDropdownMenu(); openReportModal(); }); // Raporu aÃ§
  simulationMenuBtn?.addEventListener('click', () => toggleDropdown(simulationMenu, simulationMenuBtn)); // SimÃ¼lasyon menÃ¼sÃ¼nÃ¼ aÃ§
  viewMenuBtn?.addEventListener('click', () => toggleDropdown(viewMenu, viewMenuBtn)); // GÃ¶rÃ¼nÃ¼m menÃ¼sÃ¼nÃ¼ aÃ§
  storageMenuBtn?.addEventListener('click', () => { renderSavedScenarioMenu(); toggleDropdown(storageMenu, storageMenuBtn); }); // KayÄ±t menÃ¼sÃ¼nÃ¼ aÃ§
  fullscreenBtn?.addEventListener('click', () => toggleFullscreen()); // Tam ekran deÄŸiÅŸtir
  closeAnalysisBtn?.addEventListener('click', () => closeAnalysisModal()); // Analiz modalÄ±nÄ± kapat
  analysisModal?.addEventListener('click', event => { if (event.target === analysisModal) closeAnalysisModal(); }); // DÄ±ÅŸa tÄ±klayÄ±nca kapat
  analysisRecalcBtn?.addEventListener('click', () => runAnalysis()); // Analizi yenile
  closeReportBtn?.addEventListener('click', () => closeReport()); // Rapor kapat
  reportModal?.addEventListener('click', event => { if (event.target === reportModal) closeReport(); }); // Modal dÄ±ÅŸÄ± kapat
  viewModeBtn?.addEventListener('click', () => setMode('view')); // GÃ¶rÃ¼ntÃ¼leme moduna geÃ§
  editModeBtn?.addEventListener('click', () => setMode('edit')); // DÃ¼zenleme moduna geÃ§
  centerLayoutBtn?.addEventListener('click', () => { viz.centerViewOnBounds(); showGraphToast('GÃ¶rÃ¼nÃ¼m merkeze toplandÄ±.', 'info'); }); // Merkezleme
  resetLayoutBtn?.addEventListener('click', () => resetLayoutToDefault()); // YerleÅŸimi sÄ±fÄ±rla
  normalizeLayoutBtn?.addEventListener('click', () => { viz.normalizeWorld(); showGraphToast('YerleÅŸim transformlarÄ± onarÄ±ldÄ±.', 'success'); }); // Normalize et
  refreshBubblesBtn?.addEventListener('click', () => { viz.refreshJobAnchors(true); showGraphToast('Baloncuk konumlarÄ± yenilendi.', 'info'); }); // BaloncuklarÄ± yenile
  speedSlider?.addEventListener('input', () => { // HÄ±z deÄŸiÅŸimi
    const value = Number(speedSlider.value); // DeÄŸer al
    appState.speed = value; // Duruma ata
    const display = Number.isInteger(value) ? value.toFixed(0) : value.toFixed(2); // GÃ¶sterim seÃ§imi
    speedValue.textContent = `${display}Ã—`; // Etiketi gÃ¼ncelle
    viz.setSpeed(appState.speed); // Animasyon hÄ±zÄ±nÄ± anÄ±nda uygula
    saveState(appState); // Durumu kaydet
  });
  targetInput?.addEventListener('input', () => { // Hedef deÄŸiÅŸimi
    const value = Number(targetInput.value); // DeÄŸer al
    appState.targetCount = value > 0 ? Math.floor(value) : null; // Ata
    saveState(appState); // Durumu kaydet
  });
  taktInput?.addEventListener('change', () => { // Takt deÄŸiÅŸimi
    const value = Number(taktInput.value); // DeÄŸer al
    appState.taktTime = value > 0 ? value : null; // Duruma yaz
    saveState(appState); // Durumu kaydet
    runAnalysis(); // Analizi gÃ¼ncelle
  });
  entryPolicySelect?.addEventListener('change', () => { // GiriÅŸ politikasÄ± deÄŸiÅŸimi
    appState.entryPolicy = entryPolicySelect.value; // Durum gÃ¼ncelle
    if (entryIntervalInput) { // AralÄ±k alanÄ± varsa
      entryIntervalInput.style.display = appState.entryPolicy === 'interval' ? 'block' : 'none'; // AlanÄ± gÃ¶ster/gizle
      entryIntervalInput.disabled = appState.entryPolicy !== 'interval'; // Kilit
    }
    saveState(appState); // Durumu kaydet
  });
  entryIntervalInput?.addEventListener('change', () => { // AralÄ±k deÄŸiÅŸimi
    const value = Math.max(1, Number(entryIntervalInput.value) || 1); // SÄ±nÄ±rla
    entryIntervalInput.value = value; // AlanÄ± gÃ¼ncelle
    appState.entryInterval = value; // Duruma ata
    saveState(appState); // Durumu kaydet
  });
  zoomOutBtn?.addEventListener('click', () => adjustZoom(-0.25)); // Zoom azalt
  zoomInBtn?.addEventListener('click', () => adjustZoom(0.25)); // Zoom artÄ±r
  zoomResetBtn?.addEventListener('click', () => resetZoom()); // Zoom sÄ±fÄ±rla
  viewZoomOutBtn?.addEventListener('click', () => adjustZoom(-0.25)); // MenÃ¼ zoom azalt
  viewZoomResetBtn?.addEventListener('click', () => resetZoom()); // MenÃ¼ zoom sÄ±fÄ±rla
  viewZoomInBtn?.addEventListener('click', () => adjustZoom(0.25)); // MenÃ¼ zoom artÄ±r
  saveLayoutBtn?.addEventListener('click', () => { saveState(appState); showGraphToast('YerleÅŸim kaydedildi.', 'success'); }); // YerleÅŸimi kaydet
  viewMenu?.querySelectorAll('button[data-lang]').forEach(button => { // Dil seÃ§enekleri
    button.addEventListener('click', () => { // TÄ±klama
      const lang = button.dataset.lang; // Dil kodu
      if (lang) setLanguage(lang); // Dili deÄŸiÅŸtir
      closeDropdownMenu(); // MenÃ¼yÃ¼ kapat
    });
  });
  otherMenuBtn?.addEventListener('click', () => toggleDropdown(otherMenu, otherMenuBtn)); // DiÄŸer menÃ¼
  otherMenu?.querySelectorAll('button').forEach(button => button.addEventListener('click', () => closeDropdownMenu())); // MenÃ¼ kapanÄ±ÅŸÄ±
  loadMenuList?.addEventListener('click', event => { // KayÄ±t seÃ§imi
    const button = event.target.closest('button[data-scenario]'); // Hedef butonu bul
    if (!button) return; // BulunamadÄ±ysa Ã§Ä±k
    handleLoadScenario(button.dataset.scenario); // Senaryoyu yÃ¼kle
    closeDropdownMenu(); // MenÃ¼yÃ¼ kapat
  });
  restoreYesBtn?.addEventListener('click', () => handleRestoreConfirm()); // Kurtarma onayÄ±
  restoreNoBtn?.addEventListener('click', () => handleRestoreDecline()); // Kurtarma reddi
  restoreNeverBtn?.addEventListener('click', () => handleRestoreNever()); // Bir daha sorma
  document.addEventListener('keydown', bindKeyboardShortcuts); // Klavye olaylarÄ±
  document.addEventListener('fullscreenchange', () => { // Tam ekran deÄŸiÅŸince
    updateFullscreenLabel(); // Etiketi gÃ¼ncelle
    scheduleDashboardCharts(); // Grafik boyutlarÄ±nÄ± tazele
  });
  window.addEventListener('resize', () => scheduleDashboardCharts()); // Pencere yeniden boyutlanÄ±nca grafikleri tazele
}

function initApp() { // BaÅŸlatÄ±cÄ±
  attachUiEvents(); // OlaylarÄ± baÄŸla
  initializeTabs(); // Sekmeleri yÃ¼kle
  applyTranslations(document); // Metinleri Ã§evir
  syncLanguageOptions(); // Dil butonlarÄ±nÄ± hizala
  renderSavedScenarioMenu(); // KayÄ±t menÃ¼sÃ¼nÃ¼ hazÄ±rla
  updateCompletedCounter(appState.completedDisplayCount || 0); // SayaÃ§ metnini hizala
  const rawSnapshot = typeof localStorage !== 'undefined' ? localStorage.getItem(SNAPSHOT_KEY) : null; // Ham kurtarma verisi
  if (shouldPromptRestore() && rawSnapshot) { // Kurtarma sorulacaksa
    const payload = loadCrashSnapshotPayload(); // Veriyi oku
    if (payload) { // GeÃ§erliyse
      showRestorePrompt(payload); // ModalÄ± aÃ§
    } else { // GeÃ§ersizse
      clearCrashSnapshot(); // Veriyi temizle
      showGraphToast(t('toast.snapshotFailed'), 'error'); // Hata bildirimi
    }
  }
  setTimeout(() => { // Programatik doÄŸrulama
    const addBtn = document.querySelector('#addStationBtn, [data-action="add-station"]'); // Butonu bul
    if (!addBtn) return; // Yoksa Ã§Ä±k
    const before = appState.stations.length; // Ã–nceki sayaÃ§
    const previousNextId = appState.nextStationId; // Ã–nceki kimlik sayacÄ±
    renderingPaused = true; // Yeniden Ã§izimi geÃ§ici olarak durdur
    try { // Korunan deneme bloÄŸu
      addBtn.click(); // TÄ±klamayÄ± simÃ¼le et
    } finally { // Her durumda Ã§alÄ±ÅŸacak blok
      renderingPaused = false; // BayraÄŸÄ± eski haline getir
    }
    const after = appState.stations.length; // Sonraki sayaÃ§
    console.assert(after === before + 1, 'Station not added via programmatic click'); // DoÄŸrulama
    if (after === before + 1) { // BaÅŸarÄ±lÄ±ysa
      appState.stations.pop(); // Eklenen istasyonu Ã§Ä±kar
      appState.nextStationId = previousNextId; // Kimlik sayacÄ±nÄ± geri al
      renderStations(); // Listeyi yenile
      renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
      saveState(appState); // Durumu kaydet
    }
  }, 500); // 500ms sonra Ã§alÄ±ÅŸtÄ±r
}

if (document.readyState === 'loading') { // DOM yÃ¼kleniyorsa
  document.addEventListener('DOMContentLoaded', initApp, { once: true }); // DOM hazÄ±r olunca Ã§alÄ±ÅŸtÄ±r
} else {
  queueMicrotask(initApp); // Zaten yÃ¼klÃ¼yse hemen Ã§alÄ±ÅŸtÄ±r
}
</script> <!-- Betik bitiÅŸi -->
</body>
</html>
