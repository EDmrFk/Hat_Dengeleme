<!DOCTYPE html> <!-- Tek sayfa uygulama bildirimi -->
<html lang="tr"> <!-- Dil ayarÄ± TÃ¼rkÃ§e -->
<head> <!-- BaÅŸlÄ±k bilgileri baÅŸlangÄ±cÄ± -->
<meta charset="UTF-8"> <!-- Unicode desteÄŸi -->
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <!-- Mobil uyum -->
<title>Hat SimÃ¼lasyonu</title> <!-- Sayfa baÅŸlÄ±ÄŸÄ± -->
<style> /* GÃ¶mÃ¼lÃ¼ stiller baÅŸlangÄ±cÄ± */
:root { /* Tema deÄŸiÅŸkenleri tanÄ±mÄ± */
  --bg: #111316; /* Arka plan rengi */
  --card: #1c1f24; /* Kart arka planÄ± */
  --card-light: #242830; /* Kart aÃ§Ä±k tonu */
  --accent: #64d2ff; /* Vurgu rengi */
  --accent-strong: #30a6d9; /* GÃ¼Ã§lÃ¼ vurgu rengi */
  --text: #f4f5f7; /* Metin rengi */
  --muted: #9aa0ab; /* SÃ¶nÃ¼k metin rengi */
  --danger: #ff6b6b; /* Hata/darboÄŸaz rengi */
  --border-radius: 12px; /* Genel kÃ¶ÅŸe yuvarlama */
  --transition: 160ms ease; /* Standart geÃ§iÅŸ sÃ¼resi */
}

* { /* Genel reset */
  box-sizing: border-box; /* Kutular iÃ§eriÄŸe gÃ¶re hesaplanÄ±r */
}

body { /* GÃ¶vde stili */
  margin: 0; /* VarsayÄ±lan boÅŸluklarÄ± kaldÄ±r */
  font-family: "Segoe UI", sans-serif; /* Modern yazÄ± tipi */
  background: var(--bg); /* Arka plan */
  color: var(--text); /* Metin */
  min-height: 100vh; /* Tam ekran */
}

header { /* Ãœst Ã§ubuk stili */
  position: sticky; /* YukarÄ±da sabitlenir */
  top: 0; /* YukarÄ± hizalama */
  z-index: 10; /* Ãœstte kalmasÄ± iÃ§in */
  background: rgba(17, 19, 22, 0.94); /* Hafif saydam fon */
  backdrop-filter: blur(12px); /* Cam efekti */
  padding: 16px 24px; /* Ä°Ã§ boÅŸluk */
  box-shadow: 0 2px 12px rgba(0,0,0,0.35); /* GÃ¶lge */
}

header .controls { /* Kontrol satÄ±rÄ± */
  display: flex; /* Yatay hizalama */
  flex-wrap: wrap; /* SatÄ±r atlama */
  gap: 12px; /* Aralar boÅŸluk */
  align-items: center; /* Dikey ortalama */
}

button, input, select { /* Form kontrolleri ortak stil */
  font: inherit; /* YazÄ± tipini devral */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  border: 1px solid transparent; /* Kenar */
  padding: 8px 14px; /* Ä°Ã§ boÅŸluk */
  background: var(--card-light); /* Arka plan */
  color: var(--text); /* Metin rengi */
  transition: border-color var(--transition), background var(--transition), transform var(--transition); /* GeÃ§iÅŸler */
}

#addStationBtn, [data-action="add-station"] { /* Ä°stasyon ekle butonu tÄ±klanabilirliÄŸi */
  pointer-events: auto; /* Fare etkileÅŸimini aÃ§ */
  position: relative; /* Ãœst katman konum */
  z-index: 20; /* DiÄŸer katmanlarÄ±n Ã¼stÃ¼nde */
}

header .controls { /* Kontrol satÄ±rÄ±nÄ±n katman dÃ¼zeni */
  position: relative; /* Z-index etkili olsun */
  z-index: 15; /* Ãœste taÅŸÄ± */
}

button:hover, input:focus, select:focus { /* Odak/hover durumu */
  border-color: var(--accent); /* Kenar renklendir */
  outline: none; /* VarsayÄ±lan odak kaldÄ±r */
}

button.primary { /* Ã–ne Ã§Ä±kan buton */
  background: linear-gradient(135deg, var(--accent), var(--accent-strong)); /* Degrade */
  color: #0a1a23; /* Kontrast metin */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

button.danger { /* Silme/durdurma butonu */
  background: rgba(255,107,107,0.16); /* Hafif kÄ±rmÄ±zÄ± */
  color: var(--danger); /* Metin */
}

button:disabled, input:disabled, select:disabled { /* Pasif durum */
  opacity: 0.45; /* Soluk */
  cursor: not-allowed; /* Ä°ÅŸaretÃ§i */
}

main { /* Ana iÃ§erik */
  padding: 24px; /* Ä°Ã§ boÅŸluk */
  display: grid; /* Izgara */
  gap: 24px; /* BÃ¶lÃ¼mler arasÄ± boÅŸluk */
}

.section { /* BÃ¶lÃ¼m kartÄ± */
  background: var(--card); /* Kart fonu */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  padding: 24px; /* Ä°Ã§ boÅŸluk */
  box-shadow: 0 18px 38px rgba(0,0,0,0.28); /* GÃ¶lge */
}

.section h2 { /* BaÅŸlÄ±k stil */
  margin-top: 0; /* Ãœst boÅŸluk kaldÄ±r */
  font-size: 1.2rem; /* YazÄ± boyutu */
  letter-spacing: 0.01em; /* Harf aralÄ±ÄŸÄ± */
}

#stationList { /* Ä°stasyon kartlarÄ± listesi */
  display: grid; /* Izgara dÃ¼zen */
  gap: 16px; /* Kart arasÄ± boÅŸluk */
}

.station-card { /* Her istasyon kartÄ± */
  background: var(--card-light); /* Kart tonu */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe yuvarla */
  padding: 18px; /* Ä°Ã§ boÅŸluk */
  display: grid; /* Izgara */
  gap: 12px; /* BoÅŸluk */
  position: relative; /* Ä°Ã§ pozisyonlama */
  border: 1px solid rgba(255,255,255,0.05); /* Ä°nce kenar */
}

.station-card.bottleneck { /* DarboÄŸaz vurgusu */
  border-color: rgba(255,107,107,0.6); /* KÄ±rmÄ±zÄ± kenar */
  box-shadow: 0 0 20px rgba(255,107,107,0.25); /* ParÄ±ltÄ± */
}

.station-card.dragging { /* SÃ¼rÃ¼kleme durumu */
  opacity: 0.6; /* ÅeffaflÄ±k */
}

.station-card.drag-over { /* SÃ¼rÃ¼kleme hedefi */
  border-color: var(--accent); /* Vurgu kenarÄ± */
}

.station-header { /* Kart baÅŸlÄ±k satÄ±rÄ± */
  display: flex; /* Yatay */
  justify-content: space-between; /* Aralara yay */
  gap: 12px; /* BoÅŸluk */
  align-items: center; /* Ortala */
}

.station-header input { /* Ä°sim alanÄ± */
  flex: 1; /* GeniÅŸlik */
}

.task-table { /* GÃ¶rev listesi tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* KenarlarÄ± birleÅŸtir */
  color: var(--text); /* Metin */
}

.task-table th, .task-table td { /* HÃ¼cre stili */
  border-bottom: 1px solid rgba(255,255,255,0.06); /* Alt Ã§izgi */
  padding: 6px 4px; /* Ä°Ã§ boÅŸluk */
  text-align: left; /* Hizalama */
  font-size: 0.92rem; /* YazÄ± boyutu */
}

.task-table input { /* HÃ¼cre iÃ§i input */
  width: 100%; /* Tam geniÅŸlik */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
}

.runtime-line { /* CanlÄ± metrik satÄ±rÄ± */
  display: flex; /* Yatay hizalama */
  gap: 8px; /* Eleman arasÄ± boÅŸluk */
  flex-wrap: wrap; /* SatÄ±r kaydÄ±r */
  font-size: 0.82rem; /* KÃ¼Ã§Ã¼k metin */
  color: var(--muted); /* SÃ¶nÃ¼k renk */
}

.runtime-pill { /* Metrik kapsÃ¼lÃ¼ */
  padding: 4px 8px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Yuvarlak */
  background: rgba(255,255,255,0.06); /* Arka plan */
  color: var(--text); /* Metin rengi */
}

.task-actions { /* GÃ¶rev butonlarÄ± satÄ±rÄ± */
  display: flex; /* Yatay */
  justify-content: space-between; /* Alanla */
  margin-top: 6px; /* Ãœst boÅŸluk */
}

#visualPanel { /* GÃ¶rselleÅŸtirme paneli */
  position: relative; /* Ä°Ã§ yerleÅŸim */
  height: 360px; /* Sabit yÃ¼kseklik */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
  background: radial-gradient(circle at top left, rgba(100,210,255,0.08), transparent 60%), var(--card-light); /* Arka plan */
  overflow: hidden; /* TaÅŸmayÄ± gizle */
  border: 1px solid rgba(255,255,255,0.04); /* Ä°nce kenar */
}

#lineSvg { /* SVG alanÄ± */
  width: 100%; /* Tam geniÅŸlik */
  height: 100%; /* Tam yÃ¼kseklik */
  transform-origin: center center; /* Zoom merkezini sabitle */
  transition: transform var(--transition); /* Zoom geÃ§iÅŸi */
}

.zoom-toolbar { /* Zoom denetimi kutusu */
  position: absolute; /* Panel Ã¼zerinde konumla */
  right: 16px; /* SaÄŸa yasla */
  bottom: 16px; /* Alta yasla */
  display: flex; /* Yatay hizala */
  gap: 6px; /* BoÅŸluk bÄ±rak */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
  background: rgba(12, 14, 18, 0.72); /* Saydam arka plan */
  border-radius: 999px; /* Yuvarlak kutu */
  border: 1px solid rgba(255,255,255,0.08); /* Ä°nce kenar */
  backdrop-filter: blur(6px); /* Cam efekti */
}

.zoom-toolbar button { /* Zoom butonlarÄ± */
  background: rgba(255,255,255,0.08); /* Hafif parlaklÄ±k */
  border-radius: 999px; /* Tam yuvarlak */
  border: none; /* Kenar kaldÄ±r */
  padding: 6px 12px; /* Ä°Ã§ boÅŸluk */
  color: var(--text); /* Metin rengi */
  font-weight: 600; /* KalÄ±nlÄ±k */
  cursor: pointer; /* Ä°ÅŸaretÃ§i */
}

.zoom-toolbar button:hover { /* Hover durumu */
  background: rgba(100,210,255,0.25); /* Vurgu */
  color: #0a1a23; /* Kontrast */
}

.zoom-toolbar span { /* Zoom metni */
  pointer-events: none; /* EtkileÅŸimi kapat */
}

.station-shape { /* SVG istasyon kutusu */
  fill: rgba(255,255,255,0.05); /* Dolgu */
  stroke: rgba(255,255,255,0.1); /* Kenar */
  stroke-width: 2; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
}

.station-shape.bottleneck { /* DarboÄŸaz vurgusu */
  stroke: var(--danger); /* KÄ±rmÄ±zÄ± kenar */
  fill: rgba(255,107,107,0.18); /* KÄ±rmÄ±zÄ±msÄ± dolgu */
}

.station-label { /* SVG istasyon etiketi */
  fill: var(--text); /* YazÄ± rengi */
  font-size: 13px; /* YazÄ± boyutu */
  font-weight: 600; /* KalÄ±n */
}

.metric-tag { /* CanlÄ± metrik etiketi */
  fill: var(--muted); /* Renk */
  font-size: 11px; /* Boyut */
}

.metric-tag.danger { /* Kritik metrik etiketi */
  fill: var(--danger); /* KÄ±rmÄ±zÄ± renk */
  font-weight: 600; /* KalÄ±n */
}

.job-bubble { /* Ä°ÅŸ baloncuÄŸu */
  fill: var(--accent); /* Dolgu */
  stroke: rgba(10,30,40,0.8); /* Kenar */
  stroke-width: 1.5; /* Kenar kalÄ±nlÄ±ÄŸÄ± */
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.35)); /* GÃ¶lge */
}

.job-bubble.processing { /* Ä°ÅŸlenen balon */
  fill: #ffd86b; /* FarklÄ± ton */
}

.job-bubble.waiting { /* Kuyruk balonu */
  fill: #8895ff; /* Mor ton */
}

.job-bubble.completed { /* Tamamlanan balon */
  fill: #64ff8f; /* YeÅŸil */
}

#emptyState { /* BoÅŸ durum mesajÄ± */
  color: var(--muted); /* SÃ¶nÃ¼k metin */
  text-align: center; /* Ortala */
  padding: 28px; /* Ä°Ã§ boÅŸluk */
  border: 1px dashed rgba(255,255,255,0.08); /* Kesik kenar */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
}

.badge { /* KÃ¼Ã§Ã¼k rozetler */
  display: inline-flex; /* Yatay */
  align-items: center; /* Ortala */
  gap: 6px; /* BoÅŸluk */
  font-size: 0.85rem; /* Boyut */
  padding: 4px 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 999px; /* Tam yuvarlak */
  background: rgba(100,210,255,0.12); /* Arka plan */
}

.hud-badge { /* Ãœst Ã§ubuk rozeti */
  font-weight: 600; /* KalÄ±n metin */
  background: rgba(100,210,255,0.2); /* Daha belirgin arka plan */
  border: 1px solid rgba(100,210,255,0.35); /* Ä°nce kenar */
}

.badge.danger { /* KÄ±rmÄ±zÄ± rozet */
  background: rgba(255,107,107,0.15); /* Arka plan */
  color: var(--danger); /* Metin */
}

.fullscreen-btn { /* Tam ekran butonu */
  position: absolute; /* KonumlandÄ±r */
  top: 12px; /* Ãœst boÅŸluk */
  right: 12px; /* SaÄŸ boÅŸluk */
  background: rgba(0,0,0,0.45); /* YarÄ± saydam arka plan */
  color: #fff; /* Metin rengi */
  border: 1px solid rgba(255,255,255,0.25); /* Ä°nce kenar */
  padding: 6px 10px; /* Ä°Ã§ boÅŸluk */
  border-radius: 12px; /* KÃ¶ÅŸe */
  cursor: pointer; /* Ä°mleÃ§ */
  display: flex; /* Ä°Ã§ hizalama */
  align-items: center; /* Dikey hizalama */
  gap: 6px; /* AralÄ±k */
  z-index: 11; /* Ãœste taÅŸÄ± */
}

.fullscreen-btn span { /* Buton metni */
  font-size: 0.85rem; /* YazÄ± boyutu */
}

.modal-backdrop { /* Modal arka planÄ± */
  position: fixed; /* Sabit */
  inset: 0; /* TÃ¼m ekran */
  background: rgba(0,0,0,0.6); /* Saydam siyah */
  display: none; /* VarsayÄ±lan gizli */
  align-items: center; /* Dikey ortalama */
  justify-content: center; /* Yatay ortalama */
  z-index: 20; /* Ãœste taÅŸÄ±r */
}

.modal-backdrop.active { /* Aktif modal */
  display: flex; /* GÃ¶ster */
}

.modal { /* Modal kutusu */
  background: var(--card-light); /* Arka plan */
  border-radius: var(--border-radius); /* KÃ¶ÅŸe */
  padding: 24px 28px; /* Ä°Ã§ boÅŸluk */
  width: min(900px, 92vw); /* Maks geniÅŸlik */
  max-height: 90vh; /* Maks yÃ¼kseklik */
  overflow: auto; /* KaydÄ±r */
  box-shadow: 0 24px 60px rgba(0,0,0,0.45); /* GÃ¶lge */
}

.modal h3 { /* Modal baÅŸlÄ±ÄŸÄ± */
  margin-top: 0; /* Ãœst boÅŸluk kaldÄ±r */
}


.dashboard-header { /* Dashboard baÅŸlÄ±k alanÄ± */
  display: flex; /* Yatay hizala */
  justify-content: space-between; /* DaÄŸÄ±t */
  align-items: center; /* Dikey hizala */
  gap: 12px; /* AralÄ±k */
  margin-bottom: 12px; /* Alt boÅŸluk */
}

.dashboard-grid { /* Dashboard ana Ä±zgara */
  display: grid; /* Izgara */
  gap: 18px; /* AralÄ±k */
}

.summary-cards { /* Ã–zet kart grubu */
  display: grid; /* Izgara */
  gap: 16px; /* AralÄ±k */
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); /* Uyarlanabilir sÃ¼tun */
}

.summary-card { /* Ã–zet kart */
  background: rgba(255,255,255,0.04); /* Saydam arka plan */
  border: 1px solid rgba(255,255,255,0.08); /* Kenar */
  border-radius: 16px; /* KÃ¶ÅŸe */
  padding: 16px; /* Ä°Ã§ boÅŸluk */
  display: flex; /* Ä°Ã§ hizalama */
  flex-direction: column; /* Dikey yerleÅŸim */
  gap: 6px; /* AralÄ±k */
}

.summary-card h4 { /* Kart baÅŸlÄ±ÄŸÄ± */
  margin: 0; /* BoÅŸluk kaldÄ±r */
  font-size: 0.95rem; /* YazÄ± boyutu */
  color: var(--muted); /* SÃ¶nÃ¼k ton */
}

.summary-card strong { /* Kart deÄŸeri */
  font-size: 1.4rem; /* BÃ¼yÃ¼k metin */
  font-weight: 700; /* KalÄ±n */
}

.dashboard-section { /* Dashboard bÃ¶lÃ¼mÃ¼ */
  background: rgba(0,0,0,0.25); /* Arka plan */
  border: 1px solid rgba(255,255,255,0.08); /* Kenar */
  border-radius: 18px; /* KÃ¶ÅŸe */
  padding: 18px; /* Ä°Ã§ boÅŸluk */
}

.dashboard-section h4 { /* BÃ¶lÃ¼m baÅŸlÄ±ÄŸÄ± */
  margin-top: 0; /* Ãœst boÅŸluk yok */
}

.dashboard-table { /* Dashboard tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* Kenar birleÅŸtir */
  font-size: 0.9rem; /* YazÄ± boyutu */
}

.dashboard-table th, .dashboard-table td { /* HÃ¼creler */
  border-bottom: 1px solid rgba(255,255,255,0.08); /* Alt Ã§izgi */
  padding: 8px 6px; /* Ä°Ã§ boÅŸluk */
  text-align: left; /* Hizalama */
}

.dashboard-table th { /* BaÅŸlÄ±k */
  color: var(--muted); /* SÃ¶nÃ¼k */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

.chart-card { /* Grafik kapsayÄ±cÄ± */
  display: grid; /* Izgara */
  gap: 12px; /* AralÄ±k */
}

.chart-wrapper { /* Grafik alanÄ± */
  position: relative; /* GÃ¶receli */
  width: 100%; /* Tam geniÅŸlik */
  height: 220px; /* Sabit yÃ¼kseklik */
  min-height: 220px; /* Minimum yÃ¼kseklik */
}

.chart-canvas { /* Grafik canvas */
  display: block; /* Blok eleman */
  width: 100%; /* Tam geniÅŸlik */
  max-width: 100%; /* TaÅŸmayÄ± engelle */
  height: 100%; /* Tam yÃ¼kseklik */
  background: rgba(255,255,255,0.03); /* Hafif arka plan */
  border-radius: 12px; /* KÃ¶ÅŸe */
  border: 1px solid rgba(255,255,255,0.06); /* Ä°nce kenar */
}

.analysis-panel { /* Dashboard analiz paneli */
  display: grid; /* Izgara */
  gap: 10px; /* AralÄ±k */
}

.analysis-panel p { /* Analiz paragrafÄ± */
  margin: 0; /* BoÅŸluk yok */
  line-height: 1.6; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.analysis-panel ul { /* Analiz listesi */
  margin: 0; /* Ãœst-alt yok */
  padding-left: 18px; /* Sol boÅŸluk */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.signature { /* Ä°mza */
  position: fixed; /* Sabit konum */
  right: 18px; /* SaÄŸ boÅŸluk */
  bottom: 14px; /* Alt boÅŸluk */
  font-family: 'Courier New', Courier, monospace; /* Monospace */
  font-size: 0.85rem; /* YazÄ± boyutu */
  color: rgba(255,255,255,0.55); /* Saydam gri */
  letter-spacing: 0.28em; /* Harf aralÄ±ÄŸÄ± */
  pointer-events: none; /* EtkileÅŸim yok */
  transition: opacity 0.3s ease; /* GeÃ§iÅŸ */
  z-index: 50; /* Ãœst katman */
}

.signature:hover { /* Hover durumu */
  opacity: 0.9; /* OpaklÄ±k */
}

.analysis-form { /* Analiz form satÄ±rÄ± */
  display: flex; /* Yatay hizala */
  gap: 16px; /* AralÄ±k */
  align-items: flex-end; /* Alt hizala */
  margin-bottom: 12px; /* Alt boÅŸluk */
}

.analysis-section { /* Analiz bloklarÄ± */
  margin-top: 18px; /* Ãœst boÅŸluk */
}

.analysis-table { /* Analiz tablosu */
  width: 100%; /* Tam geniÅŸlik */
  border-collapse: collapse; /* KenarlarÄ± birleÅŸtir */
}

.analysis-table th, .analysis-table td { /* Analiz hÃ¼creleri */
  border-bottom: 1px solid rgba(255,255,255,0.08); /* Alt Ã§izgi */
  padding: 6px 8px; /* Ä°Ã§ boÅŸluk */
  font-size: 0.88rem; /* YazÄ± boyutu */
}

.analysis-table th { /* Analiz baÅŸlÄ±klarÄ± */
  color: var(--muted); /* SÃ¶nÃ¼k renk */
  font-weight: 600; /* KalÄ±nlÄ±k */
}

.analysis-text { /* Analiz aÃ§Ä±klama metni */
  margin: 0; /* BoÅŸluk kaldÄ±r */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

.analysis-list { /* What-if listesi */
  margin: 8px 0 0 0; /* BoÅŸluklar */
  padding-left: 18px; /* Liste iÃ§ boÅŸluk */
  line-height: 1.5; /* SatÄ±r yÃ¼ksekliÄŸi */
}

footer { /* Alt bilgi */
  text-align: center; /* Ortala */
  padding: 16px; /* Ä°Ã§ boÅŸluk */
  color: var(--muted); /* Metin */
}

input[type="number"]::-webkit-inner-spin-button { /* Spin butonlarÄ±nÄ± gizle */
  opacity: 0; /* GÃ¶rÃ¼nmez */
}

input[type="range"] { /* Slider stili */
  width: 220px; /* GeniÅŸlik */
  -webkit-appearance: none; /* Safari uyumu */
  background: transparent; /* Arka plan */
}

input[type="range"]::-webkit-slider-runnable-track { /* Slider yolu */
  height: 6px; /* YÃ¼kseklik */
  background: rgba(255,255,255,0.18); /* Arka plan */
  border-radius: 999px; /* Tam yuvarlak */
}

input[type="range"]::-webkit-slider-thumb { /* Slider tutamaÄŸÄ± */
  -webkit-appearance: none; /* Safari uyumu */
  width: 16px; /* GeniÅŸlik */
  height: 16px; /* YÃ¼kseklik */
  border-radius: 50%; /* Yuvarlak */
  background: var(--accent); /* Renk */
  margin-top: -5px; /* Hizalama */
}

input[type="range"]::-moz-range-thumb { /* Firefox tutamak */
  width: 16px; /* GeniÅŸlik */
  height: 16px; /* YÃ¼kseklik */
  border-radius: 50%; /* Yuvarlak */
  background: var(--accent); /* Renk */
}

@media (max-width: 960px) { /* Mobil uyum */
  header .controls { /* Kontroller */
    flex-direction: column; /* Dikey sÄ±rala */
    align-items: stretch; /* GeniÅŸlet */
  }
  input[type="range"] { /* Slider */
    width: 100%; /* Tam geniÅŸlik */
  }
}
</style> <!-- Stil bitiÅŸi -->
</head>
<body> <!-- GÃ¶vde baÅŸlangÄ±cÄ± -->
<header> <!-- Ãœst Ã§ubuk -->
  <div class="controls"> <!-- Kontrol grubu -->
    <button id="addStationBtn" type="button" class="primary" title="Yeni istasyon ekle">+ Ä°stasyon Ekle</button> <!-- Ä°stasyon ekleme -->
    <button id="sampleSetupBtn" type="button" title="Ã–rnek kurulum yÃ¼kle">Ã–rnek Kurulum</button> <!-- HazÄ±r senaryo -->
    <button id="analysisBtn" type="button" title="Analiz ve Ã¶nerileri aÃ§">Analiz/Ã–neri</button> <!-- Analiz modal tetikleyici -->
    <button id="resultsBtn" type="button" title="SimÃ¼lasyon sonuÃ§larÄ±nÄ± aÃ§">SonuÃ§larÄ± GÃ¶r</button> <!-- Dashboard butonu -->
    <button id="startBtn" type="button" class="primary" title="SimÃ¼lasyonu baÅŸlat (B)">BaÅŸlat</button> <!-- BaÅŸlat butonu -->
    <button id="stopBtn" type="button" class="danger" title="SimÃ¼lasyonu durdur (D)" disabled>Durdur</button> <!-- Durdur butonu -->
    <button id="resetBtn" type="button" title="SimÃ¼lasyonu sÄ±fÄ±rla (R)">SÄ±fÄ±rla</button> <!-- SÄ±fÄ±rla butonu -->
    <label title="Animasyon hÄ±zÄ±" style="display:flex;align-items:center;gap:8px;"> <!-- HÄ±z kontrol etiketi -->
      <span>HÄ±z</span> <!-- Metin -->
      <input id="speedSlider" type="range" min="0.25" max="16" step="0.25" value="1"> <!-- Slider -->
      <span id="speedValue" class="badge">1Ã—</span> <!-- HÄ±z gÃ¶stergesi -->
    </label>
    <label title="Hedef tamamlanacak Ã¼rÃ¼n adedi" style="display:flex;align-items:center;gap:8px;"> <!-- Hedef alanÄ± -->
      <span>Hedef adet</span> <!-- Metin -->
      <input id="targetInput" type="number" min="1" placeholder="sonsuz"> <!-- Hedef giriÅŸi -->
    </label>
    <label style="display:flex;align-items:center;gap:8px;"> <!-- GiriÅŸ politikasÄ± etiketi -->
      <span>GiriÅŸ</span> <!-- Metin -->
      <select id="entryPolicySelect"> <!-- Politika seÃ§imi -->
        <option value="trigger">ÃœrÃ¼n, tamamlandÄ±kÃ§a girsin</option> <!-- SeÃ§enek 1 -->
        <option value="interval">Sabit giriÅŸ aralÄ±ÄŸÄ±</option> <!-- SeÃ§enek 2 -->
      </select>
      <input id="entryIntervalInput" type="number" min="1" value="30" style="width:120px;display:none;" placeholder="sn"> <!-- AralÄ±k giriÅŸi -->
    </label>
    <span id="completedCounter" class="badge hud-badge" aria-live="polite">Tamamlanan: 0</span> <!-- Tamamlanan sayaÃ§ -->
  </div>
</header>
<main> <!-- Ana iÃ§erik -->
  <section class="section" aria-labelledby="stationsTitle"> <!-- Ä°stasyonlar bÃ¶lÃ¼mÃ¼ -->
    <h2 id="stationsTitle">Ä°stasyonlar</h2> <!-- BaÅŸlÄ±k -->
    <p id="emptyState">Ä°stasyon ekleyin veya <strong>Ã–rnek Kurulum</strong> butonunu kullanÄ±n.</p> <!-- BoÅŸ durum -->
    <div id="stationList" aria-live="polite"></div> <!-- Kart listesi -->
  </section>
  <section class="section" aria-labelledby="vizTitle"> <!-- GÃ¶rselleÅŸtirme bÃ¶lÃ¼mÃ¼ -->
    <h2 id="vizTitle">Hat AkÄ±ÅŸÄ±</h2> <!-- BaÅŸlÄ±k -->
    <div id="visualPanel"> <!-- GÃ¶rsel panel -->
      <button id="fullscreenBtn" type="button" class="fullscreen-btn" title="SimÃ¼lasyon alanÄ±nÄ± tam ekran yap"> <!-- Tam ekran -->
        <span>ğŸ”³ Tam Ekran</span> <!-- Buton metni -->
      </button>
      <div class="zoom-toolbar" role="group" aria-label="GÃ¶rsel Ã¶lÃ§ek denetimi"> <!-- Zoom kontrol grubu -->
        <button id="zoomOutBtn" type="button" title="KÃ¼Ã§Ã¼lt">âˆ’</button> <!-- Zoom kÃ¼Ã§Ã¼lt -->
        <button id="zoomResetBtn" type="button" title="Ã–lÃ§eÄŸi 100% yap"><span id="zoomValue">100%</span></button> <!-- Zoom deÄŸeri/yenile -->
        <button id="zoomInBtn" type="button" title="BÃ¼yÃ¼t">+</button> <!-- Zoom bÃ¼yÃ¼t -->
      </div>
      <svg id="lineSvg" role="img" aria-label="Hat akÄ±ÅŸÄ± animasyonu"></svg> <!-- SVG alanÄ± -->
    </div>
  </section>
</main>
<footer> <!-- Alt bilgi -->
  <span>Klavyeden: <strong>B</strong> BaÅŸlat Â· <strong>D</strong> Durdur Â· <strong>R</strong> SÄ±fÄ±rla</span> <!-- KÄ±sayol bilgisi -->
</footer>

<div class="signature" aria-hidden="true">E.DEMIR</div> <!-- Ä°mza -->

<div class="modal-backdrop" id="analysisModal"> <!-- Analiz modal arka planÄ± -->
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="analysisTitle"> <!-- Analiz modal kutusu -->
    <h3 id="analysisTitle">Analiz ve Ã–neri</h3> <!-- Analiz baÅŸlÄ±ÄŸÄ± -->
    <p style="margin-top:0;color:var(--muted);">Hat kapasitesi ve takt time senaryolarÄ±nÄ± inceleyin.</p> <!-- AÃ§Ä±klama -->
    <div class="analysis-form"> <!-- Takt formu -->
      <label for="taktInput" style="display:flex;flex-direction:column;gap:6px;flex:1;"> <!-- Takt etiket -->
        <span>Takt Time (sn/Ã¼rÃ¼n)</span> <!-- Etiket metni -->
        <input id="taktInput" type="number" min="1" placeholder="Ã–rn: 60" /> <!-- Takt giriÅŸi -->
      </label>
      <button id="analysisRecalcBtn" type="button" class="primary" style="align-self:flex-end;">Hesapla</button> <!-- Yenile butonu -->
    </div>
    <div id="analysisSummary" class="analysis-section"> <!-- Toplam sÃ¼reler -->
      <h4>Ä°stasyon Ã–zeti</h4> <!-- Ã–zet baÅŸlÄ±ÄŸÄ± -->
      <table class="analysis-table" aria-label="Ä°stasyon sÃ¼releri ve kapasite"> <!-- Analiz tablosu -->
        <thead>
          <tr>
            <th>Ä°stasyon</th>
            <th>Toplam SÃ¼re (sn)</th>
            <th>OperatÃ¶r</th>
            <th>Paralel</th>
            <th>Teorik Kapasite (Ã¼rÃ¼n/sn)</th>
          </tr>
        </thead>
        <tbody id="analysisTableBody"></tbody>
      </table>
    </div>
    <div id="analysisInsights" class="analysis-section"> <!-- Bottleneck yorumlarÄ± -->
      <h4>Bottleneck ve Takt DeÄŸerlendirmesi</h4> <!-- BaÅŸlÄ±k -->
      <p class="analysis-text"></p> <!-- Dinamik yorum -->
    </div>
    <div id="analysisWhatIf" class="analysis-section"> <!-- What-if senaryosu -->
      <h4>What-if: OperatÃ¶r ArtÄ±rÄ±mÄ±</h4> <!-- BaÅŸlÄ±k -->
      <ul class="analysis-list"></ul> <!-- Senaryo listesi -->
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:18px;"> <!-- Alt buton satÄ±rÄ± -->
      <button id="closeAnalysisBtn" class="primary">Kapat</button> <!-- Kapat butonu -->
    </div>
  </div>
</div>

<div class="modal-backdrop" id="reportModal"> <!-- Dashboard modal arka planÄ± -->
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="reportTitle"> <!-- Dashboard kutusu -->
    <div class="dashboard-header"> <!-- BaÅŸlÄ±k satÄ±rÄ± -->
      <h3 id="reportTitle">SimÃ¼lasyon SonuÃ§larÄ±</h3> <!-- Modal baÅŸlÄ±ÄŸÄ± -->
      <div style="display:flex;gap:8px;"> <!-- Buton grubu -->
        <button id="downloadCsvBtn" type="button">CSV Olarak Ä°ndir</button> <!-- CSV butonu -->
        <button id="downloadPdfBtn" type="button">PDF Olarak Kaydet</button> <!-- PDF butonu -->
        <button id="closeReportBtn" type="button" class="danger">Kapat</button> <!-- Kapat butonu -->
      </div>
    </div>
    <div class="dashboard-grid"> <!-- Dashboard iÃ§erik -->
      <section class="summary-cards" aria-label="Genel Ã¶zet kartlarÄ±"> <!-- Ã–zet kart grubu -->
        <article class="summary-card"> <!-- Cycle kartÄ± -->
          <h4>Ortalama Cycle Time</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardCycle">0 sn</strong> <!-- DeÄŸer -->
          <span>GiriÅŸten Ã§Ä±kÄ±ÅŸa ortalama sÃ¼re</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- Tamamlanan kartÄ± -->
          <h4>Toplam Tamamlanan</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardCompleted">0</strong> <!-- DeÄŸer -->
          <span>Hedeflenen Ã¼rÃ¼nlerden biten</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- Throughput kartÄ± -->
          <h4>Throughput</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardThroughput">0 /sn</strong> <!-- DeÄŸer -->
          <span>ÃœrÃ¼n/sn ve Ã¼rÃ¼n/dk</span> <!-- AÃ§Ä±klama -->
        </article>
        <article class="summary-card"> <!-- WIP kartÄ± -->
          <h4>Ortalama WIP</h4> <!-- BaÅŸlÄ±k -->
          <strong id="cardWip">0</strong> <!-- DeÄŸer -->
          <span>EÅŸzamanlÄ± sistemdeki Ã¼rÃ¼n</span> <!-- AÃ§Ä±klama -->
        </article>
      </section>
      <section class="dashboard-section" aria-label="Ä°stasyon performans tablosu"> <!-- Performans bÃ¶lÃ¼mÃ¼ -->
        <h4>Ä°stasyon BazlÄ± Performans</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- Performans tablosu -->
          <thead>
            <tr>
              <th>Ä°stasyon</th>
              <th>OperatÃ¶r</th>
              <th>Ortalama Servis SÃ¼resi (sn)</th>
              <th>Ortalama Kuyruk</th>
              <th>Utilization (%)</th>
              <th>Bekleme (sn)</th>
              <th>Tamamlanan Ä°ÅŸ</th>
            </tr>
          </thead>
          <tbody id="stationPerformanceBody"></tbody> <!-- Tablo gÃ¶vdesi -->
        </table>
      </section>
      <section class="dashboard-section" aria-label="DarboÄŸaz Ã¶zeti"> <!-- DarboÄŸaz bÃ¶lÃ¼mÃ¼ -->
        <h4>DarboÄŸaz Ã–zeti</h4> <!-- BaÅŸlÄ±k -->
        <table class="dashboard-table"> <!-- DarboÄŸaz tablosu -->
          <thead>
            <tr>
              <th>Kriter</th>
              <th>Ä°stasyon</th>
              <th>Ã–neri</th>
            </tr>
          </thead>
          <tbody id="bottleneckTableBody"></tbody> <!-- DarboÄŸaz satÄ±rlarÄ± -->
        </table>
      </section>
      <section class="dashboard-section chart-card" aria-label="Kuyruk grafiÄŸi"> <!-- Kuyruk grafik bÃ¶lÃ¼mÃ¼ -->
        <h4>Kuyruk ve Utilization Profili</h4> <!-- BaÅŸlÄ±k -->
        <div class="chart-wrapper"> <!-- Grafik alanÄ± -->
          <canvas id="queueChart" class="chart-canvas" aria-label="Ä°stasyon kuyruk uzunluklarÄ±"></canvas> <!-- Kuyruk grafiÄŸi -->
        </div>
        <p style="margin:0;color:var(--muted);">Ä°stasyonlara gÃ¶re ortalama kuyruk uzunluÄŸu ve utilization yoÄŸunluÄŸu.</p> <!-- AÃ§Ä±klama -->
      </section>
      <section class="dashboard-section chart-card" aria-label="Ã‡Ä±kÄ±ÅŸ grafiÄŸi"> <!-- Throughput grafik bÃ¶lÃ¼mÃ¼ -->
        <h4>Zaman Ä°Ã§inde Tamamlanan ÃœrÃ¼nler</h4> <!-- BaÅŸlÄ±k -->
        <div class="chart-wrapper"> <!-- Grafik alanÄ± -->
          <canvas id="throughputChart" class="chart-canvas" aria-label="Tamamlanan Ã¼rÃ¼n trendi"></canvas> <!-- Zaman serisi -->
        </div>
        <p style="margin:0;color:var(--muted);">MantÄ±ksal zaman ekseninde kÃ¼mÃ¼latif tamamlanan Ã¼rÃ¼n.</p> <!-- AÃ§Ä±klama -->
      </section>
      <section class="dashboard-section analysis-panel" aria-label="Analiz ve Ã¶neriler"> <!-- Analiz sekmesi -->
        <h4>Analiz / Ã–neriler</h4> <!-- BaÅŸlÄ±k -->
        <p id="dashboardAnalysisText">Analiz yÃ¼kleniyor...</p> <!-- Analiz metni -->
        <ul id="dashboardAnalysisList"></ul> <!-- What-if listesi -->
      </section>
    </div>
  </div>
</div>

<script> // Uygulama betiÄŸi baÅŸlangÄ±cÄ±

window.addEventListener('error', event => console.error('Global error:', event.error || event.message)); // Global hata yakala

const STORAGE_KEY = 'line-sim-state'; // Yerel depolama anahtarÄ±
const persistedSnapshot = loadPersistedState(); // Ã–nceden kaydedilmiÅŸ durum

// YardÄ±mcÄ± sabitler //
const MAX_SERVERS = 16; // Maksimum paralel sunucu sayÄ±sÄ±
const UPDATE_INTERVAL_MS = 150; // UI metrik gÃ¼ncelleme aralÄ±ÄŸÄ±
const MOVE_DURATION_MS = 900; // Baloncuk hareket sÃ¼resi
const LOGICAL_RATE = 4; // 1 saniyede iÅŸlenecek mantÄ±ksal saniye

// KÃ¼resel durum //
const appState = window.appState ?? { // Uygulama genel durumu
  stations: [], // Ä°stasyon model listesi
  running: false, // SimÃ¼lasyon Ã§alÄ±ÅŸÄ±yor mu
  targetCount: null, // Hedef Ã¼rÃ¼n adedi
  entryPolicy: 'trigger', // GiriÅŸ politikasÄ± seÃ§imi
  entryInterval: 30, // Sabit giriÅŸ aralÄ±ÄŸÄ±
  speed: 1, // Animasyon hÄ±zÄ±
  zoom: 1, // GÃ¶rsel Ã¶lÃ§ek
  taktTime: null, // Takt time deÄŸeri
  simulation: null, // SimÃ¼lasyon motoru referansÄ±
  lastUpdate: 0, // Son UI gÃ¼ncelleme zamanÄ±
  lastMetricRefresh: 0, // Son metrik yenileme zamanÄ±
  visualCursor: 0, // GÃ¶rsel zaman imleci
  nextStationId: 1 // Bir sonraki istasyon numarasÄ±
};
window.appState = appState; // Durumu kÃ¼resele yaz

let renderingPaused = false; // GeÃ§ici olarak yeniden Ã§izimi durdurma bayraÄŸÄ±

function loadPersistedState() { // Yerel depolamadan durumu oku
  if (typeof localStorage === 'undefined') return null; // TarayÄ±cÄ± dÄ±ÅŸÄ± ortam korumasÄ±
  try {
    const raw = localStorage.getItem(STORAGE_KEY); // Ham veri al
    if (!raw) return null; // Veri yoksa Ã§Ä±k
    return JSON.parse(raw); // JSON Ã§Ã¶z
  } catch (error) {
    console.warn('Durum yÃ¼klenirken hata:', error); // Hata logla
    return null; // GÃ¼venli dÃ¶nÃ¼ÅŸ
  }
}

function saveState(state = appState) { // Durumu kaydet
  if (typeof localStorage === 'undefined') return; // TarayÄ±cÄ± dÄ±ÅŸÄ± ortam korumasÄ±
  try {
    const snapshot = { // Kaydedilecek Ã¶zet
      stations: state.stations.map(st => ({ // Her istasyon iÃ§in
        id: st.id, // Kimlik
        name: st.name, // Ä°sim
        parallelServers: st.parallelServers, // Paralel operatÃ¶r
        tasks: st.tasks.map(task => ({ // GÃ¶rev listesi
          name: task.name, // GÃ¶rev adÄ±
          operators: task.operators, // OperatÃ¶r sayÄ±sÄ±
          durationSec: task.durationSec // SÃ¼re
        }))
      })),
      targetCount: state.targetCount, // Hedef adet
      entryPolicy: state.entryPolicy, // GiriÅŸ politikasÄ±
      entryInterval: state.entryInterval, // GiriÅŸ aralÄ±ÄŸÄ±
      speed: state.speed, // HÄ±z
      zoom: state.zoom, // Zoom deÄŸeri
      taktTime: state.taktTime, // Takt time
      nextStationId: state.nextStationId // SÄ±radaki kimlik
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(snapshot)); // JSON olarak yaz
  } catch (error) {
    console.warn('Durum kaydedilirken hata:', error); // Hata logla
  }
}

// Model sÄ±nÄ±flarÄ± //
class Task { // GÃ¶rev modeli
  constructor(name, operators, durationSec) { // Kurucu
    this.name = name; // GÃ¶rev adÄ±
    this.operators = operators; // OperatÃ¶r sayÄ±sÄ±
    this.durationSec = durationSec; // SÃ¼re
  }
}

class Station { // Ä°stasyon modeli
  constructor(id, name) { // Kurucu
    this.id = id; // Kimlik
    this.name = name; // Ä°sim
    this.tasks = []; // GÃ¶rev listesi
    this.parallelServers = 1; // Paralel sunucu sayÄ±sÄ±
  }
  totalDuration() { // Toplam gÃ¶rev sÃ¼resi hesaplar
    return this.tasks.reduce((sum, task) => sum + task.durationSec, 0); // SÃ¼relerin toplamÄ±
  }
}

class FastQueue { // O(1) kuyruk yapÄ±sÄ±
  constructor() { // Kurucu
    this.store = []; // Ä°Ã§ dizi
    this.head = 0; // BaÅŸ iÅŸaretÃ§isi
  }
  enqueue(item) { // KuyruÄŸa ekle
    this.store.push(item); // Dizinin sonuna ekle
  }
  dequeue() { // Kuyruktan Ã§Ä±kar
    if (this.head >= this.store.length) return null; // BoÅŸsa null dÃ¶ndÃ¼r
    const value = this.store[this.head]; // Ä°lk elemanÄ± al
    this.head += 1; // BaÅŸ iÅŸaretÃ§isini ilerlet
    if (this.head > 32 && this.head * 2 > this.store.length) { // Temizlik eÅŸiÄŸi
      this.store = this.store.slice(this.head); // Diziyi daralt
      this.head = 0; // BaÅŸ iÅŸaretÃ§isini sÄ±fÄ±rla
    }
    return value; // ElemanÄ± dÃ¶ndÃ¼r
  }
  peekAll() { // Kuyruktaki aktif elemanlarÄ± dÃ¶ndÃ¼r
    return this.store.slice(this.head); // Aktif parÃ§ayÄ± kopyala
  }
  get length() { // Uzunluk hesapla
    return this.store.length - this.head; // Aktif eleman sayÄ±sÄ±
  }
}

class MinHeap { // Ã–ncelik kuyruÄŸu
  constructor(compare) { // Kurucu
    this.compare = compare; // KarÅŸÄ±laÅŸtÄ±rma fonksiyonu
    this.data = []; // Depolama dizisi
  }
  peek() { // En kÃ¼Ã§Ã¼k elemanÄ± getir
    return this.data.length ? this.data[0] : null; // Ä°lk eleman veya null
  }
  push(value) { // Yeni eleman ekle
    this.data.push(value); // Dizinin sonuna ekle
    this.bubbleUp(this.data.length - 1); // YukarÄ± dÃ¼zelt
  }
  pop() { // En kÃ¼Ã§Ã¼k elemanÄ± Ã§Ä±kar
    if (!this.data.length) return null; // BoÅŸsa null
    const top = this.data[0]; // KÃ¶kÃ¼ sakla
    const last = this.data.pop(); // Son elemanÄ± al
    if (this.data.length) { // HÃ¢lÃ¢ eleman varsa
      this.data[0] = last; // KÃ¶kÃ¼ son elemanla deÄŸiÅŸtir
      this.bubbleDown(0); // AÅŸaÄŸÄ± dÃ¼zelt
    }
    return top; // Eski kÃ¶kÃ¼ dÃ¶ndÃ¼r
  }
  size() { // Eleman sayÄ±sÄ±
    return this.data.length; // Uzunluk dÃ¶ndÃ¼r
  }
  bubbleUp(index) { // YukarÄ± taÅŸÄ±ma
    while (index > 0) { // KÃ¶k deÄŸilse
      const parent = Math.floor((index - 1) / 2); // Ebeveyn indeks
      if (this.compare(this.data[index], this.data[parent]) >= 0) break; // Yerinde ise Ã§Ä±k
      [this.data[index], this.data[parent]] = [this.data[parent], this.data[index]]; // ElemanlarÄ± deÄŸiÅŸtir
      index = parent; // Ä°ndeksi ebeveyne ayarla
    }
  }
  bubbleDown(index) { // AÅŸaÄŸÄ± taÅŸÄ±ma
    const length = this.data.length; // Uzunluk Ã¶nbelleÄŸi
    while (true) { // DÃ¶ngÃ¼
      let smallest = index; // En kÃ¼Ã§Ã¼k baÅŸlangÄ±Ã§
      const left = 2 * index + 1; // Sol Ã§ocuk
      const right = left + 1; // SaÄŸ Ã§ocuk
      if (left < length && this.compare(this.data[left], this.data[smallest]) < 0) smallest = left; // Sol daha kÃ¼Ã§Ã¼kse
      if (right < length && this.compare(this.data[right], this.data[smallest]) < 0) smallest = right; // SaÄŸ daha kÃ¼Ã§Ã¼kse
      if (smallest === index) break; // Yerinde ise Ã§Ä±k
      [this.data[index], this.data[smallest]] = [this.data[smallest], this.data[index]]; // ElemanlarÄ± deÄŸiÅŸtir
      index = smallest; // Ä°ndeksi gÃ¼ncelle
    }
  }
}

// SimÃ¼lasyon motoru //
class SimulationEngine { // Motor sÄ±nÄ±fÄ±
  constructor(stations, options, viz) { // Kurucu
    this.stations = stations; // Ä°stasyon modelleri
    this.options = options; // SeÃ§enekler
    this.viz = viz; // GÃ¶rselleÅŸtirme referansÄ±
    this.onLiveUpdate = null; // CanlÄ± snapshot geri Ã§aÄŸrÄ±sÄ±
    this.reset(); // BaÅŸlangÄ±Ã§ sÄ±fÄ±rlama
  }
  reset() { // TÃ¼m durum sÄ±fÄ±rlama
    this.currentTime = 0; // MantÄ±ksal zaman
    this.eventQueue = new MinHeap(this.compareEvents); // Olay Ã¶ncelik kuyruÄŸu
    this.nextJobId = 1; // Yeni iÅŸ kimliÄŸi
    this.running = false; // Ã‡alÄ±ÅŸma bayraÄŸÄ±
    this.completedJobs = []; // Tamamlanan iÅŸler
    this.runtimeStations = this.stations.map(station => ({ // Ã‡alÄ±ÅŸma zamanlÄ± istasyon durumlarÄ±
      station, // Referans
      queue: new FastQueue(), // Kuyruk iÅŸ kimlikleri
      servers: Array.from({ length: station.parallelServers }, () => null), // Sunucular
      queueLength: 0, // AnlÄ±k kuyruk uzunluÄŸu
      lastQueueUpdate: 0, // Son gÃ¼ncelleme zamanÄ±
      queueArea: 0, // Kuyruk uzunluÄŸu integrali
      busyCount: 0, // AnlÄ±k meÅŸgul sunucu adedi
      lastBusyUpdate: 0, // Son meÅŸgul gÃ¼ncellemesi
      busyArea: 0, // MeÅŸgul integrali
      totalWaitTime: 0, // Toplam bekleme sÃ¼resi
      serviceTimeAccum: 0, // Toplam servis sÃ¼resi
      serviceCount: 0 // Toplam servis adedi
    }));
    this.jobs = new Map(); // Ä°ÅŸ nesneleri haritasÄ±
    this.wipCount = 0; // AnlÄ±k WIP
    this.wipArea = 0; // WIP integrali
    this.lastWipUpdate = 0; // Son WIP gÃ¼ncellemesi
    this.lastEventTime = 0; // Son iÅŸlem zamanÄ±
    this.engineCursor = 0; // MantÄ±ksal hedef zaman
    this.pendingStop = false; // Durdurma isteÄŸi
    this.viz.clearJobs(); // GÃ¶rsel baloncuklarÄ± temizle
  }
  compareEvents = (a, b) => (a.time - b.time) || ((a.order || 0) - (b.order || 0)); // Olay karÅŸÄ±laÅŸtÄ±rÄ±cÄ±sÄ±
  schedule(event) { // OlayÄ± kuyruÄŸa ekle
    this.eventQueue.push(event); // KuyruÄŸa ekle
  }
  spawnJob(atTime) { // Yeni iÅŸ oluÅŸturma
    const jobId = this.nextJobId++; // Kimlik Ã¼ret
    const job = { // Ä°ÅŸ nesnesi
      id: jobId, // Kimlik
      stage: 0, // Åu anki istasyon
      enterTime: atTime, // Sisteme giriÅŸ zamanÄ±
      exitTime: null, // Ã‡Ä±kÄ±ÅŸ zamanÄ±
      history: [] // AÅŸamalar geÃ§miÅŸi
    };
    this.jobs.set(jobId, job); // Haritaya ekle
    this.updateWip(this.wipCount + 1, atTime); // WIP artÄ±r
    this.schedule({ type: 'arrival', jobId, stationIndex: 0, time: atTime, order: 0 }); // Ä°lk istasyona varÄ±ÅŸ planla
    this.viz.ensureJob(jobId); // GÃ¶rsel balon hazÄ±rla
    console.debug(`[Motor] Ä°ÅŸ ${jobId} oluÅŸturuldu, zaman ${atTime.toFixed(2)}`); // OluÅŸturma logu
  }
  start() { // SimÃ¼lasyonu baÅŸlat
    if (this.running) return; // Zaten Ã§alÄ±ÅŸÄ±yorsa Ã§Ä±k
    this.running = true; // BayraÄŸÄ± iÅŸaretle
    this.engineCursor = this.currentTime; // ZamanÄ± hizala
    if (this.currentTime === 0) { // Ä°lk baÅŸlangÄ±Ã§ mÄ±
      if (this.options.entryPolicy === 'interval') { // Sabit aralÄ±k ise
        const interval = Math.max(1, this.options.entryInterval); // GÃ¼venli aralÄ±k
        const limit = this.options.targetCount ? this.options.targetCount : 1000; // GÃ¼venli sÄ±nÄ±r
        for (let t = 0; t < limit; t++) { // DÃ¶ngÃ¼
          const spawnTime = t * interval; // VarÄ±ÅŸ zamanÄ±
          this.schedule({ type: 'spawn', time: spawnTime, order: -1, index: t }); // Spawn olayÄ±
        }
      } else { // Tetiklemeli giriÅŸ
        this.schedule({ type: 'spawn', time: 0, order: -1, index: 0 }); // Ä°lk Ã¼rÃ¼n
      }
    }
  }
  stop() { // SimÃ¼lasyonu durdur
    this.running = false; // BayraÄŸÄ± kapat
  }
  requestStop() { // Durdurma talebi
    this.pendingStop = true; // BayraÄŸÄ± ayarla
  }
  processUntil(targetTime) { // Belirli zamana kadar olay iÅŸle
    if (!this.running) return; // Ã‡alÄ±ÅŸmÄ±yorsa Ã§Ä±k
    this.engineCursor = targetTime; // Ä°leri hedefi gÃ¼ncelle
    let next = this.eventQueue.peek(); // SÄ±radaki olayÄ± al
    while (next && next.time <= this.engineCursor && this.running) { // Hedefe kadar dÃ¶ngÃ¼
      const event = this.eventQueue.pop(); // En erken olayÄ± Ã§Ä±kar
      this.currentTime = event.time; // MantÄ±ksal zamanÄ± gÃ¼ncelle
      this.handleEvent(event); // OlayÄ± iÅŸle
      if (this.pendingStop) { // Durdurma istekliyse
        this.stop(); // Durdur
        this.pendingStop = false; // BayraÄŸÄ± temizle
        break; // DÃ¶ngÃ¼yÃ¼ kÄ±r
      }
      next = this.eventQueue.peek(); // Sonraki olayÄ± hazÄ±rla
    }
  }
  peekNextEventTime() { // SÄ±radaki olay zamanÄ±nÄ± dÃ¶ndÃ¼r
    const next = this.eventQueue.peek(); // Tepe elemanÄ± al
    return next ? next.time : null; // Zaman veya null
  }
  handleEvent(event) { // Olay iÅŸleyici
    switch (event.type) { // TÃ¼r kontrolÃ¼
      case 'spawn': // Ä°ÅŸ oluÅŸturma
        this.handleSpawn(event); // Spawn iÅŸle
        break; // Ã‡Ä±k
      case 'arrival': // Ä°stasyona varÄ±ÅŸ
        this.handleArrival(event); // VarÄ±ÅŸÄ± iÅŸle
        break; // Ã‡Ä±k
      case 'serviceComplete': // Hizmet bitiÅŸi
        this.handleServiceCompletion(event); // TamamlamayÄ± iÅŸle
        break; // Ã‡Ä±k
    }
  }
  handleSpawn(event) { // Spawn iÅŸlemi
    if (this.options.targetCount && this.nextJobId > this.options.targetCount) return; // Hedef sÄ±nÄ±rÄ±
    this.spawnJob(event.time); // Yeni iÅŸ oluÅŸtur
    if (this.options.entryPolicy === 'interval') { // Sabit aralÄ±kta
      const nextIndex = (event.index || 0) + 1; // Sonraki indeks
      if (!this.options.targetCount || nextIndex < this.options.targetCount) { // Hedef kontrolÃ¼
        const interval = Math.max(1, this.options.entryInterval); // AralÄ±k
        const nextTime = nextIndex * interval; // Sonraki zaman
        this.schedule({ type: 'spawn', time: nextTime, order: -1, index: nextIndex }); // Yeni spawn planla
      }
    }
  }
  handleArrival(event) { // VarÄ±ÅŸ iÅŸlemleri
    const rt = this.runtimeStations[event.stationIndex]; // Ä°lgili istasyon runtime
    if (!rt) return; // GÃ¼venlik
    const job = this.jobs.get(event.jobId); // Ä°ÅŸ nesnesi
    if (!job) return; // GÃ¼venlik
    console.debug(`[Motor] Ä°ÅŸ ${job.id} ${rt.station.name} istasyonuna ${event.time.toFixed(2)} zamanÄ±nda geldi`); // VarÄ±ÅŸ logu
    job.stage = event.stationIndex; // Ä°stasyon kaydÄ±
    const arrivalRecord = { jobId: job.id, arrival: event.time }; // Kuyruk kaydÄ±
    rt.queue.enqueue(arrivalRecord); // KuyruÄŸa ekle
    this.updateQueue(rt, rt.queue.length, event.time); // Kuyruk artÄ±ÅŸÄ±
    this.viz.ensureJob(job.id); // Balon var mÄ± kontrol
    this.viz.tagJob(job.id, 'waiting'); // GÃ¶rsel durumu gÃ¼ncelle
    this.tryStartService(rt, event.stationIndex, event.time); // Servis kontrolÃ¼
    this.updateLayoutTargets(); // YerleÅŸimi gÃ¼ncelle
  }
  tryStartService(rt, stationIndex, time) { // Servise baÅŸlatma giriÅŸimi
    const serviceTime = rt.station.totalDuration(); // Servis sÃ¼resi
    if (serviceTime <= 0) return; // SÃ¼re yoksa Ã§Ä±k
    for (let i = 0; i < rt.servers.length; i++) { // Her sunucuyu dolaÅŸ
      if (rt.servers[i]) continue; // Doluysa geÃ§
      const queued = rt.queue.dequeue(); // FIFO ilk iÅŸ
      if (!queued) break; // Kuyruk boÅŸsa Ã§Ä±k
      this.updateQueue(rt, rt.queue.length, time); // KuyruÄŸu azalt
      const job = this.jobs.get(queued.jobId); // Ä°ÅŸ nesnesi
      if (!job) continue; // GÃ¼venlik
      const wait = time - queued.arrival; // Bekleme sÃ¼resi
      rt.totalWaitTime += wait; // Toplam bekleme artÄ±ÅŸÄ±
      job.history.push({ // TarihÃ§e kaydÄ±
        stationId: rt.station.id, // Ä°stasyon kimliÄŸi
        start: time, // BaÅŸlangÄ±Ã§
        wait, // Bekleme
        serviceTime // Servis sÃ¼resi
      });
      this.updateBusy(rt, rt.busyCount + 1, time); // MeÅŸgul artÄ±r
      const endTime = time + serviceTime; // BitiÅŸ zamanÄ±
      rt.servers[i] = { jobId: job.id, end: endTime, start: time }; // Sunucuya ata
      rt.serviceTimeAccum += serviceTime; // Servis sÃ¼re toplamÄ±
      rt.serviceCount += 1; // Servis sayÄ±sÄ±
      this.schedule({ type: 'serviceComplete', jobId: job.id, stationIndex, serverIndex: i, time: endTime, order: 1 }); // Hizmet bitiÅŸ planÄ±
      this.viz.tagJob(job.id, 'processing'); // GÃ¶rsel durum
      console.debug(`[Motor] Ä°ÅŸ ${job.id} ${rt.station.name} servisinde ${time.toFixed(2)}â†’${endTime.toFixed(2)} aralÄ±ÄŸÄ±nda Ã§alÄ±ÅŸÄ±yor`); // Servis baÅŸlangÄ±Ã§ logu
    }
  }
  handleServiceCompletion(event) { // Servis bitiÅŸ iÅŸlemi
    const rt = this.runtimeStations[event.stationIndex]; // Ä°stasyon runtime
    if (!rt) return; // GÃ¼venlik
    const server = rt.servers[event.serverIndex]; // Sunucu kaydÄ±
    if (!server || server.jobId !== event.jobId) return; // Kontrol
    this.updateBusy(rt, Math.max(0, rt.busyCount - 1), event.time); // MeÅŸgul azalt
    rt.servers[event.serverIndex] = null; // Sunucuyu boÅŸalt
    const job = this.jobs.get(event.jobId); // Ä°ÅŸ nesnesi
    if (!job) return; // GÃ¼venlik
    console.debug(`[Motor] Ä°ÅŸ ${event.jobId} ${rt.station.name} servisinden ${event.time.toFixed(2)} zamanÄ±nda ayrÄ±ldÄ±`); // Tamamlama logu
    if (event.stationIndex === this.stations.length - 1) { // Son istasyon mu
      job.exitTime = event.time; // Ã‡Ä±kÄ±ÅŸ zamanÄ± kaydet
      this.completedJobs.push(job); // Tamamlanan listesine ekle
      this.updateWip(this.wipCount - 1, event.time); // WIP azalt
      this.viz.tagJob(job.id, 'completed'); // GÃ¶rsel tamamlandÄ±
      this.viz.markForRemoval(job.id); // Balonu zamanla kaldÄ±r
      if (this.options.targetCount && this.completedJobs.length >= this.options.targetCount) { // Hedef tamam mÄ±
        this.requestStop(); // Durdurma iste
      }
    } else { // Ara istasyon
      const nextIndex = event.stationIndex + 1; // Sonraki istasyon
      this.schedule({ type: 'arrival', jobId: job.id, stationIndex: nextIndex, time: event.time, order: 0 }); // VarÄ±ÅŸÄ± planla
    }
    if (event.stationIndex === 0 && this.options.entryPolicy === 'trigger') { // Ä°lk istasyon tetikleyici mi
      if (!this.options.targetCount || this.nextJobId <= this.options.targetCount) { // Hedef kontrolÃ¼
        this.schedule({ type: 'spawn', time: event.time, order: -1 }); // Yeni iÅŸ tetikleme
      }
    }
    this.tryStartService(rt, event.stationIndex, event.time); // Kuyruktan yeni iÅŸ al
    this.updateLayoutTargets(); // YerleÅŸim gÃ¼ncelle
  }
  updateQueue(rt, newLength, time) { // Kuyruk metriÄŸi gÃ¼ncelle
    rt.queueArea += rt.queueLength * (time - rt.lastQueueUpdate); // Alan artÄ±ÅŸÄ±
    rt.queueLength = Math.max(0, newLength); // Yeni deÄŸer
    rt.lastQueueUpdate = time; // Zaman kaydÄ±
  }
  updateBusy(rt, newBusy, time) { // MeÅŸgul metriÄŸi gÃ¼ncelle
    rt.busyArea += rt.busyCount * (time - rt.lastBusyUpdate); // Alan artÄ±ÅŸÄ±
    rt.busyCount = Math.max(0, Math.min(newBusy, rt.servers.length)); // Yeni deÄŸer
    rt.lastBusyUpdate = time; // Zaman kaydÄ±
  }
  updateWip(newWip, time) { // WIP gÃ¼ncellemesi
    this.wipArea += this.wipCount * (time - this.lastWipUpdate); // Alan artÄ±ÅŸÄ±
    this.wipCount = Math.max(0, newWip); // Yeni deÄŸer
    this.lastWipUpdate = time; // Zaman kaydÄ±
  }
  updateLayoutTargets(timeCursor = this.currentTime) { // GÃ¶rsel yerleÅŸimi tetikle
    const renderTime = Math.max(timeCursor, this.currentTime); // GÃ¶sterim zamanÄ±
    const elapsed = Math.max(renderTime, 0.0001); // GeÃ§en sÃ¼re
    const layout = this.runtimeStations.map(rt => { // Her istasyon iÃ§in durum
      const queueEntries = rt.queue.peekAll(); // Kuyruktaki iÅŸler
      const servers = rt.servers.map(server => { // SunucularÄ± gez
        if (!server) return null; // BoÅŸsa null
        const duration = Math.max(0.0001, server.end - server.start); // SÃ¼re
        const remaining = Math.max(0, server.end - renderTime); // Kalan sÃ¼re
        const progress = Math.min(1, Math.max(0, (renderTime - server.start) / duration)); // Ä°lerleme
        return { // Sunucu verisi
          jobId: server.jobId, // Ä°ÅŸ kimliÄŸi
          start: server.start, // BaÅŸlangÄ±Ã§ zamanÄ±
          end: server.end, // BitiÅŸ zamanÄ±
          duration, // SÃ¼re
          remaining, // Kalan sÃ¼re
          progress // Ä°lerleme oranÄ±
        };
      });
      const busyCount = servers.filter(server => !!server).length; // AnlÄ±k meÅŸgul sayÄ±sÄ±
      const queueLength = queueEntries.length; // AnlÄ±k kuyruk uzunluÄŸu
      const avgQueue = (rt.queueArea + queueLength * (renderTime - rt.lastQueueUpdate)) / elapsed; // Ortalama kuyruk
      const capacity = Math.max(1, rt.servers.length); // Kapasite
      const rawUtil = (rt.busyArea + rt.busyCount * (renderTime - rt.lastBusyUpdate)) / (elapsed * capacity); // Ham util
      const avgUtil = Math.min(1, Math.max(0, rawUtil)); // SÄ±nÄ±rlandÄ±rÄ±lmÄ±ÅŸ util
      return { // YerleÅŸim verisi
        stationId: rt.station.id, // Kimlik
        stationName: rt.station.name, // Ä°stasyon adÄ±
        queue: queueEntries.map(entry => ({ jobId: entry.jobId, arrival: entry.arrival })), // Kuyruk iÅŸ listesi
        servers, // Sunucu iÅŸ listesi
        metrics: { // CanlÄ± metrikler
          queueLength, // AnlÄ±k kuyruk
          busyCount, // AnlÄ±k meÅŸgul sayÄ±sÄ±
          capacity, // Kapasite
          avgQueue, // Ortalama kuyruk
          avgUtil // Ortalama util
        }
      };
    });
    if (this.viz) this.viz.applyLayout(layout, renderTime); // Viz'e gÃ¶nder
    const snapshot = { // AnlÄ±k durum
      time: renderTime, // GÃ¶sterim zamanÄ±
      completedCount: this.completedJobs.length, // Tamamlanan adet
      wip: this.wipCount, // AnlÄ±k WIP
      layout // YerleÅŸim verisi
    };
    if (typeof this.onLiveUpdate === 'function') this.onLiveUpdate(snapshot); // Callback Ã§aÄŸÄ±r
    return snapshot; // Snapshot dÃ¶ndÃ¼r
  }
  buildReport() { // Rapor verisini hazÄ±rla
    this.runtimeStations.forEach(rt => { // Nihai alan gÃ¼ncellemesi
      this.updateQueue(rt, rt.queueLength, this.currentTime); // Kuyruk alanÄ±nÄ± gÃ¼ncelle
      this.updateBusy(rt, rt.busyCount, this.currentTime); // MeÅŸgul alanÄ±nÄ± gÃ¼ncelle
    });
    this.updateWip(this.wipCount, this.currentTime); // WIP alanÄ±nÄ± gÃ¼ncelle
    const totalCompleted = this.completedJobs.length; // Tamamlanan adet
    const horizon = this.currentTime || 1; // Toplam mantÄ±ksal sÃ¼re
    const cycleTimes = this.completedJobs.map(job => job.exitTime - job.enterTime); // Ã‡evrim sÃ¼releri
    const avgCycle = cycleTimes.length ? cycleTimes.reduce((a, b) => a + b, 0) / cycleTimes.length : 0; // Ortalama Ã§evrim
    const throughputPerSec = horizon ? totalCompleted / horizon : 0; // ÃœrÃ¼n/sn
    const throughputPerMin = throughputPerSec * 60; // ÃœrÃ¼n/dk
    const avgWip = this.wipArea / horizon; // Ortalama WIP
    const stationRows = this.runtimeStations.map(rt => { // Ä°stasyon raporu
      const util = horizon ? (rt.busyArea / (horizon * (rt.servers.length || 1))) : 0; // Utilizasyon
      const avgQ = horizon ? (rt.queueArea / horizon) : 0; // Ortalama kuyruk
      const wait = rt.serviceCount ? (rt.totalWaitTime / rt.serviceCount) : 0; // Ortalama bekleme
      const serviceTime = rt.station.totalDuration(); // Tek iÅŸ servis sÃ¼resi
      const capacityPerSec = serviceTime > 0 ? rt.station.parallelServers / serviceTime : 0; // Teorik kapasite
      return { // SatÄ±r nesnesi
        stationId: rt.station.id, // Kimlik
        stationName: rt.station.name, // Ä°sim
        parallelServers: rt.station.parallelServers, // Paralel sayÄ±sÄ±
        utilization: util, // Utilizasyon
        avgQueue: avgQ, // Kuyruk
        avgWait: wait, // Bekleme
        serviceTime, // Servis sÃ¼resi
        capacityPerSec, // Kapasite
        serviceCount: rt.serviceCount // Tamamlanan iÅŸ adedi
      };
    });
    const bottleneckUtil = stationRows.reduce((max, row) => (!max || row.utilization > max.utilization ? row : max), null); // Util darboÄŸazÄ±
    const bottleneckService = stationRows.reduce((max, row) => (!max || row.serviceTime > max.serviceTime ? row : max), null); // Servis darboÄŸazÄ±
    const completionSeries = this.completedJobs // Tamamlanan zaman serisi
      .slice() // Kopya al
      .sort((a, b) => a.exitTime - b.exitTime) // Zaman sÄ±ralamasÄ±
      .map((job, index) => ({ time: job.exitTime, count: index + 1 })); // KÃ¼mÃ¼latif nokta
    return { // Rapor objesi
      totalCompleted, // Tamamlanan
      horizon, // SimÃ¼lasyon sÃ¼resi
      avgCycle, // Ã‡evrim zamanÄ±
      throughputPerSec, // ÃœrÃ¼n/sn
      throughputPerMin, // ÃœrÃ¼n/dk
      avgWip, // Ortalama WIP
      stationRows, // Ä°stasyon satÄ±rlarÄ±
      bottleneckUtil, // Util darboÄŸazÄ±
      bottleneckService, // Servis darboÄŸazÄ±
      completionSeries // Tamamlanma serisi
    };
  }
}

// GÃ¶rselleÅŸtirme sÄ±nÄ±fÄ± //
class Visualization { // GÃ¶rsel katman
  constructor(svg) { // Kurucu
    this.svg = svg; // SVG referansÄ±
    this.jobs = new Map(); // Baloncuk haritasÄ±
    this.stationLayout = []; // Ä°stasyon yerleÅŸimi
    this.metricGroup = null; // Metrik yazÄ±larÄ± grubu
    this.speed = 1; // Animasyon hÄ±zÄ±
    this.zoom = 1; // Zoom Ã¶lÃ§eÄŸi
    this.resizeObserver = new ResizeObserver(() => this.drawStations()); // Yeniden Ã§izim dinleyicisi
    this.resizeObserver.observe(svg.parentElement); // Paneli izle
    this.frame = this.frame.bind(this); // Animasyon baÄŸla
    this.setZoom(this.zoom); // BaÅŸlangÄ±Ã§ Ã¶lÃ§eÄŸini uygula
    requestAnimationFrame(this.frame); // DÃ¶ngÃ¼yÃ¼ baÅŸlat
  }
  clearJobs() { // BaloncuklarÄ± temizle
    this.jobs.forEach(node => node.circle.remove()); // TÃ¼m daireleri kaldÄ±r
    this.jobs.clear(); // HaritayÄ± boÅŸalt
  }
  ensureJob(jobId) { // Balon var mÄ± kontrol et
    if (this.jobs.has(jobId)) return; // Varsa Ã§Ä±k
    const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle'); // Yeni daire
    circle.classList.add('job-bubble'); // SÄ±nÄ±f ekle
    circle.setAttribute('r', 12); // YarÄ±Ã§ap
    circle.setAttribute('cx', 0); // X
    circle.setAttribute('cy', 0); // Y
    this.svg.appendChild(circle); // SVG'ye ekle
    this.jobs.set(jobId, { circle, targetX: 0, targetY: 0, x: 0, y: 0, startX: 0, startY: 0, startTime: performance.now(), duration: MOVE_DURATION_MS, removeAt: null }); // Kaydet
  }
  tagJob(jobId, state) { // GÃ¶rsel durum etiketle
    const node = this.jobs.get(jobId); // Balon al
    if (!node) return; // Yoksa Ã§Ä±k
    node.circle.classList.remove('waiting', 'processing', 'completed'); // SÄ±nÄ±flarÄ± temizle
    node.circle.classList.add(state); // Yeni sÄ±nÄ±f ekle
  }
  markForRemoval(jobId) { // Balonu kaldÄ±rmaya hazÄ±rla
    const node = this.jobs.get(jobId); // Balon al
    if (!node) return; // Yoksa Ã§Ä±k
    node.removeAt = performance.now() + MOVE_DURATION_MS / this.speed; // KaldÄ±rma zamanÄ±nÄ± ayarla
  }
  removeJob(jobId) { // Balonu kaldÄ±r
    const node = this.jobs.get(jobId); // Balon al
    if (!node) return; // Yoksa Ã§Ä±k
    node.circle.remove(); // SVG'den sil
    this.jobs.delete(jobId); // Haritadan Ã§Ä±kar
  }
  setSpeed(speed) { // HÄ±zÄ± gÃ¼ncelle
    this.speed = speed; // HÄ±z ata
  }
  setZoom(scale) { // Zoom deÄŸerini gÃ¼ncelle
    this.zoom = scale; // Ã–lÃ§eÄŸi sakla
    this.svg.style.transform = `scale(${scale})`; // CSS Ã¶lÃ§eÄŸini uygula
  }
  setStations(stations) { // Ä°stasyon yerleÅŸimini gÃ¼ncelle
    this.stationLayout = stations.map((station, index) => ({ station, index })); // YerleÅŸim kaydÄ±
    this.drawStations(); // SVG'yi yeniden Ã§iz
  }
  drawStations() { // Ä°stasyon kutularÄ±nÄ± Ã§iz
    while (this.svg.firstChild) this.svg.removeChild(this.svg.firstChild); // Eski Ã¶ÄŸeleri temizle
    const width = this.svg.clientWidth || this.svg.parentElement.clientWidth; // GeniÅŸlik
    const height = this.svg.clientHeight || 360; // YÃ¼kseklik
    const count = this.stationLayout.length; // Ä°stasyon sayÄ±sÄ±
    const gap = 80; // AralÄ±k
    const stationWidth = Math.min(160, (width - gap * (count + 1)) / Math.max(1, count)); // Kutu geniÅŸliÄŸi
    const startX = (width - (stationWidth * count + gap * (count - 1))) / 2; // BaÅŸlangÄ±Ã§ X
    const baseY = height / 2; // Orta Y
    const stationsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Grup oluÅŸtur
    const arrowsGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Ok grubu
    this.svg.appendChild(arrowsGroup); // Ã–nce ok grubu
    this.svg.appendChild(stationsGroup); // Sonra kutular
    this.stationLayout.forEach((layout, idx) => { // Her istasyon iÃ§in
      const x = startX + idx * (stationWidth + gap); // X koordinatÄ±
      const y = baseY - 60; // Y koordinatÄ±
      layout.x = x; // Kaydet
      layout.y = y; // Kaydet
      layout.width = stationWidth; // GeniÅŸlik kaydÄ±
      const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect'); // DikdÃ¶rtgen
      rect.setAttribute('x', x); // X ayarÄ±
      rect.setAttribute('y', y); // Y ayarÄ±
      rect.setAttribute('width', stationWidth); // GeniÅŸlik
      rect.setAttribute('height', 140); // YÃ¼kseklik
      rect.setAttribute('rx', 22); // KÃ¶ÅŸe
      rect.classList.add('station-shape'); // SÄ±nÄ±f ekle
      stationsGroup.appendChild(rect); // SVG'ye ekle
      layout.rect = rect; // ReferansÄ± sakla
      const label = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Etiket
      label.classList.add('station-label'); // SÄ±nÄ±f
      label.setAttribute('x', x + stationWidth / 2); // X
      label.setAttribute('y', y + 24); // Y
      label.setAttribute('text-anchor', 'middle'); // Ortala
      label.textContent = this.stationLayout[idx].station.name || `S${idx + 1}`; // Metin
      stationsGroup.appendChild(label); // SVG'ye ekle
      if (idx < this.stationLayout.length - 1) { // Son deÄŸilse ok Ã§iz
        const arrow = document.createElementNS('http://www.w3.org/2000/svg', 'path'); // Ok
        const startArrowX = x + stationWidth; // BaÅŸlangÄ±Ã§ X
        const startArrowY = y + 70; // BaÅŸlangÄ±Ã§ Y
        const endArrowX = startX + (idx + 1) * (stationWidth + gap); // BitiÅŸ X
        const endArrowY = startArrowY; // BitiÅŸ Y
        const mid = (startArrowX + endArrowX) / 2; // Orta nokta
        arrow.setAttribute('d', `M ${startArrowX} ${startArrowY} Q ${mid} ${startArrowY - 40} ${endArrowX} ${endArrowY}`); // EÄŸri Ã§iz
        arrow.setAttribute('stroke', 'rgba(255,255,255,0.18)'); // Kenar rengi
        arrow.setAttribute('fill', 'none'); // Dolgu yok
        arrow.setAttribute('stroke-width', 4); // KalÄ±nlÄ±k
        const arrowHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon'); // Ok baÅŸÄ±
        arrowHead.setAttribute('points', `${endArrowX - 10},${endArrowY - 6} ${endArrowX},${endArrowY} ${endArrowX - 10},${endArrowY + 6}`); // Noktalar
        arrowHead.setAttribute('fill', 'rgba(255,255,255,0.18)'); // Dolgu
        arrowsGroup.appendChild(arrow); // Ok ekle
        arrowsGroup.appendChild(arrowHead); // Ok baÅŸÄ± ekle
      }
    });
    this.metricGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g'); // Metrik grubu
    this.svg.appendChild(this.metricGroup); // SVG'ye ekle
    this.jobs.forEach(node => this.svg.appendChild(node.circle)); // BaloncuklarÄ± Ã¼ste taÅŸÄ±
  }
  applyLayout(layout, timeCursor = 0) { // YerleÅŸim verisini uygula
    this.jobs.forEach((node, jobId) => { // Her iÅŸ iÃ§in
      let target = null; // Hedef koordinat
      layout.forEach((item, idx) => { // Ä°stasyonlarÄ± dolaÅŸ
        const queueIndex = item.queue.findIndex(entry => entry.jobId === jobId); // Kuyrukta mÄ±
        if (queueIndex !== -1) { // Kuyrukta ise
          target = this.queuePosition(idx, queueIndex); // Hedef koordinat
        }
        const serverIndex = item.servers.findIndex(server => server && server.jobId === jobId); // Sunucuda mÄ±
        if (serverIndex !== -1) { // Sunucuda ise
          target = this.serverPosition(idx, serverIndex, item.servers.length); // Hedef koordinat
        }
      });
      if (!target) { // Hedef yoksa
        const lastLayout = this.stationLayout[this.stationLayout.length - 1]; // Son istasyon
        target = { x: lastLayout ? lastLayout.x + lastLayout.width + 60 : 40, y: 40 }; // Ã‡Ä±kÄ±ÅŸ bÃ¶lgesi
      }
      this.moveNode(jobId, target.x, target.y); // Hareket uygula
    });
    this.renderMetrics(layout, timeCursor); // Metrikleri Ã§iz
  }
  queuePosition(stationIdx, queueIdx) { // Kuyruk pozisyonu hesapla
    const layout = this.stationLayout[stationIdx]; // Ä°stasyon yerleÅŸimi
    const x = layout.x + layout.width / 2; // Merkez X
    const y = layout.y - 20 - queueIdx * 28; // YukarÄ± doÄŸru istif
    return { x, y }; // Koordinat dÃ¶ndÃ¼r
  }
  serverPosition(stationIdx, serverIdx, totalServers) { // Sunucu pozisyonu hesapla
    const layout = this.stationLayout[stationIdx]; // Ä°stasyon yerleÅŸimi
    const spacing = layout.width / (totalServers + 1); // AralÄ±k
    const x = layout.x + spacing * (serverIdx + 1); // X koordinatÄ±
    const y = layout.y + 70; // Y koordinatÄ±
    return { x, y }; // Koordinat dÃ¶ndÃ¼r
  }
  moveNode(jobId, targetX, targetY) { // Balonu hedefe taÅŸÄ±
    const node = this.jobs.get(jobId); // Balon al
    if (!node) return; // Yoksa Ã§Ä±k
    node.startX = node.x; // BaÅŸlangÄ±Ã§ X
    node.startY = node.y; // BaÅŸlangÄ±Ã§ Y
    node.targetX = targetX; // Hedef X
    node.targetY = targetY; // Hedef Y
    node.startTime = performance.now(); // BaÅŸlangÄ±Ã§ zamanÄ±
    node.duration = MOVE_DURATION_MS / this.speed; // SÃ¼re hÄ±zla Ã¶lÃ§eklenir
    node.removeAt = null; // KaldÄ±rma zamanÄ±nÄ± temizle
  }
  renderMetrics(layout, timeCursor) { // Metrikleri Ã§iz
    if (!this.metricGroup) return; // Grup yoksa Ã§Ä±k
    while (this.metricGroup.firstChild) this.metricGroup.removeChild(this.metricGroup.firstChild); // Eski metrikleri temizle
    layout.forEach((item, idx) => { // Her istasyon iÃ§in
      const layoutInfo = this.stationLayout[idx]; // YerleÅŸim bilgisi
      const queueText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Kuyruk metni
      queueText.classList.add('metric-tag'); // SÄ±nÄ±f ekle
      queueText.setAttribute('x', layoutInfo.x + layoutInfo.width / 2); // X
      queueText.setAttribute('y', layoutInfo.y + 110); // Y
      queueText.setAttribute('text-anchor', 'middle'); // Ortala
      const utilPercent = item.metrics.avgUtil * 100; // Ortalama util hesapla
      queueText.textContent = `Kuyruk: ${item.metrics.queueLength} Â· Ort:${item.metrics.avgQueue.toFixed(1)}`; // Metin
      const danger = item.metrics.avgQueue > 1.5 || item.metrics.avgUtil > 0.85; // Tehlike eÅŸiÄŸi
      if (danger) { // Kuyruk veya util yÃ¼ksekse
        queueText.classList.add('danger'); // Kuyruk uyarÄ± sÄ±nÄ±fÄ±
        if (layoutInfo.rect) layoutInfo.rect.classList.add('bottleneck'); // Kutuya vurgu
      } else if (layoutInfo.rect) {
        layoutInfo.rect.classList.remove('bottleneck'); // Vurguyu kaldÄ±r
      }
      this.metricGroup.appendChild(queueText); // SVG'ye ekle
      const serviceText = document.createElementNS('http://www.w3.org/2000/svg', 'text'); // Servis metni
      serviceText.classList.add('metric-tag'); // SÄ±nÄ±f ekle
      serviceText.setAttribute('x', layoutInfo.x + layoutInfo.width / 2); // X
      serviceText.setAttribute('y', layoutInfo.y + 126); // Y
      serviceText.setAttribute('text-anchor', 'middle'); // Ortala
      const activeServers = item.servers.filter(server => !!server); // Aktif sunucular
      if (activeServers.length) { // Serviste iÅŸ varsa
        const avgProgress = activeServers.reduce((sum, server) => sum + server.progress, 0) / activeServers.length; // Ortalama ilerleme
        const maxRemaining = Math.max(...activeServers.map(server => server.remaining)); // Maks kalan sÃ¼re
        serviceText.textContent = `Servis: ${item.metrics.busyCount}/${item.metrics.capacity} Â· %${(avgProgress * 100).toFixed(0)} Â· kalan ${maxRemaining.toFixed(1)}sn`; // Servis metni
      } else {
        serviceText.textContent = 'Servis: boÅŸ'; // Servis yok metni
      }
      if (danger) serviceText.classList.add('danger'); // Servis uyarÄ±sÄ±
      this.metricGroup.appendChild(serviceText); // Servis metnini ekle
    });
  }
  frame(timestamp) { // Animasyon dÃ¶ngÃ¼sÃ¼
    const removal = []; // Silinecekler listesi
    this.jobs.forEach((node, jobId) => { // Her balon iÃ§in
      const progress = Math.min(1, (timestamp - node.startTime) / Math.max(1, node.duration)); // Ä°lerleme
      const eased = progress < 1 ? (1 - Math.pow(1 - progress, 3)) : 1; // Easing hesabÄ±
      node.x = node.startX + (node.targetX - node.startX) * eased; // X interpolasyonu
      node.y = node.startY + (node.targetY - node.startY) * eased; // Y interpolasyonu
      node.circle.setAttribute('cx', node.x); // SVG X gÃ¼ncelle
      node.circle.setAttribute('cy', node.y); // SVG Y gÃ¼ncelle
      if (node.removeAt && timestamp >= node.removeAt) { // KaldÄ±rma zamanÄ± mÄ±
        removal.push(jobId); // Listeye ekle
      }
    });
    removal.forEach(jobId => this.removeJob(jobId)); // BalonlarÄ± sil
    requestAnimationFrame(this.frame); // Sonraki kare
  }
}

// UI yardÄ±mcÄ±larÄ± //
const stationListEl = document.getElementById('stationList'); // Ä°stasyon liste alanÄ±
const emptyStateEl = document.getElementById('emptyState'); // BoÅŸ durum mesajÄ±
const addStationBtn = document.getElementById('addStationBtn'); // Ä°stasyon ekleme butonu
const startBtn = document.getElementById('startBtn'); // BaÅŸlat butonu
const stopBtn = document.getElementById('stopBtn'); // Durdur butonu
const resetBtn = document.getElementById('resetBtn'); // SÄ±fÄ±rla butonu
const sampleBtn = document.getElementById('sampleSetupBtn'); // Ã–rnek kurulum butonu
const analysisBtn = document.getElementById('analysisBtn'); // Analiz butonu
const speedSlider = document.getElementById('speedSlider'); // HÄ±z slider
const speedValue = document.getElementById('speedValue'); // HÄ±z deÄŸeri
const targetInput = document.getElementById('targetInput'); // Hedef giriÅŸi
const entryPolicySelect = document.getElementById('entryPolicySelect'); // GiriÅŸ politikasÄ± seÃ§imi
const entryIntervalInput = document.getElementById('entryIntervalInput'); // AralÄ±k giriÅŸi
const taktInput = document.getElementById('taktInput'); // Takt time giriÅŸi
const zoomOutBtn = document.getElementById('zoomOutBtn'); // Zoom kÃ¼Ã§Ã¼lt butonu
const zoomInBtn = document.getElementById('zoomInBtn'); // Zoom bÃ¼yÃ¼t butonu
const zoomResetBtn = document.getElementById('zoomResetBtn'); // Zoom sÄ±fÄ±rlama butonu
const zoomValueEl = document.getElementById('zoomValue'); // Zoom metni
const visualPanel = document.getElementById('visualPanel'); // GÃ¶rsel panel kapsayÄ±cÄ±
const fullscreenBtn = document.getElementById('fullscreenBtn'); // Tam ekran butonu
const fullscreenLabel = fullscreenBtn ? fullscreenBtn.querySelector('span') : null; // Tam ekran etiket metni
const resultsBtn = document.getElementById('resultsBtn'); // SonuÃ§ aÃ§ma butonu
const reportModal = document.getElementById('reportModal'); // Rapor modalÄ±
const closeReportBtn = document.getElementById('closeReportBtn'); // Modal kapatma butonu
const downloadCsvBtn = document.getElementById('downloadCsvBtn'); // CSV butonu
const downloadPdfBtn = document.getElementById('downloadPdfBtn'); // PDF butonu
const cardCycleEl = document.getElementById('cardCycle'); // Cycle kartÄ± metni
const cardCompletedEl = document.getElementById('cardCompleted'); // Tamamlanan kart metni
const cardThroughputEl = document.getElementById('cardThroughput'); // Throughput kart metni
const cardWipEl = document.getElementById('cardWip'); // WIP kart metni
const stationPerformanceBody = document.getElementById('stationPerformanceBody'); // Ä°stasyon tablo gÃ¶vdesi
const bottleneckTableBody = document.getElementById('bottleneckTableBody'); // DarboÄŸaz tablo gÃ¶vdesi
const queueChartCanvas = document.getElementById('queueChart'); // Kuyruk grafiÄŸi canvasÄ±
const throughputChartCanvas = document.getElementById('throughputChart'); // Throughput grafiÄŸi canvasÄ±
const dashboardAnalysisText = document.getElementById('dashboardAnalysisText'); // Dashboard analiz metni
const dashboardAnalysisList = document.getElementById('dashboardAnalysisList'); // Dashboard analiz listesi
const completedCounterEl = document.getElementById('completedCounter'); // Tamamlanan sayaÃ§ etiketi
const analysisModal = document.getElementById('analysisModal'); // Analiz modalÄ±
const closeAnalysisBtn = document.getElementById('closeAnalysisBtn'); // Analiz kapanÄ±ÅŸ butonu
const analysisRecalcBtn = document.getElementById('analysisRecalcBtn'); // Analiz hesaplama butonu
const analysisTableBody = document.getElementById('analysisTableBody'); // Analiz tablo gÃ¶vdesi
const analysisText = document.querySelector('#analysisInsights .analysis-text'); // Analiz yorum metni
const analysisList = document.querySelector('#analysisWhatIf .analysis-list'); // What-if listesi
let latestReport = null; // Son oluÅŸturulan rapor referansÄ±
let scheduledChartFrame = 0; // requestAnimationFrame kimliÄŸi

updateFullscreenLabel(); // BaÅŸlangÄ±Ã§ta tam ekran etiketi hizala

const viz = new Visualization(document.getElementById('lineSvg')); // GÃ¶rselleÅŸtirme Ã¶rneÄŸi
const stationRuntimeRefs = new Map(); // CanlÄ± metrik referans haritasÄ±

function renderGraph(stations) { // AkÄ±ÅŸ grafiÄŸini Ã§iz
  viz.setStations(stations); // GÃ¶rselleÅŸtirme modelini gÃ¼ncelle
}

function updateZoomDisplay() { // Zoom metnini gÃ¼ncelle
  if (zoomValueEl) zoomValueEl.textContent = `${Math.round(appState.zoom * 100)}%`; // YÃ¼zdelik gÃ¶ster
  if (zoomResetBtn) zoomResetBtn.title = `Ã–lÃ§eÄŸi ${Math.round(appState.zoom * 100)}% durumundan 100% yap`; // Ä°pucu gÃ¼ncelle
  viz.setZoom(appState.zoom); // GÃ¶rsel Ã¶lÃ§eÄŸi uygula
}

function adjustZoom(delta) { // Zoom deÄŸerini deÄŸiÅŸtir
  const next = Math.max(0.5, Math.min(2.5, parseFloat((appState.zoom + delta).toFixed(2)))); // SÄ±nÄ±rla ve yuvarla
  appState.zoom = next; // Duruma yaz
  updateZoomDisplay(); // GÃ¶rseli gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function resetZoom() { // Zoom'u sÄ±fÄ±rla
  appState.zoom = 1; // VarsayÄ±lan Ã¶lÃ§ek
  updateZoomDisplay(); // GÃ¶rseli gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function cloneStationsForRun() { // SimÃ¼lasyon iÃ§in istasyon kopyala
  return appState.stations.map(source => { // Her istasyon iÃ§in
    const clone = new Station(source.id, source.name); // Yeni istasyon oluÅŸtur
    clone.parallelServers = source.parallelServers; // Paralel sunucularÄ± aktar
    clone.tasks = source.tasks.map(task => new Task(task.name, task.operators, task.durationSec)); // GÃ¶revleri kopyala
    return clone; // Sonucu dÃ¶ndÃ¼r
  });
}

function addStation(name = null) { // Ä°stasyon ekleme fonksiyonu
  const stationNumber = appState.nextStationId++; // ArdÄ±ÅŸÄ±k numarayÄ± al
  const stationId = `station-${stationNumber}`; // KimliÄŸi Ã¼ret
  const stationName = name ? String(name) : `Ä°stasyon ${stationNumber}`; // Ä°smi belirle
  const station = new Station(stationId, stationName); // Yeni istasyon nesnesi
  station.parallelServers = 1; // VarsayÄ±lan kapasite
  station.tasks = []; // GÃ¶revleri boÅŸ baÅŸlat
  appState.stations.push(station); // Listeye ekle
  if (!renderingPaused) { // Yeniden Ã§izim aÃ§Ä±ksa
    renderStations(); // Kart listesini gÃ¼ncelle
    renderGraph(appState.stations); // AkÄ±ÅŸ diyagramÄ±nÄ± tazele
    saveState(appState); // Durumu kaydet
  }
  console.info('Station added:', station); // Konsola bilgi dÃ¼ÅŸ
  return station; // Yeni istasyonu dÃ¶ndÃ¼r
}

function onAddStationClick(event) { // Ä°stasyon ekle buton tÄ±klamasÄ±
  event?.preventDefault?.(); // VarsayÄ±lanÄ± engelle
  event?.stopPropagation?.(); // KabarcÄ±k yayÄ±lmasÄ±nÄ± durdur
  addStation(); // Yeni istasyon oluÅŸtur
}

function removeStation(id) { // Ä°stasyon silme fonksiyonu
  appState.stations = appState.stations.filter(station => station.id !== id); // Filtrele
  renderStations(); // Yeniden Ã§iz
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function moveStation(id, direction) { // Ä°stasyon sÄ±ralama fonksiyonu
  const index = appState.stations.findIndex(st => st.id === id); // Ä°ndeks bul
  if (index === -1) return; // BulunamadÄ±
  const newIndex = index + direction; // Yeni indeks
  if (newIndex < 0 || newIndex >= appState.stations.length) return; // SÄ±nÄ±r kontrolÃ¼
  const [station] = appState.stations.splice(index, 1); // Ä°stasyonu Ã§Ä±kar
  appState.stations.splice(newIndex, 0, station); // Yeni konuma ekle
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function addTask(stationId) { // GÃ¶rev ekleme fonksiyonu
  const station = appState.stations.find(st => st.id === stationId); // Ä°stasyon bul
  if (!station) return; // Yoksa Ã§Ä±k
  station.tasks.push(new Task('GÃ¶rev', 1, 10)); // VarsayÄ±lan gÃ¶rev ekle
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function removeTask(stationId, taskIndex) { // GÃ¶rev silme fonksiyonu
  const station = appState.stations.find(st => st.id === stationId); // Ä°stasyon bul
  if (!station) return; // Yoksa Ã§Ä±k
  if (station.tasks.length <= 1) return; // En az bir gÃ¶rev bÄ±rak
  station.tasks.splice(taskIndex, 1); // GÃ¶revi Ã§Ä±kar
  renderStations(); // UI yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function renderStations() { // Ä°stasyon kartlarÄ±nÄ± Ã§iz
  stationListEl.innerHTML = ''; // Listeyi temizle
  stationRuntimeRefs.clear(); // CanlÄ± referanslarÄ± sÄ±fÄ±rla
  if (!appState.stations.length) { // Ä°stasyon yoksa
    emptyStateEl.style.display = 'block'; // BoÅŸ mesaj gÃ¶ster
  } else {
    emptyStateEl.style.display = 'none'; // MesajÄ± gizle
  }
  appState.stations.forEach((station, index) => { // Her istasyon iÃ§in
    const card = document.createElement('div'); // Kart divi
    card.className = 'station-card'; // SÄ±nÄ±f ata
    card.dataset.id = station.id; // Veri ata
    card.draggable = !appState.running; // Ã‡alÄ±ÅŸÄ±rken sÃ¼rÃ¼klemeyi kapat
    const header = document.createElement('div'); // BaÅŸlÄ±k satÄ±rÄ±
    header.className = 'station-header'; // SÄ±nÄ±f ata
    const nameInput = document.createElement('input'); // Ä°sim inputu
    nameInput.value = station.name; // DeÄŸer ata
    nameInput.disabled = appState.running; // Ã‡alÄ±ÅŸÄ±rken kilitle
    nameInput.addEventListener('input', () => { station.name = nameInput.value; renderGraph(appState.stations); saveState(appState); }); // Ä°sim deÄŸiÅŸince gÃ¼ncelle
    header.appendChild(nameInput); // BaÅŸlÄ±ÄŸa ekle
    const totalLabel = document.createElement('span'); // SÃ¼re etiketi
    totalLabel.className = 'badge'; // SÄ±nÄ±f ata
    totalLabel.textContent = `Toplam: ${station.totalDuration()} sn`; // Metin
    header.appendChild(totalLabel); // BaÅŸlÄ±ÄŸa ekle
    card.appendChild(header); // Kart iÃ§ine ekle

    const runtimeLine = document.createElement('div'); // CanlÄ± metrik satÄ±rÄ±
    runtimeLine.className = 'runtime-line'; // SÄ±nÄ±f ata
    const capacityPill = document.createElement('span'); // Kapasite rozeti
    capacityPill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    capacityPill.textContent = `OperatÃ¶r: ${station.parallelServers} (Paralel: ${station.parallelServers})`; // VarsayÄ±lan metin
    const queuePill = document.createElement('span'); // Kuyruk rozeti
    queuePill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    queuePill.textContent = 'Kuyruk: 0'; // VarsayÄ±lan metin
    const servicePill = document.createElement('span'); // Servis rozeti
    servicePill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    servicePill.textContent = `Servis: 0/${station.parallelServers}`; // VarsayÄ±lan metin
    const remainingPill = document.createElement('span'); // Kalan sÃ¼re rozeti
    remainingPill.className = 'runtime-pill'; // SÄ±nÄ±f ata
    remainingPill.textContent = 'Kalan: -'; // VarsayÄ±lan metin
    runtimeLine.appendChild(capacityPill); // Kapasiteyi ekle
    runtimeLine.appendChild(queuePill); // KuyruÄŸu ekle
    runtimeLine.appendChild(servicePill); // Servisi ekle
    runtimeLine.appendChild(remainingPill); // KalanÄ± ekle
    card.appendChild(runtimeLine); // Kart iÃ§ine yerleÅŸtir
    stationRuntimeRefs.set(station.id, { card, capacity: capacityPill, queue: queuePill, service: servicePill, remaining: remainingPill }); // ReferansÄ± kaydet

    const serverRow = document.createElement('div'); // Sunucu satÄ±rÄ±
    serverRow.style.display = 'flex'; // Yatay dÃ¼zen
    serverRow.style.gap = '8px'; // BoÅŸluk
    serverRow.style.alignItems = 'center'; // Ortala
    const serverLabel = document.createElement('span'); // Etiket
    serverLabel.textContent = 'OperatÃ¶r (Paralel Kapasite)'; // Metin
    serverRow.appendChild(serverLabel); // SatÄ±ra ekle
    const serverInput = document.createElement('input'); // SayÄ±sal girdi
    serverInput.type = 'number'; // Tip
    serverInput.min = 1; // Minimum
    serverInput.max = MAX_SERVERS; // Maksimum
    serverInput.value = station.parallelServers; // DeÄŸer
    serverInput.disabled = appState.running; // Ã‡alÄ±ÅŸÄ±rken kapat
    serverInput.style.width = '80px'; // GeniÅŸlik
    serverInput.addEventListener('change', () => { // DeÄŸiÅŸim dinleyici
      const value = Math.max(1, Math.min(MAX_SERVERS, Number(serverInput.value) || 1)); // SÄ±nÄ±rla
      station.parallelServers = value; // Ata
      renderStations(); // Yeniden Ã§iz
      renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
      saveState(appState); // Durumu kaydet
    });
    serverRow.appendChild(serverInput); // SatÄ±ra ekle
    card.appendChild(serverRow); // Kart iÃ§ine ekle

    const table = document.createElement('table'); // GÃ¶rev tablosu
    table.className = 'task-table'; // SÄ±nÄ±f ata
    const thead = document.createElement('thead'); // BaÅŸlÄ±k
    thead.innerHTML = '<tr><th>GÃ¶rev AdÄ±</th><th>OperatÃ¶r</th><th>SÃ¼re (sn)</th><th></th></tr>'; // BaÅŸlÄ±k satÄ±rÄ±
    table.appendChild(thead); // Tabloya ekle
    const tbody = document.createElement('tbody'); // GÃ¶vde
    station.tasks.forEach((task, taskIndex) => { // Her gÃ¶rev iÃ§in
      const row = document.createElement('tr'); // SatÄ±r
      const nameCell = document.createElement('td'); // HÃ¼cre
      const nameField = document.createElement('input'); // Girdi
      nameField.value = task.name; // DeÄŸer
      nameField.disabled = appState.running; // Kilit
      nameField.addEventListener('input', () => { task.name = nameField.value; saveState(appState); }); // GÃ¼ncelle
      nameCell.appendChild(nameField); // HÃ¼creye ekle
      row.appendChild(nameCell); // SatÄ±ra ekle

      const opCell = document.createElement('td'); // OperatÃ¶r hÃ¼cresi
      const opField = document.createElement('input'); // Girdi
      opField.type = 'number'; // Tip
      opField.min = 1; // Minimum
      opField.value = task.operators; // DeÄŸer
      opField.disabled = appState.running; // Kilit
      opField.addEventListener('change', () => { // DeÄŸiÅŸim
        const value = Math.max(1, Number(opField.value) || 1); // SÄ±nÄ±rla
        task.operators = value; // Ata
        saveState(appState); // Durumu kaydet
      });
      opCell.appendChild(opField); // HÃ¼creye ekle
      row.appendChild(opCell); // SatÄ±ra ekle

      const durationCell = document.createElement('td'); // SÃ¼re hÃ¼cresi
      const durationField = document.createElement('input'); // Girdi
      durationField.type = 'number'; // Tip
      durationField.min = 1; // Minimum
      durationField.value = task.durationSec; // DeÄŸer
      durationField.disabled = appState.running; // Kilit
      durationField.addEventListener('change', () => { // DeÄŸiÅŸim
        const value = Math.max(1, Number(durationField.value) || 1); // SÄ±nÄ±rla
        task.durationSec = value; // Ata
        renderStations(); // Toplam sÃ¼reyi gÃ¼ncelle
        renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
        saveState(appState); // Durumu kaydet
      });
      durationCell.appendChild(durationField); // HÃ¼creye ekle
      row.appendChild(durationCell); // SatÄ±ra ekle

      const actionCell = document.createElement('td'); // Aksiyon hÃ¼cresi
      if (!appState.running) { // SimÃ¼lasyon kapalÄ±ysa
        const removeBtn = document.createElement('button'); // Silme butonu
        removeBtn.textContent = 'Sil'; // Metin
        removeBtn.addEventListener('click', () => removeTask(station.id, taskIndex)); // Olay baÄŸla
        actionCell.appendChild(removeBtn); // HÃ¼creye ekle
      }
      row.appendChild(actionCell); // SatÄ±ra ekle
      tbody.appendChild(row); // GÃ¶vdeye ekle
    });
    table.appendChild(tbody); // Tabloya ekle
    card.appendChild(table); // Kart iÃ§ine ekle

    if (!appState.running) { // SimÃ¼lasyon dururken
      const actions = document.createElement('div'); // Aksiyon satÄ±rÄ±
      actions.className = 'task-actions'; // SÄ±nÄ±f ata
      const addTaskBtn = document.createElement('button'); // GÃ¶rev ekleme butonu
      addTaskBtn.textContent = '+ GÃ¶rev'; // Metin
      addTaskBtn.addEventListener('click', () => addTask(station.id)); // Olay baÄŸla
      actions.appendChild(addTaskBtn); // SatÄ±ra ekle
      const moveGroup = document.createElement('div'); // TaÅŸÄ±ma grubu
      moveGroup.style.display = 'flex'; // Yatay
      moveGroup.style.gap = '8px'; // BoÅŸluk
      const upBtn = document.createElement('button'); // YukarÄ± buton
      upBtn.textContent = 'â†‘'; // Metin
      upBtn.disabled = index === 0; // Ä°lk ise kilit
      upBtn.addEventListener('click', () => moveStation(station.id, -1)); // TaÅŸÄ±
      const downBtn = document.createElement('button'); // AÅŸaÄŸÄ± buton
      downBtn.textContent = 'â†“'; // Metin
      downBtn.disabled = index === appState.stations.length - 1; // Son ise kilit
      downBtn.addEventListener('click', () => moveStation(station.id, 1)); // TaÅŸÄ±
      const deleteBtn = document.createElement('button'); // Silme butonu
      deleteBtn.textContent = 'Sil'; // Metin
      deleteBtn.className = 'danger'; // Renk
      deleteBtn.addEventListener('click', () => removeStation(station.id)); // Sil
      moveGroup.appendChild(upBtn); // Gruba ekle
      moveGroup.appendChild(downBtn); // Gruba ekle
      moveGroup.appendChild(deleteBtn); // Gruba ekle
      actions.appendChild(moveGroup); // SatÄ±ra ekle
      card.appendChild(actions); // Kart iÃ§ine ekle
    }
    stationListEl.appendChild(card); // Listeye ekle
  });
}

function applyLiveStationSnapshot(snapshot) { // CanlÄ± metrikleri karta yaz
  if (!snapshot || !Array.isArray(snapshot.layout)) return; // GeÃ§erli veri kontrolÃ¼
  snapshot.layout.forEach(item => { // Her istasyon verisi
    const refs = stationRuntimeRefs.get(item.stationId); // ReferansÄ± al
    if (!refs) return; // Yoksa geÃ§
    const busyServers = item.servers.filter(server => !!server); // Aktif sunucular
    const avgProgress = busyServers.length ? busyServers.reduce((sum, server) => sum + server.progress, 0) / busyServers.length : 0; // Ortalama ilerleme
    const maxRemaining = busyServers.length ? Math.max(...busyServers.map(server => server.remaining)) : 0; // Maks kalan sÃ¼re
    refs.capacity.textContent = `OperatÃ¶r: ${item.metrics.capacity} (Paralel: ${item.metrics.capacity})`; // Kapasite metni
    refs.queue.textContent = `Kuyruk: ${item.metrics.queueLength}`; // Kuyruk metni
    refs.service.textContent = `Servis: ${item.metrics.busyCount}/${item.metrics.capacity}`; // Servis metni
    refs.remaining.textContent = busyServers.length ? `Kalan: ${maxRemaining.toFixed(1)}sn Â· %${(avgProgress * 100).toFixed(0)}` : 'Kalan: -'; // Kalan sÃ¼re metni
    if (item.metrics.avgQueue > 1.5 || item.metrics.avgUtil > 0.85) { // DarboÄŸaz koÅŸulu
      refs.card.classList.add('bottleneck'); // KartÄ± vurgula
    } else {
      refs.card.classList.remove('bottleneck'); // Vurguyu kaldÄ±r
    }
  });
  if (completedCounterEl) { // SayaÃ§ mevcutsa
    completedCounterEl.textContent = `Tamamlanan: ${snapshot.completedCount}`; // SayaÃ§ gÃ¼ncelle
  }
}

let dragSourceId = null; // SÃ¼rÃ¼klenen istasyon kimliÄŸi

stationListEl.addEventListener('dragstart', event => { // SÃ¼rÃ¼kleme baÅŸlangÄ±cÄ±
  const card = event.target.closest('.station-card'); // KartÄ± bul
  if (!card) return; // Kart yoksa Ã§Ä±k
  dragSourceId = card.dataset.id; // KaynaÄŸÄ± kaydet
  card.classList.add('dragging'); // Stil ekle
  if (event.dataTransfer) { // DataTransfer mevcut mu
    event.dataTransfer.effectAllowed = 'move'; // TaÅŸÄ±ma modu
    event.dataTransfer.setData('text/plain', dragSourceId); // Veri aktar
  }
});

stationListEl.addEventListener('dragover', event => { // Kart Ã¼zerinde gezinme
  if (!dragSourceId) return; // Kaynak yoksa Ã§Ä±k
  event.preventDefault(); // BÄ±rakmaya izin ver
  const card = event.target.closest('.station-card'); // Hedef kart
  if (!card || card.dataset.id === dragSourceId) return; // GeÃ§ersiz hedef
  stationListEl.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); // Eski vurgularÄ± temizle
  card.classList.add('drag-over'); // Yeni vurguyu ekle
});

stationListEl.addEventListener('dragleave', event => { // Kart dÄ±ÅŸÄ±na Ã§Ä±kÄ±ÅŸ
  const card = event.target.closest('.station-card'); // Kart bul
  if (card) card.classList.remove('drag-over'); // Vurguyu kaldÄ±r
});

stationListEl.addEventListener('drop', event => { // BÄ±rakma iÅŸlemi
  if (!dragSourceId) return; // Kaynak yoksa Ã§Ä±k
  event.preventDefault(); // VarsayÄ±lanÄ± engelle
  const targetCard = event.target.closest('.station-card'); // Hedef kart
  stationListEl.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over')); // VurgularÄ± temizle
  const sourceIndex = appState.stations.findIndex(st => st.id === dragSourceId); // Kaynak indeks
  if (sourceIndex === -1) return; // GeÃ§ersiz kaynak
  const targetId = targetCard ? targetCard.dataset.id : null; // Hedef kimliÄŸi
  if (targetId && targetId === dragSourceId) { // AynÄ± karta bÄ±rakÄ±ldÄ±ysa
    dragSourceId = null; // KaynaÄŸÄ± temizle
    renderStations(); // Yeniden Ã§iz
    renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
    return; // Ã‡Ä±k
  }
  const [moved] = appState.stations.splice(sourceIndex, 1); // KaynaÄŸÄ± Ã§Ä±kar
  let insertIndex = targetId ? appState.stations.findIndex(st => st.id === targetId) : appState.stations.length; // Hedef sonrasÄ± indeks
  if (insertIndex === -1) insertIndex = appState.stations.length; // Hedef yoksa sona ekle
  if (targetCard) { // Kart varsa konumu deÄŸerlendir
    const rect = targetCard.getBoundingClientRect(); // Kart geometrisi
    const after = event.clientY > rect.top + rect.height / 2; // Alt yarÄ±da mÄ±
    if (after) insertIndex += 1; // SonrasÄ±na ekle
  }
  appState.stations.splice(insertIndex, 0, moved); // Yeni konuma yerleÅŸtir
  dragSourceId = null; // KaynaÄŸÄ± sÄ±fÄ±rla
  renderStations(); // Listeyi yenile
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
});

stationListEl.addEventListener('dragend', () => { // SÃ¼rÃ¼kleme bitiÅŸi
  stationListEl.querySelectorAll('.station-card').forEach(card => card.classList.remove('dragging', 'drag-over')); // SÄ±nÄ±flarÄ± temizle
  dragSourceId = null; // KaynaÄŸÄ± sÄ±fÄ±rla
});

function validateSetup() { // Kurulum doÄŸrulama
  if (!appState.stations.length) { // Ä°stasyon yoksa
    alert('En az bir istasyon ekleyin.'); // UyarÄ±
    return false; // BaÅŸarÄ±sÄ±z
  }
  for (const station of appState.stations) { // Her istasyon iÃ§in
    if (!station.tasks.length) { // GÃ¶rev yoksa
      alert(`${station.name} iÃ§in en az bir gÃ¶rev tanÄ±mlayÄ±n.`); // UyarÄ±
      return false; // BaÅŸarÄ±sÄ±z
    }
    if (station.parallelServers < 1 || station.parallelServers > MAX_SERVERS) { // Sunucu sÄ±nÄ±rÄ±
      alert(`${station.name} paralel operatÃ¶r 1-${MAX_SERVERS} aralÄ±ÄŸÄ±nda olmalÄ±.`); // UyarÄ±
      return false; // BaÅŸarÄ±sÄ±z
    }
    for (const task of station.tasks) { // GÃ¶rev doÄŸrula
      if (!task.name.trim()) { // BoÅŸ isim
        alert('GÃ¶rev adÄ± boÅŸ bÄ±rakÄ±lamaz.'); // UyarÄ±
        return false; // BaÅŸarÄ±sÄ±z
      }
      if (task.durationSec <= 0) { // SÃ¼re kontrolÃ¼
        alert("GÃ¶rev sÃ¼releri 0'dan bÃ¼yÃ¼k olmalÄ±."); // UyarÄ±
        return false; // BaÅŸarÄ±sÄ±z
      }
    }
  }
  return true; // BaÅŸarÄ±lÄ±
}

function startSimulation() { // SimÃ¼lasyonu baÅŸlat
  if (!validateSetup()) return; // GeÃ§ersizse Ã§Ä±k
  const options = { // SeÃ§enekler
    entryPolicy: appState.entryPolicy, // GiriÅŸ politikasÄ±
    entryInterval: appState.entryInterval, // GiriÅŸ aralÄ±ÄŸÄ±
    targetCount: appState.targetCount // Hedef adet
  };
  appState.simulation = new SimulationEngine(cloneStationsForRun(), options, viz); // Motor oluÅŸtur
  appState.simulation.onLiveUpdate = snapshot => applyLiveStationSnapshot(snapshot); // CanlÄ± gÃ¼ncelleme baÄŸla
  appState.simulation.start(); // BaÅŸlat
  appState.running = true; // Durum gÃ¼ncelle
  appState.lastUpdate = performance.now(); // Zaman kaydÄ±
  appState.lastMetricRefresh = appState.lastUpdate; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  appState.visualCursor = appState.simulation.currentTime; // GÃ¶rsel zamanÄ± hizala
  appState.simulation.updateLayoutTargets(appState.visualCursor); // Ä°lk snapshot
  if (completedCounterEl) completedCounterEl.textContent = 'Tamamlanan: 0'; // SayaÃ§ sÄ±fÄ±rla
  toggleEditing(false); // UI kilitle
  startBtn.disabled = true; // BaÅŸlat kilit
  stopBtn.disabled = false; // Durdur aÃ§
  runLoop(); // DÃ¶ngÃ¼yÃ¼ baÅŸlat
}

function stopSimulation(showReport = true) { // SimÃ¼lasyonu durdur
  if (!appState.simulation) return; // Motor yoksa Ã§Ä±k
  appState.simulation.stop(); // Motor durdur
  appState.visualCursor = appState.simulation.currentTime; // GÃ¶rsel zamanÄ± gÃ¼ncelle
  appState.simulation.updateLayoutTargets(appState.visualCursor); // Son durumu aktar
  appState.running = false; // Durum gÃ¼ncelle
  toggleEditing(true); // UI aÃ§
  startBtn.disabled = false; // BaÅŸlat aÃ§
  stopBtn.disabled = true; // Durdur kilit
  appState.lastMetricRefresh = 0; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  const canShowReport = showReport && document.fullscreenElement !== visualPanel; // Tam ekranda mÄ±
  if (canShowReport) openReportModal(); // Uygunsa raporu aÃ§
}

function resetSimulation() { // SimÃ¼lasyonu sÄ±fÄ±rla
  appState.running = false; // Durum
  startBtn.disabled = false; // BaÅŸlat aÃ§
  stopBtn.disabled = true; // Durdur kilit
  toggleEditing(true); // UI aÃ§
  if (appState.simulation) { // Motor varsa
    appState.simulation.reset(); // SÄ±fÄ±rla
  }
  appState.lastMetricRefresh = 0; // Metrik zamanÄ±nÄ± sÄ±fÄ±rla
  appState.visualCursor = 0; // GÃ¶rsel zamanÄ± sÄ±fÄ±rla
  viz.clearJobs(); // BalonlarÄ± temizle
  if (completedCounterEl) completedCounterEl.textContent = 'Tamamlanan: 0'; // SayaÃ§ sÄ±fÄ±rla
  stationRuntimeRefs.forEach((refs, stationId) => { // Her kart iÃ§in
    const station = appState.stations.find(st => st.id === stationId); // Ä°stasyonu bul
    const capacity = station ? station.parallelServers : 0; // Kapasite al
    refs.card.classList.remove('bottleneck'); // Vurguyu kaldÄ±r
    refs.capacity.textContent = `OperatÃ¶r: ${capacity} (Paralel: ${capacity})`; // Kapasiteyi sÄ±fÄ±rla
    refs.queue.textContent = 'Kuyruk: 0'; // KuyruÄŸu sÄ±fÄ±rla
    refs.service.textContent = `Servis: 0/${capacity}`; // Servisi sÄ±fÄ±rla
    refs.remaining.textContent = 'Kalan: -'; // Kalan sÃ¼reyi sÄ±fÄ±rla
  });
}

function toggleEditing(enabled) { // UI dÃ¼zenleme durumunu ayarla
  const inputs = stationListEl.querySelectorAll('input, button'); // TÃ¼m kontroller
  inputs.forEach(el => { // Her biri
    if (el.dataset.lock === 'runtime') return; // Kilitli olanlar
    if (el.id === 'stopBtn') return; // Durdur hariÃ§
    if (el.id === 'startBtn') return; // BaÅŸlat hariÃ§
    el.disabled = !enabled && !el.classList.contains('danger'); // Duruma gÃ¶re kilitle
  });
  addStationBtn.disabled = !enabled; // Ä°stasyon eklemeyi kilitle
  sampleBtn.disabled = !enabled; // Ã–rnek kurulum kilidi
  entryPolicySelect.disabled = !enabled; // GiriÅŸ seÃ§imini kilitle
  entryIntervalInput.disabled = !enabled || appState.entryPolicy !== 'interval'; // AralÄ±k giriÅŸi
  targetInput.disabled = !enabled; // Hedef giriÅŸi
}

function runLoop() { // SimÃ¼lasyon dÃ¶ngÃ¼sÃ¼
  if (!appState.simulation || !appState.simulation.running) return; // Motor Ã§alÄ±ÅŸmÄ±yorsa Ã§Ä±k
  const now = performance.now(); // Åimdiki zaman
  const deltaSec = (now - appState.lastUpdate) / 1000; // GeÃ§en sÃ¼re saniye
  appState.lastUpdate = now; // Zaman gÃ¼ncelle
  const nextEvent = appState.simulation.peekNextEventTime(); // Sonraki olay zamanÄ±
  let targetTime = appState.visualCursor + deltaSec * LOGICAL_RATE; // Hedef zaman
  if (nextEvent !== null) targetTime = Math.min(targetTime, nextEvent); // OlayÄ± aÅŸma
  targetTime = Math.max(targetTime, appState.simulation.currentTime); // Geri gitme
  appState.visualCursor = targetTime; // GÃ¶rsel zamanÄ± gÃ¼ncelle
  appState.simulation.processUntil(appState.visualCursor); // OlaylarÄ± iÅŸle
  viz.setSpeed(appState.speed); // HÄ±zÄ± gÃ¼ncelle
  if (!appState.lastMetricRefresh || now - appState.lastMetricRefresh >= UPDATE_INTERVAL_MS) { // Periyodik metrik kontrolÃ¼
    appState.simulation.updateLayoutTargets(appState.visualCursor); // YerleÅŸim gÃ¼ncelle
    appState.lastMetricRefresh = now; // Zaman kaydÄ±
  }
  if (!appState.simulation.running) { // Durduysa
    stopSimulation(true); // Raporla durdur
    return; // Ã‡Ä±k
  }
  requestAnimationFrame(runLoop); // Sonraki karede devam
}

function collectStationSummaries(report) { // Ä°stasyon Ã¶zetlerini hazÄ±rla
  return appState.stations.map(station => { // TÃ¼m istasyonlarÄ± gez
    const duration = station.totalDuration(); // Servis sÃ¼resi toplamÄ±
    const parallel = Math.max(1, station.parallelServers); // Paralel kapasite
    const capacityPerSec = duration > 0 ? parallel / duration : 0; // Teorik kapasite
    const reportRow = report?.stationRows?.find(row => row.stationId === station.id) || null; // Rapor satÄ±rÄ±
    const utilization = reportRow ? reportRow.utilization : null; // Utilizasyon deÄŸeri
    const avgQueue = reportRow ? reportRow.avgQueue : null; // Ortalama kuyruk
    const serviceCount = reportRow ? reportRow.serviceCount : 0; // Tamamlanan iÅŸ adedi
    return { station, duration, parallel, capacityPerSec, utilization, avgQueue, serviceCount }; // Ã–zet nesnesi
  });
}

function createAnalysisNarrative(summaries, report, taktTime) { // Analiz anlatÄ±sÄ±nÄ± Ã¼ret
  if (!summaries.length) { // Ã–zet yoksa
    return { text: 'Analiz iÃ§in Ã¶nce istasyon tanÄ±mlayÄ±n.', scenarios: [] }; // Bilgi mesajÄ± dÃ¶ndÃ¼r
  }
  const taktRate = taktTime && taktTime > 0 ? 1 / taktTime : null; // Takt oranÄ±
  const bottleneckService = summaries.reduce((max, row) => (!max || row.duration > max.duration ? row : max), null); // SÃ¼re darboÄŸazÄ±
  const bottleneckUtil = summaries.reduce((max, row) => { // Util darboÄŸazÄ±
    if (row.utilization === null) return max; // Veri yoksa geÃ§
    if (!max || row.utilization > (max.utilization ?? 0)) return row; // Daha yÃ¼ksekse seÃ§
    return max; // Aksi halde mevcut
  }, null); // SonuÃ§
  const serviceName = bottleneckService ? bottleneckService.station.name : '-'; // Servis darboÄŸaz adÄ±
  const utilName = bottleneckUtil ? bottleneckUtil.station.name : '-'; // Util darboÄŸaz adÄ±
  let text = `Bottleneck (servis): ${serviceName}.`; // Temel metin
  text += ` Utilizasyon analizinde Ã¶ne Ã§Ä±kan istasyon: ${utilName}.`; // Util bilgisi ekle
  if (bottleneckService && bottleneckService.avgQueue !== null) { // Kuyruk bilgisi varsa
    text += ` Ortalama kuyruk ${bottleneckService.avgQueue.toFixed(2)} iÅŸ.`; // Kuyruk metni
  }
  if (taktTime && bottleneckService) { // Takt girdisi varsa
    if (bottleneckService.duration > taktTime) { // SÃ¼re taktÄ± aÅŸÄ±yorsa
      text += ` Takt ${taktTime.toFixed(2)} sn; bu istasyonda tek Ã¼rÃ¼n sÃ¼resi ${bottleneckService.duration.toFixed(2)} sn olduÄŸundan paralel kapasite artÄ±ÅŸÄ± Ã¶nerilir.`; // Ã–neri metni
    } else {
      text += ` Takt ${taktTime.toFixed(2)} sn deÄŸerini bu istasyon karÅŸÄ±lÄ±yor; paralel artÄ±ÅŸÄ± daha Ã§ok kuyruk dengesi iÃ§in dÃ¼ÅŸÃ¼nÃ¼lmeli.`; // Bilgi metni
    }
  } else {
    text += ' Takt time girilmedi; Ã¶neriler teorik kapasite Ã¼zerinden hesaplandÄ±.'; // VarsayÄ±lan bilgi
  }
  text += ' Paralel operatÃ¶r eklemek servis sÃ¼resini kÄ±saltmaz, yalnÄ±z eÅŸzamanlÄ± iÅŸ kapasitesini artÄ±rÄ±r.'; // Sabit sÃ¼re vurgusu
  const targetRow = report?.bottleneckService?.stationId // Senaryo hedefi
    ? summaries.find(row => row.station.id === report.bottleneckService.stationId) || bottleneckService
    : bottleneckService; // VarsayÄ±lan hedef
  if (!targetRow) return { text, scenarios: [] }; // Hedef yoksa Ã§Ä±k
  const baseThroughput = targetRow.duration > 0 ? targetRow.parallel / targetRow.duration : 0; // Mevcut kapasite
  const scenarios = []; // Senaryo listesi
  [1, 2].forEach(delta => { // +1 ve +2 operatÃ¶r
    const proposed = Math.min(MAX_SERVERS, targetRow.parallel + delta); // Yeni paralel kapasite
    if (proposed === targetRow.parallel) { // ArtÄ±ÅŸ yoksa
      scenarios.push(`+${delta} operatÃ¶r: Kapasite ${MAX_SERVERS} sÄ±nÄ±rÄ±nda; artÄ±ÅŸ uygulanamaz.`); // SÄ±nÄ±r mesajÄ±
      return; // Sonraki
    }
    const newThroughput = targetRow.duration > 0 ? proposed / targetRow.duration : 0; // Yeni kapasite
    let queueNote = 'Kuyruk etkisi: '; // Kuyruk yorumu
    if (taktRate) { // Takt oranÄ± varsa
      if (newThroughput >= taktRate) { // Takt yakalandÄ±ysa
        queueNote += 'takt hÄ±zÄ±nÄ± yakalayÄ±p kuyruklarÄ± eritmesi beklenir.'; // Eriyen kuyruk
      } else if (newThroughput > baseThroughput) { // Ä°yileÅŸme var
        queueNote += 'kuyruk bÃ¼yÃ¼me hÄ±zÄ±nÄ± azaltÄ±r ancak takt altÄ±nda kalÄ±r.'; // Azalan bÃ¼yÃ¼me
      } else {
        queueNote += 'takt altÄ±nda kaldÄ±ÄŸÄ± iÃ§in etkisi sÄ±nÄ±rlÄ± olacaktÄ±r.'; // SÄ±nÄ±rlÄ± etki
      }
    } else if (newThroughput > baseThroughput) { // Takt yok ama artÄ±ÅŸ var
      queueNote += 'daha yÃ¼ksek paralel kapasite ile bekleme sÃ¼releri kÄ±salÄ±r.'; // Olumlu etki
    } else {
      queueNote += 'deÄŸiÅŸim yok.'; // Etki yok
    }
    scenarios.push(`+${delta} operatÃ¶r â†’ ${targetRow.parallel}â†’${proposed} paralel, kapasite ${baseThroughput.toFixed(3)}â†’${newThroughput.toFixed(3)} Ã¼rÃ¼n/sn. ${queueNote} Servis sÃ¼resi sabit kalÄ±r.`); // Senaryo metni
  });
  return { text, scenarios }; // SonuÃ§ dÃ¶ndÃ¼r
}

function toggleFullscreen() { // Tam ekran modunu deÄŸiÅŸtir
  if (!visualPanel) return; // Panel yoksa Ã§Ä±k
  const active = document.fullscreenElement === visualPanel; // Åu an tam ekran mÄ±
  if (active) { // Zaten tam ekran ise
    if (document.exitFullscreen) document.exitFullscreen().catch(error => console.warn('Tam ekran Ã§Ä±kÄ±ÅŸÄ± baÅŸarÄ±sÄ±z:', error)); // Ã‡Ä±kÄ±ÅŸ dene
    return; // Ã‡Ä±k
  }
  closeReport(); // Mevcut dashboard'u gizle
  if (visualPanel.requestFullscreen) { // API varsa
    visualPanel.requestFullscreen().catch(error => console.warn('Tam ekran isteÄŸi baÅŸarÄ±sÄ±z:', error)); // Hata logla
  }
}

function updateFullscreenLabel() { // Tam ekran etiketini gÃ¼ncelle
  if (!fullscreenLabel || !fullscreenBtn) return; // Elemanlar yoksa Ã§Ä±k
  const active = document.fullscreenElement === visualPanel; // Durumu kontrol et
  fullscreenLabel.textContent = active ? 'â¤º Ã‡Ä±k' : 'ğŸ”³ Tam Ekran'; // Metni ayarla
  fullscreenBtn.setAttribute('aria-pressed', active ? 'true' : 'false'); // Durum niteliÄŸini gÃ¼ncelle
}

function openAnalysisModal() { // Analiz modalÄ±nÄ± aÃ§
  runAnalysis(); // Ä°Ã§eriÄŸi Ã¼ret
  if (analysisModal) analysisModal.classList.add('active'); // ModalÄ± gÃ¶ster
}

function closeAnalysisModal() { // Analiz modalÄ±nÄ± kapat
  if (analysisModal) analysisModal.classList.remove('active'); // ModalÄ± gizle
}

function runAnalysis() { // Analiz iÃ§eriÄŸini hesapla
  if (!analysisTableBody || !analysisText || !analysisList) return; // Eleman kontrolÃ¼
  const taktTime = appState.taktTime && appState.taktTime > 0 ? appState.taktTime : null; // Takt deÄŸeri
  let report = null; // Rapor saklama
  try { // GÃ¼venli Ã§aÄŸrÄ±
    if (appState.simulation) report = appState.simulation.buildReport(); // Mevcut raporu al
  } catch (error) { // Hata durumunda
    console.warn('Analiz raporu oluÅŸturulamadÄ±:', error); // UyarÄ±
  }
  analysisTableBody.innerHTML = ''; // Tabloyu temizle
  const summaries = collectStationSummaries(report); // Ã–zet listesini Ã¼ret
  summaries.forEach(summary => { // Her Ã¶zet iÃ§in satÄ±r oluÅŸtur
    const tr = document.createElement('tr'); // Tablo satÄ±rÄ±
    tr.innerHTML = `<td>${summary.station.name}</td><td>${summary.duration.toFixed(2)}</td><td>${summary.parallel}</td><td>${summary.parallel}</td><td>${summary.capacityPerSec.toFixed(3)}</td>`; // HÃ¼creler
    analysisTableBody.appendChild(tr); // Tabloya ekle
  });
  if (!summaries.length) { // Ä°stasyon yoksa
    analysisText.textContent = 'Analiz iÃ§in Ã¶nce en az bir istasyon tanÄ±mlayÄ±n.'; // Bilgi metni
    analysisList.innerHTML = ''; // Listeyi temizle
    return; // Ã‡Ä±k
  }
  const narrative = createAnalysisNarrative(summaries, report, taktTime); // AnlatÄ±yÄ± hazÄ±rla
  analysisText.textContent = narrative.text; // Metni yaz
  analysisList.innerHTML = ''; // Listeyi temizle
  narrative.scenarios.forEach(entry => { // SenaryolarÄ± ekle
    const li = document.createElement('li'); // Liste elemanÄ±
    li.textContent = entry; // Metni ata
    analysisList.appendChild(li); // Listeye ekle
  });
}

  
function openReportModal() { // Rapor modalÄ±nÄ± aÃ§
  if (!appState.simulation) return; // Motor yoksa Ã§Ä±k
  if (document.fullscreenElement === visualPanel && document.exitFullscreen) { // Tam ekranda ise
    const exitResult = document.exitFullscreen(); // Ã‡Ä±kÄ±ÅŸ isteÄŸi
    if (exitResult && typeof exitResult.then === 'function') { // Promise dÃ¶ndÃ¼yse
      exitResult.then(() => openReportModal()).catch(error => console.warn('Tam ekran Ã§Ä±kÄ±ÅŸÄ± sÄ±rasÄ±nda rapor aÃ§Ä±lamadÄ±:', error)); // Yeniden dene
    } else {
      setTimeout(() => openReportModal(), 0); // Asenkron tekrar dene
    }
    return; // Bekle
  }
  const report = appState.simulation.buildReport(); // Raporu Ã¼ret
  if (cardCycleEl) cardCycleEl.textContent = `${report.avgCycle.toFixed(2)} sn`; // Cycle kartÄ±nÄ± gÃ¼ncelle
  if (cardCompletedEl) cardCompletedEl.textContent = `${report.totalCompleted}`; // Tamamlanan kartÄ±nÄ± gÃ¼ncelle
  if (cardThroughputEl) cardThroughputEl.textContent = `${report.throughputPerSec.toFixed(3)} /sn Â· ${report.throughputPerMin.toFixed(2)} /dk`; // Throughput kartÄ±nÄ± gÃ¼ncelle
  if (cardWipEl) cardWipEl.textContent = report.avgWip.toFixed(2); // WIP kartÄ±nÄ± gÃ¼ncelle
  if (stationPerformanceBody) { // Ä°stasyon tablosunu doldur
    stationPerformanceBody.innerHTML = ''; // Tabloyu temizle
    if (!report.stationRows.length) { // SatÄ±r yoksa
      const tr = document.createElement('tr'); // Tek satÄ±r
      tr.innerHTML = '<td colspan="7">Veri yok</td>'; // Mesaj
      stationPerformanceBody.appendChild(tr); // Tabloya ekle
    } else {
      report.stationRows.forEach(row => { // Her istasyon iÃ§in
        const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
        tr.innerHTML = `<td>${row.stationName}</td><td>${row.parallelServers}</td><td>${row.serviceTime.toFixed(2)}</td><td>${row.avgQueue.toFixed(2)}</td><td>${(row.utilization * 100).toFixed(1)}</td><td>${row.avgWait.toFixed(2)}</td><td>${row.serviceCount}</td>`; // HÃ¼creler
        stationPerformanceBody.appendChild(tr); // Tabloya ekle
      });
    }
  }
  if (bottleneckTableBody) { // DarboÄŸaz tablosunu doldur
    bottleneckTableBody.innerHTML = ''; // Tabloyu temizle
    const entries = [ // Kriter listesi
      { label: 'Utilizasyon (en yÃ¼ksek)', row: report.bottleneckUtil }, // Utilizasyon kriteri
      { label: 'Servis SÃ¼resi (en uzun)', row: report.bottleneckService } // Servis sÃ¼resi kriteri
    ];
    entries.forEach(entry => { // Her kriter iÃ§in
      const tr = document.createElement('tr'); // SatÄ±r oluÅŸtur
      const stationName = entry.row ? entry.row.stationName : '-'; // Ä°stasyon adÄ±
      const suggestion = buildBottleneckSuggestion(entry.row); // Ã–neriyi hesapla
      tr.innerHTML = `<td>${entry.label}</td><td>${stationName}</td><td>${suggestion}</td>`; // HÃ¼creler
      bottleneckTableBody.appendChild(tr); // Tabloya ekle
    });
  }
  latestReport = report; // Raporu hafÄ±zada sakla
  const taktTime = appState.taktTime && appState.taktTime > 0 ? appState.taktTime : null; // Takt deÄŸeri
  const narrative = createAnalysisNarrative(collectStationSummaries(report), report, taktTime); // AnlatÄ±yÄ± hazÄ±rla
  if (dashboardAnalysisText) dashboardAnalysisText.textContent = narrative.text; // Analiz metnini yaz
  if (dashboardAnalysisList) { // Analiz listesini hazÄ±rla
    dashboardAnalysisList.innerHTML = ''; // Temizle
    if (narrative.scenarios.length) { // Senaryolar varsa
      narrative.scenarios.forEach(entry => { // Her senaryo iÃ§in
        const li = document.createElement('li'); // Liste elemanÄ±
        li.textContent = entry; // Metni ata
        dashboardAnalysisList.appendChild(li); // Listeye ekle
      });
    } else {
      const li = document.createElement('li'); // Bilgi elemanÄ±
      li.textContent = 'Ek senaryo bulunamadÄ±.'; // Mesaj
      dashboardAnalysisList.appendChild(li); // Listeye ekle
    }
  }
  if (reportModal) reportModal.classList.add('active'); // ModalÄ± gÃ¶ster
  scheduleDashboardCharts(); // Grafiklerin Ã§izimini planla
  if (downloadCsvBtn) downloadCsvBtn.onclick = () => latestReport && downloadCsv(latestReport); // CSV butonunu gÃ¼ncel rapora baÄŸla
  if (downloadPdfBtn) { // PDF dÃ¼ÄŸmesi iÃ§in kontrol
    const canPrint = typeof window.print === 'function'; // YazdÄ±rma desteÄŸini sorgula
    downloadPdfBtn.disabled = !canPrint; // Destek yoksa pasifleÅŸtir
    downloadPdfBtn.title = canPrint ? 'YazdÄ±r veya PDF olarak kaydet' : 'TarayÄ±cÄ± yazdÄ±rma desteÄŸi bulunamadÄ±'; // Ä°pucu ayarla
    downloadPdfBtn.onclick = canPrint ? () => window.print() : null; // OlayÄ± tanÄ±mla
  }
}

function closeReport() { // Rapor modalÄ±nÄ± kapat
  if (reportModal) reportModal.classList.remove('active'); // ModalÄ± gizle
  if (scheduledChartFrame) { // Bekleyen Ã§izim varsa
    cancelAnimationFrame(scheduledChartFrame); // Kareyi iptal et
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
  }
}

function downloadCsv(report) { // CSV indirme fonksiyonu
  const lines = []; // SatÄ±r listesi
  lines.push('Kategori,DeÄŸer'); // BaÅŸlÄ±k satÄ±rÄ±
  lines.push(`Tamamlanan,${report.totalCompleted}`); // Tamamlanan Ã¼rÃ¼n
  lines.push(`SÃ¼re(sn),${report.horizon.toFixed(2)}`); // SimÃ¼lasyon sÃ¼resi
  lines.push(`Cycle(sn),${report.avgCycle.toFixed(2)}`); // Cycle time
  lines.push(`Throughput(sn),${report.throughputPerSec.toFixed(3)}`); // ÃœrÃ¼n/sn
  lines.push(`Throughput(dk),${report.throughputPerMin.toFixed(3)}`); // ÃœrÃ¼n/dk
  lines.push(`Ortalama WIP,${report.avgWip.toFixed(2)}`); // Ortalama WIP
  lines.push(''); // BoÅŸ satÄ±r
  lines.push('Ä°stasyon,OperatÃ¶r,Paralel,Servis SÃ¼resi(sn),Tamamlanan Ä°ÅŸ,Teorik Kapasite(Ã¼rÃ¼n/sn),Utilizasyon(%),Ortalama Kuyruk,Ortalama Bekleme(sn)'); // Tablo baÅŸlÄ±ÄŸÄ±
  report.stationRows.forEach(row => { // Her istasyon iÃ§in
    lines.push(`${row.stationName},${row.parallelServers},${row.parallelServers},${row.serviceTime.toFixed(2)},${row.serviceCount},${row.capacityPerSec.toFixed(3)},${(row.utilization * 100).toFixed(1)},${row.avgQueue.toFixed(2)},${row.avgWait.toFixed(2)}`); // SatÄ±rÄ± ekle
  });
  const blob = new Blob([lines.join('\n')], { type: 'text/csv;charset=utf-8;' }); // Blob oluÅŸtur
  const url = URL.createObjectURL(blob); // URL Ã¼ret
  const link = document.createElement('a'); // Link oluÅŸtur
  link.href = url; // URL ata
  link.download = 'rapor.csv'; // Dosya adÄ±
  document.body.appendChild(link); // DOM'a ekle
  link.click(); // Ä°ndirmeyi tetikle
  document.body.removeChild(link); // DOM'dan kaldÄ±r
  URL.revokeObjectURL(url); // URL temizle
}

function buildBottleneckSuggestion(row) { // DarboÄŸaz Ã¶nerisini Ã¼ret
  if (!row) return 'Veri yok.'; // Veri yoksa mesaj
  if (row.parallelServers >= MAX_SERVERS) return `OperatÃ¶r sayÄ±sÄ± ${MAX_SERVERS} sÄ±nÄ±rÄ±nda; artÄ±ÅŸ uygulanamaz.`; // SÄ±nÄ±r mesajÄ±
  const nextParallel = row.parallelServers + 1; // Yeni paralel kapasite
  const baseCapacity = row.serviceTime > 0 ? row.parallelServers / row.serviceTime : 0; // Mevcut kapasite
  const newCapacity = row.serviceTime > 0 ? nextParallel / row.serviceTime : baseCapacity; // Yeni kapasite
  const ratio = baseCapacity > 0 ? newCapacity / baseCapacity : nextParallel; // ArtÄ±ÅŸ oranÄ±
  return `OperatÃ¶r sayÄ±sÄ± +1 olursa kapasite ${ratio.toFixed(2)} kat artar, servis sÃ¼resi sabit kalÄ±r.`; // Metni dÃ¶ndÃ¼r
}

function prepareChartCanvas(canvas) { // Canvas boyutunu hazÄ±rla
  if (!canvas) return null; // Eleman yoksa Ã§Ä±k
  const ctx = canvas.getContext('2d'); // BaÄŸlamÄ± al
  if (!ctx) return null; // BaÄŸlam yoksa Ã§Ä±k
  const dpr = window.devicePixelRatio || 1; // Piksel oranÄ±
  const bounds = canvas.getBoundingClientRect(); // Piksel boyutlarÄ±nÄ± al
  const width = Math.floor(bounds.width || canvas.clientWidth || 0); // GÃ¶rÃ¼nen geniÅŸlik
  const height = Math.floor(bounds.height || canvas.clientHeight || 0); // GÃ¶rÃ¼nen yÃ¼kseklik
  if (!width || !height) return null; // Ã–lÃ§Ã¼ yoksa Ã§Ä±k
  canvas.width = width * dpr; // Piksel geniÅŸliÄŸi ayarla
  canvas.height = height * dpr; // Piksel yÃ¼ksekliÄŸi ayarla
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0); // Ã–lÃ§eÄŸi uygula
  ctx.clearRect(0, 0, width, height); // Canvas'Ä± temizle
  ctx.font = '12px sans-serif'; // YazÄ± tipini ayarla
  ctx.textBaseline = 'middle'; // Baz Ã§izgi
  return { ctx, width, height }; // Sonucu dÃ¶ndÃ¼r
}

function scheduleDashboardCharts() { // Dashboard grafikleri iÃ§in Ã§izim zamanla
  if (!reportModal || !reportModal.classList.contains('active')) return; // Modal kapalÄ±ysa Ã§Ä±k
  if (!latestReport) return; // Rapor yoksa Ã§Ä±k
  if (scheduledChartFrame) { // Ã–nceden planlanmÄ±ÅŸ kare varsa
    cancelAnimationFrame(scheduledChartFrame); // Eski kareyi iptal et
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
  }
  scheduledChartFrame = requestAnimationFrame(() => { // Yeni kare planla
    scheduledChartFrame = 0; // KimliÄŸi sÄ±fÄ±rla
    renderQueueChart(latestReport.stationRows); // Kuyruk grafiÄŸini Ã§iz
    renderThroughputChart(latestReport.completionSeries, latestReport.horizon); // Throughput grafiÄŸini Ã§iz
  });
}

function renderQueueChart(rows) { // Kuyruk grafiÄŸini Ã§iz
  if (!queueChartCanvas) return; // Canvas yoksa Ã§Ä±k
  const surface = prepareChartCanvas(queueChartCanvas); // Canvas hazÄ±rlÄ±ÄŸÄ±
  if (!surface) return; // HazÄ±rlÄ±k baÅŸarÄ±sÄ±zsa Ã§Ä±k
  const { ctx, width, height } = surface; // BoyutlarÄ± al
  if (!rows || !rows.length) { // Veri yoksa
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; // Metin rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText('Veri yok', width / 2, height / 2); // Mesaj yaz
    return; // Ã‡Ä±k
  }
  const padding = { top: 24, right: 18, bottom: 48, left: 54 }; // Kenar boÅŸluklarÄ±
  const chartWidth = Math.max(10, width - padding.left - padding.right); // Grafik geniÅŸliÄŸi
  const chartHeight = Math.max(10, height - padding.top - padding.bottom); // Grafik yÃ¼ksekliÄŸi
  const maxQueue = Math.max(...rows.map(row => row.avgQueue), 1); // Maks kuyruk
  const maxUtil = Math.max(...rows.map(row => row.utilization), 0.01); // Maks util
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; // Izgara rengi
  ctx.beginPath(); // Ã‡izim baÅŸlat
  ctx.moveTo(padding.left, height - padding.bottom); // X ekseni baÅŸlangÄ±cÄ±
  ctx.lineTo(width - padding.right, height - padding.bottom); // X ekseni
  ctx.stroke(); // Ã‡iz
  const gap = chartWidth / rows.length; // SÃ¼tun aralÄ±ÄŸÄ±
  const barWidth = Math.min(48, gap * 0.6); // SÃ¼tun geniÅŸliÄŸi
  rows.forEach((row, index) => { // Her istasyon iÃ§in
    const center = padding.left + gap * index + gap / 2; // Merkez x
    const barHeight = (row.avgQueue / maxQueue) * chartHeight; // Bar yÃ¼ksekliÄŸi
    const barX = center - barWidth / 2; // Bar sol x
    const barY = height - padding.bottom - barHeight; // Bar Ã¼st y
    ctx.fillStyle = 'rgba(100,210,255,0.45)'; // Bar rengi
    ctx.fillRect(barX, barY, barWidth, barHeight); // Bar Ã§iz
    const utilY = height - padding.bottom - (row.utilization / maxUtil) * chartHeight; // Util y
    ctx.fillStyle = 'rgba(255,107,107,0.85)'; // Nokta rengi
    ctx.beginPath(); // Yeni yol
    ctx.arc(center, utilY, 4, 0, Math.PI * 2); // Nokta Ã§iz
    ctx.fill(); // Doldur
    ctx.fillStyle = 'rgba(255,255,255,0.7)'; // Etiket rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText(row.stationName, center, height - padding.bottom + 18); // Ä°sim yaz
  });
  ctx.fillStyle = 'rgba(255,255,255,0.6)'; // BaÅŸlÄ±k rengi
  ctx.textAlign = 'left'; // Sol hizala
  ctx.fillText('Ortalama Kuyruk', padding.left, padding.top - 10); // Kuyruk etiketi
  ctx.textAlign = 'right'; // SaÄŸ hizala
  ctx.fillText('Utilizasyon %', width - padding.right, padding.top - 10); // Util etiketi
}

function renderThroughputChart(series, horizon) { // Zaman grafiÄŸini Ã§iz
  if (!throughputChartCanvas) return; // Canvas yoksa Ã§Ä±k
  const surface = prepareChartCanvas(throughputChartCanvas); // Canvas hazÄ±rlÄ±ÄŸÄ±
  if (!surface) return; // HazÄ±rlÄ±k baÅŸarÄ±sÄ±zsa Ã§Ä±k
  const { ctx, width, height } = surface; // BoyutlarÄ± al
  if (!series || !series.length) { // Veri yoksa
    ctx.fillStyle = 'rgba(255,255,255,0.6)'; // Metin rengi
    ctx.textAlign = 'center'; // Ortala
    ctx.fillText('HenÃ¼z tamamlanan Ã¼rÃ¼n yok', width / 2, height / 2); // Mesaj yaz
    return; // Ã‡Ä±k
  }
  const padding = { top: 24, right: 20, bottom: 42, left: 58 }; // Kenar boÅŸluklarÄ±
  const chartWidth = Math.max(10, width - padding.left - padding.right); // Grafik geniÅŸliÄŸi
  const chartHeight = Math.max(10, height - padding.top - padding.bottom); // Grafik yÃ¼ksekliÄŸi
  const maxTime = Math.max(series[series.length - 1].time, horizon, 1); // Maks zaman
  const maxCount = Math.max(series[series.length - 1].count, 1); // Maks adet
  const points = series.map(point => ({ // NoktalarÄ± Ã¶lÃ§ekle
    x: padding.left + (point.time / maxTime) * chartWidth, // X koordinatÄ±
    y: height - padding.bottom - (point.count / maxCount) * chartHeight // Y koordinatÄ±
  }));
  ctx.strokeStyle = 'rgba(255,255,255,0.2)'; // Eksen rengi
  ctx.beginPath(); // Yol
  ctx.moveTo(padding.left, padding.top); // Sol Ã¼st
  ctx.lineTo(padding.left, height - padding.bottom); // Y ekseni
  ctx.lineTo(width - padding.right, height - padding.bottom); // X ekseni
  ctx.stroke(); // Ã‡iz
  ctx.strokeStyle = 'rgba(100,210,255,0.85)'; // Ã‡izgi rengi
  ctx.lineWidth = 2; // Ã‡izgi kalÄ±nlÄ±ÄŸÄ±
  ctx.beginPath(); // Ã‡izgi yolu
  points.forEach((point, index) => { // Her nokta iÃ§in
    if (index === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); // Ã‡izgi oluÅŸtur
  });
  ctx.stroke(); // Ã‡iz
  ctx.beginPath(); // Alan doldurma
  points.forEach((point, index) => { // NoktalarÄ± tekrar gez
    if (index === 0) ctx.moveTo(point.x, point.y); else ctx.lineTo(point.x, point.y); // Yol Ã§iz
  });
  ctx.lineTo(points[points.length - 1].x, height - padding.bottom); // SaÄŸ alt
  ctx.lineTo(points[0].x, height - padding.bottom); // Sol alt
  ctx.closePath(); // Yolu kapat
  ctx.fillStyle = 'rgba(100,210,255,0.15)'; // Alan rengi
  ctx.fill(); // AlanÄ± doldur
  ctx.fillStyle = 'rgba(255,255,255,0.6)'; // YazÄ± rengi
  ctx.textAlign = 'center'; // X ekseni metni
  for (let i = 0; i <= 4; i += 1) { // 5 bÃ¶lme
    const time = (maxTime / 4) * i; // Zaman deÄŸeri
    const x = padding.left + (time / maxTime) * chartWidth; // X koordinatÄ±
    ctx.fillText(`${time.toFixed(0)} sn`, x, height - padding.bottom + 18); // Etiketi yaz
  }
  ctx.textAlign = 'right'; // Y ekseni metni
  for (let i = 0; i <= 4; i += 1) { // 5 bÃ¶lme
    const count = (maxCount / 4) * i; // Adet deÄŸeri
    const y = height - padding.bottom - (count / maxCount) * chartHeight; // Y koordinatÄ±
    ctx.fillText(`${count.toFixed(0)}`, padding.left - 6, y + 4); // Etiketi yaz
  }
}

function loadSample() { // Ã–rnek kurulum yÃ¼kle
  appState.stations = []; // Listeyi temizle
  appState.nextStationId = 1; // SayaÃ§ sÄ±fÄ±rla
  const s1 = new Station(`station-${appState.nextStationId++}`, 'S1'); // Ä°stasyon1
  s1.tasks = [new Task('Kesim', 1, 18), new Task('Montaj', 1, 38)]; // GÃ¶revler
  const s2 = new Station(`station-${appState.nextStationId++}`, 'S2'); // Ä°stasyon2
  s2.tasks = [new Task('Kaynak', 1, 30)]; // GÃ¶rev
  const s3 = new Station(`station-${appState.nextStationId++}`, 'S3'); // Ä°stasyon3
  s3.tasks = [new Task('Boyama', 1, 40)]; // GÃ¶rev
  appState.stations.push(s1, s2, s3); // Listeye ekle
  appState.entryPolicy = 'trigger'; // Tetikleme politikasÄ±
  appState.targetCount = 20; // Hedef 20
  syncControlsFromState(); // Kontrolleri hizala
  renderStations(); // UI gÃ¼ncelle
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Durumu kaydet
}

function syncControlsFromState() { // Kontrolleri duruma gÃ¶re hizala
  targetInput.value = appState.targetCount ?? ''; // Hedef alanÄ±
  entryPolicySelect.value = appState.entryPolicy; // Politika seÃ§imi
  entryIntervalInput.value = appState.entryInterval; // AralÄ±k alanÄ±
  entryIntervalInput.style.display = appState.entryPolicy === 'interval' ? 'block' : 'none'; // GÃ¶rÃ¼nÃ¼rlÃ¼k
  entryIntervalInput.disabled = appState.entryPolicy !== 'interval'; // Kilit durumu
  speedSlider.value = appState.speed; // HÄ±z kaydÄ±rgacÄ±
  const display = Number.isInteger(appState.speed) ? appState.speed.toFixed(0) : appState.speed.toFixed(2); // GÃ¶sterim metni
  speedValue.textContent = `${display}Ã—`; // HÄ±z etiketi
  if (taktInput) taktInput.value = appState.taktTime ?? ''; // Takt alanÄ±
  updateZoomDisplay(); // Zoom gÃ¶stergesini yenile
}

function restoreFromSnapshot(snapshot) { // Yerel depolamadan gelen durumu uygula
  if (!snapshot || typeof snapshot !== 'object') { // Veri yoksa
    renderStations(); // VarsayÄ±lan Ã§iz
    renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
    syncControlsFromState(); // Kontrolleri hizala
    return; // Ã‡Ä±k
  }
  const safeStations = Array.isArray(snapshot.stations) ? snapshot.stations : []; // GÃ¼venli istasyon listesi
  appState.stations = safeStations.map(raw => { // Her istasyon iÃ§in
    const stationId = raw.id ? String(raw.id) : `station-${appState.nextStationId++}`; // KimliÄŸi belirle
    const stationName = raw.name ? String(raw.name) : stationId; // Ä°smi seÃ§
    const station = new Station(stationId, stationName); // Yeni istasyon
    station.parallelServers = Math.max(1, Math.min(MAX_SERVERS, Number(raw.parallelServers) || 1)); // Paralel sÄ±nÄ±r
    const rawTasks = Array.isArray(raw.tasks) ? raw.tasks : []; // GÃ¶rev listesi
    station.tasks = rawTasks.map(taskRaw => new Task( // Her gÃ¶rev iÃ§in
      taskRaw.name ? String(taskRaw.name) : 'GÃ¶rev', // GÃ¶rev adÄ±
      Math.max(1, Number(taskRaw.operators) || 1), // OperatÃ¶r
      Math.max(1, Number(taskRaw.durationSec) || 1) // SÃ¼re
    ));
    return station; // HazÄ±r istasyon
  });
  const snapshotNext = snapshot.nextStationId ? Number(snapshot.nextStationId) : appState.nextStationId; // Sonraki sayaÃ§
  const computedNext = appState.stations.length ? Math.max(...appState.stations.map(st => {
    const numeric = Number(String(st.id).split('-').pop()); // Kimlikten sayÄ± Ã§Ä±kar
    return Number.isFinite(numeric) ? numeric + 1 : 1; // Sonraki tahmin
  })) : 1; // BoÅŸsa 1
  appState.nextStationId = Math.max(1, snapshotNext, computedNext); // SayaÃ§ hizala
  if (typeof snapshot.targetCount === 'number' && snapshot.targetCount > 0) { // Hedef geÃ§erli mi
    appState.targetCount = Math.floor(snapshot.targetCount); // Hedefi ata
  }
  if (typeof snapshot.entryInterval === 'number' && snapshot.entryInterval > 0) { // AralÄ±k geÃ§erli mi
    appState.entryInterval = Math.floor(snapshot.entryInterval); // AralÄ±ÄŸÄ± ata
  }
  if (snapshot.entryPolicy === 'interval' || snapshot.entryPolicy === 'trigger') { // Politika doÄŸrulama
    appState.entryPolicy = snapshot.entryPolicy; // PolitikayÄ± ata
  }
  if (typeof snapshot.speed === 'number' && snapshot.speed > 0) { // HÄ±z geÃ§erli mi
    appState.speed = Math.max(0.25, Math.min(16, snapshot.speed)); // HÄ±zÄ± sÄ±nÄ±rla
  }
  if (typeof snapshot.zoom === 'number' && snapshot.zoom > 0) { // Zoom geÃ§erli mi
    appState.zoom = Math.max(0.5, Math.min(2.5, snapshot.zoom)); // Zoom aralÄ±ÄŸÄ±nÄ± sÄ±nÄ±rla
  }
  if (typeof snapshot.taktTime === 'number' && snapshot.taktTime > 0) { // Takt deÄŸeri geÃ§erli mi
    appState.taktTime = snapshot.taktTime; // Takt time ata
  }
  syncControlsFromState(); // Kontrolleri gÃ¼ncelle
  renderStations(); // KartlarÄ± Ã§iz
  renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
  saveState(appState); // Normalize edilmiÅŸ durumu kaydet
}

let eventsBound = false; // Olay baÄŸlama bayraÄŸÄ±

function bindKeyboardShortcuts(event) { // Klavye kÄ±sayol dinleyicisi
  if (!event || !event.key) return; // GeÃ§ersizse Ã§Ä±k
  const tagName = event.target?.tagName; // Hedef etiketi
  if (tagName === 'INPUT' || tagName === 'TEXTAREA') return; // Form odakta ise Ã§Ä±k
  const key = event.key.toLowerCase(); // Harfi kÃ¼Ã§Ã¼lt
  if (key === 'b') startSimulation(); // B ile baÅŸlat
  if (key === 'd') stopSimulation(true); // D ile durdur
  if (key === 'r') resetSimulation(); // R ile sÄ±fÄ±rla
}

function guardControlForm() { // Kontrol formu gÃ¶nderimini engelle
  document.querySelector('form#controls')?.addEventListener('submit', event => event.preventDefault()); // Submit engelle
}

function attachUiEvents() { // UI olaylarÄ±nÄ± baÄŸla
  if (eventsBound) return; // Zaten baÄŸlÄ±ysa Ã§Ä±k
  eventsBound = true; // BayraÄŸÄ± iÅŸaretle
  guardControlForm(); // Form korumasÄ± ekle
  const addBtn = document.querySelector('#addStationBtn, [data-action="add-station"]'); // Butonu bul
  console.assert(addBtn, 'Add Station button not found'); // Kontrol
  addBtn?.addEventListener('click', onAddStationClick, { once: false }); // TÄ±klama baÄŸla
  sampleBtn?.addEventListener('click', loadSample); // Ã–rnek kurulum
  startBtn?.addEventListener('click', () => startSimulation()); // BaÅŸlat
  stopBtn?.addEventListener('click', () => stopSimulation(true)); // Durdur
  resetBtn?.addEventListener('click', () => resetSimulation()); // SÄ±fÄ±rla
  analysisBtn?.addEventListener('click', () => openAnalysisModal()); // Analiz modalÄ±nÄ± aÃ§
  resultsBtn?.addEventListener('click', () => openReportModal()); // Raporu aÃ§
  fullscreenBtn?.addEventListener('click', () => toggleFullscreen()); // Tam ekran deÄŸiÅŸtir
  closeAnalysisBtn?.addEventListener('click', () => closeAnalysisModal()); // Analiz modalÄ±nÄ± kapat
  analysisModal?.addEventListener('click', event => { if (event.target === analysisModal) closeAnalysisModal(); }); // DÄ±ÅŸa tÄ±klayÄ±nca kapat
  analysisRecalcBtn?.addEventListener('click', () => runAnalysis()); // Analizi yenile
  closeReportBtn?.addEventListener('click', () => closeReport()); // Rapor kapat
  reportModal?.addEventListener('click', event => { if (event.target === reportModal) closeReport(); }); // Modal dÄ±ÅŸÄ± kapat
  speedSlider?.addEventListener('input', () => { // HÄ±z deÄŸiÅŸimi
    const value = Number(speedSlider.value); // DeÄŸer al
    appState.speed = value; // Duruma ata
    const display = Number.isInteger(value) ? value.toFixed(0) : value.toFixed(2); // GÃ¶sterim seÃ§imi
    speedValue.textContent = `${display}Ã—`; // Etiketi gÃ¼ncelle
    viz.setSpeed(appState.speed); // Animasyon hÄ±zÄ±nÄ± anÄ±nda uygula
    saveState(appState); // Durumu kaydet
  });
  targetInput?.addEventListener('input', () => { // Hedef deÄŸiÅŸimi
    const value = Number(targetInput.value); // DeÄŸer al
    appState.targetCount = value > 0 ? Math.floor(value) : null; // Ata
    saveState(appState); // Durumu kaydet
  });
  taktInput?.addEventListener('change', () => { // Takt deÄŸiÅŸimi
    const value = Number(taktInput.value); // DeÄŸer al
    appState.taktTime = value > 0 ? value : null; // Duruma yaz
    saveState(appState); // Durumu kaydet
    runAnalysis(); // Analizi gÃ¼ncelle
  });
  entryPolicySelect?.addEventListener('change', () => { // GiriÅŸ politikasÄ± deÄŸiÅŸimi
    appState.entryPolicy = entryPolicySelect.value; // Durum gÃ¼ncelle
    if (entryIntervalInput) { // AralÄ±k alanÄ± varsa
      entryIntervalInput.style.display = appState.entryPolicy === 'interval' ? 'block' : 'none'; // AlanÄ± gÃ¶ster/gizle
      entryIntervalInput.disabled = appState.entryPolicy !== 'interval'; // Kilit
    }
    saveState(appState); // Durumu kaydet
  });
  entryIntervalInput?.addEventListener('change', () => { // AralÄ±k deÄŸiÅŸimi
    const value = Math.max(1, Number(entryIntervalInput.value) || 1); // SÄ±nÄ±rla
    entryIntervalInput.value = value; // AlanÄ± gÃ¼ncelle
    appState.entryInterval = value; // Duruma ata
    saveState(appState); // Durumu kaydet
  });
  zoomOutBtn?.addEventListener('click', () => adjustZoom(-0.25)); // Zoom azalt
  zoomInBtn?.addEventListener('click', () => adjustZoom(0.25)); // Zoom artÄ±r
  zoomResetBtn?.addEventListener('click', () => resetZoom()); // Zoom sÄ±fÄ±rla
  document.addEventListener('keydown', bindKeyboardShortcuts); // Klavye olaylarÄ±
  document.addEventListener('fullscreenchange', () => { // Tam ekran deÄŸiÅŸince
    updateFullscreenLabel(); // Etiketi gÃ¼ncelle
    scheduleDashboardCharts(); // Grafik boyutlarÄ±nÄ± tazele
  });
  window.addEventListener('resize', () => scheduleDashboardCharts()); // Pencere yeniden boyutlanÄ±nca grafikleri tazele
}

function initApp() { // BaÅŸlatÄ±cÄ±
  attachUiEvents(); // OlaylarÄ± baÄŸla
  if (persistedSnapshot) { // KayÄ±tlÄ± durum varsa
    restoreFromSnapshot(persistedSnapshot); // Durumu yÃ¼kle
  } else {
    syncControlsFromState(); // VarsayÄ±lan kontroller
    renderStations(); // VarsayÄ±lan Ã§izim
    renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
    saveState(appState); // BaÅŸlangÄ±Ã§ durumunu yaz
  }
  setTimeout(() => { // Programatik doÄŸrulama
    const addBtn = document.querySelector('#addStationBtn, [data-action="add-station"]'); // Butonu bul
    if (!addBtn) return; // Yoksa Ã§Ä±k
    const before = appState.stations.length; // Ã–nceki sayaÃ§
    const previousNextId = appState.nextStationId; // Ã–nceki kimlik sayacÄ±
    renderingPaused = true; // Yeniden Ã§izimi geÃ§ici olarak durdur
    try { // Korunan deneme bloÄŸu
      addBtn.click(); // TÄ±klamayÄ± simÃ¼le et
    } finally { // Her durumda Ã§alÄ±ÅŸacak blok
      renderingPaused = false; // BayraÄŸÄ± eski haline getir
    }
    const after = appState.stations.length; // Sonraki sayaÃ§
    console.assert(after === before + 1, 'Station not added via programmatic click'); // DoÄŸrulama
    if (after === before + 1) { // BaÅŸarÄ±lÄ±ysa
      appState.stations.pop(); // Eklenen istasyonu Ã§Ä±kar
      appState.nextStationId = previousNextId; // Kimlik sayacÄ±nÄ± geri al
      renderStations(); // Listeyi yenile
      renderGraph(appState.stations); // AkÄ±ÅŸÄ± gÃ¼ncelle
      saveState(appState); // Durumu kaydet
    }
  }, 500); // 500ms sonra Ã§alÄ±ÅŸtÄ±r
}

if (document.readyState === 'loading') { // DOM yÃ¼kleniyorsa
  document.addEventListener('DOMContentLoaded', initApp, { once: true }); // DOM hazÄ±r olunca Ã§alÄ±ÅŸtÄ±r
} else {
  queueMicrotask(initApp); // Zaten yÃ¼klÃ¼yse hemen Ã§alÄ±ÅŸtÄ±r
}
</script> <!-- Betik bitiÅŸi -->
</body>
</html>
